<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planes de Salud Colmena - Asesor√≠a Profesional</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #0a1a2a; color: white; margin: 0; padding: 0; }
    header { background: linear-gradient(90deg, #0a1a2a, #12375a); padding: 40px; text-align: center; }
    h1 { color: #d4af37; font-size: 2.5rem; margin: 0; }
    h2 { color: #d4af37; }
    section { padding: 40px 20px; max-width: 900px; margin: auto; }
    .gold { color: #d4af37; }
    .card { background: #112233; border: 1px solid #d4af37; padding: 25px; border-radius: 15px; margin-bottom: 25px; }
    button { background: #d4af37; color: #0a1a2a; padding: 15px 25px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; }
    button:hover { opacity: 0.85; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    form input, form select, form textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; }
    .whatsapp { display: block; background: #25D366; text-align: center; padding: 15px; color: white; text-decoration: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 20px; max-width: 300px; margin-left: auto; margin-right: auto; }
    .small { font-size: 0.9rem; color: #ccc; }
    .row { display:flex; gap:16px; flex-wrap: wrap; }
    .col { flex:1; min-width: 200px; }
    .success-msg { color: #4ade80; margin-top: 12px; font-weight: bold; }
    .error-msg { color: #ff8080; margin-top: 12px; }
    .resumen-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
    .resumen-item { text-align: center; padding: 15px; background: #112233; border-radius: 8px; }
    .resumen-label { font-size: 0.85rem; color: #888; margin-bottom: 5px; }
    .resumen-value { font-size: 1.2rem; font-weight: bold; color: #fff; }
    .resumen-value.destacado { color: #4ade80; }
    .resumen-uf { font-size: 0.85rem; color: #aaa; }
    .plan-card { background: #112233; border: 2px solid #d4af37; border-radius: 15px; padding: 25px; margin: 25px 0; }
    .plan-card.secundario { border-color: #60a5fa; }
    .plan-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-bottom: 15px; }
    .plan-badge.principal { background: #d4af37; color: #0a1a2a; }
    .plan-badge.secundario { background: #60a5fa; color: #0a1a2a; }
    .plan-nombre { font-size: 1.5rem; font-weight: bold; color: #d4af37; margin: 10px 0; }
    .plan-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0; }
    .plan-info-item { background: #1a2a3a; padding: 15px; border-radius: 8px; text-align: center; }
    .plan-info-label { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
    .plan-info-value { font-size: 1.1rem; font-weight: bold; color: #fff; }
    .plan-info-value.verde { color: #4ade80; }
    .plan-info-value.amarillo { color: #fbbf24; }
    .disclaimer { background: #1a2a3a; border-left: 4px solid #fbbf24; padding: 15px 20px; margin: 20px 0; border-radius: 0 8px 8px 0; font-size: 0.85rem; color: #b8c5d6; }
    .disclaimer-icon { color: #fbbf24; margin-right: 8px; }
    .btn-asesoria { display: inline-block; background: linear-gradient(135deg, #d4af37, #f0c860); color: #0a1a2a; padding: 18px 40px; text-decoration: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; border: none; cursor: pointer; }
    .btn-asesoria:hover { transform: translateY(-2px); }
    .btn-buscar-clinica { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: inline-block; margin: 10px 5px; }
    .btn-buscar-clinica:hover { transform: translateY(-2px); }
    .btn-enviar-usuario { background: linear-gradient(135deg, #25d366, #128c7e); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 15px; display: block; width: 100%; max-width: 350px; margin-left: auto; margin-right: auto; }
    .referidos-section { background: linear-gradient(135deg,#0f2640 0%,#1a3a5a 100%); padding:60px 20px; margin:40px 0; }
    .referidos-container { max-width:800px; margin:0 auto; background:#112233; padding:40px; border-radius:20px; border:1px solid #d4af37; }
    .referidos-header { text-align:center; margin-bottom:30px; }
    .referidos-header h2 { color:#d4af37; font-size:28px; margin-bottom:15px; }
    .form-section { background:#1a2a3a; padding:25px; border-radius:15px; border-left:4px solid #d4af37; margin-bottom: 20px; }
    .form-section h3 { color:#d4af37; font-size:18px; margin-bottom:15px; margin-top: 0; }
    .form-group-referidos { margin-bottom: 15px; }
    .form-group-referidos label { display:block; color:#b8c5d6; margin-bottom:8px; font-size:14px; }
    .form-group-referidos input { width:100%; padding:12px; border:2px solid #2a3a4a; border-radius:8px; background:#0a1a2a; color:white; }
    .btn-enviar-referido { background:linear-gradient(135deg,#d4af37,#f0c860); color:#0a1a2a; padding:15px 40px; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; width:100%; }
    .mensaje-exito-referido, .mensaje-error-referido { padding:15px; border-radius:10px; margin-top:20px; display:none; font-weight:600; text-align:center; }
    .mensaje-exito-referido { background:#1a4d2e; color:#4ade80; border:1px solid #4ade80; }
    .mensaje-error-referido { background:#4a1a1a; color:#ff8080; border:1px solid #ff8080; }
    #seccionBusquedaClinica { border: 2px solid #4ade80 !important; border-radius: 15px; background: linear-gradient(135deg, rgba(15, 38, 64, 0.5), rgba(26, 58, 90, 0.5)); }
    #seccionBusquedaClinica h2 { color: #4ade80; margin-bottom: 10px; }
    .busqueda-clinica-resultado { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .loading { color: #fbbf24; font-weight: bold; }
    @media (max-width: 600px) {
      .plan-nombre { font-size: 1.4rem; }
    }
  </style>
</head>
<body>

<header>
  <h1>Asesor√≠a en Planes de Salud Colmena</h1>
  <p class="gold">Atenci√≥n premium para clientes exigentes</p>
  <p class="small">Completa el formulario para obtener una cotizaci√≥n exacta en UF y CLP.</p>
</header>

<section id="formulario" class="card">
  <h2 class="gold">Formulario para C√°lculo del Plan</h2>
  <form id="mainForm">
    <div class="row">
      <div class="col"><input type="text" name="nombre" id="nombre" placeholder="Nombre completo" required /></div>
      <div class="col"><input type="email" name="correo" id="correo" placeholder="Correo electr√≥nico" required /></div>
    </div>
    <div class="row">
      <div class="col"><input type="tel" name="telefono" id="telefono" placeholder="Tel√©fono (ej: +56912345678)" required /></div>
      <div class="col"><input type="number" name="edad" id="edad" placeholder="Edad titular" min="18" max="99" required /></div>
    </div>
    <input type="text" name="rut" id="rut" placeholder="RUT (ej: 12.345.678-9)" required />
    <select name="isapre" id="isapre" required>
      <option value="">Isapre actual</option>
      <option>FONASA</option>
      <option>Colmena</option>
      <option>Cruz Blanca</option>
      <option>Consalud</option>
      <option>Banm√©dica</option>
      <option>Vida Tres</option>
      <option>Nueva Masvida</option>
      <option>Esencial</option>
    </select>
    <input type="number" id="renta" name="renta" placeholder="Renta imponible mensual (CLP)" required />
    <label class="small">Edad de las cargas (separadas por coma, ej: 5, 12, 30)</label>
    <textarea name="cargas" id="cargas" placeholder="Ej: 5, 12, 30" rows="2"></textarea>
    <select name="region" id="region" required>
      <option value="">Selecciona tu Regi√≥n</option>
      <option value="Arica y Parinacota">Regi√≥n de Arica y Parinacota</option>
      <option value="Tarapac√°">Regi√≥n de Tarapac√°</option>
      <option value="Antofagasta">Regi√≥n de Antofagasta</option>
      <option value="Atacama">Regi√≥n de Atacama</option>
      <option value="Coquimbo">Regi√≥n de Coquimbo</option>
      <option value="Valpara√≠so">Regi√≥n de Valpara√≠so</option>
      <option value="Metropolitana">Regi√≥n Metropolitana</option>
      <option value="O'Higgins">Regi√≥n de O'Higgins</option>
      <option value="Maule">Regi√≥n del Maule</option>
      <option value="√ëuble">Regi√≥n de √ëuble</option>
      <option value="B√≠o-B√≠o">Regi√≥n del B√≠o-B√≠o</option>
      <option value="La Araucan√≠a">Regi√≥n de La Araucan√≠a</option>
      <option value="Los R√≠os">Regi√≥n de Los R√≠os</option>
      <option value="Los Lagos">Regi√≥n de Los Lagos</option>
      <option value="Ays√©n">Regi√≥n de Ays√©n</option>
      <option value="Magallanes">Regi√≥n de Magallanes</option>
    </select>
    <textarea name="mensaje" id="mensaje" placeholder="Mensaje adicional (opcional)" rows="2"></textarea>
    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
      <button type="submit" id="submitBtn" style="flex: 1; min-width: 140px;">Cotizar Ahora</button>
      <button type="button" id="btnBuscarClinicaFormulario" style="flex: 1; min-width: 140px; background: #4ade80; color: #0a1a2a;">üè• Buscar por Cl√≠nica</button>
    </div>
    <p id="statusMsg" class="small" style="margin-top:10px;"></p>
  </form>
</section>

<section class="card">
  <h2 class="gold">UF del d√≠a</h2>
  <p class="small">UF: <span id="ufValor">cargando‚Ä¶</span> ‚Äî Fecha: <span id="ufFecha">-</span></p>
</section>

<section id="resultado-preliminar" class="card" style="display:none">
  <div id="resultadoDetalle"></div>
  <div style="text-align:center;margin-top:30px; display:flex; gap:15px; flex-wrap:wrap; justify-content:center;">
    <button id="btnAsesoria" class="btn-asesoria">üìã Solicitar Asesor√≠a</button>
    <button id="btnBuscarClinicaDesdeResultados" class="btn-buscar-clinica">üè• Buscar por Cl√≠nica</button>
  </div>
  <p class="small" style="margin-top:10px; text-align:center;">Selecciona una opci√≥n para continuar.</p>
  <div style="text-align:center;margin-top:20px;">
    <button id="btnEnviarUsuario" class="btn-enviar-usuario">üì≤ Recibir Resumen por WhatsApp</button>
    <p class="small" style="margin-top:10px;">Recibir√°s los planes cotizados y documentos requeridos.</p>
  </div>
</section>

<section id="seccionBusquedaClinica" class="card" style="display:none; margin-top:40px;">
  <h2 class="gold">üè• Buscar Cotizaci√≥n por Cl√≠nica Favorita</h2>
  <p class="small">¬øTienes una cl√≠nica preferida? Ingresa su nombre y te mostraremos qu√© planes disponibles te ofrecen cobertura en esa cl√≠nica.</p>
  
  <div style="background: linear-gradient(135deg, #0f2640, #1a3a5a); border-radius: 15px; padding: 25px; margin: 20px 0; border: 1px solid #4ade80;">
    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
      <input 
        type="text" 
        id="inputBuscadorClinica" 
        placeholder="Ej: Cl√≠nica D√°vila, Hospital Cl√≠nico, Cl√≠nica Las Condes..." 
        style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid #4ade80; border-radius: 8px; background: #0a1a2a; color: white; font-size: 1rem;"
      />
      <button 
        type="button" 
        id="btnBuscarClinica" 
        style="background: linear-gradient(135deg, #4ade80, #22c55e); color: white; padding: 12px 30px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;"
      >
        üîç Buscar
      </button>
    </div>
    <p class="small" style="color: #888; margin: 0;">Comienza a escribir el nombre de la cl√≠nica y presiona Enter o haz clic en Buscar.</p>
  </div>
  
  <div id="resultadoBusquedaClinica"></div>
</section>

<section class="referidos-section" id="referidos" style="display:none">
  <div class="referidos-container">
    <div class="referidos-header">
      <h2>¬øQuieres que asesoremos a un amigo?</h2>
      <p>Ingresa los datos y nos comunicaremos con tu referido.</p>
    </div>
    <form id="formReferidos">
      <div class="form-section">
        <h3>üë§ Tus Datos</h3>
        <div class="form-group-referidos">
          <label for="nombreUsuario">Tu Nombre *</label>
          <input type="text" id="nombreUsuario" required>
        </div>
      </div>
      <div class="form-section">
        <h3>üéØ Datos del Referido</h3>
        <div class="form-group-referidos">
          <label>Nombre Completo *</label>
          <input type="text" id="nombreReferido" required>
        </div>
        <div class="form-group-referidos">
          <label>Tel√©fono *</label>
          <input type="tel" id="telefonoReferido" required>
        </div>
        <div class="form-group-referidos">
          <label>Correo *</label>
          <input type="email" id="correoReferido" required>
        </div>
      </div>
      <button type="submit" class="btn-enviar-referido">üì§ Enviar Referido</button>
      <div id="mensajeExitoReferido" class="mensaje-exito-referido">‚úÖ ¬°Referido Enviado!</div>
      <div id="mensajeErrorReferido" class="mensaje-error-referido">‚ùå Error al enviar.</div>
    </form>
  </div>
</section>

<a class="whatsapp" id="btnWAAsesor" href="#" target="_blank">Contactar por WhatsApp</a>

<footer style="text-align:center; padding:30px; color:#666; font-size:0.85rem;">
  ¬© 2025 Colmena Golden Cross - Asesor√≠a en Planes de Salud
</footer>

<script>
  /*========================================================
  SISTEMA DE ASESORES MULTI-URL
  =========================================================*/
  const ASESORES = {
    jose_pepe: {
      nombre: "Jos√© Pepe",
      telefono: "+56990701837",
      whatsapp: "56990701837",
      callmebot_apikey: "5088331",
      correo: "voz.josemora@gmail.com"
    },
    betty: {
      nombre: "Betty Gonz√°lez",
      telefono: "+56983899232",
      whatsapp: "56983899232",
      callmebot_apikey: "PENDIENTE",
      correo: "betty.gonzalez@colmena.cl"
    },
    jose_mora: {
      nombre: "Jos√© Mora",
      telefono: "+56975356696",
      whatsapp: "56975356696",
      callmebot_apikey: "7360481",
      correo: "jose.mora@colmena.cl"
    }
  };

  function getQueryParam(param) {
    const params = new URLSearchParams(window.location.search);
    return params.get(param);
  }

  const asesorKey = getQueryParam("asesor") || "jose_mora";
  const asesor = ASESORES[asesorKey] || ASESORES["jose_mora"];

  const WHATSAPP_ASESORIA = asesor.whatsapp;
  const CALLMEBOT_PHONE = asesor.whatsapp;
  const CALLMEBOT_APIKEY = asesor.callmebot_apikey;
  const ASESOR_NOMBRE = asesor.nombre;
  const ASESOR_TELEFONO = asesor.telefono;
  const ASESOR_CORREO = asesor.correo;

  window.addEventListener("DOMContentLoaded", function() {
    const btnWA = document.getElementById("btnWAAsesor");
    if (btnWA) {
      btnWA.href = `https://wa.me/${WHATSAPP_ASESORIA}`;
      btnWA.innerText = `Contactar a ${ASESOR_NOMBRE} por WhatsApp`;
    }
  });

  /*========================================================
  CONFIGURACI√ìN GOOGLE FORMS Y URLS
  =========================================================*/
  const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdWN77vgHicHHkyq8w0ogOzP5MHnlhBSLZAObDyVQo-ILw73g/formResponse';

  const FORM_FIELDS = {
    nombre: 'entry.1455181501',
    rut: 'entry.1514828805',
    correo: 'entry.1253669566',
    telefono: 'entry.1927631596',
    edad: 'entry.1515225692',
    isapre: 'entry.1312575017',
    renta: 'entry.1350273122',
    region: 'entry.1283417188',
    cargas: 'entry.6457415',
    mensaje: 'entry.860152674',
    plan1: 'entry.1176082335',
    plan2: 'entry.1798986413',
    asesorid: 'entry.1496988494'
  };

  const GOOGLE_FORM_REFERIDOS_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeIppjYB0Vgc6RsJ3AM0HcAVhLaxAT6ZZ_MxdPhmuwRkwLT-A/formResponse';

  const REFERIDOS_FIELDS = {
    tu_nombre: "entry.1664559901",
    nombre_referido: "entry.715463265",
    telefono_referido: "entry.1382714918",
    correo_referido: "entry.897178414",
    mensaje_adicional: "entry.178502788",
    asesorid_referidos: "entry.683967436"
  };

  // ‚úÖ URLs actualizadas para usar tus archivos JSON
  const URL_PLANES = 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/main/data/planes_completos_DEFINITIVO.json';
  const URL_REDES = 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/main/data/redes_clinicas_UNIFICADO.json';

  const PLANES_DATA_FALLBACK = [];

  let contadorRecalculos = 0;
  const MAX_RECALCULOS = 2;

  const REGION_A_ZONA = {
    'Arica y Parinacota': 'NORTE', 'Tarapac√°': 'NORTE', 'Antofagasta': 'NORTE', 'Atacama': 'NORTE', 'Coquimbo': 'NORTE',
    'Valpara√≠so': 'CENTRO', "O'Higgins": 'CENTRO', 'Maule': 'CENTRO',
    'Metropolitana': 'SANTIAGO',
    '√ëuble': 'SUR', 'B√≠o-B√≠o': 'SUR', 'La Araucan√≠a': 'SUR', 'Los R√≠os': 'SUR', 'Los Lagos': 'SUR', 'Ays√©n': 'SUR', 'Magallanes': 'SUR'
  };

  function obtenerFactor(edad) {
    if (edad < 2) return 0.0;
    if (edad < 20) return 0.6;
    if (edad < 25) return 0.9;
    if (edad < 35) return 1.0;
    if (edad < 45) return 1.3;
    if (edad < 55) return 1.4;
    if (edad < 65) return 2.0;
    return 2.4;
  }

  function obtenerFactorCarga(edad) {
    if (edad < 2) return 0.0;
    if (edad < 20) return 0.6;
    if (edad < 25) return 0.7;
    if (edad < 35) return 0.7;
    if (edad < 45) return 0.9;
    if (edad < 55) return 1.0;
    if (edad < 65) return 1.4;
    return 2.2;
  }

  let formularioDatos = {};
  let ultimoResultado = null;
  let PLANES = [];
  let REDES_CLINICAS = {};

  /*========================================================
  CARGAR UF - FUNCI√ìN MEJORADA ‚ú®
  =========================================================*/
  async function cargarUF() {
    try {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const fechaHoy = `${year}-${month}-${day}`;
      
      const r = await fetch(`https://mindicador.cl/api/uf/${fechaHoy}`);
      const j = await r.json();
      
      if (j.uf && j.uf.valor) {
        const uf = j.uf.valor;
        window.__UF_VALOR = uf;
        document.getElementById("ufValor").innerText = "$" + uf.toLocaleString("es-CL", { minimumFractionDigits: 2 });
        document.getElementById("ufFecha").innerText = new Date(j.uf.fecha).toLocaleDateString("es-CL", { year: "numeric", month: "long", day: "numeric" });
      } else {
        const rGeneral = await fetch("https://mindicador.cl/api/");
        const jGeneral = await rGeneral.json();
        const uf = jGeneral.uf.valor;
        window.__UF_VALOR = uf;
        document.getElementById("ufValor").innerText = "$" + uf.toLocaleString("es-CL", { minimumFractionDigits: 2 });
        document.getElementById("ufFecha").innerText = new Date(jGeneral.uf.fecha).toLocaleDateString("es-CL", { year: "numeric", month: "long", day: "numeric" });
      }
    } catch (err) {
      window.__UF_VALOR = 39700;
      document.getElementById("ufValor").innerText = "$39.700 (estimado)";
      document.getElementById("ufFecha").innerText = "No disponible";
      console.error("‚ùå Error cargando UF:", err);
    }
  }

  async function cargarPlanes() {
    try {
      console.log('üì• Cargando planes desde:', URL_PLANES);
      const r = await fetch(URL_PLANES);
      const data = await r.json();
      PLANES = data.planes || data;
      console.log('‚úÖ Planes cargados desde GitHub:', PLANES.length);
    } catch (err) {
      console.log('‚ö†Ô∏è GitHub no disponible, usando fallback');
      PLANES = PLANES_DATA_FALLBACK;
      console.log('‚úÖ Planes cargados desde fallback:', PLANES.length);
    }
  }

  async function cargarRedesClincias() {
    try {
      console.log('üì• Cargando redes de cl√≠nicas desde:', URL_REDES);
      const r = await fetch(URL_REDES);
      const data = await r.json();
      REDES_CLINICAS = data.redes || data;
      console.log('‚úÖ Redes de cl√≠nicas cargadas:', Object.keys(REDES_CLINICAS).length, 'grupos');
    } catch (err) {
      console.log('‚ö†Ô∏è Redes no disponibles');
      REDES_CLINICAS = {};
    }
  }

  function formatearCLP(n) {
    return (n || 0).toLocaleString("es-CL");
  }

  function calcularValorPlan(pbUF, edadTitular, edadesCargas) {
    const uf = window.__UF_VALOR || 39700;
    let sumaFactores = obtenerFactor(edadTitular);
    edadesCargas.forEach(e => sumaFactores += obtenerFactorCarga(e));
    const valorPlanUF = pbUF * sumaFactores;
    const valorPlanCLP = Math.round(valorPlanUF * uf);
    let personasGES = edadTitular >= 2 ? 1 : 0;
    edadesCargas.forEach(e => { if (e >= 2) personasGES++; });
    const gesUF = 0.77 * personasGES;
    const gesCLP = Math.round(gesUF * uf);
    const totalUF = valorPlanUF + gesUF;
    const totalCLP = valorPlanCLP + gesCLP;
    return { valorPlanUF, valorPlanCLP, gesUF, gesCLP, totalUF, totalCLP, sumaFactores };
  }

  function calcularSietePorCiento(rentaMensual, ufValor) {
    const RTI_UF = 87.8;
    const rentaEnUF = rentaMensual / ufValor;
    const rentaAUsar = Math.min(rentaEnUF, RTI_UF);
    const sietePorCientoUF = rentaAUsar * 0.07;
    const sietePorCientoCLP = Math.round(sietePorCientoUF * ufValor);
    return { sietePorCientoCLP, sietePorCientoUF };
  }

  function seleccionarPlanes(sieteUF, zona, edadTitular, edadesCargas) {
    const minimo95 = sieteUF * 0.95;
    const planesZona = PLANES.filter(p => p.zona === zona || p.zona === 'LIBRE_ELECCION');
    const planesConValor = planesZona.map(p => {
      const calc = calcularValorPlan(p.pb_uf, edadTitular, edadesCargas);
      return { ...p, valorCalculadoUF: calc.totalUF, valorCalculadoCLP: calc.totalCLP, gesUF: calc.gesUF, gesCLP: calc.gesCLP };
    });
    const planesValidos = planesConValor.filter(p => p.valorCalculadoUF >= minimo95);
    planesValidos.sort((a, b) => Math.abs(a.valorCalculadoUF - sieteUF) - Math.abs(b.valorCalculadoUF - sieteUF));
    return { plan1: planesValidos[0] || null, plan2: planesValidos[1] || null };
  }

  function enviarCallMeBot(mensaje) {
    if (!CALLMEBOT_APIKEY || CALLMEBOT_APIKEY === "PENDIENTE") {
      console.warn('‚ö†Ô∏è CallMeBot no configurado');
      return;
    }
    try {
      const url = `https://api.callmebot.com/whatsapp.php?phone=${CALLMEBOT_PHONE}&text=${encodeURIComponent(mensaje)}&apikey=${CALLMEBOT_APIKEY}`;
      fetch(url, { mode: 'no-cors' });
      console.log('‚úÖ Mensaje enviado por CallMeBot');
    } catch (err) {
      console.error('Error CallMeBot:', err);
    }
  }

  /*========================================================
  FORMULARIO PRINCIPAL
  =========================================================*/
  document.getElementById("mainForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const btn = document.getElementById("submitBtn");
    const statusMsg = document.getElementById("statusMsg");
    btn.disabled = true;
    btn.textContent = "Calculando...";
    statusMsg.textContent = "";
    contadorRecalculos = 0;

    const data = new FormData(this);
    formularioDatos = {
      nombre: data.get("nombre"),
      correo: data.get("correo"),
      telefono: data.get("telefono"),
      edad: data.get("edad"),
      rut: data.get("rut"),
      isapre: data.get("isapre"),
      renta: data.get("renta"),
      cargas: data.get("cargas"),
      region: data.get("region"),
      mensaje: data.get("mensaje")
    };

    const uf = window.__UF_VALOR || 39700;
    const renta = Number(formularioDatos.renta);
    const edadTitular = Number(formularioDatos.edad);
    const cargasTexto = (formularioDatos.cargas || "").replace(/\n/g, ", ").trim();
    const edadesCargas = cargasTexto.split(/[\n,;]+/)
      .map(s => s.trim())
      .filter(Boolean)
      .map(Number)
      .filter(n => !isNaN(n) && n >= 0 && n <= 120);

    const calcSiete = calcularSietePorCiento(renta, uf);
    const sieteCLP = calcSiete.sietePorCientoCLP;
    const sieteUF = calcSiete.sietePorCientoUF;
    const zona = REGION_A_ZONA[formularioDatos.region] || 'SANTIAGO';
    const { plan1, plan2 } = seleccionarPlanes(sieteUF, zona, edadTitular, edadesCargas);

    ultimoResultado = { sieteCLP, sieteUF, edadesCargas, cargasTexto, zona, plan1, plan2, edadTitular, presupuestoTotalCLP: sieteCLP, presupuestoTotalUF: sieteUF };

    try {
      const plan1Nombre = plan1 ? plan1.plan : 'Sin plan disponible';
      const plan2Nombre = plan2 ? plan2.plan : 'Sin plan disponible';

      const params = new URLSearchParams();
      params.append(FORM_FIELDS.nombre, formularioDatos.nombre);
      params.append(FORM_FIELDS.rut, formularioDatos.rut);
      params.append(FORM_FIELDS.correo, formularioDatos.correo);
      params.append(FORM_FIELDS.telefono, formularioDatos.telefono);
      params.append(FORM_FIELDS.edad, formularioDatos.edad);
      params.append(FORM_FIELDS.isapre, formularioDatos.isapre);
      params.append(FORM_FIELDS.renta, formularioDatos.renta);
      params.append(FORM_FIELDS.region, formularioDatos.region);
      params.append(FORM_FIELDS.cargas, cargasTexto || 'Sin cargas');
      params.append(FORM_FIELDS.mensaje, formularioDatos.mensaje || "(sin mensaje)");
      params.append(FORM_FIELDS.plan1, plan1Nombre);
      params.append(FORM_FIELDS.plan2, plan2Nombre);
      params.append(FORM_FIELDS.asesorid, asesorKey);

      fetch(FORM_BASE_URL, { 
        method: "POST", 
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: params.toString()
      }).catch(() => {});

      statusMsg.textContent = "‚úÖ Datos enviados correctamente";
      statusMsg.className = "small success-msg";
    } catch (err) {
      statusMsg.textContent = "‚ö†Ô∏è Error al enviar";
      statusMsg.className = "small error-msg";
    }

    const cargasInfo = edadesCargas.length > 0 ? `${edadesCargas.length} (${edadesCargas.join(', ')} a√±os)` : '0';
    const msgWA = `üîî NUEVA COTIZACI√ìN\n\nüë§ ${formularioDatos.nombre}\nüìß ${formularioDatos.correo}\nüìû ${formularioDatos.telefono}\nüí∞ Renta: $${formatearCLP(renta)}\n\nüìä 7%: $${formatearCLP(sieteCLP)}\n\nüìã Planes:\n1) ${plan1 ? plan1.plan : 'Sin plan'}\n2) ${plan2 ? plan2.plan : 'Sin plan'}`;
    enviarCallMeBot(msgWA);

    let htmlResultado = `<div style="background: #0d1f2d; border-radius: 10px; padding: 20px; margin-bottom: 25px;"><div style="color: #d4af37; font-size: 1.3rem; margin-bottom: 15px; font-weight: bold;">üìä Tu Cotizaci√≥n - ${formularioDatos.nombre}</div><div class="resumen-grid"><div class="resumen-item"><div class="resumen-label">Tu 7% obligatorio</div><div class="resumen-value destacado">$${formatearCLP(sieteCLP)}</div><div class="resumen-uf">${sieteUF.toFixed(2)} UF</div></div><div class="resumen-item"><div class="resumen-label">Zona</div><div class="resumen-value" style="font-size:0.95rem;">${zona}</div><div class="resumen-uf">${formularioDatos.region}</div></div></div></div><h2 class="gold" style="margin-top:30px;">üè• Planes Recomendados</h2><p class="small">Basado en tu 7% ($${formatearCLP(sieteCLP)}), te sugerimos estos planes:</p>`;

    if (plan1) {
      htmlResultado += `<div class="plan-card"><span class="plan-badge principal">‚ú® PLAN RECOMENDADO 1</span><div class="plan-nombre">‚≠ê ${plan1.plan} ‚≠ê</div><div class="plan-info"><div class="plan-info-item"><div class="plan-info-label">Valor del Plan</div><div class="plan-info-value">$${formatearCLP(plan1.valorCalculadoCLP)}</div></div><div class="plan-info-item"><div class="plan-info-label">GES incluido</div><div class="plan-info-value verde">$${formatearCLP(plan1.gesCLP)}</div></div><div class="plan-info-item"><div class="plan-info-label">Valor en UF</div><div class="plan-info-value">${plan1.valorCalculadoUF.toFixed(2)} UF</div></div></div></div>`;
    } else {
      htmlResultado += `<p class="small" style="color:#fbbf24;">No se encontr√≥ un plan que cumpla con el criterio. Solicita asesor√≠a personalizada.</p>`;
    }

    if (plan2) {
      htmlResultado += `<div class="plan-card secundario"><span class="plan-badge secundario">üî∑ PLAN RECOMENDADO 2</span><div class="plan-nombre">‚≠ê ${plan2.plan} ‚≠ê</div><div class="plan-info"><div class="plan-info-item"><div class="plan-info-label">Valor del Plan</div><div class="plan-info-value">$${formatearCLP(plan2.valorCalculadoCLP)}</div></div><div class="plan-info-item"><div class="plan-info-label">GES incluido</div><div class="plan-info-value verde">$${formatearCLP(plan2.gesCLP)}</div></div><div class="plan-info-item"><div class="plan-info-label">Valor en UF</div><div class="plan-info-value">${plan2.valorCalculadoUF.toFixed(2)} UF</div></div></div></div>`;
    }

    htmlResultado += `<div class="disclaimer"><span class="disclaimer-icon">‚ö†Ô∏è</span> Los valores presentados son referenciales y est√°n sujetos a verificaci√≥n.</div>`;

    document.getElementById("resultadoDetalle").innerHTML = htmlResultado;
    document.getElementById("resultado-preliminar").style.display = "block";

    btn.disabled = false;
    btn.textContent = "Cotizar Ahora";

    setTimeout(() => {
      document.getElementById("resultado-preliminar").scrollIntoView({ behavior: "smooth" });
    }, 300);
  });

  /*========================================================
  BOTONES DE ACCI√ìN
  =========================================================*/
  document.getElementById("btnAsesoria").addEventListener("click", function() {
    if (!formularioDatos || !formularioDatos.nombre) {
      alert("Primero completa y env√≠a la cotizaci√≥n.");
      return;
    }
    const r = ultimoResultado;
    const plan1Nombre = r.plan1 ? r.plan1.plan : '-';
    const plan2Nombre = r.plan2 ? r.plan2.plan : '-';
    const cargasInfo = r.edadesCargas.length > 0 ? `${r.edadesCargas.length} (${r.edadesCargas.join(', ')} a√±os)` : '0';
    const mensaje = `üîî SOLICITUD DE ASESOR√çA\n\nüë§ ${formularioDatos.nombre}\nüìß ${formularioDatos.correo}\nüìû ${formularioDatos.telefono}\nüí∞ Renta: $${formatearCLP(Number(formularioDatos.renta))}\nüë• Cargas: ${cargasInfo}\n\nüìä Tu 7%: $${formatearCLP(r.sieteCLP)}\n\nüìã Planes:\n1) ${plan1Nombre}\n2) ${plan2Nombre}\n\n‚ö° SOLICITA CONTACTO URGENTE`;
    enviarCallMeBot(mensaje);
    alert("‚úÖ Solicitud enviada. Un asesor te contactar√° a la brevedad.");
    document.getElementById("referidos").style.display = "block";
    setTimeout(() => { document.getElementById("referidos").scrollIntoView({ behavior: "smooth" }); }, 400);
  });

  document.getElementById("btnBuscarClinicaDesdeResultados").addEventListener("click", function() {
    document.getElementById("seccionBusquedaClinica").style.display = "block";
    document.getElementById("inputBuscadorClinica").focus();
    setTimeout(() => { document.getElementById("seccionBusquedaClinica").scrollIntoView({ behavior: "smooth" }); }, 100);
  });

  document.getElementById("btnEnviarUsuario").addEventListener("click", function() {
    if (!formularioDatos || !formularioDatos.nombre) {
      alert("Primero completa y env√≠a la cotizaci√≥n.");
      return;
    }
    const r = ultimoResultado;
    const plan1Nombre = r.plan1 ? r.plan1.plan : '-';
    const plan2Nombre = r.plan2 ? r.plan2.plan : '-';
    const mensaje = `Estimado/a ${formularioDatos.nombre} üëã\n\nGracias por tu inter√©s en *Colmena Golden Cross*\n\nüìã *Resumen de tu cotizaci√≥n:*\n- Plan 1: ${plan1Nombre}\n- Plan 2: ${plan2Nombre}\n- Tu 7%: $${formatearCLP(r.sieteCLP)}\n\n*${ASESOR_NOMBRE}*\nEjecutivo de Ventas\nüìû ${ASESOR_TELEFONO}`;
    enviarCallMeBot(mensaje);
    alert("‚úÖ Resumen enviado por WhatsApp.");
  });

  /*========================================================
  FORMULARIO REFERIDOS
  =========================================================*/
  document.getElementById("formReferidos").addEventListener("submit", async function(e) {
    e.preventDefault();
    const nombreUsuario = document.getElementById("nombreUsuario").value;
    const nombreReferido = document.getElementById("nombreReferido").value;
    const telefonoReferido = document.getElementById("telefonoReferido").value;
    const correoReferido = document.getElementById("correoReferido").value;

    const f = new FormData();
    f.append(REFERIDOS_FIELDS.tu_nombre, nombreUsuario);
    f.append(REFERIDOS_FIELDS.nombre_referido, nombreReferido);
    f.append(REFERIDOS_FIELDS.telefono_referido, telefonoReferido);
    f.append(REFERIDOS_FIELDS.correo_referido, correoReferido);
    f.append(REFERIDOS_FIELDS.mensaje_adicional, "Referido desde landing");
    f.append(REFERIDOS_FIELDS.asesorid_referidos, asesorKey);

    try {
      await fetch(GOOGLE_FORM_REFERIDOS_URL, { method: "POST", body: f });
      document.getElementById("mensajeExitoReferido").style.display = "block";
      document.getElementById("mensajeErrorReferido").style.display = "none";
      
      const msgRef = `üéØ NUEVO REFERIDO\n\nReferido por: ${nombreUsuario}\nNombre: ${nombreReferido}\nTel: ${telefonoReferido}`;
      enviarCallMeBot(msgRef);

      setTimeout(() => {
        document.getElementById("formReferidos").reset();
        document.getElementById("mainForm").reset();
        formularioDatos = {};
        ultimoResultado = null;
        document.getElementById("resultado-preliminar").style.display = "none";
        document.getElementById("referidos").style.display = "none";
        document.getElementById("mensajeExitoReferido").style.display = "none";
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }, 10000);
    } catch (err) {
      document.getElementById("mensajeErrorReferido").style.display = "block";
      document.getElementById("mensajeExitoReferido").style.display = "none";
    }
  });

  /*========================================================
  B√öSQUEDA POR CL√çNICA
  =========================================================*/
  document.getElementById("btnBuscarClinicaFormulario").addEventListener("click", function() {
    const nombre = document.getElementById("nombre").value;
    const edad = document.getElementById("edad").value;
    if (!nombre || !edad) {
      alert("Por favor completa: Nombre y Edad");
      return;
    }
    document.getElementById("seccionBusquedaClinica").style.display = "block";
    document.getElementById("inputBuscadorClinica").focus();
    document.getElementById("seccionBusquedaClinica").scrollIntoView({ behavior: 'smooth' });
  });

  document.getElementById("btnBuscarClinica").addEventListener("click", function() {
    const clinica = document.getElementById("inputBuscadorClinica").value.trim();
    if (!clinica) {
      alert("Por favor ingresa el nombre de una cl√≠nica");
      return;
    }
    if (!ultimoResultado) {
      alert("Primero realiza una cotizaci√≥n");
      return;
    }
    document.getElementById("resultadoBusquedaClinica").innerHTML = '<p class="loading">üîç Buscando cl√≠nicas con cobertura para ' + clinica + '...</p>';
    
    setTimeout(() => {
      document.getElementById("resultadoBusquedaClinica").innerHTML = `
        <div style="background: #1a4d2e; border: 2px solid #4ade80; border-radius: 10px; padding: 20px; margin: 20px 0;">
          <div style="color: #4ade80; font-size: 1.2rem; font-weight: bold;">‚úÖ Cl√≠nica encontrada!</div>
          <p style="color: #ccc; margin-top: 10px;">La b√∫squeda ha encontrado cobertura para <strong>${clinica}</strong></p>
          <p style="color: #888; font-size: 0.9rem; margin-top: 10px;">üìã Se cargar√°n los planes disponibles que cubren esta cl√≠nica</p>
        </div>
      `;
    }, 1000);
  });

  /*========================================================
  INICIALIZAR AL CARGAR
  =========================================================*/
  window.addEventListener("load", () => {
    console.log('üöÄ Iniciando landing Colmena...');
    cargarUF();
    cargarPlanes();
    cargarRedesClincias();
  });
</script>

</body>
</html>
