<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planes de Salud Colmena - Asesor√≠a Profesional</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #0a1a2a; color: white; margin: 0; padding: 0; }
    header { background: linear-gradient(90deg, #0a1a2a, #12375a); padding: 40px; text-align: center; }
    h1 { color: #d4af37; font-size: 2.5rem; margin: 0; }
    h2 { color: #d4af37; }
    section { padding: 40px 20px; max-width: 900px; margin: auto; }
    .gold { color: #d4af37; }
    .card { background: #112233; border: 1px solid #d4af37; padding: 25px; border-radius: 15px; margin-bottom: 25px; }
    button { background: #d4af37; color: #0a1a2a; padding: 15px 25px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; }
    button:hover { opacity: 0.85; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    form input, form select, form textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; }
    .whatsapp { display: block; background: #25D366; text-align: center; padding: 15px; color: white; text-decoration: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 20px; max-width: 300px; margin-left: auto; margin-right: auto; }
    .small { font-size: 0.9rem; color: #ccc; }
    .row { display:flex; gap:16px; flex-wrap: wrap; }
    .col { flex:1; min-width: 200px; }
    .success-msg { color: #4ade80; margin-top: 12px; font-weight: bold; }
    .error-msg { color: #ff8080; margin-top: 12px; }

    /* Resumen cotizaci√≥n */
    .resumen-cotizacion { background: #0d1f2d; border: 1px solid #3a5a7a; border-radius: 10px; padding: 20px; margin-bottom: 25px; }
    .resumen-titulo { color: #d4af37; font-size: 1.3rem; margin-bottom: 15px; font-weight: bold; }
    .resumen-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
    .resumen-item { text-align: center; padding: 15px; background: #112233; border-radius: 8px; }
    .resumen-label { font-size: 0.85rem; color: #888; margin-bottom: 5px; }
    .resumen-value { font-size: 1.2rem; font-weight: bold; color: #fff; }
    .resumen-value.destacado { color: #4ade80; }
    .resumen-uf { font-size: 0.85rem; color: #aaa; }

    /* Card del plan */
    .plan-card { background: #112233; border: 2px solid #d4af37; border-radius: 15px; padding: 25px; margin: 25px 0; }
    .plan-card.secundario { border-color: #60a5fa; }
    .plan-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-bottom: 15px; }
    .plan-badge.principal { background: #d4af37; color: #0a1a2a; }
    .plan-badge.secundario { background: #60a5fa; color: #0a1a2a; }
    
    /* Nombre del plan MUY DESTACADO */
    .plan-nombre-container { text-align: center; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #1a3a5a, #0d1f2d); border-radius: 12px; border: 2px solid #d4af37; }
    .plan-nombre { font-size: 1.8rem; font-weight: bold; color: #d4af37; text-shadow: 0 2px 10px rgba(212,175,55,0.3); letter-spacing: 1px; }
    .plan-nombre-estrella { color: #fbbf24; font-size: 1.5rem; }

    /* Info del plan */
    .plan-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0; }
    .plan-info-item { background: #1a2a3a; padding: 15px; border-radius: 8px; text-align: center; }
    .plan-info-label { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
    .plan-info-value { font-size: 1.1rem; font-weight: bold; color: #fff; }
    .plan-info-value.verde { color: #4ade80; }
    .plan-info-value.amarillo { color: #fbbf24; }

    /* Coberturas */
    .coberturas-section { margin: 20px 0; padding: 15px; background: #0d1f2d; border-radius: 10px; }
    .coberturas-title { color: #d4af37; font-size: 1rem; margin-bottom: 10px; }
    .coberturas-texto { font-size: 0.9rem; line-height: 1.6; color: #ccc; }

    /* Cl√≠nicas con tabs */
    .clinicas-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid #3a5a7a; }
    .clinicas-title { color: #d4af37; font-size: 1.1rem; margin-bottom: 15px; }
    .grupos-tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .grupo-tab { background: #1a2a3a; border: 1px solid #3a5a7a; color: #ccc; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
    .grupo-tab:hover { border-color: #d4af37; color: #d4af37; }
    .grupo-tab.active { background: #d4af37; color: #0a1a2a; border-color: #d4af37; font-weight: bold; }
    .clinicas-tabla { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .clinicas-tabla th { background: #1a3a5a; color: #d4af37; padding: 12px 15px; text-align: left; }
    .clinicas-tabla td { padding: 10px 15px; border-bottom: 1px solid #2a3a4a; }
    .clinicas-tabla tr:nth-child(even) { background: #0d1f2d; }
    .clinicas-tabla tr:nth-child(odd) { background: #112233; }
    .clinicas-tabla tr:hover { background: #1a3a4a; }
    .grupo-content { display: none; }
    .grupo-content.active { display: block; }

    /* Bot√≥n asesor√≠a */
    .btn-asesoria { display: inline-block; background: linear-gradient(135deg, #d4af37, #f0c860); color: #0a1a2a; padding: 18px 40px; text-decoration: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 15px rgba(212,175,55,0.4); transition: all .3s ease; border: none; cursor: pointer; }
    .btn-asesoria:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,175,55,0.6); }

    /* Referidos */
    .referidos-section { background: linear-gradient(135deg,#0f2640 0%,#1a3a5a 100%); padding:60px 20px; margin:40px 0; }
    .referidos-container { max-width:800px; margin:0 auto; background:#112233; padding:40px; border-radius:20px; border:1px solid #d4af37; }
    .referidos-header { text-align:center; margin-bottom:30px; }
    .referidos-header h2 { color:#d4af37; font-size:28px; margin-bottom:15px; }
    .referidos-header p { color:#b8c5d6; font-size:16px; }
    .form-section { background:#1a2a3a; padding:25px; border-radius:15px; border-left:4px solid #d4af37; margin-bottom: 20px; }
    .form-section h3 { color:#d4af37; font-size:18px; margin-bottom:15px; margin-top: 0; }
    .form-group-referidos { margin-bottom: 15px; }
    .form-group-referidos label { display:block; color:#b8c5d6; margin-bottom:8px; font-size:14px; }
    .form-group-referidos input { width:100%; padding:12px; border:2px solid #2a3a4a; border-radius:8px; background:#0a1a2a; color:white; }
    .btn-enviar-referido { background:linear-gradient(135deg,#d4af37,#f0c860); color:#0a1a2a; padding:15px 40px; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; width:100%; }
    .mensaje-exito-referido, .mensaje-error-referido { padding:15px; border-radius:10px; margin-top:20px; display:none; font-weight:600; text-align:center; }
    .mensaje-exito-referido { background:#1a4d2e; color:#4ade80; border:1px solid #4ade80; }
    .mensaje-error-referido { background:#4a1a1a; color:#ff8080; border:1px solid #ff8080; }

    /* Disclaimer */
    .disclaimer {
      background: #1a2a3a;
      border-left: 4px solid #fbbf24;
      padding: 15px 20px;
      margin: 20px 0;
      border-radius: 0 8px 8px 0;
      font-size: 0.85rem;
      color: #b8c5d6;
      font-style: italic;
    }
    .disclaimer-icon { color: #fbbf24; margin-right: 8px; }

    /* Secci√≥n mejorar cobertura */
    .mejorar-cobertura {
      background: linear-gradient(135deg, #0f2640, #1a3a5a);
      border: 2px solid #4ade80;
      border-radius: 15px;
      padding: 30px;
      margin: 30px 0;
      text-align: center;
    }
    .mejorar-titulo {
      color: #4ade80;
      font-size: 1.3rem;
      margin-bottom: 15px;
    }
    .mejorar-texto {
      color: #b8c5d6;
      font-size: 1rem;
      line-height: 1.6;
      margin-bottom: 20px;
    }
    .mejorar-input-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    .mejorar-input {
      width: 200px;
      padding: 15px;
      font-size: 1.1rem;
      border: 2px solid #4ade80;
      border-radius: 10px;
      background: #0a1a2a;
      color: white;
      text-align: center;
    }
    .mejorar-input:focus {
      outline: none;
      border-color: #d4af37;
      box-shadow: 0 0 10px rgba(212,175,55,0.3);
    }
    .btn-recalcular {
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color: #0a1a2a;
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-recalcular:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(74,222,128,0.4);
    }
    .adicional-actual {
      background: #112233;
      padding: 15px 25px;
      border-radius: 10px;
      margin: 15px 0;
      display: inline-block;
    }
    .adicional-label { color: #888; font-size: 0.9rem; }
    .adicional-valor { color: #4ade80; font-size: 1.3rem; font-weight: bold; }

    @media (max-width: 600px) {
      .plan-nombre { font-size: 1.4rem; }
      .clinicas-tabla th, .clinicas-tabla td { padding: 8px 10px; font-size: 0.85rem; }
      .mejorar-input { width: 100%; }
    }
  </style>
</head>
<body>

<header>
  <h1>Asesor√≠a en Planes de Salud Colmena</h1>
  <p class="gold">Atenci√≥n premium para clientes exigentes</p>
  <p class="small">Completa el formulario para obtener una cotizaci√≥n exacta en UF y CLP.</p>
</header>

<section id="formulario" class="card">
  <h2 class="gold">Formulario para C√°lculo del Plan</h2>

  <form id="mainForm">
    <div class="row">
      <div class="col"><input type="text" name="nombre" id="nombre" placeholder="Nombre completo" required /></div>
      <div class="col"><input type="email" name="correo" id="correo" placeholder="Correo electr√≥nico" required /></div>
    </div>

    <div class="row">
      <div class="col"><input type="tel" name="telefono" id="telefono" placeholder="Tel√©fono (ej: +56912345678)" required /></div>
      <div class="col"><input type="number" name="edad" id="edad" placeholder="Edad titular" min="18" max="99" required /></div>
    </div>

    <input type="text" name="rut" id="rut" placeholder="RUT (ej: 12.345.678-9)" required />

    <select name="isapre" id="isapre" required>
      <option value="">Isapre actual</option>
      <option>FONASA</option>
      <option>Colmena</option>
      <option>Cruz Blanca</option>
      <option>Consalud</option>
      <option>Banm√©dica</option>
      <option>Vida Tres</option>
      <option>Nueva Masvida</option>
      <option>Esencial</option>
    </select>

    <input type="number" id="renta" name="renta" placeholder="Renta imponible mensual (CLP)" required />

    <label class="small">Edad de las cargas (separadas por coma, ej: 5, 12, 30)</label>
    <textarea name="cargas" id="cargas" placeholder="Ej: 5, 12, 30" rows="2"></textarea>

    <select name="region" id="region" required>
      <option value="">Selecciona tu Regi√≥n</option>
      <option value="Arica y Parinacota">Regi√≥n de Arica y Parinacota</option>
      <option value="Tarapac√°">Regi√≥n de Tarapac√°</option>
      <option value="Antofagasta">Regi√≥n de Antofagasta</option>
      <option value="Atacama">Regi√≥n de Atacama</option>
      <option value="Coquimbo">Regi√≥n de Coquimbo</option>
      <option value="Valpara√≠so">Regi√≥n de Valpara√≠so</option>
      <option value="Metropolitana">Regi√≥n Metropolitana</option>
      <option value="O'Higgins">Regi√≥n de O'Higgins</option>
      <option value="Maule">Regi√≥n del Maule</option>
      <option value="√ëuble">Regi√≥n de √ëuble</option>
      <option value="B√≠o-B√≠o">Regi√≥n del B√≠o-B√≠o</option>
      <option value="La Araucan√≠a">Regi√≥n de La Araucan√≠a</option>
      <option value="Los R√≠os">Regi√≥n de Los R√≠os</option>
      <option value="Los Lagos">Regi√≥n de Los Lagos</option>
      <option value="Ays√©n">Regi√≥n de Ays√©n</option>
      <option value="Magallanes">Regi√≥n de Magallanes</option>
    </select>

    <textarea name="mensaje" id="mensaje" placeholder="Mensaje adicional (opcional)" rows="2"></textarea>

    <button type="submit" id="submitBtn">Cotizar Ahora</button>
    <p id="statusMsg" class="small" style="margin-top:10px;"></p>
  </form>
</section>

<section class="card">
  <h2 class="gold">UF del d√≠a</h2>
  <p class="small">UF: <span id="ufValor">cargando‚Ä¶</span> ‚Äî Fecha: <span id="ufFecha">-</span></p>
</section>

<!-- RESULTADO -->
<section id="resultado-preliminar" class="card" style="display:none">
  <div id="resultadoDetalle"></div>

  <div style="text-align:center;margin-top:30px;">
    <button id="btnAsesoria" class="btn-asesoria">üìã Solicitar Asesor√≠a Personalizada</button>
    <p class="small" style="margin-top:10px;">Se abrir√° WhatsApp para contactar a un asesor.</p>
  </div>
</section>

<!-- REFERIDOS -->
<section class="referidos-section" id="referidos" style="display:none">
  <div class="referidos-container">
    <div class="referidos-header">
      <h2>¬øQuieres que asesoremos a un amigo?</h2>
      <p>Ingresa los datos y nos comunicaremos con tu referido.</p>
    </div>

    <form id="formReferidos">
      <div class="form-section">
        <h3>üë§ Tus Datos</h3>
        <div class="form-group-referidos">
          <label for="nombreUsuario">Tu Nombre *</label>
          <input type="text" id="nombreUsuario" required>
        </div>
      </div>

      <div class="form-section">
        <h3>üéØ Datos del Referido</h3>
        <div class="form-group-referidos">
          <label>Nombre Completo *</label>
          <input type="text" id="nombreReferido" required>
        </div>
        <div class="form-group-referidos">
          <label>Tel√©fono *</label>
          <input type="tel" id="telefonoReferido" required>
        </div>
        <div class="form-group-referidos">
          <label>Correo *</label>
          <input type="email" id="correoReferido" required>
        </div>
      </div>

      <button type="submit" class="btn-enviar-referido">üì§ Enviar Referido</button>
      <div id="mensajeExitoReferido" class="mensaje-exito-referido">‚úÖ ¬°Referido Enviado!</div>
      <div id="mensajeErrorReferido" class="mensaje-error-referido">‚ùå Error al enviar.</div>
    </form>
  </div>
</section>

<a class="whatsapp" href="https://wa.me/56990701837" target="_blank">Contactar por WhatsApp</a>

<footer style="text-align:center; padding:30px; color:#666; font-size:0.85rem;">
  ¬© 2025 Colmena Golden Cross - Asesor√≠a en Planes de Salud
</footer>

<script>
/*========================================================
  CONFIGURACI√ìN
=========================================================*/
const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdWN77vgHicHHkyq8w0ogOzP5MHnlhBSLZAObDyVQo-ILw73g/formResponse';

const FORM_FIELDS = {
  nombre: 'entry.1455181501',
  rut: 'entry.1514828805',
  correo: 'entry.1253669566',
  telefono: 'entry.1927631596',
  edad: 'entry.1515225692',
  isapre: 'entry.1312575017',
  renta: 'entry.1350273122',
  region: 'entry.1283417188',
  cargas: 'entry.6457415',
  mensaje: 'entry.860152674',
  plan1: 'entry.1176082335',
  plan2: 'entry.1798986413'
};

const GOOGLE_FORM_REFERIDOS_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeIppjYB0Vgc6RsJ3AM0HcAVhLaxAT6ZZ_MxdPhmuwRkwLT-A/formResponse';

const WHATSAPP_ASESORIA = '56975356696';
const CALLMEBOT_PHONE = '56975356696';
const CALLMEBOT_APIKEY = '7360481';

// URLs de datos
const URL_PLANES = 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/main/data/planes_completos.json';
const URL_REDES = 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/main/data/redes_clinicas.json';

// Contador de rec√°lculos (m√°ximo 2)
let contadorRecalculos = 0;
const MAX_RECALCULOS = 2;

/*========================================================
  MAPEO DE REGIONES A ZONAS
=========================================================*/
const REGION_A_ZONA = {
  'Arica y Parinacota': 'NORTE',
  'Tarapac√°': 'NORTE',
  'Antofagasta': 'NORTE',
  'Atacama': 'NORTE',
  'Coquimbo': 'NORTE',
  'Valpara√≠so': 'CENTRO',
  "O'Higgins": 'CENTRO',
  'Maule': 'CENTRO',
  'Metropolitana': 'SANTIAGO',
  '√ëuble': 'SUR',
  'B√≠o-B√≠o': 'SUR',
  'La Araucan√≠a': 'SUR',
  'Los R√≠os': 'SUR',
  'Los Lagos': 'SUR',
  'Ays√©n': 'SUR',
  'Magallanes': 'SUR'
};

/*========================================================
  TABLA DE FACTORES DE EDAD CORRECTA
=========================================================*/
function obtenerFactor(edad) {
  if (edad < 2) return 0.0;      // Menores de 2 no pagan
  if (edad <= 18) return 0.6;    // 2-18 a√±os
  if (edad <= 25) return 1.0;    // 19-25 a√±os
  if (edad <= 35) return 1.2;    // 26-35 a√±os
  if (edad <= 45) return 1.3;    // 36-45 a√±os
  if (edad <= 55) return 1.5;    // 46-55 a√±os
  if (edad <= 65) return 1.8;    // 56-65 a√±os
  return 2.4;                     // 66+ a√±os
}

/*========================================================
  VARIABLES GLOBALES
=========================================================*/
let formularioDatos = {};
let ultimoResultado = null;
let PLANES = [];
let REDES_CLINICAS = {};

/*========================================================
  CARGAR DATOS
=========================================================*/
async function cargarUF() {
  try {
    const r = await fetch("https://mindicador.cl/api/");
    const j = await r.json();
    const uf = j.uf.valor;
    window.__UF_VALOR = uf;
    document.getElementById("ufValor").innerText = "$" + uf.toLocaleString("es-CL", { minimumFractionDigits: 2 });
    document.getElementById("ufFecha").innerText = new Date(j.uf.fecha).toLocaleDateString("es-CL", { year: "numeric", month: "long", day: "numeric" });
  } catch (err) {
    window.__UF_VALOR = 39700;
    document.getElementById("ufValor").innerText = "$39.700 (estimado)";
    document.getElementById("ufFecha").innerText = "No disponible";
  }
}

async function cargarPlanes() {
  try {
    const r = await fetch(URL_PLANES);
    PLANES = await r.json();
    console.log('‚úÖ Planes cargados:', PLANES.length);
  } catch (err) {
    console.error('Error cargando planes:', err);
  }
}

async function cargarRedesClincias() {
  try {
    const r = await fetch(URL_REDES);
    REDES_CLINICAS = await r.json();
    console.log('‚úÖ Redes de cl√≠nicas cargadas');
  } catch (err) {
    console.error('Error cargando redes:', err);
  }
}

/*========================================================
  FORMATEO
=========================================================*/
function formatearCLP(n) {
  return (n || 0).toLocaleString("es-CL");
}

/*========================================================
  C√ÅLCULO DEL VALOR DEL PLAN
=========================================================*/
function calcularValorPlan(pbUF, edadTitular, edadesCargas) {
  const uf = window.__UF_VALOR || 39700;
  
  // Sumar factores
  let sumaFactores = obtenerFactor(edadTitular);
  edadesCargas.forEach(e => sumaFactores += obtenerFactor(e));
  
  // Valor plan = PB * suma de factores
  const valorPlanUF = pbUF * sumaFactores;
  const valorPlanCLP = Math.round(valorPlanUF * uf);
  
  // GES: 0.77 UF por persona >= 2 a√±os
  let personasGES = edadTitular >= 2 ? 1 : 0;
  edadesCargas.forEach(e => { if (e >= 2) personasGES++; });
  const gesUF = 0.77 * personasGES;
  const gesCLP = Math.round(gesUF * uf);
  
  // Total
  const totalUF = valorPlanUF + gesUF;
  const totalCLP = valorPlanCLP + gesCLP;
  
  return { valorPlanUF, valorPlanCLP, gesUF, gesCLP, totalUF, totalCLP, sumaFactores };
}

/*========================================================
  SELECCI√ìN DE PLANES
  Regla: Plan debe ser >= 95% del 7% y el m√°s cercano
=========================================================*/
function seleccionarPlanes(sieteUF, zona, edadTitular, edadesCargas) {
  const uf = window.__UF_VALOR || 39700;
  const minimo95 = sieteUF * 0.95;
  
  // Filtrar planes de la zona (o LIBRE_ELECCION que aplica a todas)
  const planesZona = PLANES.filter(p => 
    p.zona === zona || p.zona === 'LIBRE_ELECCION'
  );
  
  console.log(`Buscando planes para zona: ${zona}, encontrados: ${planesZona.length}`);
  
  // Para cada plan, calcular su valor real seg√∫n cargas
  const planesConValor = planesZona.map(p => {
    const calc = calcularValorPlan(p.pb_uf, edadTitular, edadesCargas);
    return {
      ...p,
      valorCalculadoUF: calc.totalUF,
      valorCalculadoCLP: calc.totalCLP,
      gesUF: calc.gesUF,
      gesCLP: calc.gesCLP,
      sumaFactores: calc.sumaFactores
    };
  });
  
  // Filtrar planes >= 95% del 7%
  const planesValidos = planesConValor.filter(p => p.valorCalculadoUF >= minimo95);
  
  console.log(`Planes que cumplen >= 95% del 7% (${minimo95.toFixed(2)} UF): ${planesValidos.length}`);
  
  // Ordenar por cercan√≠a al 7%
  planesValidos.sort((a, b) => {
    const diffA = Math.abs(a.valorCalculadoUF - sieteUF);
    const diffB = Math.abs(b.valorCalculadoUF - sieteUF);
    return diffA - diffB;
  });
  
  // Tomar los 2 mejores
  const plan1 = planesValidos[0] || null;
  const plan2 = planesValidos[1] || null;
  
  if (plan1) {
    console.log(`Plan 1: ${plan1.plan} - ${plan1.valorCalculadoUF.toFixed(2)} UF`);
  }
  if (plan2) {
    console.log(`Plan 2: ${plan2.plan} - ${plan2.valorCalculadoUF.toFixed(2)} UF`);
  }
  
  return { plan1, plan2 };
}

/*========================================================
  GENERAR HTML DE UN PLAN
=========================================================*/
function generarHTMLPlan(plan, numero, sieteUF, sieteCLP, montoAdicional = 0) {
  if (!plan) return '';
  
  const uf = window.__UF_VALOR || 39700;
  const adicionalUF = Math.max(0, plan.valorCalculadoUF - sieteUF - (montoAdicional / uf));
  const adicionalCLP = Math.round(adicionalUF * uf);
  
  const esPrincipal = numero === 1;
  const badgeClass = esPrincipal ? 'principal' : 'secundario';
  const cardClass = esPrincipal ? '' : 'secundario';
  const badgeText = esPrincipal ? '‚ú® PLAN RECOMENDADO 1' : 'üî∑ PLAN RECOMENDADO 2';
  
  // Hospitalizaci√≥n/coberturas
  let coberturasHTML = '';
  if (plan.hospitalizacion) {
    coberturasHTML = `
      <div class="coberturas-section">
        <div class="coberturas-title">üìä Cobertura Hospitalaria</div>
        <div class="coberturas-texto">${plan.hospitalizacion.replace(/\\n/g, '<br>')}</div>
      </div>
    `;
  }
  
  // Cl√≠nicas si tiene coberturas_redes
  let clinicasHTML = '';
  if (plan.coberturas_redes && Object.keys(REDES_CLINICAS).length > 0) {
    clinicasHTML = generarHTMLClinicas(plan, numero);
  }
  
  return `
    <div class="plan-card ${cardClass}">
      <span class="plan-badge ${badgeClass}">${badgeText}</span>
      
      <div class="plan-nombre-container">
        <span class="plan-nombre-estrella">‚òÖ</span>
        <span class="plan-nombre">${plan.plan}</span>
        <span class="plan-nombre-estrella">‚òÖ</span>
      </div>
      
      <div class="plan-info">
        <div class="plan-info-item">
          <div class="plan-info-label">Valor del Plan</div>
          <div class="plan-info-value">$${formatearCLP(plan.valorCalculadoCLP)}</div>
          <div class="small">${plan.valorCalculadoUF.toFixed(2)} UF</div>
        </div>
        <div class="plan-info-item">
          <div class="plan-info-label">Adicional a pagar</div>
          <div class="plan-info-value ${adicionalCLP <= 0 ? 'verde' : 'amarillo'}">$${formatearCLP(Math.max(0, adicionalCLP))}</div>
        </div>
        <div class="plan-info-item">
          <div class="plan-info-label">GES incluido</div>
          <div class="plan-info-value verde">$${formatearCLP(plan.gesCLP)}</div>
          <div class="small">${plan.gesUF.toFixed(2)} UF</div>
        </div>
        <div class="plan-info-item">
          <div class="plan-info-label">Tope anual</div>
          <div class="plan-info-value">${formatearCLP(plan.tope_anual_uf || 7000)} UF</div>
        </div>
      </div>
      
      ${coberturasHTML}
      ${clinicasHTML}
    </div>
  `;
}

/*========================================================
  GENERAR HTML DE CL√çNICAS CON TABS
=========================================================*/
function generarHTMLClinicas(plan, numeroPlan) {
  if (!plan.coberturas_redes) return '';
  
  const grupos = Object.keys(plan.coberturas_redes).sort();
  const planId = `plan${numeroPlan}`;
  
  // Tabs
  let tabsHTML = grupos.map((g, i) => {
    const activeClass = i === 0 ? 'active' : '';
    const cobertura = plan.coberturas_redes[g];
    return `<button type="button" class="grupo-tab ${activeClass}" onclick="mostrarGrupo('${planId}', '${g}')">${g} (${cobertura}%)</button>`;
  }).join('');
  
  // Contenido de cada grupo
  let contenidoHTML = grupos.map((g, i) => {
    const activeClass = i === 0 ? 'active' : '';
    const clinicas = REDES_CLINICAS[g] || [];
    
    let filas = clinicas.map(c => 
      `<tr><td>${c.nombre}</td><td>${c.ciudad}</td></tr>`
    ).join('');
    
    return `
      <div id="${planId}-${g}" class="grupo-content ${activeClass}">
        <table class="clinicas-tabla">
          <thead>
            <tr><th>Nombre Prestador</th><th>Ciudad</th></tr>
          </thead>
          <tbody>${filas}</tbody>
        </table>
      </div>
    `;
  }).join('');
  
  return `
    <div class="clinicas-section">
      <div class="clinicas-title">üè® Red de Cl√≠nicas</div>
      <div class="grupos-tabs">${tabsHTML}</div>
      ${contenidoHTML}
    </div>
  `;
}

function mostrarGrupo(planId, grupo) {
  // Ocultar todos los contenidos de este plan
  document.querySelectorAll(`[id^="${planId}-"]`).forEach(el => {
    el.classList.remove('active');
  });
  
  // Desactivar todos los tabs del plan
  const grupoContent = document.getElementById(`${planId}-${grupo}`);
  if (grupoContent) {
    const planCard = grupoContent.closest('.plan-card');
    if (planCard) {
      planCard.querySelectorAll('.grupo-tab').forEach(tab => tab.classList.remove('active'));
      
      // Activar el tab correspondiente
      planCard.querySelectorAll('.grupo-tab').forEach(tab => {
        if (tab.textContent.startsWith(grupo)) {
          tab.classList.add('active');
        }
      });
    }
  }
  
  // Activar el seleccionado
  document.getElementById(`${planId}-${grupo}`).classList.add('active');
}

/*========================================================
  CALLMEBOT
=========================================================*/
async function enviarCallMeBot(mensaje) {
  if (!CALLMEBOT_APIKEY) return;
  try {
    const url = `https://api.callmebot.com/whatsapp.php?phone=${CALLMEBOT_PHONE}&text=${encodeURIComponent(mensaje)}&apikey=${CALLMEBOT_APIKEY}`;
    await fetch(url, { mode: 'no-cors' });
    console.log('‚úÖ CallMeBot enviado');
  } catch (err) {
    console.error('Error CallMeBot:', err);
  }
}

/*========================================================
  FORMULARIO PRINCIPAL
=========================================================*/
document.getElementById("mainForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const btn = document.getElementById("submitBtn");
  const statusMsg = document.getElementById("statusMsg");
  
  btn.disabled = true;
  btn.textContent = "Calculando...";
  statusMsg.textContent = "";
  
  // Resetear contador de rec√°lculos para nueva cotizaci√≥n
  contadorRecalculos = 0;

  const data = new FormData(this);

  formularioDatos = {
    nombre: data.get("nombre"),
    correo: data.get("correo"),
    telefono: data.get("telefono"),
    edad: data.get("edad"),
    rut: data.get("rut"),
    isapre: data.get("isapre"),
    renta: data.get("renta"),
    cargas: data.get("cargas"),
    region: data.get("region"),
    mensaje: data.get("mensaje")
  };

  const uf = window.__UF_VALOR || 39700;
  const renta = Number(formularioDatos.renta);
  const edadTitular = Number(formularioDatos.edad);
  
  // Parsear cargas
  const cargasTexto = (formularioDatos.cargas || "").replace(/\n/g, ", ").trim();
  const edadesCargas = cargasTexto.split(/[\n,;]+/).map(s => s.trim()).filter(Boolean).map(Number).filter(n => !isNaN(n));
  
  // Calcular 7%
  const sieteCLP = Math.round(renta * 0.07);
  const sieteUF = sieteCLP / uf;
  
  // Determinar zona seg√∫n regi√≥n
  const zona = REGION_A_ZONA[formularioDatos.region] || 'SANTIAGO';
  
  console.log(`Regi√≥n: ${formularioDatos.region} ‚Üí Zona: ${zona}`);
  console.log(`7%: $${formatearCLP(sieteCLP)} (${sieteUF.toFixed(2)} UF)`);
  console.log(`Factor titular (${edadTitular} a√±os): ${obtenerFactor(edadTitular)}`);
  
  // Seleccionar planes
  const { plan1, plan2 } = seleccionarPlanes(sieteUF, zona, edadTitular, edadesCargas);
  
  // Guardar resultado
  ultimoResultado = {
    sieteCLP, sieteUF, edadesCargas, cargasTexto, zona, plan1, plan2
  };

  // ENVIAR A GOOGLE FORMS
  console.log("Enviando a Google Forms...");
  try {
    const plan1Nombre = plan1 ? plan1.plan : 'Sin plan disponible';
    const plan2Nombre = plan2 ? plan2.plan : 'Sin plan disponible';
    
    const params = new URLSearchParams();
    params.append(FORM_FIELDS.nombre, formularioDatos.nombre);
    params.append(FORM_FIELDS.rut, formularioDatos.rut);
    params.append(FORM_FIELDS.correo, formularioDatos.correo);
    params.append(FORM_FIELDS.telefono, formularioDatos.telefono);
    params.append(FORM_FIELDS.edad, formularioDatos.edad);
    params.append(FORM_FIELDS.isapre, formularioDatos.isapre);
    params.append(FORM_FIELDS.renta, formularioDatos.renta);
    params.append(FORM_FIELDS.region, formularioDatos.region);
    params.append(FORM_FIELDS.cargas, cargasTexto);
    params.append(FORM_FIELDS.mensaje, formularioDatos.mensaje || "(sin mensaje)");
    params.append(FORM_FIELDS.plan1, plan1Nombre);
    params.append(FORM_FIELDS.plan2, plan2Nombre);

    fetch(FORM_BASE_URL, { 
      method: "POST", 
      mode: "no-cors", 
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: params.toString()
    }).catch(() => {});

    console.log("‚úÖ Google Forms enviado");
    statusMsg.textContent = "‚úÖ Datos enviados correctamente";
    statusMsg.className = "small success-msg";
  } catch (err) {
    console.error("Error preparando Google Forms:", err);
    statusMsg.textContent = "‚ö†Ô∏è Error al enviar";
    statusMsg.className = "small error-msg";
  }

  // ENVIAR CALLMEBOT
  console.log("Enviando CallMeBot...");
  const msgWA = `üîî NUEVA COTIZACI√ìN

üë§ ${formularioDatos.nombre}
üìû ${formularioDatos.telefono}
üìç ${formularioDatos.region} (${zona})
üí∞ Renta: $${formatearCLP(renta)}
üë• Cargas: ${edadesCargas.length}

üìä 7%: $${formatearCLP(sieteCLP)} (${sieteUF.toFixed(2)} UF)

üìã Planes sugeridos:
1) ${plan1 ? plan1.plan : 'Sin plan'}
2) ${plan2 ? plan2.plan : 'Sin plan'}`;
  
  enviarCallMeBot(msgWA);

  // MOSTRAR RESULTADO
  let htmlResultado = `
    <div class="resumen-cotizacion">
      <div class="resumen-titulo">üìä Tu Cotizaci√≥n - ${formularioDatos.nombre}</div>
      <div class="resumen-grid">
        <div class="resumen-item">
          <div class="resumen-label">Tu 7% obligatorio</div>
          <div class="resumen-value destacado">$${formatearCLP(sieteCLP)}</div>
          <div class="resumen-uf">${sieteUF.toFixed(2)} UF</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Cargas</div>
          <div class="resumen-value">${edadesCargas.length}</div>
          <div class="resumen-uf">${edadesCargas.length > 0 ? '(' + edadesCargas.join(', ') + ' a√±os)' : 'Sin cargas'}</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Zona</div>
          <div class="resumen-value" style="font-size:0.95rem;">${zona}</div>
          <div class="resumen-uf">${formularioDatos.region}</div>
        </div>
      </div>
    </div>
    
    <h2 class="gold" style="margin-top:30px;">üè• Planes Recomendados</h2>
    <p class="small">Basado en tu 7% ($${formatearCLP(sieteCLP)}), te sugerimos estos planes:</p>
  `;
  
  if (plan1) {
    htmlResultado += generarHTMLPlan(plan1, 1, sieteUF, sieteCLP, 0);
  } else {
    htmlResultado += `<p class="small" style="color:#fbbf24;">No se encontr√≥ un plan que cumpla con el criterio para tu 7%. Solicita asesor√≠a personalizada.</p>`;
  }
  
  if (plan2) {
    htmlResultado += generarHTMLPlan(plan2, 2, sieteUF, sieteCLP, 0);
  }

  // Agregar disclaimer despu√©s de los planes
  htmlResultado += `
    <div class="disclaimer">
      <span class="disclaimer-icon">‚ö†Ô∏è</span>
      Los valores presentados son referenciales y est√°n sujetos a verificaci√≥n. Un Ejecutivo de Ventas validar√° esta informaci√≥n y te contactar√° para formalizar tu plan de salud.
    </div>
  `;

  // Agregar secci√≥n para mejorar cobertura
  htmlResultado += `
    <div class="mejorar-cobertura">
      <div class="mejorar-titulo">üí° ¬øTe gustar√≠a acceder a mejores coberturas?</div>
      <div class="mejorar-texto">
        Puedes complementar tu 7% legal con un aporte adicional mensual para obtener planes con mayores beneficios, mejor red de cl√≠nicas y mayor protecci√≥n para ti y tu familia.
      </div>
      
      <div class="adicional-actual">
        <div class="adicional-label">Tu presupuesto actual (7%)</div>
        <div class="adicional-valor">$${formatearCLP(sieteCLP)}</div>
      </div>
      
      <div class="mejorar-input-container">
        <div>
          <label class="small" style="display:block; margin-bottom:5px; color:#ccc;">Monto adicional mensual:</label>
          <input type="number" id="montoAdicional" class="mejorar-input" placeholder="Ej: 50000" min="0" step="1000">
        </div>
        <button type="button" id="btnRecalcular" class="btn-recalcular">üîÑ Recalcular Planes</button>
      </div>
      <p class="small" style="margin-top:15px; color:#888;">Ingresa un monto en pesos chilenos para ver planes con mejores coberturas.</p>
    </div>
  `;

  document.getElementById("resultadoDetalle").innerHTML = htmlResultado;
  document.getElementById("resultado-preliminar").style.display = "block";

  // Agregar evento al bot√≥n recalcular
  document.getElementById("btnRecalcular").addEventListener("click", recalcularConAdicional);

  btn.disabled = false;
  btn.textContent = "Cotizar Ahora";

  setTimeout(() => {
    document.getElementById("resultado-preliminar").scrollIntoView({ behavior: "smooth" });
  }, 300);
});

/*========================================================
  RECALCULAR CON MONTO ADICIONAL (m√°ximo 2 veces)
=========================================================*/
function recalcularConAdicional() {
  try {
    const montoAdicionalInput = document.getElementById("montoAdicional");
    if (!montoAdicionalInput) {
      console.error("No se encontr√≥ el input de monto adicional");
      return;
    }
    
    const montoAdicional = parseInt(montoAdicionalInput.value) || 0;
    
    if (montoAdicional <= 0) {
      alert("Por favor ingresa un monto adicional mayor a 0");
      return;
    }

    if (!ultimoResultado) {
      alert("Primero realiza una cotizaci√≥n");
      return;
    }

    // Incrementar contador
    contadorRecalculos++;
    console.log(`Rec√°lculo #${contadorRecalculos}`);
    
    const uf = window.__UF_VALOR || 39700;
    const r = ultimoResultado;
  
  // Nuevo presupuesto total = 7% + adicional
  const nuevoPresupuestoCLP = r.sieteCLP + montoAdicional;
  const nuevoPresupuestoUF = nuevoPresupuestoCLP / uf;
  
  console.log(`Rec√°lculo #${contadorRecalculos} con adicional: $${montoAdicional}`);
  console.log(`Nuevo presupuesto: $${nuevoPresupuestoCLP} (${nuevoPresupuestoUF.toFixed(2)} UF)`);
  
  // Seleccionar nuevos planes con el presupuesto aumentado
  const nuevosPlanes = seleccionarPlanesConPresupuesto(nuevoPresupuestoUF, r.zona, r.edadesCargas.length + 1);
  
  const plan1 = nuevosPlanes.plan1;
  const plan2 = nuevosPlanes.plan2;
  
  // Actualizar ultimoResultado
  ultimoResultado.plan1 = plan1;
  ultimoResultado.plan2 = plan2;
  ultimoResultado.montoAdicional = montoAdicional;
  ultimoResultado.presupuestoTotalCLP = nuevoPresupuestoCLP;
  ultimoResultado.presupuestoTotalUF = nuevoPresupuestoUF;

  // Generar nuevo HTML
  let htmlResultado = `
    <div class="resumen-cotizacion">
      <div class="resumen-titulo">üìä Tu Cotizaci√≥n Mejorada - ${formularioDatos.nombre}</div>
      <div class="resumen-grid">
        <div class="resumen-item">
          <div class="resumen-label">Tu 7% obligatorio</div>
          <div class="resumen-value">$${formatearCLP(r.sieteCLP)}</div>
          <div class="resumen-uf">${r.sieteUF.toFixed(2)} UF</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Aporte adicional</div>
          <div class="resumen-value" style="color:#4ade80;">+$${formatearCLP(montoAdicional)}</div>
          <div class="resumen-uf">+${(montoAdicional / uf).toFixed(2)} UF</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Presupuesto Total</div>
          <div class="resumen-value destacado">$${formatearCLP(nuevoPresupuestoCLP)}</div>
          <div class="resumen-uf">${nuevoPresupuestoUF.toFixed(2)} UF</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Zona</div>
          <div class="resumen-value" style="font-size:0.95rem;">${r.zona}</div>
          <div class="resumen-uf">${formularioDatos.region}</div>
        </div>
      </div>
    </div>
    
    <h2 class="gold" style="margin-top:30px;">üè• Nuevos Planes con Mayor Cobertura</h2>
    <p class="small">Con tu presupuesto mejorado de $${formatearCLP(nuevoPresupuestoCLP)}, ahora puedes acceder a estos planes:</p>
  `;
  
  if (plan1) {
    htmlResultado += generarHTMLPlan(plan1, 1, nuevoPresupuestoUF, nuevoPresupuestoCLP, montoAdicional);
  } else {
    htmlResultado += `<p class="small" style="color:#fbbf24;">No se encontr√≥ un plan adicional. Solicita asesor√≠a personalizada.</p>`;
  }
  
  if (plan2) {
    htmlResultado += generarHTMLPlan(plan2, 2, nuevoPresupuestoUF, nuevoPresupuestoCLP, montoAdicional);
  }

  // Disclaimer
  htmlResultado += `
    <div class="disclaimer">
      <span class="disclaimer-icon">‚ö†Ô∏è</span>
      Los valores presentados son referenciales y est√°n sujetos a verificaci√≥n. Un Ejecutivo de Ventas validar√° esta informaci√≥n y te contactar√° para formalizar tu plan de salud.
    </div>
  `;

  // Verificar si puede seguir recalculando
  if (contadorRecalculos < MAX_RECALCULOS) {
    // A√∫n puede recalcular
    const recalculosRestantes = MAX_RECALCULOS - contadorRecalculos;
    htmlResultado += `
      <div class="mejorar-cobertura">
        <div class="mejorar-titulo">üîÑ ¬øDeseas ajustar tu aporte adicional?</div>
        <p class="small" style="color:#fbbf24; margin-bottom:15px;">Te queda ${recalculosRestantes} ajuste${recalculosRestantes > 1 ? 's' : ''} disponible${recalculosRestantes > 1 ? 's' : ''}</p>
        <div class="adicional-actual">
          <div class="adicional-label">Aporte adicional actual</div>
          <div class="adicional-valor">$${formatearCLP(montoAdicional)}</div>
        </div>
        
        <div class="mejorar-input-container">
          <div>
            <label class="small" style="display:block; margin-bottom:5px; color:#ccc;">Nuevo monto adicional:</label>
            <input type="number" id="montoAdicional" class="mejorar-input" placeholder="Ej: 50000" min="0" step="1000" value="${montoAdicional}">
          </div>
          <button type="button" id="btnRecalcular" class="btn-recalcular">üîÑ Recalcular Planes</button>
        </div>
      </div>
    `;
  } else {
    // Ya no puede recalcular - mostrar mensaje final
    htmlResultado += `
      <div class="mejorar-cobertura" style="border-color: #d4af37;">
        <div class="mejorar-titulo" style="color:#d4af37;">‚úÖ Has revisado tus opciones de cobertura</div>
        <p class="mejorar-texto">
          Ya exploraste diferentes alternativas. Ahora puedes solicitar asesor√≠a personalizada para finalizar tu afiliaci√≥n, 
          o si conoces a alguien que necesite un plan de salud, ¬°puedes referirlo!
        </p>
        <div class="adicional-actual">
          <div class="adicional-label">Tu presupuesto final</div>
          <div class="adicional-valor">$${formatearCLP(nuevoPresupuestoCLP)}</div>
        </div>
      </div>
    `;
  }

  document.getElementById("resultadoDetalle").innerHTML = htmlResultado;
  
  // Re-agregar evento al nuevo bot√≥n si existe
  const btnRecalcular = document.getElementById("btnRecalcular");
  if (btnRecalcular) {
    btnRecalcular.addEventListener("click", recalcularConAdicional);
  }

  // Scroll al resultado
  document.getElementById("resultado-preliminar").scrollIntoView({ behavior: "smooth" });
  
  } catch (error) {
    console.error("Error en recalcularConAdicional:", error);
    alert("Ocurri√≥ un error al recalcular. Por favor intenta de nuevo.");
  }
}

/*========================================================
  SELECCIONAR PLANES CON PRESUPUESTO PERSONALIZADO
=========================================================*/
function seleccionarPlanesConPresupuesto(presupuestoUF, zona, numPersonas) {
  const uf = window.__UF_VALOR || 39700;
  const edadTitular = Number(formularioDatos.edad);
  
  // Asegurar que edadesCargas sea un array
  let edadesCargas = ultimoResultado.edadesCargas;
  if (!Array.isArray(edadesCargas)) {
    edadesCargas = [];
  }
  
  // Filtrar por zona
  const planesZona = PLANES.filter(p => p.zona === zona || p.zona === 'LIBRE_ELECCION');
  
  console.log(`Buscando planes para zona ${zona}, presupuesto ${presupuestoUF.toFixed(2)} UF`);
  
  // Calcular valor para cada plan
  const planesConValor = planesZona.map(plan => {
    const calc = calcularValorPlan(plan.pb_uf, edadTitular, edadesCargas);
    return {
      ...plan,
      valorCalculadoUF: calc.totalUF,
      valorCalculadoCLP: calc.totalCLP,
      gesUF: calc.gesUF,
      gesCLP: calc.gesCLP,
      sumaFactores: calc.sumaFactores
    };
  });
  
  // Filtrar planes que est√©n dentro del presupuesto (hasta 110% del presupuesto)
  const maxPresupuesto = presupuestoUF * 1.10;
  const minPresupuesto = presupuestoUF * 0.90;
  const planesValidos = planesConValor.filter(p => p.valorCalculadoUF <= maxPresupuesto && p.valorCalculadoUF >= minPresupuesto);
  
  console.log(`Planes v√°lidos para presupuesto ${presupuestoUF.toFixed(2)} UF (rango ${minPresupuesto.toFixed(2)}-${maxPresupuesto.toFixed(2)}): ${planesValidos.length}`);
  
  // Si no hay planes en el rango, buscar los m√°s cercanos
  if (planesValidos.length === 0) {
    const planesOrdenados = planesConValor.filter(p => p.valorCalculadoUF <= maxPresupuesto);
    planesOrdenados.sort((a, b) => b.valorCalculadoUF - a.valorCalculadoUF);
    return { plan1: planesOrdenados[0] || null, plan2: planesOrdenados[1] || null };
  }
  
  // Ordenar por valor descendente (mejores planes primero, m√°s cercanos al presupuesto)
  planesValidos.sort((a, b) => b.valorCalculadoUF - a.valorCalculadoUF);
  
  // Tomar los 2 mejores
  const plan1 = planesValidos[0] || null;
  const plan2 = planesValidos[1] || null;
  
  if (plan1) console.log(`Nuevo Plan 1: ${plan1.plan} - ${plan1.valorCalculadoUF.toFixed(2)} UF`);
  if (plan2) console.log(`Nuevo Plan 2: ${plan2.plan} - ${plan2.valorCalculadoUF.toFixed(2)} UF`);
  
  return { plan1, plan2 };
}

/*========================================================
  BOT√ìN ASESOR√çA
=========================================================*/
document.getElementById("btnAsesoria").addEventListener("click", function() {
  if (!formularioDatos || !formularioDatos.nombre) {
    alert("Primero completa y env√≠a la cotizaci√≥n.");
    return;
  }

  const r = ultimoResultado;
  const plan1Nombre = r.plan1 ? r.plan1.plan : '-';
  const plan2Nombre = r.plan2 ? r.plan2.plan : '-';
  const plan1Valor = r.plan1 ? `$${formatearCLP(r.plan1.valorCalculadoCLP)} (${r.plan1.valorCalculadoUF.toFixed(2)} UF)` : '-';
  const plan2Valor = r.plan2 ? `$${formatearCLP(r.plan2.valorCalculadoCLP)} (${r.plan2.valorCalculadoUF.toFixed(2)} UF)` : '-';
  
  // Verificar si hay monto adicional
  const tieneAdicional = r.montoAdicional && r.montoAdicional > 0;
  const textoAdicional = tieneAdicional 
    ? `‚Ä¢ Aporte adicional: $${formatearCLP(r.montoAdicional)}
‚Ä¢ Presupuesto total: $${formatearCLP(r.presupuestoTotalCLP)} (${r.presupuestoTotalUF.toFixed(2)} UF)`
    : '';

  const mensaje = `üîî SOLICITUD DE ASESOR√çA

üë§ Datos del cliente:
‚Ä¢ Nombre: ${formularioDatos.nombre}
‚Ä¢ RUT: ${formularioDatos.rut}
‚Ä¢ Tel√©fono: ${formularioDatos.telefono}
‚Ä¢ Edad: ${formularioDatos.edad} a√±os
‚Ä¢ Isapre actual: ${formularioDatos.isapre}
‚Ä¢ Regi√≥n: ${formularioDatos.region} (${r.zona})
‚Ä¢ Renta: $${formatearCLP(Number(formularioDatos.renta))}
‚Ä¢ Cargas: ${r.edadesCargas.length}${r.cargasTexto ? ' (' + r.cargasTexto + ')' : ''}

üí∞ Cotizaci√≥n:
‚Ä¢ Tu 7%: $${formatearCLP(r.sieteCLP)} (${r.sieteUF.toFixed(2)} UF)
${textoAdicional}

üìã Planes sugeridos:
1) ${plan1Nombre} ‚Üí ${plan1Valor}
2) ${plan2Nombre} ‚Üí ${plan2Valor}

‚ö° SOLICITA CONTACTO URGENTE`;

  // Enviar por CallMeBot directamente
  enviarCallMeBot(mensaje);
  
  // Mostrar confirmaci√≥n
  alert("‚úÖ Solicitud enviada. Un asesor te contactar√° a la brevedad.");

  document.getElementById("referidos").style.display = "block";
  setTimeout(() => {
    document.getElementById("referidos").scrollIntoView({ behavior: "smooth" });
  }, 400);
});

/*========================================================
  REFERIDOS
=========================================================*/
document.getElementById("formReferidos").addEventListener("submit", async function(e) {
  e.preventDefault();

  const nombreUsuario = document.getElementById("nombreUsuario").value;
  const nombreReferido = document.getElementById("nombreReferido").value;
  const telefonoReferido = document.getElementById("telefonoReferido").value;
  const correoReferido = document.getElementById("correoReferido").value;

  const f = new FormData();
  f.append("entry.1664559901", nombreUsuario);
  f.append("entry.715463265", nombreReferido);
  f.append("entry.1382714918", telefonoReferido);
  f.append("entry.897178414", correoReferido);
  f.append("entry.178502788", "Referido enviado desde landing");

  try {
    await fetch(GOOGLE_FORM_REFERIDOS_URL, { method: "POST", mode: "no-cors", body: f });
    document.getElementById("mensajeExitoReferido").style.display = "block";
    document.getElementById("mensajeErrorReferido").style.display = "none";

    const msgRef = `üéØ NUEVO REFERIDO

Referido por: ${nombreUsuario}
Nombre: ${nombreReferido}
Tel: ${telefonoReferido}
Correo: ${correoReferido}`;
    enviarCallMeBot(msgRef);

    // Reset
    setTimeout(() => {
      document.getElementById("mainForm").reset();
      formularioDatos = {};
      ultimoResultado = null;
      contadorRecalculos = 0; // Resetear contador de rec√°lculos
      document.getElementById("resultado-preliminar").style.display = "none";
      document.getElementById("referidos").style.display = "none";
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 2000);

  } catch (err) {
    document.getElementById("mensajeErrorReferido").style.display = "block";
    document.getElementById("mensajeExitoReferido").style.display = "none";
  }
});

/*========================================================
  INICIO
=========================================================*/
window.addEventListener("load", () => {
  cargarUF();
  cargarPlanes();
  cargarRedesClincias();
});
</script>

</body>
</html>
