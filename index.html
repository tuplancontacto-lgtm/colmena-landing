<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planes de Salud Colmena - Asesor√≠a Profesional</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #0a1a2a; color: white; margin: 0; padding: 0; }
    header { background: linear-gradient(90deg, #0a1a2a, #12375a); padding: 40px; text-align: center; }
    h1 { color: #d4af37; font-size: 2.5rem; margin: 0; }
    h2 { color: #d4af37; }
    section { padding: 40px 20px; max-width: 900px; margin: auto; }
    .gold { color: #d4af37; }
    .card { background: #112233; border: 1px solid #d4af37; padding: 20px; border-radius: 15px; margin-bottom: 25px; }
    button { background: #d4af37; color: #0a1a2a; padding: 15px 25px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; }
    button:hover { opacity: 0.85; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    form input, form select, form textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; }
    .whatsapp { display: block; background: #25D366; text-align: center; padding: 15px; color: white; text-decoration: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 20px; max-width: 300px; margin-left: auto; margin-right: auto; }
    .small { font-size: 0.9rem; color: #ccc; }
    .row { display:flex; gap:16px; flex-wrap: wrap; }
    .col { flex:1; min-width: 200px; }
    .uf-note { font-size:0.9rem; color:#cfcfcf; }
    .error-msg { color: #ff8080; margin-top: 12px; }
    .success-msg { color: #4ade80; margin-top: 12px; font-weight: bold; }
    
    /* Planes recomendados */
    .plan-card { background: #1a2a3a; border: 2px solid #3a5a7a; padding: 20px; border-radius: 12px; margin: 15px 0; }
    .plan-card.recomendado { border-color: #d4af37; background: #1f3345; }
    .plan-nombre { font-size: 1.2rem; font-weight: bold; color: #d4af37; margin-bottom: 10px; }
    .plan-detalle { font-size: 0.95rem; line-height: 1.6; color: #ddd; }
    
    /* Bot√≥n asesor√≠a */
    .btn-asesoria { display: inline-block; background: linear-gradient(135deg, #d4af37, #f0c860); color: #0a1a2a; padding: 18px 40px; text-decoration: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 15px rgba(212,175,55,0.4); transition: all .3s ease; border: none; cursor: pointer; }
    .btn-asesoria:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,175,55,0.6); }

    /* Referidos */
    .referidos-section { background: linear-gradient(135deg,#0f2640 0%,#1a3a5a 100%); padding:60px 20px; margin:40px 0; }
    .referidos-container { max-width:800px; margin:0 auto; background:#112233; padding:40px; border-radius:20px; border:1px solid #d4af37; }
    .referidos-header { text-align:center; margin-bottom:30px; }
    .referidos-header h2 { color:#d4af37; font-size:28px; margin-bottom:15px; }
    .referidos-header p { color:#b8c5d6; font-size:16px; }
    .form-section { background:#1a2a3a; padding:25px; border-radius:15px; border-left:4px solid #d4af37; margin-bottom: 20px; }
    .form-section h3 { color:#d4af37; font-size:18px; margin-bottom:15px; margin-top: 0; }
    .form-group-referidos { margin-bottom: 15px; }
    .form-group-referidos label { display:block; color:#b8c5d6; margin-bottom:8px; font-size:14px; }
    .form-group-referidos input { width:100%; padding:12px; border:2px solid #2a3a4a; border-radius:8px; background:#0a1a2a; color:white; }
    .btn-enviar-referido { background:linear-gradient(135deg,#d4af37,#f0c860); color:#0a1a2a; padding:15px 40px; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; width:100%; }
    .mensaje-exito-referido, .mensaje-error-referido { padding:15px; border-radius:10px; margin-top:20px; display:none; font-weight:600; text-align:center; }
    .mensaje-exito-referido { background:#1a4d2e; color:#4ade80; border:1px solid #4ade80; }
    .mensaje-error-referido { background:#4a1a1a; color:#ff8080; border:1px solid #ff8080; }
    
    /* Tabla resumen compacta */
    .tabla-resumen { width: 100%; max-width: 400px; border-collapse: collapse; margin: 15px 0; }
    .tabla-resumen td { padding: 8px 12px; border-bottom: 1px solid #2a3a4a; }
    .tabla-resumen td:first-child { color: #aaa; width: 50%; }
    .tabla-resumen td:last-child { color: #fff; font-weight: bold; }
  </style>
</head>
<body>

<header>
  <h1>Asesor√≠a en Planes de Salud Colmena</h1>
  <p class="gold">Atenci√≥n premium para clientes exigentes</p>
  <p class="small">Completa el formulario para obtener una cotizaci√≥n exacta en UF y CLP.</p>
</header>

<section id="formulario" class="card">
  <h2 class="gold">Formulario para C√°lculo del Plan</h2>

  <form id="mainForm">
    <div class="row">
      <div class="col"><input type="text" name="nombre" id="nombre" placeholder="Nombre completo" required /></div>
      <div class="col"><input type="email" name="correo" id="correo" placeholder="Correo electr√≥nico" required /></div>
    </div>

    <div class="row">
      <div class="col"><input type="tel" name="telefono" id="telefono" placeholder="Tel√©fono (ej: +56912345678)" required /></div>
      <div class="col"><input type="number" name="edad" id="edad" placeholder="Edad titular" min="18" max="99" required /></div>
    </div>

    <input type="text" name="rut" id="rut" placeholder="RUT (ej: 12.345.678-9)" required />

    <select name="isapre" id="isapre" required>
      <option value="">Isapre actual</option>
      <option>FONASA</option>
      <option>Colmena</option>
      <option>Cruz Blanca</option>
      <option>Consalud</option>
      <option>Banm√©dica</option>
      <option>Vida Tres</option>
      <option>Nueva Masvida</option>
      <option>Esencial</option>
    </select>

    <input type="number" id="renta" name="renta" placeholder="Renta imponible mensual (CLP)" required />

    <label class="small">Edad de las cargas (separadas por coma, ej: 5, 12, 30)</label>
    <textarea name="cargas" id="cargas" placeholder="Ej: 5, 12, 30" rows="2"></textarea>

    <select name="region" id="region" required>
      <option value="">Selecciona tu Regi√≥n</option>
      <option>Regi√≥n de Arica y Parinacota</option>
      <option>Regi√≥n de Tarapac√°</option>
      <option>Regi√≥n de Antofagasta</option>
      <option>Regi√≥n de Atacama</option>
      <option>Regi√≥n de Coquimbo</option>
      <option>Regi√≥n de Valpara√≠so</option>
      <option>Regi√≥n Metropolitana</option>
      <option>Regi√≥n de O'Higgins</option>
      <option>Regi√≥n del Maule</option>
      <option>Regi√≥n de √ëuble</option>
      <option>Regi√≥n del B√≠o-B√≠o</option>
      <option>Regi√≥n de La Araucan√≠a</option>
      <option>Regi√≥n de Los R√≠os</option>
      <option>Regi√≥n de Los Lagos</option>
      <option>Regi√≥n de Ays√©n</option>
      <option>Regi√≥n de Magallanes</option>
    </select>

    <textarea name="mensaje" id="mensaje" placeholder="Mensaje adicional (opcional)" rows="2"></textarea>

    <button type="submit" id="submitBtn">Cotizar Ahora</button>
    <p id="statusMsg" class="small" style="margin-top:10px;"></p>
  </form>
</section>

<section class="card">
  <h2 class="gold">UF del d√≠a</h2>
  <p class="uf-note">UF: <span id="ufValor">cargando‚Ä¶</span> ‚Äî Fecha: <span id="ufFecha">-</span></p>
</section>

<!-- RESULTADO PRELIMINAR -->
<section id="resultado-preliminar" class="card" style="display:none">
  <h2 class="gold">Resultado preliminar</h2>
  <div id="resultadoDetalle" style="line-height:1.7"></div>

  <div style="text-align:center;margin-top:30px;">
    <button id="btnAsesoria" class="btn-asesoria">üìã Solicitar Asesor√≠a Personalizada</button>
    <p class="small" style="margin-top:10px;">Se abrir√° WhatsApp para contactar a un asesor.</p>
  </div>
</section>

<!-- REFERIDOS -->
<section class="referidos-section" id="referidos" style="display:none">
  <div class="referidos-container">
    <div class="referidos-header">
      <h2>¬øQuieres que asesoremos a un amigo?</h2>
      <p>Ingresa los datos y nos comunicaremos con tu referido.</p>
    </div>

    <form id="formReferidos">
      <div class="form-section">
        <h3>üë§ Tus Datos</h3>
        <div class="form-group-referidos">
          <label for="nombreUsuario">Tu Nombre *</label>
          <input type="text" id="nombreUsuario" required>
        </div>
      </div>

      <div class="form-section">
        <h3>üéØ Datos del Referido</h3>
        <div class="form-group-referidos">
          <label>Nombre Completo *</label>
          <input type="text" id="nombreReferido" required>
        </div>
        <div class="form-group-referidos">
          <label>Tel√©fono *</label>
          <input type="tel" id="telefonoReferido" required>
        </div>
        <div class="form-group-referidos">
          <label>Correo *</label>
          <input type="email" id="correoReferido" required>
        </div>
      </div>

      <button type="submit" class="btn-enviar-referido">üì§ Enviar Referido</button>

      <div id="mensajeExitoReferido" class="mensaje-exito-referido">‚úÖ ¬°Referido Enviado!</div>
      <div id="mensajeErrorReferido" class="mensaje-error-referido">‚ùå Error al enviar. Intenta nuevamente.</div>
    </form>
  </div>
</section>

<!-- RESUMEN FINAL -->
<section id="resumen-final" class="card" style="display:none">
  <h2 class="gold">‚úÖ Resumen de tus Solicitudes</h2>
  <div id="resumenContenido" style="line-height:1.8"></div>
</section>

<a class="whatsapp" href="https://wa.me/56990701837" target="_blank">Contactar por WhatsApp</a>

<footer style="text-align:center; padding:30px; color:#666; font-size:0.85rem;">
  ¬© 2025 Colmena Golden Cross - Asesor√≠a en Planes de Salud
</footer>

<script>
/*========================================================
  CONFIGURACI√ìN - ACTUALIZA ESTOS VALORES
=========================================================*/

// URL del Google Form (formResponse)
const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdWN77vgHicHHkyq8w0ogOzP5MHnlhBSLZAObDyVQo-ILw73g/formResponse';

// IDs de los campos del formulario - VERIFICA QUE COINCIDAN CON TU GOOGLE FORM
const FORM_FIELDS = {
  nombre:   'entry.1455181501',
  rut:      'entry.1514828805',
  correo:   'entry.1253669566',
  telefono: 'entry.1927631596',
  edad:     'entry.1515225692',
  isapre:   'entry.1312575017',
  renta:    'entry.1350273122',
  region:   'entry.1283417188',
  cargas:   'entry.6457415',
  mensaje:  'entry.860152674',
  plan1:    'entry.1234567890',  // Ajustar si existe
  plan2:    'entry.0987654321'   // Ajustar si existe
};

// URL del Google Form de Referidos
const GOOGLE_FORM_REFERIDOS_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeIppjYB0Vgc6RsJ3AM0HcAVhLaxAT6ZZ_MxdPhmuwRkwLT-A/formResponse';

// N√∫mero de WhatsApp para asesor√≠a (sin +)
const WHATSAPP_ASESORIA = '56975356696';

// CallMeBot - Tu API Key
const CALLMEBOT_PHONE = '56975356696';
const CALLMEBOT_APIKEY = '7360481';

/*========================================================
  VARIABLES GLOBALES
=========================================================*/
let formularioDatos = {};
let ultimoResultado = null;
let PLANES_TOP = { REGIONALES: [], SANTIAGO: [] };

const URL_TEXTOS_TOP = 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/refs/heads/main/data/textos_comerciales_top_planes.json';

/*========================================================
  CARGAR UF
=========================================================*/
async function cargarUF() {
  try {
    const r = await fetch("https://mindicador.cl/api/");
    const j = await r.json();
    const uf = j.uf.valor;
    window.__UF_VALOR = uf;
    document.getElementById("ufValor").innerText = "$" + uf.toLocaleString("es-CL", { minimumFractionDigits: 2 });
    document.getElementById("ufFecha").innerText = new Date(j.uf.fecha).toLocaleDateString("es-CL", { year: "numeric", month: "long", day: "numeric" });
  } catch (err) {
    document.getElementById("ufValor").innerText = "$39.000 (estimado)";
    document.getElementById("ufFecha").innerText = "No disponible";
    window.__UF_VALOR = 39000;
  }
}

/*========================================================
  CARGAR DATOS DE PLANES
=========================================================*/
async function cargarDataPlanes() {
  try {
    const rTop = await fetch(URL_TEXTOS_TOP);
    const dataTop = await rTop.json();
    PLANES_TOP = { REGIONALES: [], SANTIAGO: [] };
    dataTop.forEach(p => {
      if (!PLANES_TOP[p.segmento]) PLANES_TOP[p.segmento] = [];
      PLANES_TOP[p.segmento].push(p);
    });
    console.log('‚úÖ Textos comerciales cargados', PLANES_TOP);
  } catch (err) {
    console.error('Error cargando textos comerciales', err);
  }
}

function obtenerTopPlanesPorRegion(regionTexto) {
  let segmento = 'REGIONALES';
  if (regionTexto && regionTexto.toLowerCase().includes('metropolitana')) {
    segmento = 'SANTIAGO';
  }
  const arr = PLANES_TOP[segmento] || [];
  return {
    segmento,
    planes: arr,
    plan1: arr[0] || null,
    plan2: arr[1] || null
  };
}

/*========================================================
  C√ÅLCULOS
=========================================================*/
function obtenerFactor(e) {
  if (e <= 18) return 0.6;
  if (e <= 35) return 1.0;
  if (e <= 45) return 1.5;
  if (e <= 59) return 2.0;
  return 2.4;
}

function formatearCLP(n) {
  return (n || 0).toLocaleString("es-CL");
}

function calcularCotizacion(obj) {
  const personasTotales = 1 + obj.edadesCargas.length;
  let sumaFactores = obtenerFactor(obj.edadTitular);
  obj.edadesCargas.forEach(e => sumaFactores += obtenerFactor(e));

  const costoFactorizado = obj.valorBasePlan * sumaFactores;
  const uf = window.__UF_VALOR || 39000;

  const valorGesUF = 0.77;
  const valorGesCLP = valorGesUF * uf;

  let personasQuePaganGES = 1;
  obj.edadesCargas.forEach(e => { if (e >= 2) personasQuePaganGES++; });

  const totalGes = Math.round(valorGesCLP * personasQuePaganGES);
  const valorFinal = Math.round(costoFactorizado + totalGes);
  const siete = Math.round(obj.renta * 0.07);
  const adicional = Math.max(0, valorFinal - siete);
  const valorFinalUF = valorFinal / uf;

  return { personas: personasTotales, personasQuePaganGES, costoFactorizado, totalGes, valorFinal, siete, adicional, valorFinalUF };
}

/*========================================================
  ENVIAR NOTIFICACI√ìN CALLMEBOT (WHATSAPP)
=========================================================*/
async function enviarCallMeBot(mensaje) {
  if (!CALLMEBOT_APIKEY || CALLMEBOT_APIKEY === 'TU_API_KEY_AQUI') {
    console.log('CallMeBot no configurado');
    return;
  }
  try {
    const url = `https://api.callmebot.com/whatsapp.php?phone=${CALLMEBOT_PHONE}&text=${encodeURIComponent(mensaje)}&apikey=${CALLMEBOT_APIKEY}`;
    await fetch(url, { mode: 'no-cors' });
    console.log('‚úÖ Notificaci√≥n WhatsApp enviada');
  } catch (err) {
    console.error('Error CallMeBot:', err);
  }
}

/*========================================================
  FORMULARIO PRINCIPAL - COTIZAR AHORA
=========================================================*/
document.getElementById("mainForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const btn = document.getElementById("submitBtn");
  const statusMsg = document.getElementById("statusMsg");
  
  btn.disabled = true;
  btn.textContent = "Enviando...";
  statusMsg.textContent = "";
  statusMsg.className = "small";

  const data = new FormData(this);

  formularioDatos = {
    nombre: data.get("nombre"),
    correo: data.get("correo"),
    telefono: data.get("telefono"),
    edad: data.get("edad"),
    rut: data.get("rut"),
    isapre: data.get("isapre"),
    renta: data.get("renta"),
    cargas: data.get("cargas"),
    region: data.get("region"),
    mensaje: data.get("mensaje")
  };

  // Normalizar cargas
  const cargasTexto = (formularioDatos.cargas || "").replace(/\n/g, ", ").trim();
  const edadesCargas = cargasTexto.split(/[\n,;]+/).map(s => s.trim()).filter(Boolean).map(Number).filter(n => !isNaN(n));

  // Calcular cotizaci√≥n
  const r = calcularCotizacion({
    renta: Number(formularioDatos.renta),
    edadTitular: Number(formularioDatos.edad),
    edadesCargas,
    valorBasePlan: 35000
  });

  // Obtener planes recomendados
  const { segmento, plan1, plan2 } = obtenerTopPlanesPorRegion(formularioDatos.region);
  const nombrePlan1 = plan1 ? plan1.plan_individual : "Plan Premium Colmena";
  const nombrePlan2 = plan2 ? plan2.plan_individual : "Plan Plus Colmena";

  ultimoResultado = { ...r, nCargas: edadesCargas.length, cargasTexto, edadesCargas, segmento, nombrePlan1, nombrePlan2 };

  // ENVIAR A GOOGLE FORMS
  try {
    const f = new FormData();
    f.append(FORM_FIELDS.nombre, formularioDatos.nombre);
    f.append(FORM_FIELDS.rut, formularioDatos.rut);
    f.append(FORM_FIELDS.correo, formularioDatos.correo);
    f.append(FORM_FIELDS.telefono, formularioDatos.telefono);
    f.append(FORM_FIELDS.edad, formularioDatos.edad);
    f.append(FORM_FIELDS.isapre, formularioDatos.isapre);
    f.append(FORM_FIELDS.renta, formularioDatos.renta);
    f.append(FORM_FIELDS.region, formularioDatos.region);
    f.append(FORM_FIELDS.cargas, cargasTexto);
    f.append(FORM_FIELDS.mensaje, formularioDatos.mensaje || "(sin mensaje)");

    await fetch(FORM_BASE_URL, { method: "POST", mode: "no-cors", body: f });
    console.log('‚úÖ Datos enviados a Google Forms');
    
    statusMsg.textContent = "‚úÖ Datos enviados correctamente";
    statusMsg.className = "small success-msg";
  } catch (err) {
    console.error('Error enviando a Google Forms:', err);
    statusMsg.textContent = "‚ö†Ô∏è Error al enviar, pero puedes continuar";
    statusMsg.className = "small error-msg";
  }

  // ENVIAR NOTIFICACI√ìN CALLMEBOT
  const mensajeWA = `üîî NUEVA COTIZACI√ìN\n\nNombre: ${formularioDatos.nombre}\nTel√©fono: ${formularioDatos.telefono}\nEdad: ${formularioDatos.edad}\nRenta: $${formatearCLP(Number(formularioDatos.renta))}\nRegi√≥n: ${formularioDatos.region}\nCargas: ${edadesCargas.length}\n\nValor estimado: ${r.valorFinalUF.toFixed(2)} UF ($${formatearCLP(r.valorFinal)})`;
  enviarCallMeBot(mensajeWA);

  // MOSTRAR RESULTADO
  const htmlResultado = `
    <h3 style="color:#d4af37; margin-top:0;">Cotizaci√≥n Personalizada ‚Äì Colmena</h3>
    <p>Hola <strong>${formularioDatos.nombre}</strong>, revis√© tus datos y prepar√© una propuesta ideal seg√∫n tu renta, cargas y edad.</p>
    
    <h4 style="color:#d4af37;">üîπ Resultado de tu cotizaci√≥n</h4>
    <table class="tabla-resumen">
      <tr><td>Valor final estimado:</td><td>${r.valorFinalUF.toFixed(2)} UF</td></tr>
      <tr><td>Total en pesos:</td><td>$${formatearCLP(r.valorFinal)}</td></tr>
      <tr><td>7% de tu renta:</td><td>$${formatearCLP(r.siete)}</td></tr>
      <tr><td>Adicional sobre el 7%:</td><td>$${formatearCLP(r.adicional)}</td></tr>
      <tr><td>Cargas consideradas:</td><td>${edadesCargas.length}${edadesCargas.length > 0 ? ' (' + edadesCargas.join(', ') + ' a√±os)' : ''}</td></tr>
    </table>
    
    <hr style="margin:25px 0; border-color:#d4af37;">
    
    <h4 style="color:#d4af37;">üè• Planes Recomendados - Segmento ${segmento}</h4>
    <p class="small">A continuaci√≥n se muestran dos planes sugeridos. El detalle final se confirma con un Asesor.</p>
    
    <div class="plan-card recomendado">
      <div class="plan-nombre">‚ú® ${nombrePlan1}</div>
      <div class="plan-detalle">${plan1 ? formatearTextoComercial(plan1.texto_comercial) : 'Plan premium con cobertura completa en cl√≠nicas de primera categor√≠a.'}</div>
    </div>
    
    <div class="plan-card">
      <div class="plan-nombre">üî∑ ${nombrePlan2}</div>
      <div class="plan-detalle">${plan2 ? formatearTextoComercial(plan2.texto_comercial) : 'Plan con excelente relaci√≥n precio-cobertura.'}</div>
    </div>
    
    <div style="background:#1a3a2a; padding:15px; border-radius:10px; text-align:center; margin-top:20px;">
      <p style="margin:0; color:#4ade80;">
        <strong>üìã Estos planes son sugerencias basadas en tu perfil.</strong><br>
        <span class="small">Solicita asesor√≠a para confirmar el mejor plan para ti.</span>
      </p>
    </div>
  `;

  document.getElementById("resultadoDetalle").innerHTML = htmlResultado;
  document.getElementById("resultado-preliminar").style.display = "block";

  btn.disabled = false;
  btn.textContent = "Cotizar Ahora";

  setTimeout(() => {
    document.getElementById("resultado-preliminar").scrollIntoView({ behavior: "smooth" });
  }, 300);
});

/*========================================================
  FORMATEAR TEXTO COMERCIAL (RESUMIDO)
=========================================================*/
function formatearTextoComercial(texto) {
  if (!texto) return '';
  
  // Limitar el texto a las primeras l√≠neas importantes
  const lineas = texto.split('\n').filter(l => l.trim());
  const resumen = [];
  
  for (let i = 0; i < Math.min(lineas.length, 5); i++) {
    let linea = lineas[i].trim();
    // Si la l√≠nea es muy larga (lista de cl√≠nicas), resumirla
    if (linea.length > 200 && linea.includes('Cl√≠nica')) {
      const match = linea.match(/Red de Cl√≠nicas (G\d+)/);
      if (match) {
        resumen.push(`‚Ä¢ ${match[0]}: Amplia red de cl√≠nicas con 100% de cobertura`);
      }
    } else if (linea.length < 200) {
      resumen.push(linea);
    }
  }
  
  return resumen.join('<br>');
}

/*========================================================
  BOT√ìN SOLICITAR ASESOR√çA
=========================================================*/
document.getElementById("btnAsesoria").addEventListener("click", function() {
  if (!formularioDatos || !formularioDatos.nombre) {
    alert("Primero completa y env√≠a la cotizaci√≥n.");
    return;
  }

  const nombre = formularioDatos.nombre || "";
  const rut = formularioDatos.rut || "";
  const edad = formularioDatos.edad || "";
  const isapre = formularioDatos.isapre || "";
  const region = formularioDatos.region || "";
  const renta = Number(formularioDatos.renta) || 0;
  const cargasTexto = ultimoResultado?.cargasTexto || "";
  const nCargas = ultimoResultado?.nCargas ?? 0;

  const valorUF = ultimoResultado ? ultimoResultado.valorFinalUF.toFixed(2) : "";
  const valorPesos = ultimoResultado ? formatearCLP(ultimoResultado.valorFinal) : "";
  const adicional = ultimoResultado ? formatearCLP(ultimoResultado.adicional) : "";
  const siete = ultimoResultado ? formatearCLP(ultimoResultado.siete) : "";

  const nombrePlan1 = ultimoResultado?.nombrePlan1 || "";
  const nombrePlan2 = ultimoResultado?.nombrePlan2 || "";

  const mensaje = 
    "üîî SOLICITUD DE ASESOR√çA\n\n" +
    "üë§ Datos del cliente:\n" +
    `‚Ä¢ Nombre: ${nombre}\n` +
    `‚Ä¢ RUT: ${rut}\n` +
    `‚Ä¢ Edad: ${edad} a√±os\n` +
    `‚Ä¢ Isapre actual: ${isapre}\n` +
    `‚Ä¢ Regi√≥n: ${region}\n` +
    `‚Ä¢ Renta: $${formatearCLP(renta)}\n` +
    `‚Ä¢ Cargas: ${nCargas}${cargasTexto ? " (" + cargasTexto + ")" : ""}\n\n` +
    "üí∞ Cotizaci√≥n estimada:\n" +
    `‚Ä¢ Valor: ${valorUF} UF ($${valorPesos})\n` +
    `‚Ä¢ 7% renta: $${siete}\n` +
    `‚Ä¢ Adicional: $${adicional}\n\n` +
    "üìã Planes sugeridos:\n" +
    `1) ${nombrePlan1}\n` +
    `2) ${nombrePlan2}\n\n` +
    "‚ö° Solicita contacto urgente.";

  const url = `https://wa.me/${WHATSAPP_ASESORIA}?text=${encodeURIComponent(mensaje)}`;
  window.open(url, "_blank");

  // Mostrar secci√≥n de referidos
  document.getElementById("referidos").style.display = "block";
  setTimeout(() => {
    document.getElementById("referidos").scrollIntoView({ behavior: "smooth" });
  }, 400);
});

/*========================================================
  REFERIDOS
=========================================================*/
document.getElementById("formReferidos").addEventListener("submit", async function(e) {
  e.preventDefault();

  const nombreUsuario = document.getElementById("nombreUsuario").value;
  const nombreReferido = document.getElementById("nombreReferido").value;
  const telefonoReferido = document.getElementById("telefonoReferido").value;
  const correoReferido = document.getElementById("correoReferido").value;

  const f = new FormData();
  f.append("entry.1664559901", nombreUsuario);
  f.append("entry.715463265", nombreReferido);
  f.append("entry.1382714918", telefonoReferido);
  f.append("entry.897178414", correoReferido);
  f.append("entry.178502788", "Referido enviado desde landing");

  try {
    await fetch(GOOGLE_FORM_REFERIDOS_URL, { method: "POST", mode: "no-cors", body: f });
    document.getElementById("mensajeExitoReferido").style.display = "block";
    document.getElementById("mensajeErrorReferido").style.display = "none";

    // Notificaci√≥n CallMeBot del referido
    const msgRef = `üéØ NUEVO REFERIDO\n\nReferido por: ${nombreUsuario}\nNombre: ${nombreReferido}\nTel: ${telefonoReferido}\nCorreo: ${correoReferido}`;
    enviarCallMeBot(msgRef);

    mostrarResumenFinal(nombreUsuario, nombreReferido, telefonoReferido, correoReferido);

    // Reset
    document.getElementById("mainForm").reset();
    formularioDatos = {};
    ultimoResultado = null;
    document.getElementById("resultado-preliminar").style.display = "none";

    setTimeout(() => {
      document.getElementById("resumen-final").scrollIntoView({ behavior: "smooth" });
    }, 500);

  } catch (err) {
    console.error("Error enviando referido", err);
    document.getElementById("mensajeErrorReferido").style.display = "block";
    document.getElementById("mensajeExitoReferido").style.display = "none";
  }
});

/*========================================================
  RESUMEN FINAL
=========================================================*/
function mostrarResumenFinal(nombreUsuario, nombreReferido, telefonoReferido, correoReferido) {
  const html = `
    <div style="background:#1a2a3a;padding:25px;border-radius:15px;margin-bottom:20px;">
      <h3 style="color:#d4af37;margin-top:0;">üìã Solicitud de Asesor√≠a</h3>
      <p><strong>Estado:</strong> <span style="color:#4ade80;">‚úÖ Enviada correctamente</span></p>
      <p class="small">Un asesor te contactar√° pronto.</p>
    </div>

    <div style="background:#1a2a3a;padding:25px;border-radius:15px;">
      <h3 style="color:#d4af37;margin-top:0;">üéØ Referido Enviado</h3>
      <p><strong>Referido por:</strong> ${nombreUsuario}</p>
      <p><strong>Nombre:</strong> ${nombreReferido}</p>
      <p><strong>Tel√©fono:</strong> ${telefonoReferido}</p>
      <p><strong>Correo:</strong> ${correoReferido}</p>
      <p style="color:#4ade80;font-weight:bold;margin-top:15px;">‚úÖ Datos enviados</p>
    </div>

    <div style="text-align:center;margin-top:30px;padding:20px;background:#0f2640;border-radius:10px;">
      <p style="font-size:1.1rem;color:#d4af37;margin:0;">
        ¬°Gracias por tu confianza! Te contactaremos pronto.
      </p>
      <button onclick="location.reload()" style="margin-top:15px;">Nueva Cotizaci√≥n</button>
    </div>
  `;

  document.getElementById("resumenContenido").innerHTML = html;
  document.getElementById("resumen-final").style.display = "block";
}

/*========================================================
  INICIO
=========================================================*/
window.addEventListener("load", () => {
  cargarUF();
  cargarDataPlanes();
});
</script>

</body>
</html>
