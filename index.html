<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planes de Salud Colmena - Asesor√≠a Profesional</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #0a1a2a; color: white; margin: 0; padding: 0; }
    header { background: linear-gradient(90deg, #0a1a2a, #12375a); padding: 40px; text-align: center; }
    h1 { color: #d4af37; font-size: 2.5rem; margin: 0; }
    section { padding: 40px 20px; max-width: 900px; margin: auto; }
    .gold { color: #d4af37; }
    .card { background: #112233; border: 1px solid #d4af37; padding: 20px; border-radius: 15px; margin-bottom: 25px; }
    button { background: #d4af37; color: #0a1a2a; padding: 15px 25px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; }
    button:hover { opacity: 0.85; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    form input, form select, form textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; box-sizing: border-box; }
    .whatsapp { display: block; background: #25D366; text-align: center; padding: 15px; color: white; text-decoration: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 20px; max-width: 300px; margin-left: auto; margin-right: auto; }
    .small { font-size: 0.9rem; color: #ccc; }
    .row { display:flex; gap:16px; flex-wrap: wrap; }
    .col { flex:1; min-width: 200px; }
    .uf-note { font-size:0.9rem; color:#cfcfcf; }
    .error-msg { color: #ff8080; margin-top: 12px; }
    .success-msg { color: #d4af37; margin-top: 12px; }
    .btn-asesoria { display: inline-block; background: linear-gradient(135deg, #d4af37, #f0c860); color: #0a1a2a; padding: 18px 40px; text-decoration: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4); transition: all 0.3s ease; border: none; cursor: pointer; }
    .btn-asesoria:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212, 175, 55, 0.6); }

    /* ========================================= */
    /* NUEVOS ESTILOS PARA SECCI√ìN DE REFERIDOS */
    /* ========================================= */
    .referidos-section {
      background: linear-gradient(135deg, #0f2640 0%, #1a3a5a 100%);
      padding: 60px 20px;
      margin: 40px 0;
    }

    .referidos-container {
      max-width: 800px;
      margin: 0 auto;
      background: #112233;
      padding: 40px;
      border-radius: 20px;
      border: 1px solid #d4af37;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .referidos-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .referidos-header h2 {
      color: #d4af37;
      font-size: 32px;
      margin-bottom: 15px;
      font-weight: 700;
    }

    .referidos-header p {
      color: #b8c5d6;
      font-size: 18px;
      line-height: 1.6;
    }

    .referidos-form {
      display: grid;
      gap: 20px;
    }

    .form-section {
      background: #1a2a3a;
      padding: 25px;
      border-radius: 15px;
      border-left: 4px solid #d4af37;
    }

    .form-section h3 {
      color: #d4af37;
      font-size: 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group-referidos {
      margin-bottom: 15px;
    }

    .form-group-referidos label {
      display: block;
      color: #b8c5d6;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group-referidos input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #2a3a4a;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      box-sizing: border-box;
      background: #0a1a2a;
      color: white;
    }

    .form-group-referidos input:focus {
      outline: none;
      border-color: #d4af37;
      box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
    }

    .btn-enviar-referido {
      background: linear-gradient(135deg, #d4af37 0%, #f0c860 100%);
      color: #0a1a2a;
      padding: 15px 40px;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
      width: 100%;
      margin-top: 20px;
    }

    .btn-enviar-referido:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(212, 175, 55, 0.5);
      opacity: 1;
    }

    .btn-enviar-referido:active {
      transform: translateY(0);
    }

    .btn-enviar-referido:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .mensaje-exito-referido {
      background: #1a4d2e;
      color: #4ade80;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      display: none;
      text-align: center;
      font-weight: 600;
      border: 1px solid #4ade80;
    }

    .mensaje-error-referido {
      background: #4a1a1a;
      color: #ff8080;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      display: none;
      text-align: center;
      font-weight: 600;
      border: 1px solid #ff8080;
    }
  </style>
</head>
<body>
  <header>
    <h1>Asesor√≠a en Planes de Salud Colmena</h1>
    <p class="gold">Atenci√≥n premium para clientes exigentes</p>
    <p class="small">Completa el formulario para obtener una cotizaci√≥n exacta en UF y CLP.</p>
  </header>

  <section id="formulario" class="card">
    <h2 class="gold">Formulario para C√°lculo del Plan</h2>

    <form id="mainForm">
      <div class="row">
        <div class="col"><input type="text" name="nombre" id="nombre" placeholder="Nombre completo" required /></div>
        <div class="col"><input type="email" name="correo" id="correo" placeholder="Correo electr√≥nico" required /></div>
      </div>

      <div class="row">
        <div class="col"><input type="tel" name="telefono" id="telefono" placeholder="Tel√©fono" required /></div>
        <div class="col"><input type="number" name="edad" id="edad" placeholder="Edad titular" required /></div>
      </div>

      <input type="text" name="rut" id="rut" placeholder="RUT" required />

      <select name="isapre" id="isapre" required>
        <option value="">Isapre actual</option>
        <option>FONASA</option>
        <option>Colmena</option>
        <option>Cruz Blanca</option>
        <option>Consalud</option>
        <option>Banm√©dica</option>
        <option>Vida Tres</option>
      </select>

      <input type="number" id="renta" name="renta" placeholder="Renta imponible mensual (CLP)" required />

      <label class="small">Edad de las cargas (una por l√≠nea)</label>
      <textarea name="cargas" id="cargas" placeholder="Ej: 5&#10;12&#10;30"></textarea>

      <select name="region" id="region" required>
        <option value="">Selecciona tu Regi√≥n</option>
        <option>Regi√≥n de Arica y Parinacota</option>
        <option>Regi√≥n de Tarapac√°</option>
        <option>Regi√≥n de Antofagasta</option>
        <option>Regi√≥n de Atacama</option>
        <option>Regi√≥n de Coquimbo</option>
        <option>Regi√≥n de Valpara√≠so</option>
        <option>Regi√≥n Metropolitana</option>
        <option>Regi√≥n de O'Higgins</option>
        <option>Regi√≥n del Maule</option>
        <option>Regi√≥n del √ëuble</option>
        <option>Regi√≥n del B√≠o-B√≠o</option>
        <option>Regi√≥n de La Araucan√≠a</option>
        <option>Regi√≥n de Los R√≠os</option>
        <option>Regi√≥n de Los Lagos</option>
        <option>Regi√≥n de Ays√©n</option>
        <option>Regi√≥n de Magallanes</option>
      </select>

      <textarea name="mensaje" id="mensaje" placeholder="Mensaje adicional (opcional)"></textarea>

      <button type="submit" id="submitBtn">Cotizar Ahora</button>
    </form>
  </section>

  <section class="card">
    <h2 class="gold">UF del d√≠a</h2>
    <p class="uf-note">UF: <span id="ufValor">cargando‚Ä¶</span> ‚Äî Fecha: <span id="ufFecha">-</span></p>
  </section>

  <section id="resultado-preliminar" class="card" style="display:none">
    <h2 class="gold">Resultado preliminar</h2>
    <div id="resultadoDetalle" style="line-height:1.7"></div>
    
    <div style="text-align: center; margin-top: 30px;">
      <button id="btnAsesoria" class="btn-asesoria">
        üìã Solicitar Asesor√≠a Personalizada
      </button>
      <p style="margin-top: 15px; font-size: 0.9rem; color: #ccc;">
        Tus datos ya estar√°n pre-cargados en el formulario
      </p>
    </div>
  </section>

  <!-- ========================================= -->
  <!-- NUEVA SECCI√ìN DE REFERIDOS -->
  <!-- ========================================= -->
  <section class="referidos-section" id="referidos">
    <div class="referidos-container">
      <div class="referidos-header">
        <h2>¬øQuieres que asesoremos a un amigo, familiar o colega?</h2>
        <p>Comparte los beneficios de nuestros planes de salud. Ingresa los datos y nos comunicaremos con tu referido.</p>
      </div>

      <form id="formReferidos" class="referidos-form">
        <!-- Datos del Usuario que Refiere -->
        <div class="form-section">
          <h3>üë§ Tus Datos</h3>
          
          <div class="form-group-referidos">
            <label for="nombreUsuario">Tu Nombre Completo *</label>
            <input type="text" id="nombreUsuario" name="nombreUsuario" required 
                   placeholder="Ej: Mar√≠a Gonz√°lez">
          </div>
        </div>

        <!-- Datos del Referido -->
        <div class="form-section">
          <h3>üéØ Datos de tu Referido</h3>
          
          <div class="form-group-referidos">
            <label for="nombreReferido">Nombre Completo del Referido *</label>
            <input type="text" id="nombreReferido" name="nombreReferido" required 
                   placeholder="Ej: Juan P√©rez">
          </div>

          <div class="form-group-referidos">
            <label for="telefonoReferido">Tel√©fono del Referido *</label>
            <input type="tel" id="telefonoReferido" name="telefonoReferido" required 
                   placeholder="Ej: +56912345678" pattern="[0-9+]{8,15}">
          </div>

          <div class="form-group-referidos">
            <label for="correoReferido">Correo Electr√≥nico del Referido *</label>
            <input type="email" id="correoReferido" name="correoReferido" required 
                   placeholder="Ej: juan.perez@email.com">
          </div>
        </div>

        <button type="submit" class="btn-enviar-referido">
          üì§ Enviar Referencia
        </button>

        <div class="mensaje-exito-referido" id="mensajeExitoReferido">
          ‚úÖ ¬°Referencia enviada exitosamente! Nos comunicaremos pronto con tu referido.
        </div>

        <div class="mensaje-error-referido" id="mensajeErrorReferido">
          ‚ùå Hubo un error al enviar la referencia. Por favor, intenta nuevamente.
        </div>
      </form>
    </div>
  </section>
  <!-- ========================================= -->
  <!-- FIN SECCI√ìN DE REFERIDOS -->
  <!-- ========================================= -->

  <a class="whatsapp" href="https://wa.me/56990701837" target="_blank">Contactar por WhatsApp</a>

  <script>
    const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdWN77vgHicHHkyq8w0ogOzP5MHnlhBSLZAObDyVQo-ILw73g/viewform';
    
    // IDs de los campos del Google Form
    const FORM_FIELDS = {
      nombre: 'entry.1455181501',
      correo: 'entry.1253669566',
      telefono: 'entry.1927631596',
      edad: 'entry.1515225692',
      rut: 'entry.852144857',
      isapre: 'entry.1312575017',
      renta: 'entry.1350273122',
      region: 'entry.1283417188',
      cargas: 'entry.6457415'
    };

    let formularioDatos = {};

    async function cargarUF() {
      try {
        const res = await fetch('https://mindicador.cl/api');
        const data = await res.json();
        const uf = data.uf.valor;
        window.__UF_VALOR = uf;
        document.getElementById('ufValor').innerText = '$' + uf.toLocaleString('es-CL', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
        document.getElementById('ufFecha').innerText = new Date(data.uf.fecha).toLocaleDateString('es-CL', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        console.log('‚úÖ UF cargada:', uf);
      } catch (e) {
        const ufDefault = 38000;
        window.__UF_VALOR = ufDefault;
        document.getElementById('ufValor').innerText = '$' + ufDefault.toLocaleString('es-CL') + ' (estimado)';
        document.getElementById('ufFecha').innerText = 'No disponible';
        console.log('‚ö†Ô∏è Usando UF por defecto');
      }
    }

    function obtenerFactor(edad) {
      if (edad <= 18) return 0.6;
      if (edad <= 35) return 1.0;
      if (edad <= 45) return 1.5;
      if (edad <= 59) return 2.0;
      return 2.4;
    }

    function formatearCLP(n) {
      return n.toLocaleString("es-CL");
    }

    function calcularCotizacion(obj) {
      const personas = 1 + obj.edadesCargas.length;
      let sumaFactores = obtenerFactor(obj.edadTitular);
      obj.edadesCargas.forEach(e => sumaFactores += obtenerFactor(e));
      const costoFactorizado = obj.valorBasePlan * sumaFactores;
      const uf = window.__UF_VALOR || 38000;
      const valorGesCLP = 0.93 * uf;
      const totalGes = Math.round(valorGesCLP * personas);
      const valorFinal = Math.round(costoFactorizado + totalGes);
      const siete = Math.round(obj.renta * 0.07);
      const adicional = Math.max(0, valorFinal - siete);
      const valorFinalUF = uf ? valorFinal / uf : null;
      return { personas, costoFactorizado, totalGes, valorFinal, siete, adicional, valorFinalUF };
    }

    function construirURLPreLlenada() {
      const params = new URLSearchParams();
      
      if (formularioDatos.nombre) params.append(FORM_FIELDS.nombre, formularioDatos.nombre);
      if (formularioDatos.correo) params.append(FORM_FIELDS.correo, formularioDatos.correo);
      if (formularioDatos.telefono) params.append(FORM_FIELDS.telefono, formularioDatos.telefono);
      if (formularioDatos.edad) params.append(FORM_FIELDS.edad, formularioDatos.edad);
      if (formularioDatos.rut) params.append(FORM_FIELDS.rut, formularioDatos.rut);
      if (formularioDatos.isapre) params.append(FORM_FIELDS.isapre, formularioDatos.isapre);
      if (formularioDatos.renta) params.append(FORM_FIELDS.renta, formularioDatos.renta);
      if (formularioDatos.region) params.append(FORM_FIELDS.region, formularioDatos.region);
      if (formularioDatos.cargas) params.append(FORM_FIELDS.cargas, formularioDatos.cargas);
      
      return `${FORM_BASE_URL}?${params.toString()}`;
    }

    document.getElementById('mainForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      console.log('üì§ Formulario enviado');
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = "Calculando...";

      const formData = new FormData(this);
      
      // Guardar datos del formulario
      formularioDatos = {
        nombre: formData.get("nombre"),
        correo: formData.get("correo"),
        telefono: formData.get("telefono"),
        edad: formData.get("edad"),
        rut: formData.get("rut"),
        isapre: formData.get("isapre"),
        renta: formData.get("renta"),
        cargas: formData.get("cargas"),
        region: formData.get("region"),
        mensaje: formData.get("mensaje")
      };
      
      const edadesCargas = (formData.get("cargas") || "")
        .split(/\n/).map(s => s.trim()).filter(s => s !== "").map(s => parseInt(s));

      const resultado = calcularCotizacion({
        renta: Number(formData.get("renta")),
        edadTitular: Number(formData.get("edad")),
        edadesCargas,
        valorBasePlan: 35000,
        valorGesUF: 0.93
      });

      console.log('üí∞ C√°lculos:', resultado);

      // Mostrar resultado
      const div = document.getElementById("resultadoDetalle");
      div.innerHTML = `
        <p><strong>Personas en plan:</strong> ${resultado.personas}</p>
        <p><strong>Costo base ajustado:</strong> $${formatearCLP(resultado.costoFactorizado)}</p>
        <p><strong>GES total:</strong> $${formatearCLP(resultado.totalGes)}</p>
        <p><strong>Valor final:</strong> $${formatearCLP(resultado.valorFinal)}</p>
        <p><strong>Valor final UF:</strong> ${resultado.valorFinalUF?.toFixed(3) ?? 'N/D'} UF</p>
        <p><strong>7% renta:</strong> $${formatearCLP(resultado.siete)}</p>
        <p><strong>Adicional:</strong> $${formatearCLP(resultado.adicional)}</p>
      `;
      document.getElementById("resultado-preliminar").style.display = "block";

      submitBtn.disabled = false;
      submitBtn.textContent = "Cotizar Ahora";
    });

    // Bot√≥n para abrir formulario pre-llenado
    document.getElementById('btnAsesoria').addEventListener('click', function() {
      const url = construirURLPreLlenada();
      console.log('üîó Abriendo formulario pre-llenado:', url);
      window.open(url, '_blank');
    });

    // ========================================
    // SISTEMA DE REFERIDOS
    // ========================================

    // URL del Google Form de Referidos (YA CONFIGURADA)
    const GOOGLE_FORM_REFERIDOS_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeIppjYB0Vgc6RsJ3AM0HcAVhLaxAT6ZZ_MxdPhmuwRkwLT-A/formResponse';

    // IDs de los campos del Google Form de Referidos (YA CONFIGURADOS)
    const FORM_REFERIDOS_FIELDS = {
      nombreUsuario: 'entry.1664559901',
      nombreReferido: 'entry.715463265',
      telefonoReferido: 'entry.1382714918',
      correoReferido: 'entry.897178414',
      mensaje: 'entry.178502788'
    };

    // Manejar env√≠o del formulario de referidos
    document.getElementById('formReferidos').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      console.log('üì§ Formulario de referidos enviado');
      
      const nombreUsuario = document.getElementById('nombreUsuario').value;
      const nombreReferido = document.getElementById('nombreReferido').value;
      const telefonoReferido = document.getElementById('telefonoReferido').value;
      const correoReferido = document.getElementById('correoReferido').value;
      
      // Ocultar mensajes previos
      document.getElementById('mensajeExitoReferido').style.display = 'none';
      document.getElementById('mensajeErrorReferido').style.display = 'none';
      
      // Deshabilitar bot√≥n mientras se env√≠a
      const btnEnviar = document.querySelector('.btn-enviar-referido');
      btnEnviar.disabled = true;
      btnEnviar.textContent = '‚è≥ Enviando...';
      
      try {
        // Enviar a Google Forms
        await enviarReferidoAGoogleForm(nombreUsuario, nombreReferido, telefonoReferido, correoReferido);
        
        // Mostrar mensaje de √©xito
        document.getElementById('mensajeExitoReferido').style.display = 'block';
        
        // Limpiar formulario
        document.getElementById('formReferidos').reset();
        
        // Scroll al mensaje de √©xito
        document.getElementById('mensajeExitoReferido').scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
        
        console.log('‚úÖ Referido enviado exitosamente');
        
      } catch (error) {
        console.error('‚ùå Error al enviar referido:', error);
        document.getElementById('mensajeErrorReferido').style.display = 'block';
      } finally {
        // Rehabilitar bot√≥n
        btnEnviar.disabled = false;
        btnEnviar.textContent = 'üì§ Enviar Referencia';
      }
    });

    // Funci√≥n para enviar a Google Forms
    async function enviarReferidoAGoogleForm(nombreUsuario, nombreReferido, telefonoReferido, correoReferido) {
      const formData = new FormData();
      
      formData.append(FORM_REFERIDOS_FIELDS.nombreUsuario, nombreUsuario);
      formData.append(FORM_REFERIDOS_FIELDS.nombreReferido, nombreReferido);
      formData.append(FORM_REFERIDOS_FIELDS.telefonoReferido, telefonoReferido);
      formData.append(FORM_REFERIDOS_FIELDS.correoReferido, correoReferido);
      formData.append(FORM_REFERIDOS_FIELDS.mensaje, `Referido de: ${nombreUsuario}`);
      
      // Enviar a Google Forms (modo no-cors)
      await fetch(GOOGLE_FORM_REFERIDOS_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: formData
      });
    }

    window.addEventListener("load", cargarUF);
  </script>
</body>
</html>
