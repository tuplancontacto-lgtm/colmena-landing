<!DOCTYPE html>
<html lang="es">
<head>	
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planes de Salud Colmena - Asesor√≠a Profesional</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #0a1a2a; color: white; margin: 0; padding: 0; }
    header { background: linear-gradient(90deg, #0a1a2a, #12375a); padding: 40px; text-align: center; }
    h1 { color: #d4af37; font-size: 2.5rem; margin: 0; }
    h2 { color: #d4af37; }
    section { padding: 40px 20px; max-width: 900px; margin: auto; }
    .gold { color: #d4af37; }
    .card { background: #112233; border: 1px solid #d4af37; padding: 25px; border-radius: 15px; margin-bottom: 25px; }
    button { background: #d4af37; color: #0a1a2a; padding: 15px 25px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; }
    button:hover { opacity: 0.85; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    form input, form select, form textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; }
    .whatsapp { display: block; background: #25D366; text-align: center; padding: 15px; color: white; text-decoration: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 20px; max-width: 300px; margin-left: auto; margin-right: auto; }
    .small { font-size: 0.9rem; color: #ccc; }
    .row { display:flex; gap:16px; flex-wrap: wrap; }
    .col { flex:1; min-width: 200px; }
    .success-msg { color: #4ade80; margin-top: 12px; font-weight: bold; }
    .error-msg { color: #ff8080; margin-top: 12px; }
    .resumen-cotizacion { background: #0d1f2d; border: 1px solid #3a5a7a; border-radius: 10px; padding: 20px; margin-bottom: 25px; }
    .resumen-titulo { color: #d4af37; font-size: 1.3rem; margin-bottom: 15px; font-weight: bold; }
    .resumen-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
    .resumen-item { text-align: center; padding: 15px; background: #112233; border-radius: 8px; }
    .resumen-label { font-size: 0.85rem; color: #888; margin-bottom: 5px; }
    .resumen-value { font-size: 1.2rem; font-weight: bold; color: #fff; }
    .resumen-value.destacado { color: #4ade80; }
    .resumen-uf { font-size: 0.85rem; color: #aaa; }
    .plan-card { background: #112233; border: 2px solid #d4af37; border-radius: 15px; padding: 25px; margin: 25px 0; }
    .plan-card.secundario { border-color: #60a5fa; }
    .plan-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-bottom: 15px; }
    .plan-badge.principal { background: #d4af37; color: #0a1a2a; }
    .plan-badge.secundario { background: #60a5fa; color: #0a1a2a; }
    .plan-nombre-container { text-align: center; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #1a3a5a, #0d1f2d); border-radius: 12px; border: 2px solid #d4af37; }
    .plan-nombre { font-size: 1.8rem; font-weight: bold; color: #d4af37; text-shadow: 0 2px 10px rgba(212,175,55,0.3); letter-spacing: 1px; }
    .plan-nombre-estrella { color: #fbbf24; font-size: 1.5rem; }
    .plan-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0; }
    .plan-info-item { background: #1a2a3a; padding: 15px; border-radius: 8px; text-align: center; }
    .plan-info-label { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
    .plan-info-value { font-size: 1.1rem; font-weight: bold; color: #fff; }
    .plan-info-value.verde { color: #4ade80; }
    .plan-info-value.amarillo { color: #fbbf24; }
    .coberturas-section { margin: 20px 0; padding: 15px; background: #0d1f2d; border-radius: 10px; }
    .coberturas-title { color: #d4af37; font-size: 1rem; margin-bottom: 10px; }
    .coberturas-texto { font-size: 0.9rem; line-height: 1.6; color: #ccc; }
    .clinicas-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid #3a5a7a; }
    .clinicas-title { color: #d4af37; font-size: 1.1rem; margin-bottom: 15px; }
    .grupos-tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .grupo-tab { background: #1a2a3a; border: 1px solid #3a5a7a; color: #ccc; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
    .grupo-tab:hover { border-color: #d4af37; color: #d4af37; }
    .grupo-tab.active { background: #d4af37; color: #0a1a2a; border-color: #d4af37; font-weight: bold; }
    .clinicas-tabla { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .clinicas-tabla th { background: #1a3a5a; color: #d4af37; padding: 12px 15px; text-align: left; }
    .clinicas-tabla td { padding: 10px 15px; border-bottom: 1px solid #2a3a4a; }
    .clinicas-tabla tr:nth-child(even) { background: #0d1f2d; }
    .clinicas-tabla tr:nth-child(odd) { background: #112233; }
    .clinicas-tabla tr:hover { background: #1a3a4a; }
    .grupo-content { display: none; }
    .grupo-content.active { display: block; }
    .btn-asesoria { display: inline-block; background: linear-gradient(135deg, #d4af37, #f0c860); color: #0a1a2a; padding: 18px 40px; text-decoration: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 15px rgba(212,175,55,0.4); transition: all .3s ease; border: none; cursor: pointer; }
    .btn-asesoria:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,175,55,0.6); }
    .referidos-section { background: linear-gradient(135deg,#0f2640 0%,#1a3a5a 100%); padding:60px 20px; margin:40px 0; }
    .referidos-container { max-width:800px; margin:0 auto; background:#112233; padding:40px; border-radius:20px; border:1px solid #d4af37; }
    .referidos-header { text-align:center; margin-bottom:30px; }
    .referidos-header h2 { color:#d4af37; font-size:28px; margin-bottom:15px; }
    .referidos-header p { color:#b8c5d6; font-size:16px; }
    .form-section { background:#1a2a3a; padding:25px; border-radius:15px; border-left:4px solid #d4af37; margin-bottom: 20px; }
    .form-section h3 { color:#d4af37; font-size:18px; margin-bottom:15px; margin-top: 0; }
    .form-group-referidos { margin-bottom: 15px; }
    .form-group-referidos label { display:block; color:#b8c5d6; margin-bottom:8px; font-size:14px; }
    .form-group-referidos input { width:100%; padding:12px; border:2px solid #2a3a4a; border-radius:8px; background:#0a1a2a; color:white; }
    .btn-enviar-referido { background:linear-gradient(135deg,#d4af37,#f0c860); color:#0a1a2a; padding:15px 40px; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; width:100%; }
    .mensaje-exito-referido, .mensaje-error-referido { padding:15px; border-radius:10px; margin-top:20px; display:none; font-weight:600; text-align:center; }
    .mensaje-exito-referido { background:#1a4d2e; color:#4ade80; border:1px solid #4ade80; }
    .mensaje-error-referido { background:#4a1a1a; color:#ff8080; border:1px solid #ff8080; }
    .disclaimer { background: #1a2a3a; border-left: 4px solid #fbbf24; padding: 15px 20px; margin: 20px 0; border-radius: 0 8px 8px 0; font-size: 0.85rem; color: #b8c5d6; font-style: italic; }
    .disclaimer-icon { color: #fbbf24; margin-right: 8px; }
    .mejorar-cobertura { background: linear-gradient(135deg, #0f2640, #1a3a5a); border: 2px solid #4ade80; border-radius: 15px; padding: 30px; margin: 30px 0; text-align: center; }
    .mejorar-titulo { color: #4ade80; font-size: 1.3rem; margin-bottom: 15px; }
    .mejorar-texto { color: #b8c5d6; font-size: 1rem; line-height: 1.6; margin-bottom: 20px; }
    .mejorar-input-container { display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; margin-top: 20px; }
    .mejorar-input { width: 200px; padding: 15px; font-size: 1.1rem; border: 2px solid #4ade80; border-radius: 10px; background: #0a1a2a; color: white; text-align: center; }
    .mejorar-input:focus { outline: none; border-color: #d4af37; box-shadow: 0 0 10px rgba(212,175,55,0.3); }
    .btn-recalcular { background: linear-gradient(135deg, #4ade80, #22c55e); color: #0a1a2a; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .btn-recalcular:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(74,222,128,0.4); }
    .adicional-actual { background: #112233; padding: 15px 25px; border-radius: 10px; margin: 15px 0; display: inline-block; }
    .adicional-label { color: #888; font-size: 0.9rem; }
    .adicional-valor { color: #4ade80; font-size: 1.3rem; font-weight: bold; }
    .btn-enviar-usuario { background: linear-gradient(135deg, #25d366, #128c7e); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-top: 15px; display: block; width: 100%; max-width: 350px; margin-left: auto; margin-right: auto; }
    .btn-enviar-usuario:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(37,211,102,0.4); }
    .btn-buscar-clinica { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; display: inline-block; }
    .btn-buscar-clinica:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(96,165,250,0.4); }
    
    /* ESTILOS B√öSQUEDA POR CL√çNICA */
    #seccionBusquedaClinica { 
      border: 2px solid #4ade80 !important; 
      border-radius: 15px;
      background: linear-gradient(135deg, rgba(15, 38, 64, 0.5), rgba(26, 58, 90, 0.5));
    }
    
    #seccionBusquedaClinica h2 { 
      color: #4ade80;
      margin-bottom: 10px;
    }
    
    .busqueda-clinica-resultado { 
      animation: slideIn 0.3s ease-out; 
    }
    
    @keyframes slideIn { 
      from { 
        opacity: 0; 
        transform: translateY(10px); 
      } 
      to { 
        opacity: 1; 
        transform: translateY(0); 
      } 
    }
    
    .btn-enviar-clinica { 
      transition: all 0.3s ease;
    }
    
    .btn-enviar-clinica:hover { 
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(74,222,128,0.4);
    }
    
    @media (max-width: 600px) {
      .plan-nombre { font-size: 1.4rem; }
      .clinicas-tabla th, .clinicas-tabla td { padding: 8px 10px; font-size: 0.85rem; }
      .mejorar-input { width: 100%; }
    }
  </style>
</head>
<body>

<header>
  <h1>Asesor√≠a en Planes de Salud Colmena</h1>
  <p class="gold">Atenci√≥n premium para clientes exigentes</p>
  <p class="small">Completa el formulario para obtener una cotizaci√≥n exacta en UF y CLP.</p>
</header>

<section id="formulario" class="card">
  <h2 class="gold">Formulario para C√°lculo del Plan</h2>
  <form id="mainForm">
    <div class="row">
      <div class="col"><input type="text" name="nombre" id="nombre" placeholder="Nombre completo" required /></div>
      <div class="col"><input type="email" name="correo" id="correo" placeholder="Correo electr√≥nico" required /></div>
    </div>
    <div class="row">
      <div class="col"><input type="tel" name="telefono" id="telefono" placeholder="Tel√©fono (ej: +56912345678)" required /></div>
      <div class="col"><input type="number" name="edad" id="edad" placeholder="Edad titular" min="18" max="99" required /></div>
    </div>
    <input type="text" name="rut" id="rut" placeholder="RUT (ej: 12.345.678-9)" required />
    <select name="isapre" id="isapre" required>
      <option value="">Isapre actual</option>
      <option>FONASA</option>
      <option>Colmena</option>
      <option>Cruz Blanca</option>
      <option>Consalud</option>
      <option>Banm√©dica</option>
      <option>Vida Tres</option>
      <option>Nueva Masvida</option>
      <option>Esencial</option>
    </select>
    <input type="number" id="renta" name="renta" placeholder="Renta imponible mensual (CLP)" required />
    <label class="small">Edad de las cargas (separadas por coma, ej: 5, 12, 30)</label>
    <textarea name="cargas" id="cargas" placeholder="Ej: 5, 12, 30" rows="2"></textarea>
    <select name="region" id="region" required>
      <option value="">Selecciona tu Regi√≥n</option>
      <option value="Arica y Parinacota">Regi√≥n de Arica y Parinacota</option>
      <option value="Tarapac√°">Regi√≥n de Tarapac√°</option>
      <option value="Antofagasta">Regi√≥n de Antofagasta</option>
      <option value="Atacama">Regi√≥n de Atacama</option>
      <option value="Coquimbo">Regi√≥n de Coquimbo</option>
      <option value="Valpara√≠so">Regi√≥n de Valpara√≠so</option>
      <option value="Metropolitana">Regi√≥n Metropolitana</option>
      <option value="O'Higgins">Regi√≥n de O'Higgins</option>
      <option value="Maule">Regi√≥n del Maule</option>
      <option value="√ëuble">Regi√≥n de √ëuble</option>
      <option value="B√≠o-B√≠o">Regi√≥n del B√≠o-B√≠o</option>
      <option value="La Araucan√≠a">Regi√≥n de La Araucan√≠a</option>
      <option value="Los R√≠os">Regi√≥n de Los R√≠os</option>
      <option value="Los Lagos">Regi√≥n de Los Lagos</option>
      <option value="Ays√©n">Regi√≥n de Ays√©n</option>
      <option value="Magallanes">Regi√≥n de Magallanes</option>
    </select>
    <textarea name="mensaje" id="mensaje" placeholder="Mensaje adicional (opcional)" rows="2"></textarea>
    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
      <button type="submit" id="submitBtn" style="flex: 1; min-width: 140px;">Cotizar Ahora</button>
      <button type="button" id="btnBuscarClinicaFormulario" style="flex: 1; min-width: 140px; background: #4ade80; color: #0a1a2a;">üè• Buscar por Cl√≠nica</button>
    </div>
    <p id="statusMsg" class="small" style="margin-top:10px;"></p>
  </form>
</section>

<section class="card">
  <h2 class="gold">UF del d√≠a</h2>
  <p class="small">UF: <span id="ufValor">cargando‚Ä¶</span> ‚Äî Fecha: <span id="ufFecha">-</span></p>
</section>

<section id="resultado-preliminar" class="card" style="display:none">
  <div id="resultadoDetalle"></div>
  <div style="text-align:center;margin-top:30px; display:flex; gap:15px; flex-wrap:wrap; justify-content:center;">
    <button id="btnAsesoria" class="btn-asesoria">üìã Solicitar Asesor√≠a</button>
    <button id="btnBuscarClinicaDesdeResultados" class="btn-buscar-clinica">üè• Buscar por Cl√≠nica</button>
  </div>
  <p class="small" style="margin-top:10px; text-align:center;">Selecciona una opci√≥n para continuar.</p>
  <div style="text-align:center;margin-top:20px;">
    <button id="btnEnviarUsuario" class="btn-enviar-usuario">üì≤ Recibir Resumen por WhatsApp</button>
    <p class="small" style="margin-top:10px;">Recibir√°s los planes cotizados y documentos requeridos.</p>
  </div>
</section>

<!-- SECCI√ìN DE B√öSQUEDA POR CL√çNICA FAVORITA -->
<section id="seccionBusquedaClinica" class="card" style="display:none; margin-top:40px; border: 2px solid #4ade80;">
  <h2 class="gold">üè• Buscar Cotizaci√≥n por Cl√≠nica Favorita</h2>
  <p class="small">¬øTienes una cl√≠nica preferida? Ingresa su nombre y te mostraremos qu√© planes disponibles te ofrecen cobertura en esa cl√≠nica.</p>
  
  <div style="background: linear-gradient(135deg, #0f2640, #1a3a5a); border-radius: 15px; padding: 25px; margin: 20px 0; border: 1px solid #4ade80;">
    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
      <input 
        type="text" 
        id="inputBuscadorClinica" 
        placeholder="Ej: Cl√≠nica D√°vila, Hospital Cl√≠nico, Cl√≠nica Las Condes..." 
        style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid #4ade80; border-radius: 8px; background: #0a1a2a; color: white; font-size: 1rem;"
      />
      <button 
        type="button" 
        id="btnBuscarClinica" 
        style="background: linear-gradient(135deg, #4ade80, #22c55e); color: white; padding: 12px 30px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; font-size: 1rem;"
      >
        üîç Buscar
      </button>
    </div>
    <p class="small" style="color: #888; margin: 0;">Comienza a escribir el nombre de la cl√≠nica y presiona Enter o haz clic en Buscar.</p>
  </div>
  
  <div id="resultadoBusquedaClinica"></div>
</section>

<section class="referidos-section" id="referidos" style="display:none">
  <div class="referidos-container">
    <div class="referidos-header">
      <h2>¬øQuieres que asesoremos a un amigo?</h2>
      <p>Ingresa los datos y nos comunicaremos con tu referido.</p>
    </div>
    <form id="formReferidos">
      <div class="form-section">
        <h3>üë§ Tus Datos</h3>
        <div class="form-group-referidos">
          <label for="nombreUsuario">Tu Nombre *</label>
          <input type="text" id="nombreUsuario" required>
        </div>
      </div>
      <div class="form-section">
        <h3>üéØ Datos del Referido</h3>
        <div class="form-group-referidos">
          <label>Nombre Completo *</label>
          <input type="text" id="nombreReferido" required>
        </div>
        <div class="form-group-referidos">
          <label>Tel√©fono *</label>
          <input type="tel" id="telefonoReferido" required>
        </div>
        <div class="form-group-referidos">
          <label>Correo *</label>
          <input type="email" id="correoReferido" required>
        </div>
      </div>
      <button type="submit" class="btn-enviar-referido">üì§ Enviar Referido</button>
      <div id="mensajeExitoReferido" class="mensaje-exito-referido">‚úÖ ¬°Referido Enviado!</div>
      <div id="mensajeErrorReferido" class="mensaje-error-referido">‚ùå Error al enviar.</div>
    </form>
  </div>
</section>

<a class="whatsapp" id="btnWAAsesor" href="#" target="_blank">Contactar por WhatsApp</a>

<footer style="text-align:center; padding:30px; color:#666; font-size:0.85rem;">
  ¬© 2025 Colmena Golden Cross - Asesor√≠a en Planes de Salud
</footer>

<script>
  const ASESORES = {
    jose_pepe: {
      nombre: "Jos√© Pepe",
      telefono: "+56990701837",
      whatsapp: "56990701837",
      callmebot_apikey: "5088331",
      correo: "voz.josemora@gmail.com"
    },
    betty: {
      nombre: "Betty Gonz√°lez",
      telefono: "+56983899232",
      whatsapp: "56983899232",
      callmebot_apikey: "PENDIENTE",
      correo: "betty.gonzalez@colmena.cl"
    },
    jose_mora: {
      nombre: "Jos√© Mora",
      telefono: "+56975356696",
      whatsapp: "56975356696",
      callmebot_apikey: "7360481",
      correo: "jose.mora@colmena.cl"
    }
  };

  function getQueryParam(param) {
    const params = new URLSearchParams(window.location.search);
    return params.get(param);
  }

  const asesorKey = getQueryParam("asesor") || "jose_mora";
  const asesor = ASESORES[asesorKey] || ASESORES["jose_mora"];

  const WHATSAPP_ASESORIA = asesor.whatsapp;
  const CALLMEBOT_PHONE = asesor.whatsapp;
  const CALLMEBOT_APIKEY = asesor.callmebot_apikey;
  const ASESOR_NOMBRE = asesor.nombre;
  const ASESOR_TELEFONO = asesor.telefono;
  const ASESOR_CORREO = asesor.correo;

  window.addEventListener("DOMContentLoaded", function() {
    const btnWA = document.getElementById("btnWAAsesor");
    if (btnWA) {
      btnWA.href = `https://wa.me/${WHATSAPP_ASESORIA}`;
      btnWA.innerText = `Contactar a ${ASESOR_NOMBRE} por WhatsApp`;
    }
  });

  const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdWN77vgHicHHkyq8w0ogOzP5MHnlhBSLZAObDyVQo-ILw73g/formResponse';

  const FORM_FIELDS = {
    nombre: 'entry.1455181501',
    rut: 'entry.1514828805',
    correo: 'entry.1253669566',
    telefono: 'entry.1927631596',
    edad: 'entry.1515225692',
    isapre: 'entry.1312575017',
    renta: 'entry.1350273122',
    region: 'entry.1283417188',
    cargas: 'entry.6457415',
    mensaje: 'entry.860152674',
    plan1: 'entry.1176082335',
    plan2: 'entry.1798986413',
    asesorid: 'entry.1496988494'
  };

  const GOOGLE_FORM_REFERIDOS_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeIppjYB0Vgc6RsJ3AM0HcAVhLaxAT6ZZ_MxdPhmuwRkwLT-A/formResponse';

  const REFERIDOS_FIELDS = {
    tu_nombre: "entry.1664559901",
    nombre_referido: "entry.715463265",
    telefono_referido: "entry.1382714918",
    correo_referido: "entry.897178414",
    mensaje_adicional: "entry.178502788",
    asesorid_referidos: "entry.683967436"
  };

  const URL_PLANES = 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/main/data/planes.json';
  const URL_REDES = 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/main/data/redes_clinicas.json';

  const GRUPOS_GX = {
    "Grupo 46 - GX Premium": [
      { "nombre": "CL√çNICA ALEMANA", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" },
      { "nombre": "CL√çNICA LAS CONDES", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" }
    ],
    "Grupo 45 - GX Plus": [
      { "nombre": "CL√çNICA SAN CARLOS APOQUINDO", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" },
      { "nombre": "CL√çNICA UNIVERSIDAD CAT√ìLICA", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" },
      { "nombre": "CL√çNICA UNIVERSIDAD DE LOS ANDES", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" },
      { "nombre": "CL√çNICA MEDS", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" },
      { "nombre": "CL√çNICA SANTA MAR√çA", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" }
    ],
    "Grupo 44 - GX Red": [
      { "nombre": "CL√çNICA REDSALUD VITACURA", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" },
      { "nombre": "HOSPITAL CL√çNICO UNIVERSIDAD CAT√ìLICA", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" },
      { "nombre": "FUNDACI√ìN ARTURO LOPEZ PEREZ", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" },
      { "nombre": "HOSPITAL CL√çNICO DE LA FUERZA A√âREA DE CHILE", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" },
      { "nombre": "CL√çNICA INDISA", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" }
    ],
    "Grupo 43 - GX Red": [
      { "nombre": "HOSPITAL DEL NI√ëO", "ciudad": "VI√ëA DEL MAR", "region": "Regi√≥n de Valpara√≠so" },
      { "nombre": "CL√çNICA CHILLAN", "ciudad": "CHILLAN", "region": "Regi√≥n de √ëuble" },
      { "nombre": "CL√çNICA B√çO B√çO", "ciudad": "CONCEPCI√ìN", "region": "Regi√≥n del B√≠o-B√≠o" }
    ],
    "Grupo 42 - GX Ampliada": [
      { "nombre": "CL√çNICA D√ÅVILA RECOLETA", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" },
      { "nombre": "CL√çNICA REDSALUD PROVIDENCIA", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" }
    ],
    "Grupo 41 - GX Preferente": [
      { "nombre": "CL√çNICA JUAN PABLO II", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" },
      { "nombre": "CL√çNICA SIERRA BELLA", "ciudad": "SANTIAGO", "region": "Regi√≥n Metropolitana" }
    ]
  };

  const PLANES_DATA = [
    {"plan": "COLMENA MAX 2245050", "codigo": 10101, "pb_uf": 2.22, "zona": "LIBRE_ELECCION", "coberturas_redes": {"G41": 60, "G42": 50, "G43": 40, "G44": 30, "G45": 25, "G46": 25}, "tope_anual_uf": 7000, "hospitalizacion": "%G41=60%  %G42 =50%  %G43=40% %G44=30%  %G45=25%  %G46=25%", "consulta": {"tipo": "libre_eleccion", "valor": "50% (0,50 UF)"}},
    {"plan": "COLMENA MAX 2246050", "codigo": 10102, "pb_uf": 2.3, "zona": "LIBRE_ELECCION", "coberturas_redes": {"G41": 70, "G42": 60, "G43": 50, "G44": 40, "G45": 30, "G46": 30}, "tope_anual_uf": 7000, "hospitalizacion": "%G41=70%  %G42 =60%  %G43=50% %G44=40%  %G45=30%  %G46=30%", "consulta": {"tipo": "libre_eleccion", "valor": "50% (0,55 UF)"}},
    {"plan": "COLMENA MAX 2246060", "codigo": 10103, "pb_uf": 2.4, "zona": "LIBRE_ELECCION", "coberturas_redes": {"G41": 70, "G42": 60, "G43": 50, "G44": 40, "G45": 30, "G46": 30}, "tope_anual_uf": 7000, "hospitalizacion": "%G41=70%  %G42 =60%  %G43=50% %G44=40%  %G45=30%  %G46=30%", "consulta": {"tipo": "libre_eleccion", "valor": "60% (0,60 UF)"}},
    {"plan": "COLMENA MAX 2247050", "codigo": 10104, "pb_uf": 2.5, "zona": "LIBRE_ELECCION", "coberturas_redes": {"G41": 80, "G42": 70, "G43": 60, "G44": 50, "G45": 30, "G46": 30}, "tope_anual_uf": 7000, "hospitalizacion": "%G41=80%  %G42 =70%  %G43=60% %G44=50%  %G45=30%  %G46=30%", "consulta": {"tipo": "libre_eleccion", "valor": "50% (0,65 UF)"}},
    {"plan": "COLMENA MAX 2247060", "codigo": 10105, "pb_uf": 2.6, "zona": "LIBRE_ELECCION", "coberturas_redes": {"G41": 80, "G42": 70, "G44": 60, "G45": 50, "G46": 35}, "tope_anual_uf": 7000, "hospitalizacion": "%G41=80%  %G42 =70%  %G44=60% %G45=50%  %G46=35%", "consulta": {"tipo": "libre_eleccion", "valor": "60% (0,70 UF)"}},
    {"plan": "COLMENA MAX 2247070", "codigo": 10106, "pb_uf": 2.7, "zona": "LIBRE_ELECCION", "coberturas_redes": {"G41": 80, "G42": 70, "G44": 60, "G45": 50, "G46": 35}, "tope_anual_uf": 7000, "hospitalizacion": "%G41=80%  %G42 =70%  %G44=60% %G45=50%  %G46=35%", "consulta": {"tipo": "libre_eleccion", "valor": "70% (0,75 UF)"}},
    {"plan": "COLMENA MAX 2248050", "codigo": 10107, "pb_uf": 2.7, "zona": "LIBRE_ELECCION", "coberturas_redes": {"G41": 90, "G42": 80, "G44": 60, "G45": 50, "G46": 35}, "tope_anual_uf": 7000, "hospitalizacion": "%G41=90%  %G42 =80%  %G44=60% %G45=50%  %G46=35%", "consulta": {"tipo": "libre_eleccion", "valor": "50% (0,80 UF)"}},
    {"plan": "COLMENA MAX 2248060", "codigo": 10108, "pb_uf": 2.8, "zona": "LIBRE_ELECCION", "coberturas_redes": {"G41": 90, "G42": 80, "G44": 70, "G45": 60, "G46": 35}, "tope_anual_uf": 7000, "hospitalizacion": "%G41=90%  %G42 =80%  %G44=70% %G45=60%  %G46=35%", "consulta": {"tipo": "libre_eleccion", "valor": "60% (0,85 UF)"}},
    {"plan": "COLMENA MAX 2248070", "codigo": 10109, "pb_uf": 3.0, "zona": "LIBRE_ELECCION", "coberturas_redes": {"G41": 90, "G42": 80, "G44": 70, "G45": 60, "G46": 35}, "tope_anual_uf": 7000, "hospitalizacion": "%G41=90%  %G42 =80%  %G44=70% %G45=60%  %G46=35%", "consulta": {"tipo": "libre_eleccion", "valor": "70% (0,90 UF)"}},
    {"plan": "COLMENA MAX 2249050", "codigo": 10110, "pb_uf": 3.0, "zona": "LIBRE_ELECCION", "coberturas_redes": {"G41": 100, "G42": 90, "G44": 80, "G45": 70, "G46": 35}, "tope_anual_uf": 7000, "hospitalizacion": "%G41=100%  %G42 =90%  %G44=80% %G45=70%  %G46=35%", "consulta": {"tipo": "libre_eleccion", "valor": "50% (0,95 UF)"}},
    {"plan": "COLMENA PLUS 2244040", "codigo": 10637, "pb_uf": 1.58, "zona": "SANTIAGO", "tope_anual_uf": 7000, "hospitalizacion": "%G41=50%  %G42 =40%  %G43=30% %G44=25%  %G45=25%  %G46=25%", "consulta": {"tipo": "libre_eleccion", "valor": "40% (0,30 UF)"}},
    {"plan": "COLMENA PLUS 2244050", "codigo": 10638, "pb_uf": 1.66, "zona": "SANTIAGO", "tope_anual_uf": 7000, "hospitalizacion": "%G41=50%  %G42 =40%  %G43=30% %G44=25%  %G45=25%  %G46=25%", "consulta": {"tipo": "libre_eleccion", "valor": "50% (0,30 UF)"}},
    {"plan": "COLMENA PLUS 2245040", "codigo": 10639, "pb_uf": 1.69, "zona": "SANTIAGO", "tope_anual_uf": 7000, "hospitalizacion": "%G41=60%  %G42 =50%  %G43=40% %G44=30%  %G45=25%  %G46=25%", "consulta": {"tipo": "libre_eleccion", "valor": "40% (0,30 UF)"}},
    {"plan": "COLMENA PLUS 2245050", "codigo": 10640, "pb_uf": 1.82, "zona": "SANTIAGO", "tope_anual_uf": 7000, "hospitalizacion": "%G41=60%  %G42 =50%  %G43=40% %G44=30%  %G45=25%  %G46=25%", "consulta": {"tipo": "libre_eleccion", "valor": "50% (0,30 UF)"}},
    {"plan": "COLMENA PLUS 2245060", "codigo": 10641, "pb_uf": 1.88, "zona": "SANTIAGO", "tope_anual_uf": 7000, "hospitalizacion": "%G41=60%  %G42 =50%  %G43=40% %G44=30%  %G45=25%  %G46=25%", "consulta": {"tipo": "libre_eleccion", "valor": "60% (0,34 UF)"}},
    {"plan": "COLMENA PLUS 2245070", "codigo": 10642, "pb_uf": 1.95, "zona": "SANTIAGO", "tope_anual_uf": 7000, "hospitalizacion": "%G41=60%  %G42 =50%  %G43=40% %G44=30%  %G45=25%  %G46=25%", "consulta": {"tipo": "libre_eleccion", "valor": "70% (0,37 UF)"}},
    {"plan": "COLMENA PLUS 2245080", "codigo": 10643, "pb_uf": 2.0, "zona": "SANTIAGO", "tope_anual_uf": 7000, "hospitalizacion": "%G41=60%  %G42 =50%  %G43=40% %G44=30%  %G45=25%  %G46=25%", "consulta": {"tipo": "libre_eleccion", "valor": "80% (0,37 UF)"}},
    {"plan": "COLMENA PLUS 2246050", "codigo": 10644, "pb_uf": 2.04, "zona": "SANTIAGO", "tope_anual_uf": 7000, "hospitalizacion": "%G41=70%  %G42 =60%  %G43=50% %G44=40%  %G45=30%  %G46=30%", "consulta": {"tipo": "libre_eleccion", "valor": "50% (0,34 UF)"}},
    {"plan": "COLMENA PLUS 2246060", "codigo": 10645, "pb_uf": 2.12, "zona": "SANTIAGO", "tope_anual_uf": 7000, "hospitalizacion": "%G41=70%  %G42 =60%  %G43=50% %G44=40%  %G45=30%  %G46=30%", "consulta": {"tipo": "libre_eleccion", "valor": "60% (0,38 UF)"}},
    {"plan": "COLMENA PLUS 2246070", "codigo": 10646, "pb_uf": 2.15, "zona": "SANTIAGO", "tope_anual_uf": 7000, "hospitalizacion": "%G41=70%  %G42 =60%  %G43=50% %G44=40%  %G45=30%  %G46=30%", "consulta": {"tipo": "libre_eleccion", "valor": "70% (0,44 UF)"}},
    {"plan": "COLMENA PLUS 2246080", "codigo": 10647, "pb_uf": 2.2, "zona": "SANTIAGO", "tope_anual_uf": 7000, "hospitalizacion": "%G41=70%  %G42 =60%  %G43=50% %G44=40%  %G45=30%  %G46=30%", "consulta": {"tipo": "libre_eleccion", "valor": "80% (0,44 UF)"}}
  ];

  let contadorRecalculos = 0;
  const MAX_RECALCULOS = 2;

  const REGION_A_ZONA = {
    'Arica y Parinacota': 'NORTE',
    'Tarapac√°': 'NORTE',
    'Antofagasta': 'NORTE',
    'Atacama': 'NORTE',
    'Coquimbo': 'NORTE',
    'Valpara√≠so': 'CENTRO',
    "O'Higgins": 'CENTRO',
    'Maule': 'CENTRO',
    'Metropolitana': 'SANTIAGO',
    '√ëuble': 'SUR',
    'B√≠o-B√≠o': 'SUR',
    'La Araucan√≠a': 'SUR',
    'Los R√≠os': 'SUR',
    'Los Lagos': 'SUR',
    'Ays√©n': 'SUR',
    'Magallanes': 'SUR'
  };

  function obtenerFactor(edad) {
    if (edad < 2) return 0.0;
    if (edad < 20) return 0.6;
    if (edad < 25) return 0.9;
    if (edad < 35) return 1.0;
    if (edad < 45) return 1.3;
    if (edad < 55) return 1.4;
    if (edad < 65) return 2.0;
    return 2.4;
  }

  function obtenerFactorCarga(edad) {
    if (edad < 2) return 0.0;
    if (edad < 20) return 0.6;
    if (edad < 25) return 0.7;
    if (edad < 35) return 0.7;
    if (edad < 45) return 0.9;
    if (edad < 55) return 1.0;
    if (edad < 65) return 1.4;
    return 2.2;
  }

  let formularioDatos = {};
  let ultimoResultado = null;
  let PLANES = [];
  let REDES_CLINICAS = {};

  async function cargarUF() {
    try {
      const r = await fetch("https://mindicador.cl/api/");
      const j = await r.json();
      const uf = j.uf.valor;
      window.__UF_VALOR = uf;
      document.getElementById("ufValor").innerText = "$" + uf.toLocaleString("es-CL", { minimumFractionDigits: 2 });
      document.getElementById("ufFecha").innerText = new Date(j.uf.fecha).toLocaleDateString("es-CL", { year: "numeric", month: "long", day: "numeric" });
    } catch (err) {
      window.__UF_VALOR = 39700;
      document.getElementById("ufValor").innerText = "$39.700 (estimado)";
      document.getElementById("ufFecha").innerText = "No disponible";
    }
  }

  async function cargarPlanes() {
    PLANES = PLANES_DATA;
  }

  async function cargarRedesClincias() {
    REDES_CLINICAS = GRUPOS_GX;
  }

  function formatearCLP(n) {
    return (n || 0).toLocaleString("es-CL");
  }

  function calcularValorPlan(pbUF, edadTitular, edadesCargas) {
    const uf = window.__UF_VALOR || 39700;
    let sumaFactores = obtenerFactor(edadTitular);
    edadesCargas.forEach(e => sumaFactores += obtenerFactorCarga(e));
    const valorPlanUF = pbUF * sumaFactores;
    const valorPlanCLP = Math.round(valorPlanUF * uf);
    let personasGES = edadTitular >= 2 ? 1 : 0;
    edadesCargas.forEach(e => { if (e >= 2) personasGES++; });
    const gesUF = 0.77 * personasGES;
    const gesCLP = Math.round(gesUF * uf);
    const totalUF = valorPlanUF + gesUF;
    const totalCLP = valorPlanCLP + gesCLP;
    return { valorPlanUF, valorPlanCLP, gesUF, gesCLP, totalUF, totalCLP, sumaFactores };
  }

  function calcularSietePorCiento(rentaMensual, ufValor) {
    const RTI_UF = 87.8;
    const rentaEnUF = rentaMensual / ufValor;
    const rentaAUsar = Math.min(rentaEnUF, RTI_UF);
    const sietePorCientoUF = rentaAUsar * 0.07;
    const sietePorCientoCLP = Math.round(sietePorCientoUF * ufValor);
    const rtiAplicado = rentaEnUF > RTI_UF;
    return { sietePorCientoCLP, sietePorCientoUF, rtiAplicado };
  }

  function seleccionarPlanes(sieteUF, zona, edadTitular, edadesCargas, region) {
    const uf = window.__UF_VALOR || 39700;
    function calcularPlanesDisponibles(filtroZona) {
      const planesZona = PLANES.filter(p => p.zona === filtroZona || p.zona === 'LIBRE_ELECCION');
      const planesConValor = planesZona.map(p => {
        const calc = calcularValorPlan(p.pb_uf, edadTitular, edadesCargas);
        const diferencia = Math.abs(calc.totalUF - sieteUF);
        let coberturaPromedio = 0;
        if (p.coberturas_redes && Object.keys(p.coberturas_redes).length > 0) {
          const coberturas = Object.values(p.coberturas_redes);
          coberturaPromedio = Math.round(coberturas.reduce((a, b) => a + b, 0) / coberturas.length);
        }
        return { ...p, valorCalculadoUF: calc.totalUF, valorCalculadoCLP: calc.totalCLP, gesUF: calc.gesUF, gesCLP: calc.gesCLP, sumaFactores: calc.sumaFactores, diferencia: diferencia, exceso: Math.max(0, calc.totalUF - sieteUF), coberturaPromedio: coberturaPromedio };
      });
      return planesConValor;
    }
    let planesZona = calcularPlanesDisponibles(zona);
    const rango95 = sieteUF * 0.95;
    const rango110 = sieteUF * 1.10;
    let planesIdeales = planesZona.filter(p => p.valorCalculadoUF >= rango95 && p.valorCalculadoUF <= rango110);
    if (planesIdeales.length === 0) {
      const planesLibres = PLANES.filter(p => p.zona === 'LIBRE_ELECCION');
      const planesLibresConValor = planesLibres.map(p => {
        const calc = calcularValorPlan(p.pb_uf, edadTitular, edadesCargas);
        const diferencia = Math.abs(calc.totalUF - sieteUF);
        let coberturaPromedio = 0;
        if (p.coberturas_redes && Object.keys(p.coberturas_redes).length > 0) {
          const coberturas = Object.values(p.coberturas_redes);
          coberturaPromedio = Math.round(coberturas.reduce((a, b) => a + b, 0) / coberturas.length);
        }
        return { ...p, valorCalculadoUF: calc.totalUF, valorCalculadoCLP: calc.totalCLP, gesUF: calc.gesUF, gesCLP: calc.gesCLP, sumaFactores: calc.sumaFactores, diferencia: diferencia, exceso: Math.max(0, calc.totalUF - sieteUF), coberturaPromedio: coberturaPromedio };
      });
      planesIdeales = planesLibresConValor.filter(p => p.valorCalculadoUF >= rango95 && p.valorCalculadoUF <= rango110);
    }
    function agruparPorCobertura(planes) {
      const grupos = { 90: [], 80: [], 70: [], 60: [], otros: [] };
      planes.forEach(p => {
        if (p.coberturaPromedio >= 85) { grupos[90].push(p); } 
        else if (p.coberturaPromedio >= 75 && p.coberturaPromedio < 85) { grupos[80].push(p); } 
        else if (p.coberturaPromedio >= 65 && p.coberturaPromedio < 75) { grupos[70].push(p); } 
        else if (p.coberturaPromedio >= 55 && p.coberturaPromedio < 65) { grupos[60].push(p); } 
        else { grupos.otros.push(p); }
      });
      Object.keys(grupos).forEach(key => { grupos[key].sort((a, b) => a.diferencia - b.diferencia); });
      return grupos;
    }
    function seleccionarMejoresPorCobertura(planes) {
      const grupos = agruparPorCobertura(planes);
      const resultado = [];
      if (grupos[90].length > 0) resultado.push(grupos[90][0]);
      if (grupos[80].length > 0) resultado.push(grupos[80][0]);
      if (grupos[70].length > 0) resultado.push(grupos[70][0]);
      if (grupos[60].length > 0) resultado.push(grupos[60][0]);
      if (resultado.length < 2 && grupos.otros.length > 0) resultado.push(grupos.otros[0]);
      return resultado;
    }
    if (planesIdeales.length > 0) {
      const planesSeleccionados = seleccionarMejoresPorCobertura(planesIdeales);
      return { plan1: planesSeleccionados[0] || null, plan2: planesSeleccionados[1] || null, plan3: planesSeleccionados[2] || null, plan4: planesSeleccionados[3] || null, fuente: `Planes ideales diferenciados en ${zona}`, coberturas: planesSeleccionados.map(p => p.coberturaPromedio) };
    }
    let planesAlternativos = planesZona.filter(p => p.valorCalculadoUF >= sieteUF * 0.85 && p.valorCalculadoUF <= sieteUF * 1.30);
    if (planesAlternativos.length === 0) {
      const planesLibres = PLANES.filter(p => p.zona === 'LIBRE_ELECCION');
      const planesLibresConValor = planesLibres.map(p => {
        const calc = calcularValorPlan(p.pb_uf, edadTitular, edadesCargas);
        const diferencia = Math.abs(calc.totalUF - sieteUF);
        let coberturaPromedio = 0;
        if (p.coberturas_redes && Object.keys(p.coberturas_redes).length > 0) {
          const coberturas = Object.values(p.coberturas_redes);
          coberturaPromedio = Math.round(coberturas.reduce((a, b) => a + b, 0) / coberturas.length);
        }
        return { ...p, valorCalculadoUF: calc.totalUF, valorCalculadoCLP: calc.totalCLP, gesUF: calc.gesUF, gesCLP: calc.gesCLP, sumaFactores: calc.sumaFactores, diferencia: diferencia, exceso: Math.max(0, calc.totalUF - sieteUF), coberturaPromedio: coberturaPromedio };
      });
      planesAlternativos = planesLibresConValor.filter(p => p.valorCalculadoUF >= sieteUF * 0.85 && p.valorCalculadoUF <= sieteUF * 1.30);
    }
    const planesSeleccionados = seleccionarMejoresPorCobertura(planesAlternativos);
    return { plan1: planesSeleccionados[0] || null, plan2: planesSeleccionados[1] || null, plan3: planesSeleccionados[2] || null, plan4: planesSeleccionados[3] || null, fuente: `Planes alternativos diferenciados`, coberturas: planesSeleccionados.map(p => p.coberturaPromedio) };
  }

  function generarTablaEjecutiva(plan1, plan2, plan3, sieteUF, sieteCLP) {
    const planes = [plan1, plan2, plan3].filter(p => p);
    if (planes.length === 0) return '';
    let html = `
      <div style="margin-top:30px; margin-bottom:30px;">
        <h3 style="color:#d4af37; text-align:center; font-size:1.3rem; margin-bottom:20px;">üìä RESUMEN EJECUTIVO - 3 PLANES M√ÅS CERCANOS AL 7%</h3>
        <div style="overflow-x: auto; background:#112233; border-radius:15px; border:1px solid #d4af37; padding:0;">
          <table style="width:100%; border-collapse:collapse; font-size:0.95rem;">
            <thead>
              <tr style="background:linear-gradient(90deg, #1a3a5a, #0f2640); border-bottom:2px solid #d4af37;">
                <th style="padding:15px; text-align:left; color:#d4af37; font-weight:bold; border-right:1px solid #3a5a7a;">Plan</th>
                <th style="padding:15px; text-align:center; color:#d4af37; font-weight:bold; border-right:1px solid #3a5a7a;">C√≥digo</th>
                <th style="padding:15px; text-align:center; color:#d4af37; font-weight:bold; border-right:1px solid #3a5a7a;">Costo Mensual</th>
                <th style="padding:15px; text-align:center; color:#d4af37; font-weight:bold; border-right:1px solid #3a5a7a;">Diferencia al 7%</th>
                <th style="padding:15px; text-align:left; color:#d4af37; font-weight:bold; border-right:1px solid #3a5a7a;">Cobertura Hospitalaria</th>
                <th style="padding:15px; text-align:left; color:#d4af37; font-weight:bold;">Consultas</th>
              </tr>
            </thead>
            <tbody>
    `;
    planes.forEach((plan, idx) => {
      const uf = window.__UF_VALOR || 39700;
      const diferencia = plan.valorCalculadoUF - sieteUF;
      const diferenciaCLP = Math.round(diferencia * uf);
      const diferenciaPorcentaje = ((diferencia / sieteUF) * 100).toFixed(1);
      let coberturaHospitalaria = "No especificada";
      if (plan.hospitalizacion) {
        coberturaHospitalaria = plan.hospitalizacion.replace(/%G41=/g, "G41: ").replace(/%G42=/g, " | G42: ").replace(/%G43=/g, " | G43: ").replace(/%G44=/g, " | G44: ").replace(/%G45=/g, " | G45: ").replace(/%G46=/g, " | G46: ").substring(0, 80) + "...";
      }
      let consultaTexto = "Libre Elecci√≥n";
      if (plan.consulta) {
        if (plan.consulta.tipo === 'preferente') {
          consultaTexto = "Preferente: " + plan.consulta.valor;
        } else {
          consultaTexto = "Libre Elecci√≥n: " + plan.consulta.valor;
        }
      }
      const bgColor = idx === 0 ? "#1a3a5a" : "#112233";
      const borderColor = idx === 0 ? "#d4af37" : "#3a5a7a";
      html += `
        <tr style="background:${bgColor}; border-bottom:1px solid ${borderColor};">
          <td style="padding:15px; border-right:1px solid #2a3a4a; color:#fff; font-weight:${idx === 0 ? 'bold' : 'normal'};">
            ${idx === 0 ? 'ü•á ' : (idx === 1 ? 'ü•à ' : 'ü•â ')}${plan.plan}
          </td>
          <td style="padding:15px; border-right:1px solid #2a3a4a; color:#fbbf24; text-align:center; font-weight:bold;">
            ${plan.codigo}
          </td>
          <td style="padding:15px; border-right:1px solid #2a3a4a; text-align:center;">
            <div style="color:#4ade80; font-weight:bold; font-size:1.05rem;">$${plan.valorCalculadoCLP.toLocaleString("es-CL")}</div>
            <div style="color:#888; font-size:0.85rem;">${plan.valorCalculadoUF.toFixed(2)} UF</div>
          </td>
          <td style="padding:15px; border-right:1px solid #2a3a4a; text-align:center;">
            <div style="color:${diferencia < 0 ? '#4ade80' : '#fbbf24'}; font-weight:bold;">
              ${diferencia < 0 ? '‚àí' : '+'}$${Math.abs(diferenciaCLP).toLocaleString("es-CL")}
            </div>
            <div style="color:#888; font-size:0.85rem;">${diferenciaPorcentaje > 0 ? '+' : ''}${diferenciaPorcentaje}%</div>
          </td>
          <td style="padding:15px; border-right:1px solid #2a3a4a; color:#b8c5d6; font-size:0.9rem;">
            ${coberturaHospitalaria}
          </td>
          <td style="padding:15px; color:#b8c5d6; font-size:0.9rem;">
            ${consultaTexto}
          </td>
        </tr>
      `;
    });
    html += `
            </tbody>
          </table>
        </div>
        <div style="margin-top:15px; padding:15px; background:#1a2a3a; border-radius:10px; border-left:4px solid #4ade80;">
          <p class="small" style="margin:0; color:#b8c5d6;">
            <strong>üí° Referencia:</strong> Tu aporte legal (7%) es de <strong style="color:#4ade80;">$${sieteCLP.toLocaleString("es-CL")}</strong>. 
            Los planes mostrados son los m√°s cercanos a este monto, con la opci√≥n de pagar adicional o recibir subsidio.
          </p>
        </div>
      </div>
    `;
    return html;
  }

  function generarHTMLPlan(plan, numero, sieteUF, sieteCLP, montoAdicional = 0) {
    if (!plan) return '';
    const uf = window.__UF_VALOR || 39700;
    const adicionalUF = Math.max(0, plan.valorCalculadoUF - sieteUF - (montoAdicional / uf));
    const adicionalCLP = Math.round(adicionalUF * uf);
    const esPrincipal = numero === 1;
    const badgeClass = esPrincipal ? 'principal' : 'secundario';
    const cardClass = esPrincipal ? '' : 'secundario';
    let badgeText = '';
    if (numero === 1) badgeText = 'ü•á MEJOR OPCI√ìN';
    else if (numero === 2) badgeText = 'ü•à ALTERNATIVA 2';
    else if (numero === 3) badgeText = 'ü•â ALTERNATIVA 3';
    else badgeText = '‚≠ê ALTERNATIVA 4';
    let coberturasHTML = '';
    if (plan.hospitalizacion) {
      coberturasHTML = `
        <div class="coberturas-section">
          <div class="coberturas-title">üìä Cobertura Hospitalaria</div>
          <div class="coberturas-texto">${plan.hospitalizacion.replace(/\n/g, '<br>')}</div>
        </div>
      `;
    }
    let consultaHTML = '';
    if (plan.consulta) {
      const consultaTipo = plan.consulta.tipo === 'preferente' ? 'Consulta Preferente Ambulatoria' : 'Consulta Libre Elecci√≥n';
      consultaHTML = `
        <div class="coberturas-section">
          <div class="coberturas-title">üè• ${consultaTipo}</div>
          <div class="coberturas-texto">${plan.consulta.valor}</div>
        </div>
      `;
    }
    return `
      <div class="plan-card ${cardClass}">
        <span class="plan-badge ${badgeClass}">${badgeText}</span>
        <div class="plan-nombre-container">
          <span class="plan-nombre-estrella">‚òÖ</span>
          <span class="plan-nombre">${plan.plan} <span style="font-size: 0.8rem; color: #aaa;">(${plan.codigo})</span></span>
          <span class="plan-nombre-estrella">‚òÖ</span>
        </div>
        <div class="plan-info">
          <div class="plan-info-item">
            <div class="plan-info-label">Valor del Plan</div>
            <div class="plan-info-value">$${formatearCLP(plan.valorCalculadoCLP)}</div>
            <div class="small">${plan.valorCalculadoUF.toFixed(2)} UF</div>
          </div>
          <div class="plan-info-item">
            <div class="plan-info-label">Adicional a pagar</div>
            <div class="plan-info-value ${adicionalCLP <= 0 ? 'verde' : 'amarillo'}">$${formatearCLP(Math.max(0, adicionalCLP))}</div>
          </div>
          <div class="plan-info-item">
            <div class="plan-info-label">GES incluido</div>
            <div class="plan-info-value verde">$${formatearCLP(plan.gesCLP)}</div>
            <div class="small">${plan.gesUF.toFixed(2)} UF</div>
          </div>
          <div class="plan-info-item">
            <div class="plan-info-label">Tope anual</div>
            <div class="plan-info-value">${formatearCLP(plan.tope_anual_uf || 7000)} UF</div>
          </div>
        </div>
        ${coberturasHTML}
        ${consultaHTML}
      </div>
    `;
  }

  document.getElementById("mainForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const btn = document.getElementById("submitBtn");
    const statusMsg = document.getElementById("statusMsg");
    btn.disabled = true;
    btn.textContent = "Calculando...";
    statusMsg.textContent = "";
    contadorRecalculos = 0;
    const data = new FormData(this);
    formularioDatos = {
      nombre: data.get("nombre"),
      correo: data.get("correo"),
      telefono: data.get("telefono"),
      edad: data.get("edad"),
      rut: data.get("rut"),
      isapre: data.get("isapre"),
      renta: data.get("renta"),
      cargas: data.get("cargas"),
      region: data.get("region"),
      mensaje: data.get("mensaje")
    };
    const camposObligatorios = ['nombre', 'correo', 'telefono', 'edad', 'rut', 'isapre', 'renta', 'region'];
    const faltanCampos = camposObligatorios.filter(campo => !formularioDatos[campo]);
    if (faltanCampos.length > 0) {
      statusMsg.textContent = "‚ùå Por favor completa todos los campos requeridos";
      statusMsg.className = "small error-msg";
      btn.disabled = false;
      btn.textContent = "Cotizar Ahora";
      return;
    }
    const uf = window.__UF_VALOR || 39700;
    const renta = Number(formularioDatos.renta);
    const edadTitular = Number(formularioDatos.edad);
    const cargasTexto = (formularioDatos.cargas || "").replace(/\n/g, ", ").trim();
    const edadesCargas = cargasTexto.split(/[\n,;]+/).map(s => s.trim()).filter(Boolean).map(Number).filter(n => !isNaN(n) && n >= 0 && n <= 120);
    const calcSiete = calcularSietePorCiento(renta, uf);
    const sieteCLP = calcSiete.sietePorCientoCLP;
    const sieteUF = calcSiete.sietePorCientoUF;
    const rtiAplicado = calcSiete.rtiAplicado;
    const zona = REGION_A_ZONA[formularioDatos.region] || 'SANTIAGO';
    const { plan1, plan2, plan3, plan4, fuente, coberturas } = seleccionarPlanes(sieteUF, zona, edadTitular, edadesCargas, formularioDatos.region);
    ultimoResultado = { sieteCLP, sieteUF, edadesCargas, cargasTexto, zona, plan1, plan2, plan3, plan4, edadTitular };
    try {
      const plan1Nombre = plan1 ? plan1.plan : 'Sin plan disponible';
      const plan2Nombre = plan2 ? plan2.plan : 'Sin plan disponible';
      const params = new URLSearchParams();
      params.append(FORM_FIELDS.nombre, formularioDatos.nombre);
      params.append(FORM_FIELDS.rut, formularioDatos.rut);
      params.append(FORM_FIELDS.correo, formularioDatos.correo);
      params.append(FORM_FIELDS.telefono, formularioDatos.telefono);
      params.append(FORM_FIELDS.edad, formularioDatos.edad);
      params.append(FORM_FIELDS.isapre, formularioDatos.isapre);
      params.append(FORM_FIELDS.renta, formularioDatos.renta);
      params.append(FORM_FIELDS.region, formularioDatos.region);
      params.append(FORM_FIELDS.cargas, cargasTexto || 'Sin cargas');
      params.append(FORM_FIELDS.mensaje, formularioDatos.mensaje || "(sin mensaje)");
      params.append(FORM_FIELDS.plan1, plan1Nombre);
      params.append(FORM_FIELDS.plan2, plan2Nombre);
      params.append(FORM_FIELDS.asesorid, asesorKey);
      fetch(FORM_BASE_URL, { method: "POST", headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body: params.toString() }).catch(() => {});
      statusMsg.textContent = "‚úÖ Datos enviados correctamente";
      statusMsg.className = "small success-msg";
    } catch (err) {
      statusMsg.textContent = "‚ö†Ô∏è Error al enviar";
      statusMsg.className = "small error-msg";
    }
    const resultadoDetalle = document.getElementById("resultadoDetalle");
    let htmlResultado = `
      <div class="resumen-cotizacion">
        <div class="resumen-titulo">üìä Resumen de tu Cotizaci√≥n</div>
        <div class="resumen-grid">
          <div class="resumen-item">
            <div class="resumen-label">Tu Renta Mensual</div>
            <div class="resumen-value">$${formatearCLP(renta)}</div>
          </div>
          <div class="resumen-item">
            <div class="resumen-label">7% Legal (Aporte)</div>
            <div class="resumen-value destacado">$${formatearCLP(sieteCLP)}</div>
            <div class="resumen-uf">${sieteUF.toFixed(2)} UF</div>
          </div>
          <div class="resumen-item">
            <div class="resumen-label">Titular</div>
            <div class="resumen-value">${edadTitular} a√±os</div>
          </div>
          <div class="resumen-item">
            <div class="resumen-label">Cargas Familiares</div>
            <div class="resumen-value">${edadesCargas.length}</div>
            <div class="resumen-uf">${cargasTexto || 'Sin cargas'}</div>
          </div>
          <div class="resumen-item">
            <div class="resumen-label">Zona de Cobertura</div>
            <div class="resumen-value">${zona}</div>
          </div>
        </div>
        ${rtiAplicado ? '<p class="small" style="color:#fbbf24; margin-top:10px;">‚ö†Ô∏è Nota: Se aplic√≥ l√≠mite RTI de 87.8 UF en renta imponible</p>' : ''}
      </div>
    `;
    htmlResultado += generarTablaEjecutiva(plan1, plan2, plan3, sieteUF, sieteCLP);
    if (plan1) htmlResultado += generarHTMLPlan(plan1, 1, sieteUF, sieteCLP, 0);
    if (plan2) htmlResultado += generarHTMLPlan(plan2, 2, sieteUF, sieteCLP, 0);
    if (plan3) htmlResultado += generarHTMLPlan(plan3, 3, sieteUF, sieteCLP, 0);
    if (plan4) htmlResultado += generarHTMLPlan(plan4, 4, sieteUF, sieteCLP, 0);
    htmlResultado += `
      <div class="mejorar-cobertura">
        <div class="mejorar-titulo">üí∞ ¬øQuieres Mejorar tu Cobertura?</div>
        <p class="mejorar-texto">Ingresa un monto adicional mensual para ver planes con m√°s beneficios:</p>
        <div class="mejorar-input-container">
          <input type="number" id="inputAdicional" class="mejorar-input" placeholder="Ej: 50000" min="0" />
          <button type="button" id="btnRecalcular" class="btn-recalcular">üîÑ Recalcular</button>
        </div>
        <p class="small" style="color:#888; margin-top:10px;">Podr√°s recalcular hasta 2 veces. Rec√°lculos restantes: <span id="recalculosRestantes">${MAX_RECALCULOS - contadorRecalculos}</span></p>
      </div>
    `;
    resultadoDetalle.innerHTML = htmlResultado;
    document.getElementById("resultado-preliminar").style.display = "block";
    document.getElementById("btnRecalcular").addEventListener("click", recalcularConAdicional);
    document.getElementById("btnAsesoria").addEventListener("click", function() {
      const sieteCLPMsg = sieteCLP.toLocaleString("es-CL");
      const plan1Msg = plan1 ? plan1.plan : "No disponible";
      const plan2Msg = plan2 ? plan2.plan : "No disponible";
      const mensaje = `Hola ${ASESOR_NOMBRE}, quisiera recibir asesor√≠a sobre mis opciones de planes. Mi 7% es $${sieteCLPMsg}. Planes recomendados: ${plan1Msg} y ${plan2Msg}. Mis cargas son: ${cargasTexto || 'sin cargas'}.`;
      const urlWA = `https://wa.me/${WHATSAPP_ASESORIA}?text=${encodeURIComponent(mensaje)}`;
      window.open(urlWA, "_blank");
    });
    document.getElementById("btnBuscarClinicaDesdeResultados").addEventListener("click", mostrarBusquedaClinica);
    document.getElementById("btnBuscarClinicaFormulario").addEventListener("click", mostrarBusquedaClinica);
    function mostrarBusquedaClinica() {
      document.getElementById("seccionBusquedaClinica").style.display = "block";
      document.getElementById("seccionBusquedaClinica").scrollIntoView({ behavior: "smooth", block: "start" });
    }
    btn.disabled = false;
    btn.textContent = "Cotizar Ahora";
  });

  function recalcularConAdicional() {
    if (contadorRecalculos >= MAX_RECALCULOS) {
      alert(`‚ùå Has alcanzado el m√°ximo de ${MAX_RECALCULOS} rec√°lculos. Contacta a ${ASESOR_NOMBRE} para m√°s opciones.`);
      return;
    }
    const inputAdicional = document.getElementById("inputAdicional").value;
    if (!inputAdicional || isNaN(inputAdicional) || Number(inputAdicional) < 0) {
      alert("Por favor ingresa un monto v√°lido");
      return;
    }
    const montoAdicional = Number(inputAdicional);
    const uf = window.__UF_VALOR || 39700;
    const nuevoPresupuesto = ultimoResultado.sieteCLP + montoAdicional;
    const nuevoPresupuestoUF = nuevoPresupuesto / uf;
    const { plan1, plan2, plan3, plan4 } = seleccionarPlanes(nuevoPresupuestoUF, ultimoResultado.zona, ultimoResultado.edadTitular, ultimoResultado.edadesCargas, formularioDatos.region);
    contadorRecalculos++;
    let htmlNuevos = `
      <div style="margin-top:40px; padding:20px; background:#1a2a3a; border-left:4px solid #4ade80; border-radius:10px;">
        <h3 style="color:#4ade80; margin-top:0;">Rec√°lculo #${contadorRecalculos} - Presupuesto Ampliado</h3>
        <p class="small">Nuevo presupuesto: <strong>$${formatearCLP(nuevoPresupuesto)}</strong> (${nuevoPresupuestoUF.toFixed(2)} UF)</p>
        <div style="margin-top:15px;">
    `;
    if (plan1) htmlNuevos += generarHTMLPlan(plan1, 1, nuevoPresupuestoUF, nuevoPresupuesto, montoAdicional);
    if (plan2) htmlNuevos += generarHTMLPlan(plan2, 2, nuevoPresupuestoUF, nuevoPresupuesto, montoAdicional);
    if (plan3) htmlNuevos += generarHTMLPlan(plan3, 3, nuevoPresupuestoUF, nuevoPresupuesto, montoAdicional);
    if (plan4) htmlNuevos += generarHTMLPlan(plan4, 4, nuevoPresupuestoUF, nuevoPresupuesto, montoAdicional);
    htmlNuevos += `
        </div>
      </div>
    `;
    document.getElementById("resultadoDetalle").innerHTML += htmlNuevos;
    document.getElementById("recalculosRestantes").textContent = MAX_RECALCULOS - contadorRecalculos;
    if (contadorRecalculos >= MAX_RECALCULOS) {
      document.getElementById("btnRecalcular").disabled = true;
      document.getElementById("btnRecalcular").textContent = "M√°ximo de rec√°lculos alcanzado";
    }
    ultimoResultado = { ...ultimoResultado, sieteCLP: nuevoPresupuesto, sieteUF: nuevoPresupuestoUF, plan1, plan2, plan3, plan4 };
  }

  document.getElementById("btnBuscarClinica").addEventListener("click", function() {
    const nombreClinica = document.getElementById("inputBuscadorClinica").value.trim().toUpperCase();
    if (!nombreClinica) {
      alert("Por favor ingresa el nombre de la cl√≠nica");
      return;
    }
    const resultadoDiv = document.getElementById("resultadoBusquedaClinica");
    resultadoDiv.innerHTML = '<p class="small">üîç Buscando cl√≠nicas...</p>';
    let clinicasEncontradas = [];
    for (const [grupo, clinicas] of Object.entries(GRUPOS_GX)) {
      clinicas.forEach(clinica => {
        if (clinica.nombre.toUpperCase().includes(nombreClinica)) {
          clinicasEncontradas.push({ clinica, grupo });
        }
      });
    }
    if (clinicasEncontradas.length === 0) {
      resultadoDiv.innerHTML = '<p class="small error-msg">‚ùå No encontramos cl√≠nicas con ese nombre. Intenta con otro nombre.</p>';
      return;
    }
    let html = `
      <div style="margin-top:20px; padding:20px; background:linear-gradient(135deg, #0f2640, #1a3a5a); border-radius:15px; border:1px solid #4ade80;">
        <h3 style="color:#4ade80; margin-top:0;">‚úÖ Cl√≠nicas Encontradas (${clinicasEncontradas.length})</h3>
        <div style="margin-bottom:20px;">
    `;
    clinicasEncontradas.forEach(({ clinica, grupo }) => {
      html += `
        <div style="background:#112233; padding:15px; margin-bottom:12px; border-radius:8px; border-left:3px solid #4ade80;">
          <p style="margin:0; color:#4ade80; font-weight:bold;">${clinica.nombre}</p>
          <p style="margin:5px 0; color:#888; font-size:0.9rem;">${clinica.ciudad} - ${clinica.region}</p>
          <p style="margin:5px 0; color:#d4af37; font-size:0.85rem; font-weight:bold;">üìç ${grupo}</p>
        </div>
      `;
    });
    html += `</div>`;
    if (ultimoResultado && ultimoResultado.plan1) {
      html += `
        <div style="margin-top:20px; padding:20px; background:#1a2a3a; border-radius:10px; border-left:4px solid #d4af37;">
          <h4 style="color:#d4af37; margin-top:0;">üìã Planes que cubren estas cl√≠nicas</h4>
          <p class="small" style="color:#b8c5d6; margin-bottom:15px;">Los siguientes planes tienen cobertura en la red de cl√≠nicas encontradas:</p>
          <div style="display:grid; gap:12px;">
      `;
      const planesRecomendados = [ultimoResultado.plan1, ultimoResultado.plan2, ultimoResultado.plan3, ultimoResultado.plan4].filter(p => p);
      planesRecomendados.forEach((plan, idx) => {
        if (!plan) return;
        const tieneCobertura = plan.coberturas_redes && Object.keys(plan.coberturas_redes).length > 0;
        const coberturaTexto = tieneCobertura ? `Con cobertura de ${Object.keys(plan.coberturas_redes).join(', ')}` : "Cobertura variable seg√∫n grupo";
        html += `
          <div style="background:#112233; padding:15px; border-radius:8px; border-left:3px solid #d4af37;">
            <p style="margin:0; color:#fff; font-weight:bold;">${plan.plan}</p>
            <p style="margin:5px 0; color:#888; font-size:0.9rem;">${coberturaTexto}</p>
            <p style="margin:5px 0; color:#4ade80; font-weight:bold;">$${formatearCLP(plan.valorCalculadoCLP)} (${plan.valorCalculadoUF.toFixed(2)} UF)</p>
          </div>
        `;
      });
      html += `
          </div>
          <button type="button" id="btnEnviarClinica" class="btn-enviar-clinica" style="width:100%; margin-top:20px;">üì≤ Solicitar Informaci√≥n de Cobertura</button>
        </div>
      `;
    }
    html += `</div>`;
    resultadoDiv.innerHTML = html;
    resultadoDiv.classList.add("busqueda-clinica-resultado");
    document.getElementById("btnEnviarClinica").addEventListener("click", function() {
      const clinicasTexto = clinicasEncontradas.map(c => `${c.clinica.nombre} (${c.clinica.ciudad})`).join(", ");
      const planesTexto = [ultimoResultado.plan1, ultimoResultado.plan2, ultimoResultado.plan3, ultimoResultado.plan4].filter(p => p).map(p => p.plan).join(", ");
      const mensaje = `Hola ${ASESOR_NOMBRE}, estoy interesado en conocer la cobertura exacta de mis planes en las siguientes cl√≠nicas: ${clinicasTexto}. Mis planes cotizados son: ${planesTexto}.`;
      const urlWA = `https://wa.me/${WHATSAPP_ASESORIA}?text=${encodeURIComponent(mensaje)}`;
      window.open(urlWA, "_blank");
    });
  });

  document.getElementById("inputBuscadorClinica").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      document.getElementById("btnBuscarClinica").click();
    }
  });

  document.getElementById("btnEnviarUsuario").addEventListener("click", function() {
    if (!ultimoResultado || !ultimoResultado.plan1) {
      alert("Por favor cotiza primero");
      return;
    }
    const sieteCLPMsg = ultimoResultado.sieteCLP.toLocaleString("es-CL");
    const plan1 = ultimoResultado.plan1.plan;
    const plan2 = ultimoResultado.plan2 ? ultimoResultado.plan2.plan : "No disponible";
    const cargasMsg = ultimoResultado.cargasTexto || "Sin cargas";
    const mensaje = `Hola ${ASESOR_NOMBRE}, \n\nQuisiera recibir el resumen de mi cotizaci√≥n y documentos requeridos para afiliaci√≥n.\n\n*Mi Informaci√≥n:*\n‚Ä¢ Nombre: ${formularioDatos.nombre}\n‚Ä¢ Rut: ${formularioDatos.rut}\n‚Ä¢ Edad: ${formularioDatos.edad}\n‚Ä¢ Correo: ${formularioDatos.correo}\n‚Ä¢ 7% aporte: $${sieteCLPMsg}\n\n*Planes Recomendados:*\n‚Ä¢ Plan 1: ${plan1}\n‚Ä¢ Plan 2: ${plan2}\n\n*Cargas Familiares:* ${cargasMsg}\n\n¬øCu√°les son los documentos requeridos para formalizar la afiliaci√≥n?`;
    const urlWA = `https://wa.me/${WHATSAPP_ASESORIA}?text=${encodeURIComponent(mensaje)}`;
    window.open(urlWA, "_blank");
  });

  document.getElementById("formReferidos").addEventListener("submit", async function(e) {
    e.preventDefault();
    const nombreUsuario = document.getElementById("nombreUsuario").value;
    const nombreReferido = document.getElementById("nombreReferido").value;
    const telefonoReferido = document.getElementById("telefonoReferido").value;
    const correoReferido = document.getElementById("correoReferido").value;
    const params = new URLSearchParams();
    params.append(REFERIDOS_FIELDS.tu_nombre, nombreUsuario);
    params.append(REFERIDOS_FIELDS.nombre_referido, nombreReferido);
params.append(REFERIDOS_FIELDS.telefono_referido, telefonoReferido);
params.append(REFERIDOS_FIELDS.correo_referido, correoReferido);
params.append(REFERIDOS_FIELDS.mensaje_adicional, Referido realizado a trav√©s de ${asesorKey});
params.append(REFERIDOS_FIELDS.asesorid_referidos, asesorKey);
try {
fetch(GOOGLE_FORM_REFERIDOS_URL, {
method: "POST",
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: params.toString()
}).catch(() => {});
document.getElementById("mensajeExitoReferido").style.display = "block";
document.getElementById("mensajeErrorReferido").style.display = "none";
document.getElementById("formReferidos").reset();
setTimeout(() => {
document.getElementById("mensajeExitoReferido").style.display = "none";
}, 4000);
} catch (err) {
document.getElementById("mensajeErrorReferido").style.display = "block";
document.getElementById("mensajeExitoReferido").style.display = "none";
}
});
window.addEventListener("DOMContentLoaded", async function() {
await cargarUF();
await cargarPlanes();
await cargarRedesClincias();
if (ultimoResultado) {
document.getElementById("resultado-preliminar").style.display = "block";
document.getElementById("referidos").style.display = "block";
}
});
document.getElementById("mainForm").addEventListener("submit", function() {
setTimeout(() => {
document.getElementById("referidos").style.display = "block";
}, 1000);
});
</script>
</body>
</html>
```
