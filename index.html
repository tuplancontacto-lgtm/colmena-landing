<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Cotiza tu plan de salud Colmena Golden Cross. Asesor√≠a profesional y personalizada." />
  <title>Planes de Salud Colmena - Asesor√≠a Profesional</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background-color: #0a1a2a; color: white; margin: 0; padding: 0; line-height: 1.6; }
    
    /* Header */
    header { background: linear-gradient(135deg, #0a1a2a, #12375a); padding: 40px 20px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    h1 { color: #d4af37; font-size: clamp(1.8rem, 5vw, 2.5rem); margin: 0 0 10px 0; }
    h2 { color: #d4af37; font-size: clamp(1.3rem, 4vw, 1.8rem); }
    
    /* Layout */
    section { padding: 40px 20px; max-width: 900px; margin: auto; }
    .gold { color: #d4af37; }
    .card { background: #112233; border: 1px solid #d4af37; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    
    /* Buttons */
    button { background: #d4af37; color: #0a1a2a; padding: 15px 25px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; transition: all 0.3s; font-weight: 600; }
    button:hover { opacity: 0.85; transform: translateY(-2px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button:active { transform: translateY(0); }
    
    /* Forms */
    form label { display: block; color: #b8c5d6; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500; }
    form input, form select, form textarea { 
      width: 100%; 
      padding: 12px; 
      margin: 8px 0 16px 0; 
      border-radius: 8px; 
      border: 2px solid #2a3a4a; 
      background: #0a1a2a; 
      color: white; 
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    form input:focus, form select:focus, form textarea:focus { 
      outline: none; 
      border-color: #d4af37; 
      box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
    }
    form input.error, form select.error { border-color: #ff8080; }
    .field-error { color: #ff8080; font-size: 0.85rem; margin-top: -12px; margin-bottom: 12px; display: none; }
    .field-error.show { display: block; }
    
    .whatsapp { display: block; background: #25D366; text-align: center; padding: 15px; color: white; text-decoration: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 20px; max-width: 300px; margin-left: auto; margin-right: auto; transition: all 0.3s; }
    .whatsapp:hover { background: #1da851; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4); }
    
    .small { font-size: 0.9rem; color: #ccc; }
    .row { display:flex; gap:16px; flex-wrap: wrap; }
    .col { flex:1; min-width: 250px; }
    .success-msg { color: #4ade80; margin-top: 12px; font-weight: bold; }
    .error-msg { color: #ff8080; margin-top: 12px; }

    /* Loading skeleton */
    .skeleton { animation: pulse 1.5s ease-in-out infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .skeleton-card { background: #1a2a3a; height: 100px; border-radius: 10px; margin-bottom: 15px; }

    /* Resumen cotizaci√≥n */
    .resumen-cotizacion { background: linear-gradient(135deg, #0d1f2d, #1a2a3a); border: 1px solid #3a5a7a; border-radius: 10px; padding: 20px; margin-bottom: 25px; }
    .resumen-titulo { color: #d4af37; font-size: clamp(1.1rem, 3vw, 1.3rem); margin-bottom: 15px; font-weight: bold; text-align: center; }
    .resumen-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
    .resumen-item { text-align: center; padding: 15px; background: #112233; border-radius: 8px; }
    .resumen-label { font-size: 0.85rem; color: #888; margin-bottom: 5px; }
    .resumen-value { font-size: clamp(1rem, 3vw, 1.2rem); font-weight: bold; color: #fff; }
    .resumen-value.destacado { color: #4ade80; }
    .resumen-uf { font-size: 0.85rem; color: #aaa; }

    /* Card del plan */
    .plan-card { background: #112233; border: 2px solid #d4af37; border-radius: 15px; padding: 25px; margin: 25px 0; }
    .plan-card.secundario { border-color: #60a5fa; }
    .plan-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-bottom: 15px; }
    .plan-badge.principal { background: #d4af37; color: #0a1a2a; }
    .plan-badge.secundario { background: #60a5fa; color: #0a1a2a; }
    
    .plan-nombre-container { text-align: center; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #1a3a5a, #0d1f2d); border-radius: 12px; border: 2px solid #d4af37; }
    .plan-nombre { font-size: clamp(1.2rem, 4vw, 1.8rem); font-weight: bold; color: #d4af37; text-shadow: 0 2px 10px rgba(212,175,55,0.3); letter-spacing: 1px; word-break: break-word; }
    .plan-nombre-estrella { color: #fbbf24; font-size: clamp(1rem, 3vw, 1.5rem); }

    .plan-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0; }
    .plan-info-item { background: #1a2a3a; padding: 15px; border-radius: 8px; text-align: center; }
    .plan-info-label { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
    .plan-info-value { font-size: clamp(0.95rem, 2.5vw, 1.1rem); font-weight: bold; color: #fff; }
    .plan-info-value.verde { color: #4ade80; }
    .plan-info-value.amarillo { color: #fbbf24; }

    .coberturas-section { margin: 20px 0; padding: 15px; background: #0d1f2d; border-radius: 10px; }
    .coberturas-title { color: #d4af37; font-size: 1rem; margin-bottom: 10px; }
    .coberturas-texto { font-size: 0.9rem; line-height: 1.6; color: #ccc; }

    /* Cl√≠nicas */
    .clinicas-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid #3a5a7a; }
    .clinicas-title { color: #d4af37; font-size: 1.1rem; margin-bottom: 15px; }
    .grupos-tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .grupo-tab { background: #1a2a3a; border: 1px solid #3a5a7a; color: #ccc; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
    .grupo-tab:hover { border-color: #d4af37; color: #d4af37; }
    .grupo-tab.active { background: #d4af37; color: #0a1a2a; border-color: #d4af37; font-weight: bold; }
    .clinicas-tabla { width: 100%; border-collapse: collapse; font-size: 0.9rem; overflow-x: auto; display: block; }
    .clinicas-tabla thead { display: table; width: 100%; table-layout: fixed; }
    .clinicas-tabla tbody { display: table; width: 100%; table-layout: fixed; }
    .clinicas-tabla th { background: #1a3a5a; color: #d4af37; padding: 12px 15px; text-align: left; }
    .clinicas-tabla td { padding: 10px 15px; border-bottom: 1px solid #2a3a4a; }
    .clinicas-tabla tr:nth-child(even) { background: #0d1f2d; }
    .clinicas-tabla tr:nth-child(odd) { background: #112233; }
    .clinicas-tabla tr:hover { background: #1a3a4a; }
    .grupo-content { display: none; }
    .grupo-content.active { display: block; }

    .btn-asesoria { display: inline-block; background: linear-gradient(135deg, #d4af37, #f0c860); color: #0a1a2a; padding: 18px 40px; text-decoration: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 15px rgba(212,175,55,0.4); transition: all .3s ease; border: none; cursor: pointer; }
    .btn-asesoria:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,175,55,0.6); }

    /* Referidos */
    .referidos-section { background: linear-gradient(135deg,#0f2640 0%,#1a3a5a 100%); padding:60px 20px; margin:40px 0; }
    .referidos-container { max-width:800px; margin:0 auto; background:#112233; padding:40px 20px; border-radius:20px; border:1px solid #d4af37; }
    .referidos-header { text-align:center; margin-bottom:30px; }
    .referidos-header h2 { color:#d4af37; font-size:clamp(1.3rem, 4vw, 28px); margin-bottom:15px; }
    .referidos-header p { color:#b8c5d6; font-size:16px; }
    .form-section { background:#1a2a3a; padding:25px; border-radius:15px; border-left:4px solid #d4af37; margin-bottom: 20px; }
    .form-section h3 { color:#d4af37; font-size:18px; margin-bottom:15px; margin-top: 0; }
    .btn-enviar-referido { background:linear-gradient(135deg,#d4af37,#f0c860); color:#0a1a2a; padding:15px 40px; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; width:100%; }
    .mensaje-exito-referido, .mensaje-error-referido { padding:15px; border-radius:10px; margin-top:20px; display:none; font-weight:600; text-align:center; }
    .mensaje-exito-referido { background:#1a4d2e; color:#4ade80; border:1px solid #4ade80; }
    .mensaje-error-referido { background:#4a1a1a; color:#ff8080; border:1px solid #ff8080; }

    .disclaimer { background: #1a2a3a; border-left: 4px solid #fbbf24; padding: 15px 20px; margin: 20px 0; border-radius: 0 8px 8px 0; font-size: 0.85rem; color: #b8c5d6; font-style: italic; }
    .disclaimer-icon { color: #fbbf24; margin-right: 8px; }

    .mejorar-cobertura { background: linear-gradient(135deg, #0f2640, #1a3a5a); border: 2px solid #4ade80; border-radius: 15px; padding: 30px 20px; margin: 30px 0; text-align: center; }
    .mejorar-titulo { color: #4ade80; font-size: clamp(1.1rem, 3vw, 1.3rem); margin-bottom: 15px; }
    .mejorar-texto { color: #b8c5d6; font-size: 1rem; line-height: 1.6; margin-bottom: 20px; }
    .mejorar-input-container { display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; margin-top: 20px; }
    .mejorar-input { width: 200px; padding: 15px; font-size: 1.1rem; border: 2px solid #4ade80; border-radius: 10px; background: #0a1a2a; color: white; text-align: center; }
    .mejorar-input:focus { outline: none; border-color: #d4af37; box-shadow: 0 0 10px rgba(212,175,55,0.3); }
    .btn-recalcular { background: linear-gradient(135deg, #4ade80, #22c55e); color: #0a1a2a; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .btn-recalcular:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(74,222,128,0.4); }
    .adicional-actual { background: #112233; padding: 15px 25px; border-radius: 10px; margin: 15px 0; display: inline-block; }
    .adicional-label { color: #888; font-size: 0.9rem; }
    .adicional-valor { color: #4ade80; font-size: clamp(1.1rem, 3vw, 1.3rem); font-weight: bold; }

    .btn-enviar-usuario { background: linear-gradient(135deg, #25d366, #128c7e); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-top: 15px; display: block; width: 100%; max-width: 350px; margin-left: auto; margin-right: auto; }
    .btn-enviar-usuario:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(37,211,102,0.4); }

    /* Toast notifications */
    .toast { position: fixed; bottom: 20px; right: 20px; background: #112233; border: 2px solid #4ade80; border-radius: 10px; padding: 15px 20px; color: white; box-shadow: 0 4px 20px rgba(0,0,0,0.4); z-index: 1000; animation: slideIn 0.3s ease; }
    .toast.error { border-color: #ff8080; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    @media (max-width: 768px) {
      .plan-nombre { font-size: 1.2rem; }
      .clinicas-tabla th, .clinicas-tabla td { padding: 8px 10px; font-size: 0.85rem; }
      .mejorar-input { width: 100%; max-width: 250px; }
      .col { min-width: 100%; }
      .resumen-grid { grid-template-columns: 1fr; }
      header { padding: 30px 15px; }
      section { padding: 30px 15px; }
    }

    @media (max-width: 480px) {
      .plan-info { grid-template-columns: 1fr; }
      .btn-asesoria { padding: 15px 25px; font-size: 1rem; }
    }
  </style>
</head>
<body>

<header>
  <h1>Asesor√≠a en Planes de Salud Colmena</h1>
  <p class="gold">Atenci√≥n premium para clientes exigentes</p>
  <p class="small">Completa el formulario para obtener una cotizaci√≥n exacta en UF y CLP.</p>
</header>

<section id="formulario" class="card">
  <h2 class="gold">Formulario para C√°lculo del Plan</h2>

  <form id="mainForm" novalidate>
    <div class="row">
      <div class="col">
        <label for="nombre">Nombre completo *</label>
        <input type="text" name="nombre" id="nombre" required aria-required="true" />
        <div class="field-error" id="error-nombre">Por favor ingresa tu nombre completo</div>
      </div>
      <div class="col">
        <label for="correo">Correo electr√≥nico *</label>
        <input type="email" name="correo" id="correo" required aria-required="true" />
        <div class="field-error" id="error-correo">Por favor ingresa un correo v√°lido</div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="telefono">Tel√©fono *</label>
        <input type="tel" name="telefono" id="telefono" placeholder="+56912345678" required aria-required="true" />
        <div class="field-error" id="error-telefono">Formato: +56912345678</div>
      </div>
      <div class="col">
        <label for="edad">Edad titular *</label>
        <input type="number" name="edad" id="edad" min="18" max="99" required aria-required="true" />
        <div class="field-error" id="error-edad">Edad debe estar entre 18 y 99 a√±os</div>
      </div>
    </div>

    <label for="rut">RUT *</label>
    <input type="text" name="rut" id="rut" placeholder="12.345.678-9" required aria-required="true" />
    <div class="field-error" id="error-rut">RUT inv√°lido. Formato: 12.345.678-9</div>

    <label for="isapre">Isapre actual *</label>
    <select name="isapre" id="isapre" required aria-required="true">
      <option value="">Selecciona tu isapre</option>
      <option>FONASA</option>
      <option>Colmena</option>
      <option>Cruz Blanca</option>
      <option>Consalud</option>
      <option>Banm√©dica</option>
      <option>Vida Tres</option>
      <option>Nueva Masvida</option>
      <option>Esencial</option>
    </select>
    <div class="field-error" id="error-isapre">Por favor selecciona tu isapre actual</div>

    <label for="renta">Renta imponible mensual (CLP) *</label>
    <input type="number" id="renta" name="renta" min="0" step="1000" required aria-required="true" />
    <div class="field-error" id="error-renta">Por favor ingresa tu renta imponible</div>

    <label for="cargas">Edad de las cargas (separadas por coma)</label>
    <textarea name="cargas" id="cargas" placeholder="Ej: 5, 12, 30" rows="2"></textarea>
    <p class="small" style="margin-top: -8px;">Opcional: ingresa las edades separadas por comas</p>

    <label for="region">Regi√≥n *</label>
    <select name="region" id="region" required aria-required="true">
      <option value="">Selecciona tu Regi√≥n</option>
      <option value="Arica y Parinacota">Regi√≥n de Arica y Parinacota</option>
      <option value="Tarapac√°">Regi√≥n de Tarapac√°</option>
      <option value="Antofagasta">Regi√≥n de Antofagasta</option>
      <option value="Atacama">Regi√≥n de Atacama</option>
      <option value="Coquimbo">Regi√≥n de Coquimbo</option>
      <option value="Valpara√≠so">Regi√≥n de Valpara√≠so</option>
      <option value="Metropolitana">Regi√≥n Metropolitana</option>
      <option value="O'Higgins">Regi√≥n de O'Higgins</option>
      <option value="Maule">Regi√≥n del Maule</option>
      <option value="√ëuble">Regi√≥n de √ëuble</option>
      <option value="B√≠o-B√≠o">Regi√≥n del B√≠o-B√≠o</option>
      <option value="La Araucan√≠a">Regi√≥n de La Araucan√≠a</option>
      <option value="Los R√≠os">Regi√≥n de Los R√≠os</option>
      <option value="Los Lagos">Regi√≥n de Los Lagos</option>
      <option value="Ays√©n">Regi√≥n de Ays√©n</option>
      <option value="Magallanes">Regi√≥n de Magallanes</option>
    </select>
    <div class="field-error" id="error-region">Por favor selecciona tu regi√≥n</div>

    <label for="mensaje">Mensaje adicional</label>
    <textarea name="mensaje" id="mensaje" placeholder="Cu√©ntanos tus necesidades espec√≠ficas..." rows="2"></textarea>

    <button type="submit" id="submitBtn">Cotizar Ahora</button>
    <p id="statusMsg" class="small" style="margin-top:10px;"></p>
  </form>
</section>

<section class="card">
  <h2 class="gold">UF del d√≠a</h2>
  <p class="small">UF: <span id="ufValor">cargando‚Ä¶</span> ‚Äî Fecha: <span id="ufFecha">-</span></p>
</section>

<section id="resultado-preliminar" class="card" style="display:none">
  <div id="resultadoDetalle"></div>

  <div style="text-align:center;margin-top:30px;">
    <button id="btnAsesoria" class="btn-asesoria">üìã Solicitar Asesor√≠a Personalizada</button>
    <p class="small" style="margin-top:10px;">Un asesor te contactar√° a la brevedad.</p>
    
    <button id="btnEnviarUsuario" class="btn-enviar-usuario">üì≤ Recibir Resumen por WhatsApp</button>
    <p class="small" style="margin-top:10px;">Recibir√°s los planes cotizados y documentos requeridos.</p>
  </div>
</section>

<section class="referidos-section" id="referidos" style="display:none">
  <div class="referidos-container">
    <div class="referidos-header">
      <h2>¬øQuieres que asesoremos a un amigo?</h2>
      <p>Ingresa los datos y nos comunicaremos con tu referido.</p>
    </div>

    <form id="formReferidos" novalidate>
      <div class="form-section">
        <h3>üë§ Tus Datos</h3>
        <label for="nombreUsuario">Tu Nombre *</label>
        <input type="text" id="nombreUsuario" required aria-required="true">
      </div>

      <div class="form-section">
        <h3>üéØ Datos del Referido</h3>
        <label for="nombreReferido">Nombre Completo *</label>
        <input type="text" id="nombreReferido" required aria-required="true">
        
        <label for="telefonoReferido">Tel√©fono *</label>
        <input type="tel" id="telefonoReferido" required aria-required="true">
        
        <label for="correoReferido">Correo *</label>
        <input type="email" id="correoReferido" required aria-required="true">
      </div>

      <button type="submit" class="btn-enviar-referido">üì§ Enviar Referido</button>
      <div id="mensajeExitoReferido" class="mensaje-exito-referido">‚úÖ ¬°Referido Enviado!</div>
      <div id="mensajeErrorReferido" class="mensaje-error-referido">‚ùå Error al enviar.</div>
    </form>
  </div>
</section>

<a class="whatsapp" href="https://wa.me/56990701837" target="_blank">üí¨ Contactar por WhatsApp</a>

<footer style="text-align:center; padding:30px; color:#666; font-size:0.85rem;">
  ¬© 2025 Colmena Golden Cross - Asesor√≠a en Planes de Salud
</footer>

<script>
// ============================================
// CONFIGURACI√ìN
// ============================================
const CONFIG = {
  FORM_BASE_URL: 'https://docs.google.com/forms/d/e/1FAIpQLSdWN77vgHicHHkyq8w0ogOzP5MHnlhBSLZAObDyVQo-ILw73g/formResponse',
  FORM_REFERIDOS_URL: 'https://docs.google.com/forms/d/e/1FAIpQLSeIppjYB0Vgc6RsJ3AM0HcAVhLaxAT6ZZ_MxdPhmuwRkwLT-A/formResponse',
  WHATSAPP_ASESORIA: '56975356696',
  CALLMEBOT_PHONE: '56975356696',
  CALLMEBOT_APIKEY: '7360481',
  ASESOR_NOMBRE: 'Jos√© Mora',
  ASESOR_TELEFONO: '+56 9 7535 6696',
  URL_PLANES: 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/main/data/planes_completos.json',
  URL_REDES: 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/main/data/redes_clinicas.json',
  MAX_RECALCULOS: 2
};

const FORM_FIELDS = {
  nombre: 'entry.1455181501',
  rut: 'entry.1514828805',
  correo: 'entry.1253669566',
  telefono: 'entry.1927631596',
  edad: 'entry.1515225692',
  isapre: 'entry.1312575017',
  renta: 'entry.1350273122',
  region: 'entry.1283417188',
  cargas: 'entry.6457415',
  mensaje: 'entry.860152674',
  plan1: 'entry.1176082335',
  plan2: 'entry.1798986413'
};

// ============================================
// ESTADO GLOBAL
// ============================================
const Estado = {
  ufValor: 39700,
  planes: [],
  redesClinicas: {},
  formularioDatos: {},
  ultimoResultado: null,
  contadorRecalculos: 0
};

// ============================================
// VALIDACIONES
// ============================================
const Validador = {
  rut(rut) {
    if (!rut) return false;
    rut = rut.replace(/\./g, '').replace('-', '');
    if (rut.length < 8) return false;
    
    const cuerpo = rut.slice(0, -1);
    const dv = rut.slice(-1).toUpperCase();
    
    let suma = 0;
    let multiplo = 2;
    
    for (let i = cuerpo.length - 1; i >= 0; i--) {
      suma += parseInt(cuerpo[i]) * multiplo;
      multiplo = multiplo < 7 ? multiplo + 1 : 2;
    }
    
    const dvEsperado =
     <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Cotiza tu plan de salud Colmena Golden Cross. Asesor√≠a profesional y personalizada." />
  <title>Planes de Salud Colmena - Asesor√≠a Profesional</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background-color: #0a1a2a; color: white; margin: 0; padding: 0; line-height: 1.6; }
    
    /* Header */
    header { background: linear-gradient(135deg, #0a1a2a, #12375a); padding: 40px 20px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    h1 { color: #d4af37; font-size: clamp(1.8rem, 5vw, 2.5rem); margin: 0 0 10px 0; }
    h2 { color: #d4af37; font-size: clamp(1.3rem, 4vw, 1.8rem); }
    
    /* Layout */
    section { padding: 40px 20px; max-width: 900px; margin: auto; }
    .gold { color: #d4af37; }
    .card { background: #112233; border: 1px solid #d4af37; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    
    /* Buttons */
    button { background: #d4af37; color: #0a1a2a; padding: 15px 25px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; transition: all 0.3s; font-weight: 600; }
    button:hover { opacity: 0.85; transform: translateY(-2px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button:active { transform: translateY(0); }
    
    /* Forms */
    form label { display: block; color: #b8c5d6; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500; }
    form input, form select, form textarea { 
      width: 100%; 
      padding: 12px; 
      margin: 8px 0 16px 0; 
      border-radius: 8px; 
      border: 2px solid #2a3a4a; 
      background: #0a1a2a; 
      color: white; 
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    form input:focus, form select:focus, form textarea:focus { 
      outline: none; 
      border-color: #d4af37; 
      box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
    }
    form input.error, form select.error { border-color: #ff8080; }
    .field-error { color: #ff8080; font-size: 0.85rem; margin-top: -12px; margin-bottom: 12px; display: none; }
    .field-error.show { display: block; }
    
    .whatsapp { display: block; background: #25D366; text-align: center; padding: 15px; color: white; text-decoration: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 20px; max-width: 300px; margin-left: auto; margin-right: auto; transition: all 0.3s; }
    .whatsapp:hover { background: #1da851; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4); }
    
    .small { font-size: 0.9rem; color: #ccc; }
    .row { display:flex; gap:16px; flex-wrap: wrap; }
    .col { flex:1; min-width: 250px; }
    .success-msg { color: #4ade80; margin-top: 12px; font-weight: bold; }
    .error-msg { color: #ff8080; margin-top: 12px; }

    /* Loading skeleton */
    .skeleton { animation: pulse 1.5s ease-in-out infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .skeleton-card { background: #1a2a3a; height: 100px; border-radius: 10px; margin-bottom: 15px; }

    /* Resumen cotizaci√≥n */
    .resumen-cotizacion { background: linear-gradient(135deg, #0d1f2d, #1a2a3a); border: 1px solid #3a5a7a; border-radius: 10px; padding: 20px; margin-bottom: 25px; }
    .resumen-titulo { color: #d4af37; font-size: clamp(1.1rem, 3vw, 1.3rem); margin-bottom: 15px; font-weight: bold; text-align: center; }
    .resumen-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
    .resumen-item { text-align: center; padding: 15px; background: #112233; border-radius: 8px; }
    .resumen-label { font-size: 0.85rem; color: #888; margin-bottom: 5px; }
    .resumen-value { font-size: clamp(1rem, 3vw, 1.2rem); font-weight: bold; color: #fff; }
    .resumen-value.destacado { color: #4ade80; }
    .resumen-uf { font-size: 0.85rem; color: #aaa; }

    /* Card del plan */
    .plan-card { background: #112233; border: 2px solid #d4af37; border-radius: 15px; padding: 25px; margin: 25px 0; }
    .plan-card.secundario { border-color: #60a5fa; }
    .plan-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-bottom: 15px; }
    .plan-badge.principal { background: #d4af37; color: #0a1a2a; }
    .plan-badge.secundario { background: #60a5fa; color: #0a1a2a; }
    
    .plan-nombre-container { text-align: center; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #1a3a5a, #0d1f2d); border-radius: 12px; border: 2px solid #d4af37; }
    .plan-nombre { font-size: clamp(1.2rem, 4vw, 1.8rem); font-weight: bold; color: #d4af37; text-shadow: 0 2px 10px rgba(212,175,55,0.3); letter-spacing: 1px; word-break: break-word; }
    .plan-nombre-estrella { color: #fbbf24; font-size: clamp(1rem, 3vw, 1.5rem); }

    .plan-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0; }
    .plan-info-item { background: #1a2a3a; padding: 15px; border-radius: 8px; text-align: center; }
    .plan-info-label { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
    .plan-info-value { font-size: clamp(0.95rem, 2.5vw, 1.1rem); font-weight: bold; color: #fff; }
    .plan-info-value.verde { color: #4ade80; }
    .plan-info-value.amarillo { color: #fbbf24; }

    .coberturas-section { margin: 20px 0; padding: 15px; background: #0d1f2d; border-radius: 10px; }
    .coberturas-title { color: #d4af37; font-size: 1rem; margin-bottom: 10px; }
    .coberturas-texto { font-size: 0.9rem; line-height: 1.6; color: #ccc; }

    /* Cl√≠nicas */
    .clinicas-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid #3a5a7a; }
    .clinicas-title { color: #d4af37; font-size: 1.1rem; margin-bottom: 15px; }
    .grupos-tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .grupo-tab { background: #1a2a3a; border: 1px solid #3a5a7a; color: #ccc; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
    .grupo-tab:hover { border-color: #d4af37; color: #d4af37; }
    .grupo-tab.active { background: #d4af37; color: #0a1a2a; border-color: #d4af37; font-weight: bold; }
    .clinicas-tabla { width: 100%; border-collapse: collapse; font-size: 0.9rem; overflow-x: auto; display: block; }
    .clinicas-tabla thead { display: table; width: 100%; table-layout: fixed; }
    .clinicas-tabla tbody { display: table; width: 100%; table-layout: fixed; }
    .clinicas-tabla th { background: #1a3a5a; color: #d4af37; padding: 12px 15px; text-align: left; }
    .clinicas-tabla td { padding: 10px 15px; border-bottom: 1px solid #2a3a4a; }
    .clinicas-tabla tr:nth-child(even) { background: #0d1f2d; }
    .clinicas-tabla tr:nth-child(odd) { background: #112233; }
    .clinicas-tabla tr:hover { background: #1a3a4a; }
    .grupo-content { display: none; }
    .grupo-content.active { display: block; }

    .btn-asesoria { display: inline-block; background: linear-gradient(135deg, #d4af37, #f0c860); color: #0a1a2a; padding: 18px 40px; text-decoration: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 15px rgba(212,175,55,0.4); transition: all .3s ease; border: none; cursor: pointer; }
    .btn-asesoria:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,175,55,0.6); }

    /* Referidos */
    .referidos-section { background: linear-gradient(135deg,#0f2640 0%,#1a3a5a 100%); padding:60px 20px; margin:40px 0; }
    .referidos-container { max-width:800px; margin:0 auto; background:#112233; padding:40px 20px; border-radius:20px; border:1px solid #d4af37; }
    .referidos-header { text-align:center; margin-bottom:30px; }
    .referidos-header h2 { color:#d4af37; font-size:clamp(1.3rem, 4vw, 28px); margin-bottom:15px; }
    .referidos-header p { color:#b8c5d6; font-size:16px; }
    .form-section { background:#1a2a3a; padding:25px; border-radius:15px; border-left:4px solid #d4af37; margin-bottom: 20px; }
    .form-section h3 { color:#d4af37; font-size:18px; margin-bottom:15px; margin-top: 0; }
    .btn-enviar-referido { background:linear-gradient(135deg,#d4af37,#f0c860); color:#0a1a2a; padding:15px 40px; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; width:100%; }
    .mensaje-exito-referido, .mensaje-error-referido { padding:15px; border-radius:10px; margin-top:20px; display:none; font-weight:600; text-align:center; }
    .mensaje-exito-referido { background:#1a4d2e; color:#4ade80; border:1px solid #4ade80; }
    .mensaje-error-referido { background:#4a1a1a; color:#ff8080; border:1px solid #ff8080; }

    .disclaimer { background: #1a2a3a; border-left: 4px solid #fbbf24; padding: 15px 20px; margin: 20px 0; border-radius: 0 8px 8px 0; font-size: 0.85rem; color: #b8c5d6; font-style: italic; }
    .disclaimer-icon { color: #fbbf24; margin-right: 8px; }

    .mejorar-cobertura { background: linear-gradient(135deg, #0f2640, #1a3a5a); border: 2px solid #4ade80; border-radius: 15px; padding: 30px 20px; margin: 30px 0; text-align: center; }
    .mejorar-titulo { color: #4ade80; font-size: clamp(1.1rem, 3vw, 1.3rem); margin-bottom: 15px; }
    .mejorar-texto { color: #b8c5d6; font-size: 1rem; line-height: 1.6; margin-bottom: 20px; }
    .mejorar-input-container { display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; margin-top: 20px; }
    .mejorar-input { width: 200px; padding: 15px; font-size: 1.1rem; border: 2px solid #4ade80; border-radius: 10px; background: #0a1a2a; color: white; text-align: center; }
    .mejorar-input:focus { outline: none; border-color: #d4af37; box-shadow: 0 0 10px rgba(212,175,55,0.3); }
    .btn-recalcular { background: linear-gradient(135deg, #4ade80, #22c55e); color: #0a1a2a; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .btn-recalcular:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(74,222,128,0.4); }
    .adicional-actual { background: #112233; padding: 15px 25px; border-radius: 10px; margin: 15px 0; display: inline-block; }
    .adicional-label { color: #888; font-size: 0.9rem; }
    .adicional-valor { color: #4ade80; font-size: clamp(1.1rem, 3vw, 1.3rem); font-weight: bold; }

    .btn-enviar-usuario { background: linear-gradient(135deg, #25d366, #128c7e); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-top: 15px; display: block; width: 100%; max-width: 350px; margin-left: auto; margin-right: auto; }
    .btn-enviar-usuario:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(37,211,102,0.4); }

    /* Toast notifications */
    .toast { position: fixed; bottom: 20px; right: 20px; background: #112233; border: 2px solid #4ade80; border-radius: 10px; padding: 15px 20px; color: white; box-shadow: 0 4px 20px rgba(0,0,0,0.4); z-index: 1000; animation: slideIn 0.3s ease; }
    .toast.error { border-color: #ff8080; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    @media (max-width: 768px) {
      .plan-nombre { font-size: 1.2rem; }
      .clinicas-tabla th, .clinicas-tabla td { padding: 8px 10px; font-size: 0.85rem; }
      .mejorar-input { width: 100%; max-width: 250px; }
      .col { min-width: 100%; }
      .resumen-grid { grid-template-columns: 1fr; }
      header { padding: 30px 15px; }
      section { padding: 30px 15px; }
    }

    @media (max-width: 480px) {
      .plan-info { grid-template-columns: 1fr; }
      .btn-asesoria { padding: 15px 25px; font-size: 1rem; }
    }
  </style>
</head>
<body>

<header>
  <h1>Asesor√≠a en Planes de Salud Colmena</h1>
  <p class="gold">Atenci√≥n premium para clientes exigentes</p>
  <p class="small">Completa el formulario para obtener una cotizaci√≥n exacta en UF y CLP.</p>
</header>

<section id="formulario" class="card">
  <h2 class="gold">Formulario para C√°lculo del Plan</h2>

  <form id="mainForm" novalidate>
    <div class="row">
      <div class="col">
        <label for="nombre">Nombre completo *</label>
        <input type="text" name="nombre" id="nombre" required aria-required="true" />
        <div class="field-error" id="error-nombre">Por favor ingresa tu nombre completo</div>
      </div>
      <div class="col">
        <label for="correo">Correo electr√≥nico *</label>
        <input type="email" name="correo" id="correo" required aria-required="true" />
        <div class="field-error" id="error-correo">Por favor ingresa un correo v√°lido</div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="telefono">Tel√©fono *</label>
        <input type="tel" name="telefono" id="telefono" placeholder="+56912345678" required aria-required="true" />
        <div class="field-error" id="error-telefono">Formato: +56912345678</div>
      </div>
      <div class="col">
        <label for="edad">Edad titular *</label>
        <input type="number" name="edad" id="edad" min="18" max="99" required aria-required="true" />
        <div class="field-error" id="error-edad">Edad debe estar entre 18 y 99 a√±os</div>
      </div>
    </div>

    <label for="rut">RUT *</label>
    <input type="text" name="rut" id="rut" placeholder="12.345.678-9" required aria-required="true" />
    <div class="field-error" id="error-rut">RUT inv√°lido. Formato: 12.345.678-9</div>

    <label for="isapre">Isapre actual *</label>
    <select name="isapre" id="isapre" required aria-required="true">
      <option value="">Selecciona tu isapre</option>
      <option>FONASA</option>
      <option>Colmena</option>
      <option>Cruz Blanca</option>
      <option>Consalud</option>
      <option>Banm√©dica</option>
      <option>Vida Tres</option>
      <option>Nueva Masvida</option>
      <option>Esencial</option>
    </select>
    <div class="field-error" id="error-isapre">Por favor selecciona tu isapre actual</div>

    <label for="renta">Renta imponible mensual (CLP) *</label>
    <input type="number" id="renta" name="renta" min="0" step="1000" required aria-required="true" />
    <div class="field-error" id="error-renta">Por favor ingresa tu renta imponible</div>

    <label for="cargas">Edad de las cargas (separadas por coma)</label>
    <textarea name="cargas" id="cargas" placeholder="Ej: 5, 12, 30" rows="2"></textarea>
    <p class="small" style="margin-top: -8px;">Opcional: ingresa las edades separadas por comas</p>

    <label for="region">Regi√≥n *</label>
    <select name="region" id="region" required aria-required="true">
      <option value="">Selecciona tu Regi√≥n</option>
      <option value="Arica y Parinacota">Regi√≥n de Arica y Parinacota</option>
      <option value="Tarapac√°">Regi√≥n de Tarapac√°</option>
      <option value="Antofagasta">Regi√≥n de Antofagasta</option>
      <option value="Atacama">Regi√≥n de Atacama</option>
      <option value="Coquimbo">Regi√≥n de Coquimbo</option>
      <option value="Valpara√≠so">Regi√≥n de Valpara√≠so</option>
      <option value="Metropolitana">Regi√≥n Metropolitana</option>
      <option value="O'Higgins">Regi√≥n de O'Higgins</option>
      <option value="Maule">Regi√≥n del Maule</option>
      <option value="√ëuble">Regi√≥n de √ëuble</option>
      <option value="B√≠o-B√≠o">Regi√≥n del B√≠o-B√≠o</option>
      <option value="La Araucan√≠a">Regi√≥n de La Araucan√≠a</option>
      <option value="Los R√≠os">Regi√≥n de Los R√≠os</option>
      <option value="Los Lagos">Regi√≥n de Los Lagos</option>
      <option value="Ays√©n">Regi√≥n de Ays√©n</option>
      <option value="Magallanes">Regi√≥n de Magallanes</option>
    </select>
    <div class="field-error" id="error-region">Por favor selecciona tu regi√≥n</div>

    <label for="mensaje">Mensaje adicional</label>
    <textarea name="mensaje" id="mensaje" placeholder="Cu√©ntanos tus necesidades espec√≠ficas..." rows="2"></textarea>

    <button type="submit" id="submitBtn">Cotizar Ahora</button>
    <p id="statusMsg" class="small" style="margin-top:10px;"></p>
  </form>
</section>

<section class="card">
  <h2 class="gold">UF del d√≠a</h2>
  <p class="small">UF: <span id="ufValor">cargando‚Ä¶</span> ‚Äî Fecha: <span id="ufFecha">-</span></p>
</section>

<section id="resultado-preliminar" class="card" style="display:none">
  <div id="resultadoDetalle"></div>

  <div style="text-align:center;margin-top:30px;">
    <button id="btnAsesoria" class="btn-asesoria">üìã Solicitar Asesor√≠a Personalizada</button>
    <p class="small" style="margin-top:10px;">Un asesor te contactar√° a la brevedad.</p>
    
    <button id="btnEnviarUsuario" class="btn-enviar-usuario">üì≤ Recibir Resumen por WhatsApp</button>
    <p class="small" style="margin-top:10px;">Recibir√°s los planes cotizados y documentos requeridos.</p>
  </div>
</section>

<section class="referidos-section" id="referidos" style="display:none">
  <div class="referidos-container">
    <div class="referidos-header">
      <h2>¬øQuieres que asesoremos a un amigo?</h2>
      <p>Ingresa los datos y nos comunicaremos con tu referido.</p>
    </div>

    <form id="formReferidos" novalidate>
      <div class="form-section">
        <h3>üë§ Tus Datos</h3>
        <label for="nombreUsuario">Tu Nombre *</label>
        <input type="text" id="nombreUsuario" required aria-required="true">
      </div>

      <div class="form-section">
        <h3>üéØ Datos del Referido</h3>
        <label for="nombreReferido">Nombre Completo *</label>
        <input type="text" id="nombreReferido" required aria-required="true">
        
        <label for="telefonoReferido">Tel√©fono *</label>
        <input type="tel" id="telefonoReferido" required aria-required="true">
        
        <label for="correoReferido">Correo *</label>
        <input type="email" id="correoReferido" required aria-required="true">
      </div>

      <button type="submit" class="btn-enviar-referido">üì§ Enviar Referido</button>
      <div id="mensajeExitoReferido" class="mensaje-exito-referido">‚úÖ ¬°Referido Enviado!</div>
      <div id="mensajeErrorReferido" class="mensaje-error-referido">‚ùå Error al enviar.</div>
    </form>
  </div>
</section>

<a class="whatsapp" href="https://wa.me/56990701837" target="_blank">üí¨ Contactar por WhatsApp</a>

<footer style="text-align:center; padding:30px; color:#666; font-size:0.85rem;">
  ¬© 2025 Colmena Golden Cross - Asesor√≠a en Planes de Salud
</footer>

<script>
// ============================================
// CONFIGURACI√ìN
// ============================================
const CONFIG = {
  FORM_BASE_URL: 'https://docs.google.com/forms/d/e/1FAIpQLSdWN77vgHicHHkyq8w0ogOzP5MHnlhBSLZAObDyVQo-ILw73g/formResponse',
  FORM_REFERIDOS_URL: 'https://docs.google.com/forms/d/e/1FAIpQLSeIppjYB0Vgc6RsJ3AM0HcAVhLaxAT6ZZ_MxdPhmuwRkwLT-A/formResponse',
  WHATSAPP_ASESORIA: '56975356696',
  CALLMEBOT_PHONE: '56975356696',
  CALLMEBOT_APIKEY: '7360481',
  ASESOR_NOMBRE: 'Jos√© Mora',
  ASESOR_TELEFONO: '+56 9 7535 6696',
  URL_PLANES: 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/main/data/planes_completos.json',
  URL_REDES: 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/main/data/redes_clinicas.json',
  MAX_RECALCULOS: 2
};

const FORM_FIELDS = {
  nombre: 'entry.1455181501',
  rut: 'entry.1514828805',
  correo: 'entry.1253669566',
  telefono: 'entry.1927631596',
  edad: 'entry.1515225692',
  isapre: 'entry.1312575017',
  renta: 'entry.1350273122',
  region: 'entry.1283417188',
  cargas: 'entry.6457415',
  mensaje: 'entry.860152674',
  plan1: 'entry.1176082335',
  plan2: 'entry.1798986413'
};

// ============================================
// ESTADO GLOBAL
// ============================================
const Estado = {
  ufValor: 39700,
  planes: [],
  redesClinicas: {},
  formularioDatos: {},
  ultimoResultado: null,
  contadorRecalculos: 0
};

// ============================================
// VALIDACIONES
// ============================================
const Validador = {
  rut(rut) {
    if (!rut) return false;
    rut = rut.replace(/\./g, '').replace('-', '');
    if (rut.length < 8) return false;
    
    const cuerpo = rut.slice(0, -1);
    const dv = rut.slice(-1).toUpperCase();
    
    let suma = 0;
    let multiplo = 2;
    
    for (let i = cuerpo.length - 1; i >= 0; i--) {
      suma += parseInt(cuerpo[i]) * multiplo;
      multiplo = multiplo < 7 ? multiplo + 1 : 2;
    }
    
    const dvEsperado = 11 - (suma % 11);
    const dvFinal = dvEsperado === 11 ? '0' : dvEsperado === 10 ? 'K' : String(dvEsperado);
    
    return dv === dvFinal;
  },

  email(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  },

  telefono(tel) {
    return /^\+?56\d{9}$/.test(tel.replace(/\s/g, ''));
  },

  edad(edad) {
    const num = parseInt(edad);
    return num >= 18 && num <= 99;
  },

  required(value) {
    return value && value.toString().trim() !== '';
  }
};

// ============================================
// UTILIDADES UI
// ============================================
const UI = {
  mostrarToast(mensaje, tipo = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${tipo}`;
    toast.textContent = mensaje;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.animation = 'slideIn 0.3s ease reverse';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  },

  mostrarError(inputId, mensaje) {
    const input = document.getElementById(inputId);
    const error = document.getElementById(`error-${inputId}`);
    
    if (input && error) {
      input.classList.add('error');
      error.classList.add('show');
      if (mensaje) error.textContent = mensaje;
    }
  },

  limpiarError(inputId) {
    const input = document.getElementById(inputId);
    const error = document.getElementById(`error-${inputId}`);
    
    if (input && error) {
      input.classList.remove('error');
      error.classList.remove('show');
    }
  },

  sanitize(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  },

  formatearCLP(n) {
    return (n || 0).toLocaleString("es-CL");
  }
};

// ============================================
// MAPEO REGIONES Y FACTORES
// ============================================
const REGION_A_ZONA = {
  'Arica y Parinacota': 'NORTE',
  'Tarapac√°': 'NORTE',
  'Antofagasta': 'NORTE',
  'Atacama': 'NORTE',
  'Coquimbo': 'NORTE',
  'Valpara√≠so': 'CENTRO',
  "O'Higgins": 'CENTRO',
  'Maule': 'CENTRO',
  'Metropolitana': 'SANTIAGO',
  '√ëuble': 'SUR',
  'B√≠o-B√≠o': 'SUR',
  'La Araucan√≠a': 'SUR',
  'Los R√≠os': 'SUR',
  'Los Lagos': 'SUR',
  'Ays√©n': 'SUR',
  'Magallanes': 'SUR'
};

function obtenerFactor(edad) {
  if (edad < 2) return 0.0;
  if (edad < 20) return 0.6;
  if (edad < 25) return 0.9;
  if (edad < 35) return 1.0;
  if (edad < 45) return 1.3;
  if (edad < 55) return 1.4;
  if (edad < 65) return 2.0;
  return 2.4;
}

function obtenerFactorCarga(edad) {
  if (edad < 2) return 0.0;
  if (edad < 20) return 0.6;
  if (edad < 25) return 0.7;
  if (edad < 35) return 0.7;
  if (edad < 45) return 0.9;
  if (edad < 55) return 1.0;
  if (edad < 65) return 1.4;
  return 2.2;
}

// ============================================
// CARGA DE DATOS
// ============================================
async function cargarUF() {
  try {
    const r = await fetch("https://mindicador.cl/api/");
    const j = await r.json();
    Estado.ufValor = j.uf.valor;
    document.getElementById("ufValor").innerText = "$" + Estado.ufValor.toLocaleString("es-CL", { minimumFractionDigits: 2 });
    document.getElementById("ufFecha").innerText = new Date(j.uf.fecha).toLocaleDateString("es-CL", { year: "numeric", month: "long", day: "numeric" });
  } catch (err) {
    console.error('Error cargando UF:', err);
    document.getElementById("ufValor").innerText = "$39.700 (estimado)";
    document.getElementById("ufFecha").innerText = "No disponible";
  }
}

async function cargarPlanes() {
  try {
    const r = await fetch(CONFIG.URL_PLANES);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    Estado.planes = await r.json();
    console.log('‚úÖ Planes cargados:', Estado.planes.length);
  } catch (err) {
    console.error('‚ùå Error cargando planes:', err);
    UI.mostrarToast('Error al cargar planes. Intenta m√°s tarde.', 'error');
  }
}

async function cargarRedesClinicas() {
  try {
    const r = await fetch(CONFIG.URL_REDES);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    Estado.redesClinicas = await r.json();
    console.log('‚úÖ Redes de cl√≠nicas cargadas');
  } catch (err) {
    console.error('‚ùå Error cargando redes:', err);
  }
}

// ============================================
// C√ÅLCULOS
// ============================================
function calcularValorPlan(pbUF, edadTitular, edadesCargas) {
  let sumaFactores = obtenerFactor(edadTitular);
  edadesCargas.forEach(e => sumaFactores += obtenerFactorCarga(e));
  
  const valorPlanUF = pbUF * sumaFactores;
  const valorPlanCLP = Math.round(valorPlanUF * Estado.ufValor);
  
  let personasGES = edadTitular >= 2 ? 1 : 0;
  edadesCargas.forEach(e => { if (e >= 2) personasGES++; });
  const gesUF = 0.77 * personasGES;
  const gesCLP = Math.round(gesUF * Estado.ufValor);
  
  const totalUF = valorPlanUF + gesUF;
  const totalCLP = valorPlanCLP + gesCLP;
  
  return { valorPlanUF, valorPlanCLP, gesUF, gesCLP, totalUF, totalCLP, sumaFactores };
}

function seleccionarPlanes(sieteUF, zona, edadTitular, edadesCargas) {
  const minimo95 = sieteUF * 0.95;
  
  const planesZona = Estado.planes.filter(p => 
    p.zona === zona || p.zona === 'LIBRE_ELECCION'
  );
  
  const planesConValor = planesZona.map(p => {
    const calc = calcularValorPlan(p.pb_uf, edadTitular, edadesCargas);
    return { ...p, ...calc };
  });
  
  const planesValidos = planesConValor.filter(p => p.totalUF >= minimo95);
  planesValidos.sort((a, b) => Math.abs(a.totalUF - sieteUF) - Math.abs(b.totalUF - sieteUF));
  
  return { plan1: planesValidos[0] || null, plan2: planesValidos[1] || null };
}

// ============================================
// GENERACI√ìN DE HTML
// ============================================
function generarHTMLPlan(plan, numero, sieteUF, sieteCLP, montoAdicional = 0) {
  if (!plan) return '';
  
  const adicionalUF = Math.max(0, plan.totalUF - sieteUF - (montoAdicional / Estado.ufValor));
  const adicionalCLP = Math.round(adicionalUF * Estado.ufValor);
  
  const esPrincipal = numero === 1;
  const badgeClass = esPrincipal ? 'principal' : 'secundario';
  const cardClass = esPrincipal ? '' : 'secundario';
  const badgeText = esPrincipal ? '‚ú® PLAN RECOMENDADO 1' : 'üî∑ PLAN RECOMENDADO 2';
  
  let coberturasHTML = '';
  if (plan.hospitalizacion) {
    coberturasHTML = `
      <div class="coberturas-section">
        <div class="coberturas-title">üìä Cobertura Hospitalaria</div>
        <div class="coberturas-texto">${plan.hospitalizacion.replace(/\\n/g, '<br>')}</div>
      </div>
    `;
  }
  
  let clinicasHTML = '';
  if (plan.coberturas_redes && Object.keys(Estado.redesClinicas).length > 0) {
    clinicasHTML = generarHTMLClinicas(plan, numero);
  }
  
  return `
    <div class="plan-card ${cardClass}">
      <span class="plan-badge ${badgeClass}">${badgeText}</span>
      
      <div class="plan-nombre-container">
        <span class="plan-nombre-estrella">‚òÖ</span>
        <span class="plan-nombre">${UI.sanitize(plan.plan)}</span>
        <span class="plan-nombre-estrella">‚òÖ</span>
      </div>
      
      <div class="plan-info">
        <div class="plan-info-item">
          <div class="plan-info-label">Valor del Plan</div>
          <div class="plan-info-value">${UI.formatearCLP(plan.totalCLP)}</div>
          <div class="small">${plan.totalUF.toFixed(2)} UF</div>
        </div>
        <div class="plan-info-item">
          <div class="plan-info-label">Adicional a pagar</div>
          <div class="plan-info-value ${adicionalCLP <= 0 ? 'verde' : 'amarillo'}">${UI.formatearCLP(Math.max(0, adicionalCLP))}</div>
        </div>
        <div class="plan-info-item">
          <div class="plan-info-label">GES incluido</div>
          <div class="plan-info-value verde">${UI.formatearCLP(plan.gesCLP)}</div>
          <div class="small">${plan.gesUF.toFixed(2)} UF</div>
        </div>
        <div class="plan-info-item">
          <div class="plan-info-label">Tope anual</div>
          <div class="plan-info-value">${UI.formatearCLP(plan.tope_anual_uf || 7000)} UF</div>
        </div>
      </div>
      
      ${coberturasHTML}
      ${clinicasHTML}
    </div>
  `;
}

function generarHTMLClinicas(plan, numeroPlan) {
  if (!plan.coberturas_redes) return '';
  
  const grupos = Object.keys(plan.coberturas_redes).sort();
  const planId = `plan${numeroPlan}`;
  
  let tabsHTML = grupos.map((g, i) => {
    const activeClass = i === 0 ? 'active' : '';
    const cobertura = plan.coberturas_redes[g];
    return `<button type="button" class="grupo-tab ${activeClass}" onclick="mostrarGrupo('${planId}', '${g}')">${g} (${cobertura}%)</button>`;
  }).join('');
  
  let contenidoHTML = grupos.map((g, i) => {
    const activeClass = i === 0 ? 'active' : '';
    const clinicas = Estado.redesClinicas[g] || [];
    
    let filas = clinicas.map(c => 
      `<tr><td>${UI.sanitize(c.nombre)}</td><td>${UI.sanitize(c.ciudad)}</td></tr>`
    ).join('');
    
    return `
      <div id="${planId}-${g}" class="grupo-content ${activeClass}">
        <table class="clinicas-tabla">
          <thead>
            <tr><th>Nombre Prestador</th><th>Ciudad</th></tr>
          </thead>
          <tbody>${filas}</tbody>
        </table>
      </div>
    `;
  }).join('');
  
  return `
    <div class="clinicas-section">
      <div class="clinicas-title">üè® Red de Cl√≠nicas</div>
      <div class="grupos-tabs">${tabsHTML}</div>
      ${contenidoHTML}
    </div>
  `;
}

function mostrarGrupo(planId, grupo) {
  document.querySelectorAll(`[id^="${planId}-"]`).forEach(el => el.classList.remove('active'));
  
  const grupoContent = document.getElementById(`${planId}-${grupo}`);
  if (grupoContent) {
    const planCard = grupoContent.closest('.plan-card');
    if (planCard) {
      planCard.querySelectorAll('.grupo-tab').forEach(tab => tab.classList.remove('active'));
      planCard.querySelectorAll('.grupo-tab').forEach(tab => {
        if (tab.textContent.startsWith(grupo)) tab.classList.add('active');
      });
    }
  }
  
  document.getElementById(`${planId}-${grupo}`).classList.add('active');
}

// ============================================
// COMUNICACI√ìN
// ============================================
async function enviarCallMeBot(mensaje) {
  if (!CONFIG.CALLMEBOT_APIKEY) return;
  try {
    const url = `https://api.callmebot.com/whatsapp.php?phone=${CONFIG.CALLMEBOT_PHONE}&text=${encodeURIComponent(mensaje)}&apikey=${CONFIG.CALLMEBOT_APIKEY}`;
    await fetch(url, { mode: 'no-cors' });
    console.log('‚úÖ CallMeBot enviado');
  } catch (err) {
    console.error('Error CallMeBot:', err);
  }
}

// ============================================
// FORMULARIO PRINCIPAL
// ============================================
document.getElementById("mainForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  // Validar todos los campos
  let valido = true;
  
  const nombre = document.getElementById('nombre').value;
  if (!Validador.required(nombre)) {
    UI.mostrarError('nombre');
    valido = false;
  } else {
    UI.limpiarError('nombre');
  }
  
  const correo = document.getElementById('correo').value;
  if (!Validador.email(correo)) {
    UI.mostrarError('correo');
    valido = false;
  } else {
    UI.limpiarError('correo');
  }
  
  const telefono = document.getElementById('telefono').value;
  if (!Validador.telefono(telefono)) {
    UI.mostrarError('telefono');
    valido = false;
  } else {
    UI.limpiarError('telefono');
  }
  
  const edad = document.getElementById('edad').value;
  if (!Validador.edad(edad)) {
    UI.mostrarError('edad');
    valido = false;
  } else {
    UI.limpiarError('edad');
  }
  
  const rut = document.getElementById('rut').value;
  if (!Validador.rut(rut)) {
    UI.mostrarError('rut');
    valido = false;
  } else {
    UI.limpiarError('rut');
  }
  
  const isapre = document.getElementById('isapre').value;
  if (!Validador.required(isapre)) {
    UI.mostrarError('isapre');
    valido = false;
  } else {
    UI.limpiarError('isapre');
  }
  
  const renta = document.getElementById('renta').value;
  if (!Validador.required(renta) || renta <= 0) {
    UI.mostrarError('renta');
    valido = false;
  } else {
    UI.limpiarError('renta');
  }
  
  const region = document.getElementById('region').value;
  if (!Validador.required(region)) {
    UI.mostrarError('region');
    valido = false;
  } else {
    UI.limpiarError('region');
  }
  
  if (!valido) {
    UI.mostrarToast('Por favor corrige los errores en el formulario', 'error');
    return;
  }

  const btn = document.getElementById("submitBtn");
  const statusMsg = document.getElementById("statusMsg");
  
  btn.disabled = true;
  btn.textContent = "Calculando...";
  statusMsg.textContent = "";
  
  Estado.contadorRecalculos = 0;

  const data = new FormData(this);

  Estado.formularioDatos = {
    nombre: data.get("nombre"),
    correo: data.get("correo"),
    telefono: data.get("telefono"),
    edad: data.get("edad"),
    rut: data.get("rut"),
    isapre: data.get("isapre"),
    renta: data.get("renta"),
    cargas: data.get("cargas"),
    region: data.get("region"),
    mensaje: data.get("mensaje")
  };

  const rentaNum = Number(Estado.formularioDatos.renta);
  const edadTitular = Number(Estado.formularioDatos.edad);
  
  const cargasTexto = (Estado.formularioDatos.cargas || "").replace(/\n/g, ", ").trim();
  const edadesCargas = cargasTexto.split(/[\n,;]+/).map(s => s.trim()).filter(Boolean).map(Number).filter(n => !isNaN(n));
  
  const sieteCLP = Math.round(rentaNum * 0.07);
  const sieteUF = sieteCLP / Estado.ufValor;
  
  const zona = REGION_A_ZONA[Estado.formularioDatos.region] || 'SANTIAGO';
  
  const { plan1, plan2 } = seleccionarPlanes(sieteUF, zona, edadTitular, edadesCargas);
  
  Estado.ultimoResultado = {
    sieteCLP, sieteUF, edadesCargas, cargasTexto, zona, plan1, plan2
  };

  // Enviar a Google Forms
  try {
    const plan1Nombre = plan1 ? plan1.plan : 'Sin plan disponible';
    const plan2Nombre = plan2 ? plan2.plan : 'Sin plan disponible';
    
    const params = new URLSearchParams();
    Object.keys(FORM_FIELDS).forEach(key => {
      if (key === 'plan1') params.append(FORM_FIELDS[key], plan1Nombre);
      else if (key === 'plan2') params.append(FORM_FIELDS[key], plan2Nombre);
      else if (key === 'cargas') params.append(FORM_FIELDS[key], cargasTexto);
      else params.append(FORM_FIELDS[key], Estado.formularioDatos[key] || '');
    });

    fetch(CONFIG.FORM_BASE_URL, { 
      method: "POST", 
      mode: "no-cors", 
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params.toString()
    }).catch(() => {});

    UI.mostrarToast('‚úÖ Cotizaci√≥n generada exitosamente');
  } catch (err) {
    console.error("Error enviando formulario:", err);
  }

  // CallMeBot
  const cargasInfo = edadesCargas.length > 0 ? `${edadesCargas.length} (${edadesCargas.join(', ')} a√±os)` : '0';
  const msgWA = `üîî NUEVA COTIZACI√ìN

üë§ ${Estado.formularioDatos.nombre}
üìß ${Estado.formularioDatos.correo}
üìû ${Estado.formularioDatos.telefono}
üìç ${Estado.formularioDatos.region} (${zona})
üí∞ Renta: ${UI.formatearCLP(rentaNum)}
üë• Cargas: ${cargasInfo}

üìä 7%: ${UI.formatearCLP(sieteCLP)} (${sieteUF.toFixed(2)} UF)

üìã Planes sugeridos:
1) ${plan1 ? plan1.plan + ' ‚Üí ' + plan1.totalUF.toFixed(2) + ' UF' : 'Sin plan'}
2) ${plan2 ? plan2.plan + ' ‚Üí ' + plan2.totalUF.toFixed(2) + ' UF' : 'Sin plan'}`;
  
  enviarCallMeBot(msgWA);

  // Mostrar resultado
  let htmlResultado = `
    <div class="resumen-cotizacion">
      <div class="resumen-titulo">üìä Tu Cotizaci√≥n - ${UI.sanitize(Estado.formularioDatos.nombre)}</div>
      <div class="resumen-grid">
        <div class="resumen-item">
          <div class="resumen-label">Tu 7% obligatorio</div>
          <div class="resumen-value destacado">${UI.formatearCLP(sieteCLP)}</div>
          <div class="resumen-uf">${sieteUF.toFixed(2)} UF</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Cargas</div>
          <div class="resumen-value">${edadesCargas.length}</div>
          <div class="resumen-uf">${edadesCargas.length > 0 ? '(' + edadesCargas.join(', ') + ' a√±os)' : 'Sin cargas'}</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Zona</div>
          <div class="resumen-value" style="font-size:0.95rem;">${zona}</div>
          <div class="resumen-uf">${Estado.formularioDatos.region}</div>
        </div>
      </div>
    </div>
    
    <h2 class="gold" style="margin-top:30px;">üè• Planes Recomendados</h2>
    <p class="small">Basado en tu 7% (${UI.formatearCLP(sieteCLP)}), te sugerimos estos planes:</p>
  `;
  
  if (plan1) {
    htmlResultado += generarHTMLPlan(plan1, 1, sieteUF, sieteCLP, 0);
  } else {
    htmlResultado += `<p class="small" style="color:#fbbf24;">No se encontr√≥ un plan que cumpla con el criterio para tu 7%. Solicita asesor√≠a personalizada.</p>`;
  }
  
  if (plan2) {
    htmlResultado += generarHTMLPlan(plan2, 2, sieteUF, sieteCLP, 0);
  }

  htmlResultado += `
    <div class="disclaimer">
      <span class="disclaimer-icon">‚ö†Ô∏è</span>
      Los valores presentados son referenciales y est√°n sujetos a verificaci√≥n. Un Ejecutivo de Ventas validar√° esta informaci√≥n y te contactar√° para formalizar tu plan de salud.
    </div>
  `;

  htmlResultado += `
    <div class="mejorar-cobertura">
      <div class="mejorar-titulo">üí° ¬øTe gustar√≠a acceder a mejores coberturas?</div>
      <div class="mejorar-texto">
        Puedes complementar tu 7% legal con un aporte adicional mensual para obtener planes con mayores beneficios.
      </div>
      
      <div class="adicional-actual">
        <div class="adicional-label">Tu presupuesto actual (7%)</div>
        <div class="adicional-valor">${UI.formatearCLP(sieteCLP)}</div>
      </div>
      
      <div class="mejorar-input-container">
        <div>
          <label class="small" style="display:block; margin-bottom:5px; color:#ccc;">Monto adicional mensual:</label>
          <input type="number" id="montoAdicional" class="mejorar-input" placeholder="Ej: 50000" min="0" step="1000">
        </div>
        <button type="button" id="btnRecalcular" class="btn-recalcular">üîÑ Recalcular Planes</button>
      </div>
    </div>
  `;

  document.getElementById("resultadoDetalle").innerHTML = htmlResultado;
  document.getElementById("resultado-preliminar").style.display = "block";

  document.getElementById("btnRecalcular").addEventListener("click", recalcularConAdicional);

  btn.disabled = false;
  btn.textContent = "Cotizar Ahora";

  setTimeout(() => {
    document.getElementById("resultado-preliminar").scrollIntoView({ behavior: "smooth" });
  }, 300);
});

// ============================================
// RECALCULAR
// ============================================
function recalcularConAdicional() {
  const montoAdicional = parseInt(document.getElementById("montoAdicional").value) || 0;
  
  if (montoAdicional <= 0) {
    UI.mostrarToast('Por favor ingresa un monto adicional mayor a 0', 'error');
    return;
  }

  if (!Estado.ultimoResultado) {
    UI.mostrarToast('Primero realiza una cotizaci√≥n', 'error');
    return;
  }

  Estado.contadorRecalculos++;
  
  const r = Estado.ultimoResultado;
  const nuevoPresupuestoCLP = r.sieteCLP + montoAdicional;
  const nuevoPresupuestoUF = nuevoPresupuestoCLP / Estado.ufValor;
  
  // Seleccionar nuevos planes (implementaci√≥n simplificada)
  const maxPresupuesto = nuevoPresupuestoUF * 1.10;
  const minPresupuesto = nuevoPresupuestoUF * 0.90;
  
  const edadTitular = Number(Estado.formularioDatos.edad);
  const planesZona = Estado.planes.filter(p => p.zona === r.zona || p.zona === 'LIBRE_ELECCION');
  
  const planesConValor = planesZona.map(p => {
    const calc = calcularValorPlan(p.pb_uf, edadTitular, r.edadesCargas);
    return { ...p, ...calc };
  });
  
  const planesValidos = planesConValor.filter(p => p.totalUF <= maxPresupuesto && p.totalUF >= minPresupuesto);
  planesValidos.sort((a, b) => b.totalUF - a.totalUF);
  
  const plan1 = planesValidos[0] || null;
  const plan2 = planesValidos[1] || null;
  
  Estado.ultimoResultado.plan1 = plan1;
  Estado.ultimoResultado.plan2 = plan2;
  Estado.ultimoResultado.montoAdicional = montoAdicional;

  let htmlResultado = `
    <div class="resumen-cotizacion">
      <div class="resumen-titulo">üìä Tu Cotizaci√≥n Mejorada</div>
      <div class="resumen-grid">
        <div class="resumen-item">
          <div class="resumen-label">Tu 7% obligatorio</div>
          <div class="resumen-value">${UI.formatearCLP(r.sieteCLP)}</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Aporte adicional</div>
          <div class="resumen-value" style="color:#4ade80;">+${UI.formatearCLP(montoAdicional)}</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Presupuesto Total</div>
          <div class="resumen-value destacado">${UI.formatearCLP(nuevoPresupuestoCLP)}</div>
        </div>
      </div>
    </div>
  `;
  
  if (plan1) htmlResultado += generarHTMLPlan(plan1, 1, nuevoPresupuestoUF, nuevoPresupuestoCLP, montoAdicional);
  if (plan2) htmlResultado += generarHTMLPlan(plan2, 2, nuevoPresupuestoUF, nuevoPresupuestoCLP, montoAdicional);

  if (Estado.contadorRecalculos < CONFIG.MAX_RECALCULOS) {
    htmlResultado += `
      <div class="mejorar-cobertura">
        <div class="mejorar-titulo">üîÑ ¬øDeseas ajustar tu aporte?</div>
        <div class="mejorar-input-container">
          <input type="number" id="montoAdicional" class="mejorar-input" value="${montoAdicional}" min="0">
          <button type="button" id="btnRecalcular" class="btn-recalcular">üîÑ Recalcular</button>
        </div>
      </div>
    `;
  }

  document.getElementById("resultadoDetalle").innerHTML = htmlResultado;
  
  const btnRecalcular = document.getElementById("btnRecalcular");
  if (btnRecalcular) {
    btnRecalcular.addEventListener("click", recalcularConAdicional);
  }

  UI.mostrarToast('‚úÖ Planes recalculados');
}

// ============================================
// EVENTOS
// ============================================
document.getElementById("btnAsesoria").addEventListener("click", function<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Cotiza tu plan de salud Colmena Golden Cross. Asesor√≠a profesional y personalizada." />
  <title>Planes de Salud Colmena - Asesor√≠a Profesional</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background-color: #0a1a2a; color: white; margin: 0; padding: 0; line-height: 1.6; }
    
    /* Header */
    header { background: linear-gradient(135deg, #0a1a2a, #12375a); padding: 40px 20px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    h1 { color: #d4af37; font-size: clamp(1.8rem, 5vw, 2.5rem); margin: 0 0 10px 0; }
    h2 { color: #d4af37; font-size: clamp(1.3rem, 4vw, 1.8rem); }
    
    /* Layout */
    section { padding: 40px 20px; max-width: 900px; margin: auto; }
    .gold { color: #d4af37; }
    .card { background: #112233; border: 1px solid #d4af37; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    
    /* Buttons */
    button { background: #d4af37; color: #0a1a2a; padding: 15px 25px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; transition: all 0.3s; font-weight: 600; }
    button:hover { opacity: 0.85; transform: translateY(-2px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button:active { transform: translateY(0); }
    
    /* Forms */
    form label { display: block; color: #b8c5d6; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500; }
    form input, form select, form textarea { 
      width: 100%; 
      padding: 12px; 
      margin: 8px 0 16px 0; 
      border-radius: 8px; 
      border: 2px solid #2a3a4a; 
      background: #0a1a2a; 
      color: white; 
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    form input:focus, form select:focus, form textarea:focus { 
      outline: none; 
      border-color: #d4af37; 
      box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
    }
    form input.error, form select.error { border-color: #ff8080; }
    .field-error { color: #ff8080; font-size: 0.85rem; margin-top: -12px; margin-bottom: 12px; display: none; }
    .field-error.show { display: block; }
    
    .whatsapp { display: block; background: #25D366; text-align: center; padding: 15px; color: white; text-decoration: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 20px; max-width: 300px; margin-left: auto; margin-right: auto; transition: all 0.3s; }
    .whatsapp:hover { background: #1da851; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4); }
    
    .small { font-size: 0.9rem; color: #ccc; }
    .row { display:flex; gap:16px; flex-wrap: wrap; }
    .col { flex:1; min-width: 250px; }
    .success-msg { color: #4ade80; margin-top: 12px; font-weight: bold; }
    .error-msg { color: #ff8080; margin-top: 12px; }

    /* Loading skeleton */
    .skeleton { animation: pulse 1.5s ease-in-out infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .skeleton-card { background: #1a2a3a; height: 100px; border-radius: 10px; margin-bottom: 15px; }

    /* Resumen cotizaci√≥n */
    .resumen-cotizacion { background: linear-gradient(135deg, #0d1f2d, #1a2a3a); border: 1px solid #3a5a7a; border-radius: 10px; padding: 20px; margin-bottom: 25px; }
    .resumen-titulo { color: #d4af37; font-size: clamp(1.1rem, 3vw, 1.3rem); margin-bottom: 15px; font-weight: bold; text-align: center; }
    .resumen-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
    .resumen-item { text-align: center; padding: 15px; background: #112233; border-radius: 8px; }
    .resumen-label { font-size: 0.85rem; color: #888; margin-bottom: 5px; }
    .resumen-value { font-size: clamp(1rem, 3vw, 1.2rem); font-weight: bold; color: #fff; }
    .resumen-value.destacado { color: #4ade80; }
    .resumen-uf { font-size: 0.85rem; color: #aaa; }

    /* Card del plan */
    .plan-card { background: #112233; border: 2px solid #d4af37; border-radius: 15px; padding: 25px; margin: 25px 0; }
    .plan-card.secundario { border-color: #60a5fa; }
    .plan-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-bottom: 15px; }
    .plan-badge.principal { background: #d4af37; color: #0a1a2a; }
    .plan-badge.secundario { background: #60a5fa; color: #0a1a2a; }
    
    .plan-nombre-container { text-align: center; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #1a3a5a, #0d1f2d); border-radius: 12px; border: 2px solid #d4af37; }
    .plan-nombre { font-size: clamp(1.2rem, 4vw, 1.8rem); font-weight: bold; color: #d4af37; text-shadow: 0 2px 10px rgba(212,175,55,0.3); letter-spacing: 1px; word-break: break-word; }
    .plan-nombre-estrella { color: #fbbf24; font-size: clamp(1rem, 3vw, 1.5rem); }

    .plan-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0; }
    .plan-info-item { background: #1a2a3a; padding: 15px; border-radius: 8px; text-align: center; }
    .plan-info-label { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
    .plan-info-value { font-size: clamp(0.95rem, 2.5vw, 1.1rem); font-weight: bold; color: #fff; }
    .plan-info-value.verde { color: #4ade80; }
    .plan-info-value.amarillo { color: #fbbf24; }

    .coberturas-section { margin: 20px 0; padding: 15px; background: #0d1f2d; border-radius: 10px; }
    .coberturas-title { color: #d4af37; font-size: 1rem; margin-bottom: 10px; }
    .coberturas-texto { font-size: 0.9rem; line-height: 1.6; color: #ccc; }

    /* Cl√≠nicas */
    .clinicas-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid #3a5a7a; }
    .clinicas-title { color: #d4af37; font-size: 1.1rem; margin-bottom: 15px; }
    .grupos-tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .grupo-tab { background: #1a2a3a; border: 1px solid #3a5a7a; color: #ccc; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
    .grupo-tab:hover { border-color: #d4af37; color: #d4af37; }
    .grupo-tab.active { background: #d4af37; color: #0a1a2a; border-color: #d4af37; font-weight: bold; }
    .clinicas-tabla { width: 100%; border-collapse: collapse; font-size: 0.9rem; overflow-x: auto; display: block; }
    .clinicas-tabla thead { display: table; width: 100%; table-layout: fixed; }
    .clinicas-tabla tbody { display: table; width: 100%; table-layout: fixed; }
    .clinicas-tabla th { background: #1a3a5a; color: #d4af37; padding: 12px 15px; text-align: left; }
    .clinicas-tabla td { padding: 10px 15px; border-bottom: 1px solid #2a3a4a; }
    .clinicas-tabla tr:nth-child(even) { background: #0d1f2d; }
    .clinicas-tabla tr:nth-child(odd) { background: #112233; }
    .clinicas-tabla tr:hover { background: #1a3a4a; }
    .grupo-content { display: none; }
    .grupo-content.active { display: block; }

    .btn-asesoria { display: inline-block; background: linear-gradient(135deg, #d4af37, #f0c860); color: #0a1a2a; padding: 18px 40px; text-decoration: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 15px rgba(212,175,55,0.4); transition: all .3s ease; border: none; cursor: pointer; }
    .btn-asesoria:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,175,55,0.6); }

    /* Referidos */
    .referidos-section { background: linear-gradient(135deg,#0f2640 0%,#1a3a5a 100%); padding:60px 20px; margin:40px 0; }
    .referidos-container { max-width:800px; margin:0 auto; background:#112233; padding:40px 20px; border-radius:20px; border:1px solid #d4af37; }
    .referidos-header { text-align:center; margin-bottom:30px; }
    .referidos-header h2 { color:#d4af37; font-size:clamp(1.3rem, 4vw, 28px); margin-bottom:15px; }
    .referidos-header p { color:#b8c5d6; font-size:16px; }
    .form-section { background:#1a2a3a; padding:25px; border-radius:15px; border-left:4px solid #d4af37; margin-bottom: 20px; }
    .form-section h3 { color:#d4af37; font-size:18px; margin-bottom:15px; margin-top: 0; }
    .btn-enviar-referido { background:linear-gradient(135deg,#d4af37,#f0c860); color:#0a1a2a; padding:15px 40px; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; width:100%; }
    .mensaje-exito-referido, .mensaje-error-referido { padding:15px; border-radius:10px; margin-top:20px; display:none; font-weight:600; text-align:center; }
    .mensaje-exito-referido { background:#1a4d2e; color:#4ade80; border:1px solid #4ade80; }
    .mensaje-error-referido { background:#4a1a1a; color:#ff8080; border:1px solid #ff8080; }

    .disclaimer { background: #1a2a3a; border-left: 4px solid #fbbf24; padding: 15px 20px; margin: 20px 0; border-radius: 0 8px 8px 0; font-size: 0.85rem; color: #b8c5d6; font-style: italic; }
    .disclaimer-icon { color: #fbbf24; margin-right: 8px; }

    .mejorar-cobertura { background: linear-gradient(135deg, #0f2640, #1a3a5a); border: 2px solid #4ade80; border-radius: 15px; padding: 30px 20px; margin: 30px 0; text-align: center; }
    .mejorar-titulo { color: #4ade80; font-size: clamp(1.1rem, 3vw, 1.3rem); margin-bottom: 15px; }
    .mejorar-texto { color: #b8c5d6; font-size: 1rem; line-height: 1.6; margin-bottom: 20px; }
    .mejorar-input-container { display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; margin-top: 20px; }
    .mejorar-input { width: 200px; padding: 15px; font-size: 1.1rem; border: 2px solid #4ade80; border-radius: 10px; background: #0a1a2a; color: white; text-align: center; }
    .mejorar-input:focus { outline: none; border-color: #d4af37; box-shadow: 0 0 10px rgba(212,175,55,0.3); }
    .btn-recalcular { background: linear-gradient(135deg, #4ade80, #22c55e); color: #0a1a2a; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .btn-recalcular:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(74,222,128,0.4); }
    .adicional-actual { background: #112233; padding: 15px 25px; border-radius: 10px; margin: 15px 0; display: inline-block; }
    .adicional-label { color: #888; font-size: 0.9rem; }
    .adicional-valor { color: #4ade80; font-size: clamp(1.1rem, 3vw, 1.3rem); font-weight: bold; }

    .btn-enviar-usuario { background: linear-gradient(135deg, #25d366, #128c7e); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-top: 15px; display: block; width: 100%; max-width: 350px; margin-left: auto; margin-right: auto; }
    .btn-enviar-usuario:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(37,211,102,0.4); }

    /* Toast notifications */
    .toast { position: fixed; bottom: 20px; right: 20px; background: #112233; border: 2px solid #4ade80; border-radius: 10px; padding: 15px 20px; color: white; box-shadow: 0 4px 20px rgba(0,0,0,0.4); z-index: 1000; animation: slideIn 0.3s ease; }
    .toast.error { border-color: #ff8080; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    @media (max-width: 768px) {
      .plan-nombre { font-size: 1.2rem; }
      .clinicas-tabla th, .clinicas-tabla td { padding: 8px 10px; font-size: 0.85rem; }
      .mejorar-input { width: 100%; max-width: 250px; }
      .col { min-width: 100%; }
      .resumen-grid { grid-template-columns: 1fr; }
      header { padding: 30px 15px; }
      section { padding: 30px 15px; }
    }

    @media (max-width: 480px) {
      .plan-info { grid-template-columns: 1fr; }
      .btn-asesoria { padding: 15px 25px; font-size: 1rem; }
    }
  </style>
</head>
<body>

<header>
  <h1>Asesor√≠a en Planes de Salud Colmena</h1>
  <p class="gold">Atenci√≥n premium para clientes exigentes</p>
  <p class="small">Completa el formulario para obtener una cotizaci√≥n exacta en UF y CLP.</p>
</header>

<section id="formulario" class="card">
  <h2 class="gold">Formulario para C√°lculo del Plan</h2>

  <form id="mainForm" novalidate>
    <div class="row">
      <div class="col">
        <label for="nombre">Nombre completo *</label>
        <input type="text" name="nombre" id="nombre" required aria-required="true" />
        <div class="field-error" id="error-nombre">Por favor ingresa tu nombre completo</div>
      </div>
      <div class="col">
        <label for="correo">Correo electr√≥nico *</label>
        <input type="email" name="correo" id="correo" required aria-required="true" />
        <div class="field-error" id="error-correo">Por favor ingresa un correo v√°lido</div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="telefono">Tel√©fono *</label>
        <input type="tel" name="telefono" id="telefono" placeholder="+56912345678" required aria-required="true" />
        <div class="field-error" id="error-telefono">Formato: +56912345678</div>
      </div>
      <div class="col">
        <label for="edad">Edad titular *</label>
        <input type="number" name="edad" id="edad" min="18" max="99" required aria-required="true" />
        <div class="field-error" id="error-edad">Edad debe estar entre 18 y 99 a√±os</div>
      </div>
    </div>

    <label for="rut">RUT *</label>
    <input type="text" name="rut" id="rut" placeholder="12.345.678-9" required aria-required="true" />
    <div class="field-error" id="error-rut">RUT inv√°lido. Formato: 12.345.678-9</div>

    <label for="isapre">Isapre actual *</label>
    <select name="isapre" id="isapre" required aria-required="true">
      <option value="">Selecciona tu isapre</option>
      <option>FONASA</option>
      <option>Colmena</option>
      <option>Cruz Blanca</option>
      <option>Consalud</option>
      <option>Banm√©dica</option>
      <option>Vida Tres</option>
      <option>Nueva Masvida</option>
      <option>Esencial</option>
    </select>
    <div class="field-error" id="error-isapre">Por favor selecciona tu isapre actual</div>

    <label for="renta">Renta imponible mensual (CLP) *</label>
    <input type="number" id="renta" name="renta" min="0" step="1000" required aria-required="true" />
    <div class="field-error" id="error-renta">Por favor ingresa tu renta imponible</div>

    <label for="cargas">Edad de las cargas (separadas por coma)</label>
    <textarea name="cargas" id="cargas" placeholder="Ej: 5, 12, 30" rows="2"></textarea>
    <p class="small" style="margin-top: -8px;">Opcional: ingresa las edades separadas por comas</p>

    <label for="region">Regi√≥n *</label>
    <select name="region" id="region" required aria-required="true">
      <option value="">Selecciona tu Regi√≥n</option>
      <option value="Arica y Parinacota">Regi√≥n de Arica y Parinacota</option>
      <option value="Tarapac√°">Regi√≥n de Tarapac√°</option>
      <option value="Antofagasta">Regi√≥n de Antofagasta</option>
      <option value="Atacama">Regi√≥n de Atacama</option>
      <option value="Coquimbo">Regi√≥n de Coquimbo</option>
      <option value="Valpara√≠so">Regi√≥n de Valpara√≠so</option>
      <option value="Metropolitana">Regi√≥n Metropolitana</option>
      <option value="O'Higgins">Regi√≥n de O'Higgins</option>
      <option value="Maule">Regi√≥n del Maule</option>
      <option value="√ëuble">Regi√≥n de √ëuble</option>
      <option value="B√≠o-B√≠o">Regi√≥n del B√≠o-B√≠o</option>
      <option value="La Araucan√≠a">Regi√≥n de La Araucan√≠a</option>
      <option value="Los R√≠os">Regi√≥n de Los R√≠os</option>
      <option value="Los Lagos">Regi√≥n de Los Lagos</option>
      <option value="Ays√©n">Regi√≥n de Ays√©n</option>
      <option value="Magallanes">Regi√≥n de Magallanes</option>
    </select>
    <div class="field-error" id="error-region">Por favor selecciona tu regi√≥n</div>

    <label for="mensaje">Mensaje adicional</label>
    <textarea name="mensaje" id="mensaje" placeholder="Cu√©ntanos tus necesidades espec√≠ficas..." rows="2"></textarea>

    <button type="submit" id="submitBtn">Cotizar Ahora</button>
    <p id="statusMsg" class="small" style="margin-top:10px;"></p>
  </form>
</section>

<section class="card">
  <h2 class="gold">UF del d√≠a</h2>
  <p class="small">UF: <span id="ufValor">cargando‚Ä¶</span> ‚Äî Fecha: <span id="ufFecha">-</span></p>
</section>

<section id="resultado-preliminar" class="card" style="display:none">
  <div id="resultadoDetalle"></div>

  <div style="text-align:center;margin-top:30px;">
    <button id="btnAsesoria" class="btn-asesoria">üìã Solicitar Asesor√≠a Personalizada</button>
    <p class="small" style="margin-top:10px;">Un asesor te contactar√° a la brevedad.</p>
    
    <button id="btnEnviarUsuario" class="btn-enviar-usuario">üì≤ Recibir Resumen por WhatsApp</button>
    <p class="small" style="margin-top:10px;">Recibir√°s los planes cotizados y documentos requeridos.</p>
  </div>
</section>

<section class="referidos-section" id="referidos" style="display:none">
  <div class="referidos-container">
    <div class="referidos-header">
      <h2>¬øQuieres que asesoremos a un amigo?</h2>
      <p>Ingresa los datos y nos comunicaremos con tu referido.</p>
    </div>

    <form id="formReferidos" novalidate>
      <div class="form-section">
        <h3>üë§ Tus Datos</h3>
        <label for="nombreUsuario">Tu Nombre *</label>
        <input type="text" id="nombreUsuario" required aria-required="true">
      </div>

      <div class="form-section">
        <h3>üéØ Datos del Referido</h3>
        <label for="nombreReferido">Nombre Completo *</label>
        <input type="text" id="nombreReferido" required aria-required="true">
        
        <label for="telefonoReferido">Tel√©fono *</label>
        <input type="tel" id="telefonoReferido" required aria-required="true">
        
        <label for="correoReferido">Correo *</label>
        <input type="email" id="correoReferido" required aria-required="true">
      </div>

      <button type="submit" class="btn-enviar-referido">üì§ Enviar Referido</button>
      <div id="mensajeExitoReferido" class="mensaje-exito-referido">‚úÖ ¬°Referido Enviado!</div>
      <div id="mensajeErrorReferido" class="mensaje-error-referido">‚ùå Error al enviar.</div>
    </form>
  </div>
</section>

<a class="whatsapp" href="https://wa.me/56990701837" target="_blank">üí¨ Contactar por WhatsApp</a>

<footer style="text-align:center; padding:30px; color:#666; font-size:0.85rem;">
  ¬© 2025 Colmena Golden Cross - Asesor√≠a en Planes de Salud
</footer>

<script>
// ============================================
// CONFIGURACI√ìN
// ============================================
const CONFIG = {
  FORM_BASE_URL: 'https://docs.google.com/forms/d/e/1FAIpQLSdWN77vgHicHHkyq8w0ogOzP5MHnlhBSLZAObDyVQo-ILw73g/formResponse',
  FORM_REFERIDOS_URL: 'https://docs.google.com/forms/d/e/1FAIpQLSeIppjYB0Vgc6RsJ3AM0HcAVhLaxAT6ZZ_MxdPhmuwRkwLT-A/formResponse',
  WHATSAPP_ASESORIA: '56975356696',
  CALLMEBOT_PHONE: '56975356696',
  CALLMEBOT_APIKEY: '7360481',
  ASESOR_NOMBRE: 'Jos√© Mora',
  ASESOR_TELEFONO: '+56 9 7535 6696',
  URL_PLANES: 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/main/data/planes_completos.json',
  URL_REDES: 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/main/data/redes_clinicas.json',
  MAX_RECALCULOS: 2
};

const FORM_FIELDS = {
  nombre: 'entry.1455181501',
  rut: 'entry.1514828805',
  correo: 'entry.1253669566',
  telefono: 'entry.1927631596',
  edad: 'entry.1515225692',
  isapre: 'entry.1312575017',
  renta: 'entry.1350273122',
  region: 'entry.1283417188',
  cargas: 'entry.6457415',
  mensaje: 'entry.860152674',
  plan1: 'entry.1176082335',
  plan2: 'entry.1798986413'
};

// ============================================
// ESTADO GLOBAL
// ============================================
const Estado = {
  ufValor: 39700,
  planes: [],
  redesClinicas: {},
  formularioDatos: {},
  ultimoResultado: null,
  contadorRecalculos: 0
};

// ============================================
// VALIDACIONES
// ============================================
const Validador = {
  rut(rut) {
    if (!rut) return false;
    rut = rut.replace(/\./g, '').replace('-', '');
    if (rut.length < 8) return false;
    
    const cuerpo = rut.slice(0, -1);
    const dv = rut.slice(-1).toUpperCase();
    
    let suma = 0;
    let multiplo = 2;
    
    for (let i = cuerpo.length - 1; i >= 0; i--) {
      suma += parseInt(cuerpo[i]) * multiplo;
      multiplo = multiplo < 7 ? multiplo + 1 : 2;
    }
    
    const dvEsperado = 11 - (suma % 11);
    const dvFinal = dvEsperado === 11 ? '0' : dvEsperado === 10 ? 'K' : String(dvEsperado);
    
    return dv === dvFinal;
  },

  email(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  },

  telefono(tel) {
    return /^\+?56\d{9}$/.test(tel.replace(/\s/g, ''));
  },

  edad(edad) {
    const num = parseInt(edad);
    return num >= 18 && num <= 99;
  },

  required(value) {
    return value && value.toString().trim() !== '';
  }
};

// ============================================
// UTILIDADES UI
// ============================================
const UI = {
  mostrarToast(mensaje, tipo = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${tipo}`;
    toast.textContent = mensaje;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.animation = 'slideIn 0.3s ease reverse';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  },

  mostrarError(inputId, mensaje) {
    const input = document.getElementById(inputId);
    const error = document.getElementById(`error-${inputId}`);
    
    if (input && error) {
      input.classList.add('error');
      error.classList.add('show');
      if (mensaje) error.textContent = mensaje;
    }
  },

  limpiarError(inputId) {
    const input = document.getElementById(inputId);
    const error = document.getElementById(`error-${inputId}`);
    
    if (input && error) {
      input.classList.remove('error');
      error.classList.remove('show');
    }
  },

  sanitize(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  },

  formatearCLP(n) {
    return (n || 0).toLocaleString("es-CL");
  }
};

// ============================================
// MAPEO REGIONES Y FACTORES
// ============================================
const REGION_A_ZONA = {
  'Arica y Parinacota': 'NORTE',
  'Tarapac√°': 'NORTE',
  'Antofagasta': 'NORTE',
  'Atacama': 'NORTE',
  'Coquimbo': 'NORTE',
  'Valpara√≠so': 'CENTRO',
  "O'Higgins": 'CENTRO',
  'Maule': 'CENTRO',
  'Metropolitana': 'SANTIAGO',
  '√ëuble': 'SUR',
  'B√≠o-B√≠o': 'SUR',
  'La Araucan√≠a': 'SUR',
  'Los R√≠os': 'SUR',
  'Los Lagos': 'SUR',
  'Ays√©n': 'SUR',
  'Magallanes': 'SUR'
};

function obtenerFactor(edad) {
  if (edad < 2) return 0.0;
  if (edad < 20) return 0.6;
  if (edad < 25) return 0.9;
  if (edad < 35) return 1.0;
  if (edad < 45) return 1.3;
  if (edad < 55) return 1.4;
  if (edad < 65) return 2.0;
  return 2.4;
}

function obtenerFactorCarga(edad) {
  if (edad < 2) return 0.0;
  if (edad < 20) return 0.6;
  if (edad < 25) return 0.7;
  if (edad < 35) return 0.7;
  if (edad < 45) return 0.9;
  if (edad < 55) return 1.0;
  if (edad < 65) return 1.4;
  return 2.2;
}

// ============================================
// CARGA DE DATOS
// ============================================
async function cargarUF() {
  try {
    const r = await fetch("https://mindicador.cl/api/");
    const j = await r.json();
    Estado.ufValor = j.uf.valor;
    document.getElementById("ufValor").innerText = "$" + Estado.ufValor.toLocaleString("es-CL", { minimumFractionDigits: 2 });
    document.getElementById("ufFecha").innerText = new Date(j.uf.fecha).toLocaleDateString("es-CL", { year: "numeric", month: "long", day: "numeric" });
  } catch (err) {
    console.error('Error cargando UF:', err);
    document.getElementById("ufValor").innerText = "$39.700 (estimado)";
    document.getElementById("ufFecha").innerText = "No disponible";
  }
}

async function cargarPlanes() {
  try {
    const r = await fetch(CONFIG.URL_PLANES);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    Estado.planes = await r.json();
    console.log('‚úÖ Planes cargados:', Estado.planes.length);
  } catch (err) {
    console.error('‚ùå Error cargando planes:', err);
    UI.mostrarToast('Error al cargar planes. Intenta m√°s tarde.', 'error');
  }
}

async function cargarRedesClinicas() {
  try {
    const r = await fetch(CONFIG.URL_REDES);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    Estado.redesClinicas = await r.json();
    console.log('‚úÖ Redes de cl√≠nicas cargadas');
  } catch (err) {
    console.error('‚ùå Error cargando redes:', err);
  }
}

// ============================================
// C√ÅLCULOS
// ============================================
function calcularValorPlan(pbUF, edadTitular, edadesCargas) {
  let sumaFactores = obtenerFactor(edadTitular);
  edadesCargas.forEach(e => sumaFactores += obtenerFactorCarga(e));
  
  const valorPlanUF = pbUF * sumaFactores;
  const valorPlanCLP = Math.round(valorPlanUF * Estado.ufValor);
  
  let personasGES = edadTitular >= 2 ? 1 : 0;
  edadesCargas.forEach(e => { if (e >= 2) personasGES++; });
  const gesUF = 0.77 * personasGES;
  const gesCLP = Math.round(gesUF * Estado.ufValor);
  
  const totalUF = valorPlanUF + gesUF;
  const totalCLP = valorPlanCLP + gesCLP;
  
  return { valorPlanUF, valorPlanCLP, gesUF, gesCLP, totalUF, totalCLP, sumaFactores };
}

function seleccionarPlanes(sieteUF, zona, edadTitular, edadesCargas) {
  const minimo95 = sieteUF * 0.95;
  
  const planesZona = Estado.planes.filter(p => 
    p.zona === zona || p.zona === 'LIBRE_ELECCION'
  );
  
  const planesConValor = planesZona.map(p => {
    const calc = calcularValorPlan(p.pb_uf, edadTitular, edadesCargas);
    return { ...p, ...calc };
  });
  
  const planesValidos = planesConValor.filter(p => p.totalUF >= minimo95);
  planesValidos.sort((a, b) => Math.abs(a.totalUF - sieteUF) - Math.abs(b.totalUF - sieteUF));
  
  return { plan1: planesValidos[0] || null, plan2: planesValidos[1] || null };
}

// ============================================
// GENERACI√ìN DE HTML
// ============================================
function generarHTMLPlan(plan, numero, sieteUF, sieteCLP, montoAdicional = 0) {
  if (!plan) return '';
  
  const adicionalUF = Math.max(0, plan.totalUF - sieteUF - (montoAdicional / Estado.ufValor));
  const adicionalCLP = Math.round(adicionalUF * Estado.ufValor);
  
  const esPrincipal = numero === 1;
  const badgeClass = esPrincipal ? 'principal' : 'secundario';
  const cardClass = esPrincipal ? '' : 'secundario';
  const badgeText = esPrincipal ? '‚ú® PLAN RECOMENDADO 1' : 'üî∑ PLAN RECOMENDADO 2';
  
  let coberturasHTML = '';
  if (plan.hospitalizacion) {
    coberturasHTML = `
      <div class="coberturas-section">
        <div class="coberturas-title">üìä Cobertura Hospitalaria</div>
        <div class="coberturas-texto">${plan.hospitalizacion.replace(/\\n/g, '<br>')}</div>
      </div>
    `;
  }
  
  let clinicasHTML = '';
  if (plan.coberturas_redes && Object.keys(Estado.redesClinicas).length > 0) {
    clinicasHTML = generarHTMLClinicas(plan, numero);
  }
  
  return `
    <div class="plan-card ${cardClass}">
      <span class="plan-badge ${badgeClass}">${badgeText}</span>
      
      <div class="plan-nombre-container">
        <span class="plan-nombre-estrella">‚òÖ</span>
        <span class="plan-nombre">${UI.sanitize(plan.plan)}</span>
        <span class="plan-nombre-estrella">‚òÖ</span>
      </div>
      
      <div class="plan-info">
        <div class="plan-info-item">
          <div class="plan-info-label">Valor del Plan</div>
          <div class="plan-info-value">${UI.formatearCLP(plan.totalCLP)}</div>
          <div class="small">${plan.totalUF.toFixed(2)} UF</div>
        </div>
        <div class="plan-info-item">
          <div class="plan-info-label">Adicional a pagar</div>
          <div class="plan-info-value ${adicionalCLP <= 0 ? 'verde' : 'amarillo'}">${UI.formatearCLP(Math.max(0, adicionalCLP))}</div>
        </div>
        <div class="plan-info-item">
          <div class="plan-info-label">GES incluido</div>
          <div class="plan-info-value verde">${UI.formatearCLP(plan.gesCLP)}</div>
          <div class="small">${plan.gesUF.toFixed(2)} UF</div>
        </div>
        <div class="plan-info-item">
          <div class="plan-info-label">Tope anual</div>
          <div class="plan-info-value">${UI.formatearCLP(plan.tope_anual_uf || 7000)} UF</div>
        </div>
      </div>
      
      ${coberturasHTML}
      ${clinicasHTML}
    </div>
  `;
}

function generarHTMLClinicas(plan, numeroPlan) {
  if (!plan.coberturas_redes) return '';
  
  const grupos = Object.keys(plan.coberturas_redes).sort();
  const planId = `plan${numeroPlan}`;
  
  let tabsHTML = grupos.map((g, i) => {
    const activeClass = i === 0 ? 'active' : '';
    const cobertura = plan.coberturas_redes[g];
    return `<button type="button" class="grupo-tab ${activeClass}" onclick="mostrarGrupo('${planId}', '${g}')">${g} (${cobertura}%)</button>`;
  }).join('');
  
  let contenidoHTML = grupos.map((g, i) => {
    const activeClass = i === 0 ? 'active' : '';
    const clinicas = Estado.redesClinicas[g] || [];
    
    let filas = clinicas.map(c => 
      `<tr><td>${UI.sanitize(c.nombre)}</td><td>${UI.sanitize(c.ciudad)}</td></tr>`
    ).join('');
    
    return `
      <div id="${planId}-${g}" class="grupo-content ${activeClass}">
        <table class="clinicas-tabla">
          <thead>
            <tr><th>Nombre Prestador</th><th>Ciudad</th></tr>
          </thead>
          <tbody>${filas}</tbody>
        </table>
      </div>
    `;
  }).join('');
  
  return `
    <div class="clinicas-section">
      <div class="clinicas-title">üè® Red de Cl√≠nicas</div>
      <div class="grupos-tabs">${tabsHTML}</div>
      ${contenidoHTML}
    </div>
  `;
}

function mostrarGrupo(planId, grupo) {
  document.querySelectorAll(`[id^="${planId}-"]`).forEach(el => el.classList.remove('active'));
  
  const grupoContent = document.getElementById(`${planId}-${grupo}`);
  if (grupoContent) {
    const planCard = grupoContent.closest('.plan-card');
    if (planCard) {
      planCard.querySelectorAll('.grupo-tab').forEach(tab => tab.classList.remove('active'));
      planCard.querySelectorAll('.grupo-tab').forEach(tab => {
        if (tab.textContent.startsWith(grupo)) tab.classList.add('active');
      });
    }
  }
  
  document.getElementById(`${planId}-${grupo}`).classList.add('active');
}

// ============================================
// COMUNICACI√ìN
// ============================================
async function enviarCallMeBot(mensaje) {
  if (!CONFIG.CALLMEBOT_APIKEY) return;
  try {
    const url = `https://api.callmebot.com/whatsapp.php?phone=${CONFIG.CALLMEBOT_PHONE}&text=${encodeURIComponent(mensaje)}&apikey=${CONFIG.CALLMEBOT_APIKEY}`;
    await fetch(url, { mode: 'no-cors' });
    console.log('‚úÖ CallMeBot enviado');
  } catch (err) {
    console.error('Error CallMeBot:', err);
  }
}

// ============================================
// FORMULARIO PRINCIPAL
// ============================================
document.getElementById("mainForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  // Validar todos los campos
  let valido = true;
  
  const nombre = document.getElementById('nombre').value;
  if (!Validador.required(nombre)) {
    UI.mostrarError('nombre');
    valido = false;
  } else {
    UI.limpiarError('nombre');
  }
  
  const correo = document.getElementById('correo').value;
  if (!Validador.email(correo)) {
    UI.mostrarError('correo');
    valido = false;
  } else {
    UI.limpiarError('correo');
  }
  
  const telefono = document.getElementById('telefono').value;
  if (!Validador.telefono(telefono)) {
    UI.mostrarError('telefono');
    valido = false;
  } else {
    UI.limpiarError('telefono');
  }
  
  const edad = document.getElementById('edad').value;
  if (!Validador.edad(edad)) {
    UI.mostrarError('edad');
    valido = false;
  } else {
    UI.limpiarError('edad');
  }
  
  const rut = document.getElementById('rut').value;
  if (!Validador.rut(rut)) {
    UI.mostrarError('rut');
    valido = false;
  } else {
    UI.limpiarError('rut');
  }
  
  const isapre = document.getElementById('isapre').value;
  if (!Validador.required(isapre)) {
    UI.mostrarError('isapre');
    valido = false;
  } else {
    UI.limpiarError('isapre');
  }
  
  const renta = document.getElementById('renta').value;
  if (!Validador.required(renta) || renta <= 0) {
    UI.mostrarError('renta');
    valido = false;
  } else {
    UI.limpiarError('renta');
  }
  
  const region = document.getElementById('region').value;
  if (!Validador.required(region)) {
    UI.mostrarError('region');
    valido = false;
  } else {
    UI.limpiarError('region');
  }
  
  if (!valido) {
    UI.mostrarToast('Por favor corrige los errores en el formulario', 'error');
    return;
  }

  const btn = document.getElementById("submitBtn");
  const statusMsg = document.getElementById("statusMsg");
  
  btn.disabled = true;
  btn.textContent = "Calculando...";
  statusMsg.textContent = "";
  
  Estado.contadorRecalculos = 0;

  const data = new FormData(this);

  Estado.formularioDatos = {
    nombre: data.get("nombre"),
    correo: data.get("correo"),
    telefono: data.get("telefono"),
    edad: data.get("edad"),
    rut: data.get("rut"),
    isapre: data.get("isapre"),
    renta: data.get("renta"),
    cargas: data.get("cargas"),
    region: data.get("region"),
    mensaje: data.get("mensaje")
  };

  const rentaNum = Number(Estado.formularioDatos.renta);
  const edadTitular = Number(Estado.formularioDatos.edad);
  
  const cargasTexto = (Estado.formularioDatos.cargas || "").replace(/\n/g, ", ").trim();
  const edadesCargas = cargasTexto.split(/[\n,;]+/).map(s => s.trim()).filter(Boolean).map(Number).filter(n => !isNaN(n));
  
  const sieteCLP = Math.round(rentaNum * 0.07);
  const sieteUF = sieteCLP / Estado.ufValor;
  
  const zona = REGION_A_ZONA[Estado.formularioDatos.region] || 'SANTIAGO';
  
  const { plan1, plan2 } = seleccionarPlanes(sieteUF, zona, edadTitular, edadesCargas);
  
  Estado.ultimoResultado = {
    sieteCLP, sieteUF, edadesCargas, cargasTexto, zona, plan1, plan2
  };

  // Enviar a Google Forms
  try {
    const plan1Nombre = plan1 ? plan1.plan : 'Sin plan disponible';
    const plan2Nombre = plan2 ? plan2.plan : 'Sin plan disponible';
    
    const params = new URLSearchParams();
    Object.keys(FORM_FIELDS).forEach(key => {
      if (key === 'plan1') params.append(FORM_FIELDS[key], plan1Nombre);
      else if (key === 'plan2') params.append(FORM_FIELDS[key], plan2Nombre);
      else if (key === 'cargas') params.append(FORM_FIELDS[key], cargasTexto);
      else params.append(FORM_FIELDS[key], Estado.formularioDatos[key] || '');
    });

    fetch(CONFIG.FORM_BASE_URL, { 
      method: "POST", 
      mode: "no-cors", 
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params.toString()
    }).catch(() => {});

    UI.mostrarToast('‚úÖ Cotizaci√≥n generada exitosamente');
  } catch (err) {
    console.error("Error enviando formulario:", err);
  }

  // CallMeBot
  const cargasInfo = edadesCargas.length > 0 ? `${edadesCargas.length} (${edadesCargas.join(', ')} a√±os)` : '0';
  const msgWA = `üîî NUEVA COTIZACI√ìN

üë§ ${Estado.formularioDatos.nombre}
üìß ${Estado.formularioDatos.correo}
üìû ${Estado.formularioDatos.telefono}
üìç ${Estado.formularioDatos.region} (${zona})
üí∞ Renta: ${UI.formatearCLP(rentaNum)}
üë• Cargas: ${cargasInfo}

üìä 7%: ${UI.formatearCLP(sieteCLP)} (${sieteUF.toFixed(2)} UF)

üìã Planes sugeridos:
1) ${plan1 ? plan1.plan + ' ‚Üí ' + plan1.totalUF.toFixed(2) + ' UF' : 'Sin plan'}
2) ${plan2 ? plan2.plan + ' ‚Üí ' + plan2.totalUF.toFixed(2) + ' UF' : 'Sin plan'}`;
  
  enviarCallMeBot(msgWA);

  // Mostrar resultado
  let htmlResultado = `
    <div class="resumen-cotizacion">
      <div class="resumen-titulo">üìä Tu Cotizaci√≥n - ${UI.sanitize(Estado.formularioDatos.nombre)}</div>
      <div class="resumen-grid">
        <div class="resumen-item">
          <div class="resumen-label">Tu 7% obligatorio</div>
          <div class="resumen-value destacado">${UI.formatearCLP(sieteCLP)}</div>
          <div class="resumen-uf">${sieteUF.toFixed(2)} UF</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Cargas</div>
          <div class="resumen-value">${edadesCargas.length}</div>
          <div class="resumen-uf">${edadesCargas.length > 0 ? '(' + edadesCargas.join(', ') + ' a√±os)' : 'Sin cargas'}</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Zona</div>
          <div class="resumen-value" style="font-size:0.95rem;">${zona}</div>
          <div class="resumen-uf">${Estado.formularioDatos.region}</div>
        </div>
      </div>
    </div>
    
    <h2 class="gold" style="margin-top:30px;">üè• Planes Recomendados</h2>
    <p class="small">Basado en tu 7% (${UI.formatearCLP(sieteCLP)}), te sugerimos estos planes:</p>
  `;
  
  if (plan1) {
    htmlResultado += generarHTMLPlan(plan1, 1, sieteUF, sieteCLP, 0);
  } else {
    htmlResultado += `<p class="small" style="color:#fbbf24;">No se encontr√≥ un plan que cumpla con el criterio para tu 7%. Solicita asesor√≠a personalizada.</p>`;
  }
  
  if (plan2) {
    htmlResultado += generarHTMLPlan(plan2, 2, sieteUF, sieteCLP, 0);
  }

  htmlResultado += `
    <div class="disclaimer">
      <span class="disclaimer-icon">‚ö†Ô∏è</span>
      Los valores presentados son referenciales y est√°n sujetos a verificaci√≥n. Un Ejecutivo de Ventas validar√° esta informaci√≥n y te contactar√° para formalizar tu plan de salud.
    </div>
  `;

  htmlResultado += `
    <div class="mejorar-cobertura">
      <div class="mejorar-titulo">üí° ¬øTe gustar√≠a acceder a mejores coberturas?</div>
      <div class="mejorar-texto">
        Puedes complementar tu 7% legal con un aporte adicional mensual para obtener planes con mayores beneficios.
      </div>
      
      <div class="adicional-actual">
        <div class="adicional-label">Tu presupuesto actual (7%)</div>
        <div class="adicional-valor">${UI.formatearCLP(sieteCLP)}</div>
      </div>
      
      <div class="mejorar-input-container">
        <div>
          <label class="small" style="display:block; margin-bottom:5px; color:#ccc;">Monto adicional mensual:</label>
          <input type="number" id="montoAdicional" class="mejorar-input" placeholder="Ej: 50000" min="0" step="1000">
        </div>
        <button type="button" id="btnRecalcular" class="btn-recalcular">üîÑ Recalcular Planes</button>
      </div>
    </div>
  `;

  document.getElementById("resultadoDetalle").innerHTML = htmlResultado;
  document.getElementById("resultado-preliminar").style.display = "block";

  document.getElementById("btnRecalcular").addEventListener("click", recalcularConAdicional);

  btn.disabled = false;
  btn.textContent = "Cotizar Ahora";

  setTimeout(() => {
    document.getElementById("resultado-preliminar").scrollIntoView({ behavior: "smooth" });
  }, 300);
});

// ============================================
// RECALCULAR
// ============================================
function recalcularConAdicional() {
  const montoAdicional = parseInt(document.getElementById("montoAdicional").value) || 0;
  
  if (montoAdicional <= 0) {
    UI.mostrarToast('Por favor ingresa un monto adicional mayor a 0', 'error');
    return;
  }

  if (!Estado.ultimoResultado) {
    UI.mostrarToast('Primero realiza una cotizaci√≥n', 'error');
    return;
  }

  Estado.contadorRecalculos++;
  
  const r = Estado.ultimoResultado;
  const nuevoPresupuestoCLP = r.sieteCLP + montoAdicional;
  const nuevoPresupuestoUF = nuevoPresupuestoCLP / Estado.ufValor;
  
  // Seleccionar nuevos planes (implementaci√≥n simplificada)
  const maxPresupuesto = nuevoPresupuestoUF * 1.10;
  const minPresupuesto = nuevoPresupuestoUF * 0.90;
  
  const edadTitular = Number(Estado.formularioDatos.edad);
  const planesZona = Estado.planes.filter(p => p.zona === r.zona || p.zona === 'LIBRE_ELECCION');
  
  const planesConValor = planesZona.map(p => {
    const calc = calcularValorPlan(p.pb_uf, edadTitular, r.edadesCargas);
    return { ...p, ...calc };
  });
  
  const planesValidos = planesConValor.filter(p => p.totalUF <= maxPresupuesto && p.totalUF >= minPresupuesto);
  planesValidos.sort((a, b) => b.totalUF - a.totalUF);
  
  const plan1 = planesValidos[0] || null;
  const plan2 = planesValidos[1] || null;
  
  Estado.ultimoResultado.plan1 = plan1;
  Estado.ultimoResultado.plan2 = plan2;
  Estado.ultimoResultado.montoAdicional = montoAdicional;

  let htmlResultado = `
    <div class="resumen-cotizacion">
      <div class="resumen-titulo">üìä Tu Cotizaci√≥n Mejorada</div>
      <div class="resumen-grid">
        <div class="resumen-item">
          <div class="resumen-label">Tu 7% obligatorio</div>
          <div class="resumen-value">${UI.formatearCLP(r.sieteCLP)}</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Aporte adicional</div>
          <div class="resumen-value" style="color:#4ade80;">+${UI.formatearCLP(montoAdicional)}</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Presupuesto Total</div>
          <div class="resumen-value destacado">${UI.formatearCLP(nuevoPresupuestoCLP)}</div>
        </div>
      </div>
    </div>
  `;
  
  if (plan1) htmlResultado += generarHTMLPlan(plan1, 1, nuevoPresupuestoUF, nuevoPresupuestoCLP, montoAdicional);
  if (plan2) htmlResultado += generarHTMLPlan(plan2, 2, nuevoPresupuestoUF, nuevoPresupuestoCLP, montoAdicional);

  if (Estado.contadorRecalculos < CONFIG.MAX_RECALCULOS) {
    htmlResultado += `
      <div class="mejorar-cobertura">
        <div class="mejorar-titulo">üîÑ ¬øDeseas ajustar tu aporte?</div>
        <div class="mejorar-input-container">
          <input type="number" id="montoAdicional" class="mejorar-input" value="${montoAdicional}" min="0">
          <button type="button" id="btnRecalcular" class="btn-recalcular">üîÑ Recalcular</button>
        </div>
      </div>
    `;
  }

  document.getElementById("resultadoDetalle").innerHTML = htmlResultado;
  
  const btnRecalcular = document.getElementById("btnRecalcular");
  if (btnRecalcular) {
    btnRecalcular.addEventListener("click", recalcularConAdicional);
  }

  UI.mostrarToast('‚úÖ Planes recalculados');
}

// ============================================
// EVENTOS
// ============================================
document.getElementById("btnAsesoria").addEventListener("click", function() {
  if (!Estado.formularioDatos || !Estado.formularioDatos.nombre) {
    UI.mostrarToast("Primero completa la cotizaci√≥n", 'error');
    return;
  }

  const r = Estado.ultimoResultado;
  const plan1Nombre = r.plan1 ? r.plan1.plan : '-';
  const plan2Nombre = r.plan2 ? r.plan2.plan : '-';
  
  const cargasInfo = r.edadesCargas.length > 0 ? `${r.edadesCargas.length} (${r.edadesCargas.join(', ')} a√±os)` : '0';
  
  const tieneAdicional = r.montoAdicional && r.montoAdicional > 0;
  const textoAdicional = tieneAdicional 
    ? `‚Ä¢ Aporte adicional: ${UI.formatearCLP(r.montoAdicional)}\n‚Ä¢ Presupuesto total: ${UI.formatearCLP(r.sieteCLP + r.montoAdicional)}`
    : '';

  const mensaje = `üîî SOLICITUD DE ASESOR√çA

üë§ Datos del cliente:
‚Ä¢ Nombre: ${Estado.formularioDatos.nombre}
‚Ä¢ Correo: ${Estado.formularioDatos.correo}
‚Ä¢ RUT: ${Estado.formularioDatos.rut}
‚Ä¢ Tel√©fono: ${Estado.formularioDatos.telefono}
‚Ä¢ Edad: ${Estado.formularioDatos.edad} a√±os
‚Ä¢ Isapre actual: ${Estado.formularioDatos.isapre}
‚Ä¢ Regi√≥n: ${Estado.formularioDatos.region} (${r.zona})
‚Ä¢ Renta: ${UI.formatearCLP(Number(Estado.formularioDatos.renta))}
‚Ä¢ Cargas: ${cargasInfo}

üí∞ Cotizaci√≥n:
‚Ä¢ Tu 7%: ${UI.formatearCLP(r.sieteCLP)} (${r.sieteUF.toFixed(2)} UF)
${textoAdicional}

üìã Planes sugeridos:
1) ${plan1Nombre}
2) ${plan2Nombre}

‚ö° SOLICITA CONTACTO URGENTE`;

  enviarCallMeBot(mensaje);
  
  UI.mostrarToast("‚úÖ Solicitud enviada. Un asesor te contactar√° pronto.");

  document.getElementById("referidos").style.display = "block";
  setTimeout(() => {
    document.getElementById("referidos").scrollIntoView({ behavior: "smooth" });
  }, 400);
});

document.getElementById("btnEnviarUsuario").addEventListener("click", function() {
  if (!Estado.formularioDatos || !Estado.formularioDatos.nombre) {
    UI.mostrarToast("Primero completa la cotizaci√≥n", 'error');
    return;
  }

  const r = Estado.ultimoResultado;
  const plan1Nombre = r.plan1 ? r.plan1.plan : '-';
  const plan2Nombre = r.plan2 ? r.plan2.plan : '-';
  const plan1Valor = r.plan1 ? `${r.plan1.totalUF.toFixed(2)} UF` : '-';
  const plan2Valor = r.plan2 ? `${r.plan2.totalUF.toFixed(2)} UF` : '-';

  const mensaje = `Estimado/a ${Estado.formularioDatos.nombre} üëã

Gracias por tu inter√©s en *Colmena Golden Cross*

üìã *Resumen de tu cotizaci√≥n:*
‚Ä¢ Plan 1: ${plan1Nombre} ‚Üí ${plan1Valor}
‚Ä¢ Plan 2: ${plan2Nombre} ‚Üí ${plan2Valor}
‚Ä¢ Tu 7%: ${UI.formatearCLP(r.sieteCLP)} (${r.sieteUF.toFixed(2)} UF)

üìÑ *Documentos para iniciar tu afiliaci√≥n:*
1. √öltima liquidaci√≥n de sueldo
2. 12 √∫ltimas cotizaciones AFP
3. Foto RUT (ambos lados)

Puedes enviarlos por este medio.

*${CONFIG.ASESOR_NOMBRE}*
Ejecutivo de Ventas - Colmena Golden Cross
üìû ${CONFIG.ASESOR_TELEFONO}`;

  enviarCallMeBot(mensaje);
  
  UI.mostrarToast("‚úÖ Resumen enviado correctamente");
});

// ============================================
// REFERIDOS
// ============================================
document.getElementById("formReferidos").addEventListener("submit", async function(e) {
  e.preventDefault();

  const nombreUsuario = document.getElementById("nombreUsuario").value;
  const nombreReferido = document.getElementById("nombreReferido").value;
  const telefonoReferido = document.getElementById("telefonoReferido").value;
  const correoReferido = document.getElementById("correoReferido").value;

  if (!nombreUsuario || !nombreReferido || !telefonoReferido || !correoReferido) {
    UI.mostrarToast("Por favor completa todos los campos", 'error');
    return;
  }

  const f = new FormData();
  f.append("entry.1664559901", nombreUsuario);
  f.append("entry.715463265", nombreReferido);
  f.append("entry.1382714918", telefonoReferido);
  f.append("entry.897178414", correoReferido);
  f.append("entry.178502788", "Referido enviado desde landing");

  try {
    await fetch(CONFIG.FORM_REFERIDOS_URL, { method: "POST", mode: "no-cors", body: f });
    document.getElementById("mensajeExitoReferido").style.display = "block";
    document.getElementById("mensajeErrorReferido").style.display = "none";

    const msgRef = `üéØ NUEVO REFERIDO

Referido por: ${nombreUsuario}
Nombre: ${nombreReferido}
Tel: ${telefonoReferido}
Correo: ${correoReferido}`;
    enviarCallMeBot(msgRef);

    UI.mostrarToast("‚úÖ Referido enviado exitosamente");

    setTimeout(() => {
      document.getElementById("mainForm").reset();
      Estado.formularioDatos = {};
      Estado.ultimoResultado = null;
      Estado.contadorRecalculos = 0;
      document.getElementById("resultado-preliminar").style.display = "none";
      document.getElementById("referidos").style.display = "none";
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 2000);

  } catch (err) {
    document.getElementById("mensajeErrorReferido").style.display = "block";
    document.getElementById("mensajeExitoReferido").style.display = "none";
    UI.mostrarToast("Error al enviar referido", 'error');
  }
});

// ============================================
// VALIDACI√ìN EN TIEMPO REAL
// ============================================
document.getElementById('rut').addEventListener('blur', function() {
  if (this.value && !Validador.rut(this.value)) {
    UI.mostrarError('rut');
  } else {
    UI.limpiarError('rut');
  }
});

document.getElementById('correo').addEventListener('blur', function() {
  if (this.value && !Validador.email(this.value)) {
    UI.mostrarError('correo');
  } else {
    UI.limpiarError('correo');
  }
});

document.getElementById('telefono').addEventListener('blur', function() {
  if (this.value && !Validador.telefono(this.value)) {
    UI.mostrarError('telefono');
  } else {
    UI.limpiarError('telefono');
  }
});

document.getElementById('edad').addEventListener('blur', function() {
  if (this.value && !Validador.edad(this.value)) {
    UI.mostrarError('edad');
  } else {
    UI.limpiarError('edad');
  }
});

// ============================================
// FORMATEO AUTOM√ÅTICO RUT
// ============================================
document.getElementById('rut').addEventListener('input', function(e) {
  let value = e.target.value.replace(/[^0-9kK]/g, '');
  
  if (value.length > 1) {
    const dv = value.slice(-1);
    const numero = value.slice(0, -1);
    
    // Formatear con puntos
    const formateado = numero.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    e.target.value = `${formateado}-${dv}`;
  } else {
    e.target.value = value;
  }
});

// ============================================
// INICIALIZACI√ìN
// ============================================
window.addEventListener("load", () => {
  cargarUF();
  cargarPlanes();
  cargarRedesClinicas();
  
  // Smooth scroll para navegaci√≥n interna
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  });
});

// ============================================
// SERVICE WORKER (opcional para PWA)
// ============================================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    // Descomentar para habilitar PWA
    // navigator.serviceWorker.register('/sw.js');
  });
}
</script>

</body>
</html> 
