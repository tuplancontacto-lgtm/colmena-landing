<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planes de Salud Colmena - Asesoría Profesional</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #0a1a2a; color: white; margin: 0; padding: 0; }
    header { background: linear-gradient(90deg, #0a1a2a, #12375a); padding: 40px; text-align: center; }
    h1 { color: #d4af37; font-size: 2.5rem; margin: 0; }
    section { padding: 40px 20px; max-width: 900px; margin: auto; }
    .gold { color: #d4af37; }
    .card { background: #112233; border: 1px solid #d4af37; padding: 20px; border-radius: 15px; margin-bottom: 25px; }
    button { background: #d4af37; color: #0a1a2a; padding: 15px 25px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; }
    button:hover { opacity: 0.85; }
    form input, form select, form textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; }
    .whatsapp { display: block; background: #25D366; text-align: center; padding: 15px; color: white; text-decoration: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 20px; max-width: 300px; margin-left: auto; margin-right: auto; }
    .small { font-size: 0.9rem; color: #ccc; }
    .row { display:flex; gap:16px; }
    .col { flex:1; }
    img.profile { width:160px; height:160px; object-fit:cover; border-radius:12px; display:block; margin:16px auto; }
    .uf-note { font-size:0.9rem; color:#cfcfcf; }
  </style>
</head>
<body>
  <header>
    <h1>Asesoría en Planes de Salud Colmena</h1>
    <p class="gold">Atención premium para clientes exigentes</p>
    <p class="small">Completa el formulario para obtener una cotización exacta en UF y CLP.</p>
  </header>

  <!-- FORMULARIO -->
  <section id="formulario" class="card">
    <h2 class="gold">Formulario para Cálculo del Plan</h2>

    <form id="mainForm" action="TU_URL_WEBAPP" method="POST" onsubmit="handleSubmit(event)">

      <div class="row">
        <div class="col"><input type="text" name="nombre" placeholder="Nombre completo" required /></div>
        <div class="col"><input type="email" name="correo" placeholder="Correo electrónico" required /></div>
      </div>

      <div class="row">
        <div class="col"><input type="tel" name="telefono" placeholder="Teléfono" required /></div>
        <div class="col"><input type="number" name="edad" placeholder="Edad titular" required /></div>
      </div>

      <input type="text" name="rut" placeholder="RUT" required />

      <select name="isapre" required>
        <option value="">Isapre actual</option>
        <option>FONASA</option>
        <option>Colmena</option>
        <option>Cruz Blanca</option>
        <option>Consalud</option>
        <option>Banmédica</option>
        <option>Vida Tres</option>
      </select>

      <input type="number" id="renta" name="renta" placeholder="Renta imponible mensual (CLP)" required />

      <label class="small">Edad de las cargas (una por línea)</label>
      <textarea name="cargas" id="cargas" placeholder="Ej: 5&#10;12&#10;30"></textarea>

      <select name="region" required>
        <option value="">Selecciona tu Región</option>
        <option>Región de Arica y Parinacota</option>
        <option>Región de Tarapacá</option>
        <option>Región de Antofagasta</option>
        <option>Región de Atacama</option>
        <option>Región de Coquimbo</option>
        <option>Región de Valparaíso</option>
        <option>Región Metropolitana</option>
        <option>Región de O'Higgins</option>
        <option>Región del Maule</option>
        <option>Región del Ñuble</option>
        <option>Región del Bío-Bío</option>
        <option>Región de La Araucanía</option>
        <option>Región de Los Ríos</option>
        <option>Región de Los Lagos</option>
        <option>Región de Aysén</option>
        <option>Región de Magallanes</option>
      </select>

      <textarea name="mensaje" placeholder="Mensaje adicional (opcional)"></textarea>

      <!-- Valores internos -->
      <input type="hidden" name="valorBasePlan" id="valorBasePlan" value="35000">

      <!-- GES en UF → 0.93 UF por persona -->
      <input type="hidden" name="valorGesUF" id="valorGesUF" value="0.93">

      <button type="submit">Cotizar Ahora</button>
    </form>
  </section>

  <!-- UF -->
  <section class="card">
    <h2 class="gold">UF del día</h2>
    <p class="uf-note">UF: <span id="ufValor">cargando…</span> — Fecha: <span id="ufFecha">-</span></p>
  </section>

  <!-- RESULTADO -->
  <section id="resultado-preliminar" class="card" style="display:none">
    <h2 class="gold">Resultado preliminar</h2>
    <div id="resultadoDetalle" style="line-height:1.7"></div>
  </section>

  <a class="whatsapp" href="https://wa.me/56990701837" target="_blank">Contactar por WhatsApp</a>

  <script>
    /* ================================
          CARGAR UF DEL DÍA
       ================================ */
    async function cargarUF() {
      try {
        const res = await fetch('https://mindicador.cl/api');
        const data = await res.json();
        const uf = data.uf.valor;
        window.__UF_VALOR = uf;
        document.getElementById('ufValor').innerText = uf.toLocaleString('es-CL');
        document.getElementById('ufFecha').innerText = new Date(data.uf.fecha).toLocaleDateString();
      } catch (e) {
        document.getElementById('ufValor').innerText = "Error";
      }
    }

    /* ================================
          FACTORES ETARIOS
       ================================ */
    function obtenerFactor(edad) {
      if (edad <= 18) return 0.6;
      if (edad <= 35) return 1.0;
      if (edad <= 45) return 1.5;
      if (edad <= 59) return 2.0;
      return 2.4;
    }

    function formatearCLP(n) {
      return n.toLocaleString("es-CL");
    }

    /* ================================
          CALCULO GENERAL
       ================================ */
    function calcularCotizacion(obj) {
      const personas = 1 + obj.edadesCargas.length;

      let sumaFactores = obtenerFactor(obj.edadTitular);
      obj.edadesCargas.forEach(e => sumaFactores += obtenerFactor(e));

      const costoFactorizado = obj.valorBasePlan * sumaFactores;

      // GES en UF → CLP
      const uf = window.__UF_VALOR || 0;
      const valorGesCLP = obj.valorGesUF * uf;
      const totalGes = Math.round(valorGesCLP * personas);

      const valorFinal = Math.round(costoFactorizado + totalGes);
      const siete = Math.round(obj.renta * 0.07);
      const adicional = Math.max(0, valorFinal - siete);

      const valorFinalUF = uf ? valorFinal / uf : null;

      return { personas, costoFactorizado, totalGes, valorFinal, siete, adicional, valorFinalUF };
    }

    /* ================================
          ENVIO Y RESULTADO
       ================================ */
    async function handleSubmit(e) {
      e.preventDefault();

      const form = document.getElementById("mainForm");
      const formData = new FormData(form);

      const edadesCargas = (formData.get("cargas") || "")
        .split(/\n/)
        .map(s => s.trim())
        .filter(s => s !== "")
        .map(s => parseInt(s));

      const resultado = calcularCotizacion({
        renta: Number(formData.get("renta")),
        edadTitular: Number(formData.get("edad")),
        edadesCargas,
        valorBasePlan: Number(document.getElementById("valorBasePlan").value),
        valorGesUF: Number(document.getElementById("valorGesUF").value)
      });

      const div = document.getElementById("resultadoDetalle");
      div.innerHTML = `
        <p><strong>Personas en plan:</strong> ${resultado.personas}</p>
        <p><strong>Costo base ajustado:</strong> $${formatearCLP(resultado.costoFactorizado)}</p>
        <p><strong>GES total:</strong> $${formatearCLP(resultado.totalGes)}</p>
        <p><strong>Valor final:</strong> $${formatearCLP(resultado.valorFinal)}</p>
        <p><strong>Valor final UF:</strong> ${resultado.valorFinalUF?.toFixed(3) ?? 'N/D'} UF</p>
        <p><strong>7% renta:</strong> $${formatearCLP(resultado.siete)}</p>
        <p><strong>Adicional:</strong> $${formatearCLP(resultado.adicional)}</p>
      `;
      document.getElementById("resultado-preliminar").style.display = "block";

      /* Enviar al Google Script */
      formData.append("valorFinal", resultado.valorFinal);
      formData.append("adicional", resultado.adicional);
      formData.append("siete", resultado.siete);
      formData.append("personas", resultado.personas);
      formData.append("costoFactorizado", resultado.costoFactorizado);
      formData.append("totalGes", resultado.totalGes);

      try {
        await fetch(form.action, { method: "POST", body: formData });
        div.innerHTML += `<p style="color:#d4af37;margin-top:12px">Enviado correctamente.</p>`;
      } catch (err) {
        div.innerHTML += `<p style="color:#ff8080;margin-top:12px">Error al enviar.</p>`;
      }
    }

    window.addEventListener("load", cargarUF);
  </script>
</body>
</html>
