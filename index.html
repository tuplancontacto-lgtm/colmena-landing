<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planes de Salud Colmena - Asesor√≠a Profesional</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #0a1a2a; color: white; margin: 0; padding: 0; }
    header { background: linear-gradient(90deg, #0a1a2a, #12375a); padding: 40px; text-align: center; }
    h1 { color: #d4af37; font-size: 2.5rem; margin: 0; }
    h2 { color: #d4af37; }
    section { padding: 40px 20px; max-width: 900px; margin: auto; }
    .gold { color: #d4af37; }
    .card { background: #112233; border: 1px solid #d4af37; padding: 25px; border-radius: 15px; margin-bottom: 25px; }
    button { background: #d4af37; color: #0a1a2a; padding: 15px 25px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; }
    button:hover { opacity: 0.85; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    form input, form select, form textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; }
    .whatsapp { display: block; background: #25D366; text-align: center; padding: 15px; color: white; text-decoration: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 20px; max-width: 300px; margin-left: auto; margin-right: auto; }
    .small { font-size: 0.9rem; color: #ccc; }
    .row { display:flex; gap:16px; flex-wrap: wrap; }
    .col { flex:1; min-width: 200px; }
    .success-msg { color: #4ade80; margin-top: 12px; font-weight: bold; }
    .error-msg { color: #ff8080; margin-top: 12px; }
    .resumen-cotizacion { background: #0d1f2d; border: 1px solid #3a5a7a; border-radius: 10px; padding: 20px; margin-bottom: 25px; }
    .resumen-titulo { color: #d4af37; font-size: 1.3rem; margin-bottom: 15px; font-weight: bold; }
    .resumen-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
    .resumen-item { text-align: center; padding: 15px; background: #112233; border-radius: 8px; }
    .resumen-label { font-size: 0.85rem; color: #888; margin-bottom: 5px; }
    .resumen-value { font-size: 1.2rem; font-weight: bold; color: #fff; }
    .resumen-value.destacado { color: #4ade80; }
    .resumen-uf { font-size: 0.85rem; color: #aaa; }
    .plan-card { background: #112233; border: 2px solid #d4af37; border-radius: 15px; padding: 25px; margin: 25px 0; }
    .plan-card.secundario { border-color: #60a5fa; }
    .plan-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-bottom: 15px; }
    .plan-badge.principal { background: #d4af37; color: #0a1a2a; }
    .plan-badge.secundario { background: #60a5fa; color: #0a1a2a; }
    .plan-nombre-container { text-align: center; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #1a3a5a, #0d1f2d); border-radius: 12px; border: 2px solid #d4af37; }
    .plan-nombre { font-size: 1.8rem; font-weight: bold; color: #d4af37; text-shadow: 0 2px 10px rgba(212,175,55,0.3); letter-spacing: 1px; }
    .plan-nombre-estrella { color: #fbbf24; font-size: 1.5rem; }
    .plan-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0; }
    .plan-info-item { background: #1a2a3a; padding: 15px; border-radius: 8px; text-align: center; }
    .plan-info-label { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
    .plan-info-value { font-size: 1.1rem; font-weight: bold; color: #fff; }
    .plan-info-value.verde { color: #4ade80; }
    .plan-info-value.amarillo { color: #fbbf24; }
    .coberturas-section { margin: 20px 0; padding: 15px; background: #0d1f2d; border-radius: 10px; }
    .coberturas-title { color: #d4af37; font-size: 1rem; margin-bottom: 10px; }
    .coberturas-texto { font-size: 0.9rem; line-height: 1.6; color: #ccc; }
    .clinicas-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid #3a5a7a; }
    .clinicas-title { color: #d4af37; font-size: 1.1rem; margin-bottom: 15px; }
    .grupos-tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .grupo-tab { background: #1a2a3a; border: 1px solid #3a5a7a; color: #ccc; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
    .grupo-tab:hover { border-color: #d4af37; color: #d4af37; }
    .grupo-tab.active { background: #d4af37; color: #0a1a2a; border-color: #d4af37; font-weight: bold; }
    .clinicas-tabla { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .clinicas-tabla th { background: #1a3a5a; color: #d4af37; padding: 12px 15px; text-align: left; }
    .clinicas-tabla td { padding: 10px 15px; border-bottom: 1px solid #2a3a4a; }
    .clinicas-tabla tr:nth-child(even) { background: #0d1f2d; }
    .clinicas-tabla tr:nth-child(odd) { background: #112233; }
    .clinicas-tabla tr:hover { background: #1a3a4a; }
    .grupo-content { display: none; }
    .grupo-content.active { display: block; }
    .btn-asesoria { display: inline-block; background: linear-gradient(135deg, #d4af37, #f0c860); color: #0a1a2a; padding: 18px 40px; text-decoration: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 15px rgba(212,175,55,0.4); transition: all .3s ease; border: none; cursor: pointer; }
    .btn-asesoria:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,175,55,0.6); }
    .referidos-section { background: linear-gradient(135deg,#0f2640 0%,#1a3a5a 100%); padding:60px 20px; margin:40px 0; }
    .referidos-container { max-width:800px; margin:0 auto; background:#112233; padding:40px; border-radius:20px; border:1px solid #d4af37; }
    .referidos-header { text-align:center; margin-bottom:30px; }
    .referidos-header h2 { color:#d4af37; font-size:28px; margin-bottom:15px; }
    .referidos-header p { color:#b8c5d6; font-size:16px; }
    .form-section { background:#1a2a3a; padding:25px; border-radius:15px; border-left:4px solid #d4af37; margin-bottom: 20px; }
    .form-section h3 { color:#d4af37; font-size:18px; margin-bottom:15px; margin-top: 0; }
    .form-group-referidos { margin-bottom: 15px; }
    .form-group-referidos label { display:block; color:#b8c5d6; margin-bottom:8px; font-size:14px; }
    .form-group-referidos input { width:100%; padding:12px; border:2px solid #2a3a4a; border-radius:8px; background:#0a1a2a; color:white; }
    .btn-enviar-referido { background:linear-gradient(135deg,#d4af37,#f0c860); color:#0a1a2a; padding:15px 40px; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; width:100%; }
    .mensaje-exito-referido, .mensaje-error-referido { padding:15px; border-radius:10px; margin-top:20px; display:none; font-weight:600; text-align:center; }
    .mensaje-exito-referido { background:#1a4d2e; color:#4ade80; border:1px solid #4ade80; }
    .mensaje-error-referido { background:#4a1a1a; color:#ff8080; border:1px solid #ff8080; }
    .disclaimer { background: #1a2a3a; border-left: 4px solid #fbbf24; padding: 15px 20px; margin: 20px 0; border-radius: 0 8px 8px 0; font-size: 0.85rem; color: #b8c5d6; font-style: italic; }
    .disclaimer-icon { color: #fbbf24; margin-right: 8px; }
    .mejorar-cobertura { background: linear-gradient(135deg, #0f2640, #1a3a5a); border: 2px solid #4ade80; border-radius: 15px; padding: 30px; margin: 30px 0; text-align: center; }
    .mejorar-titulo { color: #4ade80; font-size: 1.3rem; margin-bottom: 15px; }
    .mejorar-texto { color: #b8c5d6; font-size: 1rem; line-height: 1.6; margin-bottom: 20px; }
    .mejorar-input-container { display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; margin-top: 20px; }
    .mejorar-input { width: 200px; padding: 15px; font-size: 1.1rem; border: 2px solid #4ade80; border-radius: 10px; background: #0a1a2a; color: white; text-align: center; }
    .mejorar-input:focus { outline: none; border-color: #d4af37; box-shadow: 0 0 10px rgba(212,175,55,0.3); }
    .btn-recalcular { background: linear-gradient(135deg, #4ade80, #22c55e); color: #0a1a2a; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .btn-recalcular:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(74,222,128,0.4); }
    .adicional-actual { background: #112233; padding: 15px 25px; border-radius: 10px; margin: 15px 0; display: inline-block; }
    .adicional-label { color: #888; font-size: 0.9rem; }
    .adicional-valor { color: #4ade80; font-size: 1.3rem; font-weight: bold; }
    .btn-enviar-usuario { background: linear-gradient(135deg, #25d366, #128c7e); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-top: 15px; display: block; width: 100%; max-width: 350px; margin-left: auto; margin-right: auto; }
    .btn-enviar-usuario:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(37,211,102,0.4); }
    .btn-buscar-clinica { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; display: inline-block; }
    .btn-buscar-clinica:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(96,165,250,0.4); }
    
    /* ESTILOS B√öSQUEDA POR CL√çNICA */
    #seccionBusquedaClinica { 
      border: 2px solid #4ade80 !important; 
      border-radius: 15px;
      background: linear-gradient(135deg, rgba(15, 38, 64, 0.5), rgba(26, 58, 90, 0.5));
    }
    
    #seccionBusquedaClinica h2 { 
      color: #4ade80;
      margin-bottom: 10px;
    }
    
    .busqueda-clinica-resultado { 
      animation: slideIn 0.3s ease-out; 
    }
    
    @keyframes slideIn { 
      from { 
        opacity: 0; 
        transform: translateY(10px); 
      } 
      to { 
        opacity: 1; 
        transform: translateY(0); 
      } 
    }
    
    .btn-enviar-clinica { 
      transition: all 0.3s ease;
    }
    
    .btn-enviar-clinica:hover { 
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(74,222,128,0.4);
    }
    
    @media (max-width: 600px) {
      .plan-nombre { font-size: 1.4rem; }
      .clinicas-tabla th, .clinicas-tabla td { padding: 8px 10px; font-size: 0.85rem; }
      .mejorar-input { width: 100%; }
    }
  </style>
</head>
<body>

<header>
  <h1>Asesor√≠a en Planes de Salud Colmena</h1>
  <p class="gold">Atenci√≥n premium para clientes exigentes</p>
  <p class="small">Completa el formulario para obtener una cotizaci√≥n exacta en UF y CLP.</p>
</header>

<section id="formulario" class="card">
  <h2 class="gold">Formulario para C√°lculo del Plan</h2>
  <form id="mainForm">
    <div class="row">
      <div class="col"><input type="text" name="nombre" id="nombre" placeholder="Nombre completo" required /></div>
      <div class="col"><input type="email" name="correo" id="correo" placeholder="Correo electr√≥nico" required /></div>
    </div>
    <div class="row">
      <div class="col"><input type="tel" name="telefono" id="telefono" placeholder="Tel√©fono (ej: +56912345678)" required /></div>
      <div class="col"><input type="number" name="edad" id="edad" placeholder="Edad titular" min="18" max="99" required /></div>
    </div>
    <input type="text" name="rut" id="rut" placeholder="RUT (ej: 12.345.678-9)" required />
    <select name="isapre" id="isapre" required>
      <option value="">Isapre actual</option>
      <option>FONASA</option>
      <option>Colmena</option>
      <option>Cruz Blanca</option>
      <option>Consalud</option>
      <option>Banm√©dica</option>
      <option>Vida Tres</option>
      <option>Nueva Masvida</option>
      <option>Esencial</option>
    </select>
    <input type="number" id="renta" name="renta" placeholder="Renta imponible mensual (CLP)" required />
    <label class="small">Edad de las cargas (separadas por coma, ej: 5, 12, 30)</label>
    <textarea name="cargas" id="cargas" placeholder="Ej: 5, 12, 30" rows="2"></textarea>
    <select name="region" id="region" required>
      <option value="">Selecciona tu Regi√≥n</option>
      <option value="Arica y Parinacota">Regi√≥n de Arica y Parinacota</option>
      <option value="Tarapac√°">Regi√≥n de Tarapac√°</option>
      <option value="Antofagasta">Regi√≥n de Antofagasta</option>
      <option value="Atacama">Regi√≥n de Atacama</option>
      <option value="Coquimbo">Regi√≥n de Coquimbo</option>
      <option value="Valpara√≠so">Regi√≥n de Valpara√≠so</option>
      <option value="Metropolitana">Regi√≥n Metropolitana</option>
      <option value="O'Higgins">Regi√≥n de O'Higgins</option>
      <option value="Maule">Regi√≥n del Maule</option>
      <option value="√ëuble">Regi√≥n de √ëuble</option>
      <option value="B√≠o-B√≠o">Regi√≥n del B√≠o-B√≠o</option>
      <option value="La Araucan√≠a">Regi√≥n de La Araucan√≠a</option>
      <option value="Los R√≠os">Regi√≥n de Los R√≠os</option>
      <option value="Los Lagos">Regi√≥n de Los Lagos</option>
      <option value="Ays√©n">Regi√≥n de Ays√©n</option>
      <option value="Magallanes">Regi√≥n de Magallanes</option>
    </select>
    <textarea name="mensaje" id="mensaje" placeholder="Mensaje adicional (opcional)" rows="2"></textarea>
    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
      <button type="submit" id="submitBtn" style="flex: 1; min-width: 140px;">Cotizar Ahora</button>
      <button type="button" id="btnBuscarClinicaFormulario" style="flex: 1; min-width: 140px; background: #4ade80; color: #0a1a2a;">üè• Buscar por Cl√≠nica</button>
    </div>
    <p id="statusMsg" class="small" style="margin-top:10px;"></p>
  </form>
</section>

<section class="card">
  <h2 class="gold">UF del d√≠a</h2>
  <p class="small">UF: <span id="ufValor">cargando‚Ä¶</span> ‚Äî Fecha: <span id="ufFecha">-</span></p>
</section>

<section id="resultado-preliminar" class="card" style="display:none">
  <div id="resultadoDetalle"></div>
  <div style="text-align:center;margin-top:30px; display:flex; gap:15px; flex-wrap:wrap; justify-content:center;">
    <button id="btnAsesoria" class="btn-asesoria">üìã Solicitar Asesor√≠a</button>
    <button id="btnBuscarClinicaDesdeResultados" class="btn-buscar-clinica">üè• Buscar por Cl√≠nica</button>
  </div>
  <p class="small" style="margin-top:10px; text-align:center;">Selecciona una opci√≥n para continuar.</p>
  <div style="text-align:center;margin-top:20px;">
    <button id="btnEnviarUsuario" class="btn-enviar-usuario">üì≤ Recibir Resumen por WhatsApp</button>
    <p class="small" style="margin-top:10px;">Recibir√°s los planes cotizados y documentos requeridos.</p>
  </div>
</section>

<!-- SECCI√ìN DE B√öSQUEDA POR CL√çNICA FAVORITA -->
<section id="seccionBusquedaClinica" class="card" style="display:none; margin-top:40px; border: 2px solid #4ade80;">
  <h2 class="gold">üè• Buscar Cotizaci√≥n por Cl√≠nica Favorita</h2>
  <p class="small">¬øTienes una cl√≠nica preferida? Ingresa su nombre y te mostraremos qu√© planes disponibles te ofrecen cobertura en esa cl√≠nica.</p>
  
  <div style="background: linear-gradient(135deg, #0f2640, #1a3a5a); border-radius: 15px; padding: 25px; margin: 20px 0; border: 1px solid #4ade80;">
    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
      <input 
        type="text" 
        id="inputBuscadorClinica" 
        placeholder="Ej: Cl√≠nica D√°vila, Hospital Cl√≠nico, Cl√≠nica Las Condes..." 
        style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid #4ade80; border-radius: 8px; background: #0a1a2a; color: white; font-size: 1rem;"
      />
      <button 
        type="button" 
        id="btnBuscarClinica" 
        style="background: linear-gradient(135deg, #4ade80, #22c55e); color: white; padding: 12px 30px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; font-size: 1rem;"
      >
        üîç Buscar
      </button>
    </div>
    <p class="small" style="color: #888; margin: 0;">Comienza a escribir el nombre de la cl√≠nica y presiona Enter o haz clic en Buscar.</p>
  </div>
  
  <div id="resultadoBusquedaClinica"></div>
</section>

<section class="referidos-section" id="referidos" style="display:none">
  <div class="referidos-container">
    <div class="referidos-header">
      <h2>¬øQuieres que asesoremos a un amigo?</h2>
      <p>Ingresa los datos y nos comunicaremos con tu referido.</p>
    </div>
    <form id="formReferidos">
      <div class="form-section">
        <h3>üë§ Tus Datos</h3>
        <div class="form-group-referidos">
          <label for="nombreUsuario">Tu Nombre *</label>
          <input type="text" id="nombreUsuario" required>
        </div>
      </div>
      <div class="form-section">
        <h3>üéØ Datos del Referido</h3>
        <div class="form-group-referidos">
          <label>Nombre Completo *</label>
          <input type="text" id="nombreReferido" required>
        </div>
        <div class="form-group-referidos">
          <label>Tel√©fono *</label>
          <input type="tel" id="telefonoReferido" required>
        </div>
        <div class="form-group-referidos">
          <label>Correo *</label>
          <input type="email" id="correoReferido" required>
        </div>
      </div>
      <button type="submit" class="btn-enviar-referido">üì§ Enviar Referido</button>
      <div id="mensajeExitoReferido" class="mensaje-exito-referido">‚úÖ ¬°Referido Enviado!</div>
      <div id="mensajeErrorReferido" class="mensaje-error-referido">‚ùå Error al enviar.</div>
    </form>
  </div>
</section>

<a class="whatsapp" id="btnWAAsesor" href="#" target="_blank">Contactar por WhatsApp</a>

<footer style="text-align:center; padding:30px; color:#666; font-size:0.85rem;">
  ¬© 2025 Colmena Golden Cross - Asesor√≠a en Planes de Salud
</footer>

<script>
  /*========================================================
  SISTEMA DE ASESORES MULTI-URL
=========================================================*/
const ASESORES = {
  jose_pepe: {
    nombre: "Jos√© Pepe",
    telefono: "+56990701837",
    whatsapp: "56990701837",
    callmebot_apikey: "5088331",
    correo: "voz.josemora@gmail.com"
  },
  betty: {
    nombre: "Betty Gonz√°lez",
    telefono: "+56983899232",
    whatsapp: "56983899232",
    callmebot_apikey: "PENDIENTE",
    correo: "betty.gonzalez@colmena.cl"
  },
  jose_mora: {
    nombre: "Jos√© Mora",
    telefono: "+56975356696",
    whatsapp: "56975356696",
    callmebot_apikey: "7360481",
    correo: "jose.mora@colmena.cl"
  }
};

function getQueryParam(param) {
  const params = new URLSearchParams(window.location.search);
  return params.get(param);
}

const asesorKey = getQueryParam("asesor") || "jose_mora";
const asesor = ASESORES[asesorKey] || ASESORES["jose_mora"];

const WHATSAPP_ASESORIA = asesor.whatsapp;
const CALLMEBOT_PHONE = asesor.whatsapp;
const CALLMEBOT_APIKEY = asesor.callmebot_apikey;
const ASESOR_NOMBRE = asesor.nombre;
const ASESOR_TELEFONO = asesor.telefono;
const ASESOR_CORREO = asesor.correo;

window.addEventListener("DOMContentLoaded", function() {
  const btnWA = document.getElementById("btnWAAsesor");
  if (btnWA) {
    btnWA.href = `https://wa.me/${WHATSAPP_ASESORIA}`;
    btnWA.innerText = `Contactar a ${ASESOR_NOMBRE} por WhatsApp`;
  }
});

/*========================================================
  CONFIGURACI√ìN GOOGLE FORMS
=========================================================*/
const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdWN77vgHicHHkyq8w0ogOzP5MHnlhBSLZAObDyVQo-ILw73g/formResponse';

const FORM_FIELDS = {
  nombre: 'entry.1455181501',
  rut: 'entry.1514828805',
  correo: 'entry.1253669566',
  telefono: 'entry.1927631596',
  edad: 'entry.1515225692',
  isapre: 'entry.1312575017',
  renta: 'entry.1350273122',
  region: 'entry.1283417188',
  cargas: 'entry.6457415',
  mensaje: 'entry.860152674',
  plan1: 'entry.1176082335',
  plan2: 'entry.1798986413',
  asesorid: 'entry.1496988494'
};

const GOOGLE_FORM_REFERIDOS_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeIppjYB0Vgc6RsJ3AM0HcAVhLaxAT6ZZ_MxdPhmuwRkwLT-A/formResponse';

const REFERIDOS_FIELDS = {
  tu_nombre: "entry.1664559901",
  nombre_referido: "entry.715463265",
  telefono_referido: "entry.1382714918",
  correo_referido: "entry.897178414",
  mensaje_adicional: "entry.178502788",
  asesorid_referidos: "entry.683967436"
};

const URL_PLANES = 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/main/data/planes.json';
const URL_REDES = 'https://raw.githubusercontent.com/tuplancontacto-lgtm/colmena-landing/main/data/redes_clinicas.json';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GRUPOS GX (REDES CL√çNICAS) - Definidos localmente
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const GRUPOS_GX = {
  "Grupo 46 - GX Premium": [
    {
      "nombre": "CL√çNICA ALEMANA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA LAS CONDES",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    }
  ],
  "Grupo 45 - GX Plus": [
    {
      "nombre": "CL√çNICA SAN CARLOS APOQUINDO",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA UNIVERSIDAD CAT√ìLICA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA UNIVERSIDAD DE LOS ANDES",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA MEDS",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA SANTA MAR√çA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    }
  ],
  "Grupo 44 - GX Red": [
    {
      "nombre": "CL√çNICA REDSALUD VITACURA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "HOSPITAL CL√çNICO UNIVERSIDAD CAT√ìLICA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "FUNDACI√ìN ARTURO LOPEZ PEREZ",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "HOSPITAL CL√çNICO DE LA FUERZA A√âREA DE CHILE",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA INDISA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA BUPA ANTOFAGASTA",
      "ciudad": "ANTOFAGASTA",
      "region": "Regi√≥n de Antofagasta"
    },
    {
      "nombre": "CL√çNICA BUPA RE√ëACA",
      "ciudad": "VI√ëA DEL MAR",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "CL√çNICA SANATORIO ALEM√ÅN",
      "ciudad": "CONCEPCI√ìN",
      "region": "Regi√≥n del B√≠o-B√≠o"
    },
    {
      "nombre": "CL√çNICA LOS ANDES",
      "ciudad": "LOS ANGELES",
      "region": "Regi√≥n del B√≠o-B√≠o"
    },
    {
      "nombre": "CL√çNICA ALEMANA DE TEMUCO",
      "ciudad": "TEMUCO",
      "region": "Regi√≥n de La Araucan√≠a"
    },
    {
      "nombre": "CL√çNICA ALEMANA DE VALDIVIA",
      "ciudad": "VALDIVIA",
      "region": "Regi√≥n de Los Rios"
    },
    {
      "nombre": "CL√çNICA ALEMANA DE OSORNO",
      "ciudad": "OSORNO",
      "region": "Regi√≥n de Los Rios"
    },
    {
      "nombre": "CL√çNICA REDSALUD MAGALLANES",
      "ciudad": "PUNTA ARENAS",
      "region": "Regi√≥n de Magallanes"
    }
  ],
  "Grupo 43 - GX Red": [
    {
      "nombre": "HOSPITAL DEL NI√ëO",
      "ciudad": "VI√ëA DEL MAR",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "CL√çNICA CHILLAN",
      "ciudad": "CHILLAN",
      "region": "Regi√≥n de √ëuble"
    },
    {
      "nombre": "CL√çNICA B√çO B√çO",
      "ciudad": "CONCEPCI√ìN",
      "region": "Regi√≥n del B√≠o-B√≠o"
    },
    {
      "nombre": "CL√çNICA ANDES SALUD CONCEPCI√ìN",
      "ciudad": "CONCEPCI√ìN",
      "region": "Regi√≥n del B√≠o-B√≠o"
    },
    {
      "nombre": "HOSPITAL CL√çNICO DEL SUR",
      "ciudad": "CONCEPCI√ìN",
      "region": "Regi√≥n del B√≠o-B√≠o"
    }
  ],
  "Grupo 42 - GX Ampliada": [
    {
      "nombre": "CL√çNICA D√ÅVILA RECOLETA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA REDSALUD PROVIDENCIA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA REDSALUD SANTIAGO",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA EL LOA",
      "ciudad": "CALAMA",
      "region": "Regi√≥n de Antofagasta"
    },
    {
      "nombre": "CL√çNICA PORTADA",
      "ciudad": "ANTOFAGASTA",
      "region": "Regi√≥n de Antofagasta"
    },
    {
      "nombre": "CL√çNICA CUMBRES DEL NORTE",
      "ciudad": "ANTOFAGASTA",
      "region": "Regi√≥n de Antofagasta"
    },
    {
      "nombre": "HOSPITAL MILITAR DEL NORTE",
      "ciudad": "ANTOFAGASTA",
      "region": "Regi√≥n de Antofagasta"
    },
    {
      "nombre": "CL√çNICA RCR ATACAMA",
      "ciudad": "COPIAP√ì",
      "region": "Regi√≥n de Atacama"
    },
    {
      "nombre": "CL√çNICA REDSALUD ELQUI",
      "ciudad": "LA SERENA",
      "region": "Regi√≥n de Coquimbo"
    },
    {
      "nombre": "HOSPITAL CL√çNICO DE VI√ëA DEL MAR",
      "ciudad": "VI√ëA DEL MAR",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "HOSPITAL NAVAL ALMIRANTE NEF",
      "ciudad": "VI√ëA DEL MAR",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "CL√çNICA REDSALUD VALPARAISO",
      "ciudad": "VALPARAISO",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "CL√çNICA LOS CARRERA",
      "ciudad": "QUILPU√â",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "CL√çNICA ISAMEDICA",
      "ciudad": "RANCAGUA",
      "region": "Regi√≥n de O'Higgins"
    },
    {
      "nombre": "HOSPITAL CL√çNICO FUSAT",
      "ciudad": "RANCAGUA",
      "region": "Regi√≥n de O'Higgins"
    },
    {
      "nombre": "CLINICA RED SALUD RANCAGUA (INTEGRAL)",
      "ciudad": "RANCAGUA",
      "region": "Regi√≥n de O'Higgins"
    },
    {
      "nombre": "CL√çNICA LIRCAY",
      "ciudad": "TALCA",
      "region": ""
    },
    {
      "nombre": "CL√çNICA LAS AMAPOLAS",
      "ciudad": "CHILL√ÅN",
      "region": ""
    },
    {
      "nombre": "CL√çNICA REDSALUD MAYOR",
      "ciudad": "TEMUCO",
      "region": "Regi√≥n de La Araucan√≠a"
    },
    {
      "nombre": "CL√çNICA PUERTO VARAS",
      "ciudad": "PUERTO VARAS",
      "region": "Regi√≥n de Los Lagos"
    },
    {
      "nombre": "CL√çNICA ANDES SALUD PUERTO MONTT",
      "ciudad": "PUERTO MONTT",
      "region": "Regi√≥n de Los Lagos"
    },
    {
      "nombre": "CL√çNICA PUERTO MONTT",
      "ciudad": "PUERTO MONTT",
      "region": "Regi√≥n de Los Lagos"
    }
  ],
  "Grupo 41 - GX Preferente": [
    {
      "nombre": "CL√çNICA JUAN PABLO II",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA SIERRA BELLA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "HOSPITAL DEL PROFESOR",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "HOSPITAL PARROQUIAL SAN BERNARDO",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA FLEMING ARICA",
      "ciudad": "ARICA",
      "region": "Regi√≥n de Arica y Parinacota"
    },
    {
      "nombre": "CL√çNICA R√çO BLANCO",
      "ciudad": "LOS ANDES",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "CL√çNICA SAN ANTONIO",
      "ciudad": "SAN ANTONIO",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "CL√çNICA ADVENTISTA LOS ANGELES",
      "ciudad": "LOS ANGELES",
      "region": "Regi√≥n del B√≠o-B√≠o"
    },
    {
      "nombre": "HOSPITAL DE LAS FFAA CIRUJANO GUZM√ÅN",
      "ciudad": "PUNTA ARENAS",
      "region": "Regi√≥n de Magallanes"
    }
  ],
  "GC1 (G55)": [
    {
      "nombre": "CL√çNICA R√çO BLANCO",
      "ciudad": "LOS ANDES",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "CL√çNICA LOS CARRERA",
      "ciudad": "QUILPU√â",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "HOSPITAL NAVAL ALMIRANTE NEF",
      "ciudad": "VI√ëA DEL MAR",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "CL√çNICA REDSALUD RANCAGUA (INTEGRAL)",
      "ciudad": "RANCAGUA",
      "region": "Regi√≥n de O'Higgins"
    },
    {
      "nombre": "CL√çNICA D√ÅVILA RECOLETA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA D√ÅVILA VESPUCIO",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA REDSALUD SANTIAGO",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA REDSALUD PROVIDENCIA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    }
  ],
  "GC2 (G56)": [
    {
      "nombre": "CL√çNICA LOS LEONES",
      "ciudad": "LA CALERA",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "CL√çNICA REDSALUD VALPARA√çSO",
      "ciudad": "VALPARA√çSO",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "HOSPITAL CL√çNICO DE VI√ëA DEL MAR",
      "ciudad": "VI√ëA DEL MAR",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "CL√çNICA ISAMEDICA",
      "ciudad": "RANCAGUA",
      "region": "Regi√≥n de O'Higgins"
    },
    {
      "nombre": "HOSPITAL CL√çNICO FUSAT",
      "ciudad": "RANCAGUA",
      "region": "Regi√≥n de O'Higgins"
    },
    {
      "nombre": "CL√çNICA BUPA SANTIAGO",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    }
  ],
  "GC3 (G57)": [
    {
      "nombre": "CL√çNICA BUPA RE√ëACA",
      "ciudad": "VI√ëA DEL MAR",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "CL√çNICA CIUDAD DEL MAR",
      "ciudad": "VI√ëA DEL MAR",
      "region": "Regi√≥n de Valpara√≠so"
    },
    {
      "nombre": "CL√çNICA INDISA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    }
  ],
  "GS1 (G63)": [
    {
      "nombre": "CL√çNICA PUERTO VARAS",
      "ciudad": "PUERTO VARAS",
      "region": "Regi√≥n de Los Lagos"
    },
    {
      "nombre": "CL√çNICA PUERTO MONTT",
      "ciudad": "PUERTO MONTT",
      "region": "Regi√≥n de Los Lagos"
    },
    {
      "nombre": "HOSPITAL DE LAS FFAA CIRUJANO GUZM√ÅN",
      "ciudad": "PUNTA ARENAS",
      "region": "Regi√≥n de Magallanes"
    },
    {
      "nombre": "CL√çNICA D√ÅVILA RECOLETA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA D√ÅVILA VESPUCIO",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA REDSALUD SANTIAGO",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    },
    {
      "nombre": "CL√çNICA REDSALUD PROVIDENCIA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    }
  ],
  "GS2 (G64)": [
    {
      "nombre": "CL√çNICA REDSALUD MAYOR",
      "ciudad": "TEMUCO",
      "region": "Regi√≥n de La Araucan√≠a"
    },
    {
      "nombre": "CL√çNICA ALEMANA DE OSORNO",
      "ciudad": "OSORNO",
      "region": "Regi√≥n de Los Rios"
    },
    {
      "nombre": "CL√çNICA ANDES SALUD PUERTO MONTT",
      "ciudad": "PUERTO MONTT",
      "region": "Regi√≥n de Los Lagos"
    },
    {
      "nombre": "CL√çNICA REDSALUD MAGALLANES",
      "ciudad": "PUNTA ARENAS",
      "region": "Regi√≥n de Magallanes"
    },
    {
      "nombre": "CL√çNICA BUPA SANTIAGO",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    }
  ],
  "GS3 (G65)": [
    {
      "nombre": "CL√çNICA ALEMANA DE TEMUCO",
      "ciudad": "TEMUCO",
      "region": "Regi√≥n de La Araucan√≠a"
    },
    {
      "nombre": "CL√çNICA ALEMANA DE VALDIVIA",
      "ciudad": "VALDIVIA",
      "region": "Regi√≥n de Los R√≠os"
    },
    {
      "nombre": "CL√çNICA INDISA",
      "ciudad": "SANTIAGO",
      "region": "Regi√≥n Metropolitana"
    }
  ]
};

let contadorRecalculos = 0;
const MAX_RECALCULOS = 2;

/*========================================================
  MAPEO DE REGIONES A ZONAS
=========================================================*/
const REGION_A_ZONA = {
  'Arica y Parinacota': 'NORTE',
  'Tarapac√°': 'NORTE',
  'Antofagasta': 'NORTE',
  'Atacama': 'NORTE',
  'Coquimbo': 'NORTE',
  'Valpara√≠so': 'CENTRO',
  "O'Higgins": 'CENTRO',
  'Maule': 'CENTRO',
  'Metropolitana': 'SANTIAGO',
  '√ëuble': 'SUR',
  'B√≠o-B√≠o': 'SUR',
  'La Araucan√≠a': 'SUR',
  'Los R√≠os': 'SUR',
  'Los Lagos': 'SUR',
  'Ays√©n': 'SUR',
  'Magallanes': 'SUR'
};

/*========================================================
  TABLA DE FACTORES DE EDAD
=========================================================*/
function obtenerFactor(edad) {
  if (edad < 2) return 0.0;
  if (edad < 20) return 0.6;
  if (edad < 25) return 0.9;
  if (edad < 35) return 1.0;
  if (edad < 45) return 1.3;
  if (edad < 55) return 1.4;
  if (edad < 65) return 2.0;
  return 2.4;
}

function obtenerFactorCarga(edad) {
  if (edad < 2) return 0.0;
  if (edad < 20) return 0.6;
  if (edad < 25) return 0.7;
  if (edad < 35) return 0.7;
  if (edad < 45) return 0.9;
  if (edad < 55) return 1.0;
  if (edad < 65) return 1.4;
  return 2.2;
}

/*========================================================
  VARIABLES GLOBALES
=========================================================*/
let formularioDatos = {};
let ultimoResultado = null;
let PLANES = [];
let REDES_CLINICAS = {};

/*========================================================
  CARGAR DATOS
=========================================================*/
async function cargarUF() {
  try {
    const r = await fetch("https://mindicador.cl/api/");
    const j = await r.json();
    const uf = j.uf.valor;
    window.__UF_VALOR = uf;
    document.getElementById("ufValor").innerText = "$" + uf.toLocaleString("es-CL", { minimumFractionDigits: 2 });
    document.getElementById("ufFecha").innerText = new Date(j.uf.fecha).toLocaleDateString("es-CL", { year: "numeric", month: "long", day: "numeric" });
  } catch (err) {
    window.__UF_VALOR = 39700;
    document.getElementById("ufValor").innerText = "$39.700 (estimado)";
    document.getElementById("ufFecha").innerText = "No disponible";
  }
}

async function cargarPlanes() {
  try {
    const r = await fetch(URL_PLANES);
    PLANES = await r.json();
    console.log('‚úÖ Planes cargados:', PLANES.length);
  } catch (err) {
    console.error('Error cargando planes:', err);
  }
}

async function cargarRedesClincias() {
  try {
    const r = await fetch(URL_REDES);
    REDES_CLINICAS = await r.json();
    console.log('‚úÖ Redes de cl√≠nicas cargadas');
  } catch (err) {
    console.error('Error cargando redes:', err);
  }
}

/*========================================================
  FORMATEO
=========================================================*/
function formatearCLP(n) {
  return (n || 0).toLocaleString("es-CL");
}

/*========================================================
  C√ÅLCULO DEL VALOR DEL PLAN
=========================================================*/
function calcularValorPlan(pbUF, edadTitular, edadesCargas) {
  const uf = window.__UF_VALOR || 39700;
  
  let sumaFactores = obtenerFactor(edadTitular);
  edadesCargas.forEach(e => sumaFactores += obtenerFactorCarga(e));
  
  const valorPlanUF = pbUF * sumaFactores;
  const valorPlanCLP = Math.round(valorPlanUF * uf);
  
  let personasGES = edadTitular >= 2 ? 1 : 0;
  edadesCargas.forEach(e => { if (e >= 2) personasGES++; });
  const gesUF = 0.77 * personasGES;
  const gesCLP = Math.round(gesUF * uf);
  
  const totalUF = valorPlanUF + gesUF;
  const totalCLP = valorPlanCLP + gesCLP;
  
  return { valorPlanUF, valorPlanCLP, gesUF, gesCLP, totalUF, totalCLP, sumaFactores };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALCULAR 7% CON VALIDACI√ìN RTI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function calcularSietePorCiento(rentaMensual, ufValor) {
  const RTI_UF = 87.8; // Renta Tope Imponible - Actualizar si cambia
  const rentaEnUF = rentaMensual / ufValor;
  
  // Si renta es mayor al tope, usar el tope para calcular el 7%
  const rentaAUsar = Math.min(rentaEnUF, RTI_UF);
  const sietePorCientoUF = rentaAUsar * 0.07;
  const sietePorCientoCLP = Math.round(sietePorCientoUF * ufValor);
  const rtiAplicado = rentaEnUF > RTI_UF;
  
  return {
    sietePorCientoCLP,
    sietePorCientoUF,
    rtiAplicado
  };
}

/*========================================================
  SELECCI√ìN DE PLANES
=========================================================*/
function seleccionarPlanes(sieteUF, zona, edadTitular, edadesCargas) {
  const minimo95 = sieteUF * 0.95;
  const planesZona = PLANES.filter(p => p.zona === zona || p.zona === 'LIBRE_ELECCION');
  
  const planesConValor = planesZona.map(p => {
    const calc = calcularValorPlan(p.pb_uf, edadTitular, edadesCargas);
    return { ...p, valorCalculadoUF: calc.totalUF, valorCalculadoCLP: calc.totalCLP, gesUF: calc.gesUF, gesCLP: calc.gesCLP, sumaFactores: calc.sumaFactores };
  });
  
  const planesValidos = planesConValor.filter(p => p.valorCalculadoUF >= minimo95);
  planesValidos.sort((a, b) => Math.abs(a.valorCalculadoUF - sieteUF) - Math.abs(b.valorCalculadoUF - sieteUF));
  
  return { plan1: planesValidos[0] || null, plan2: planesValidos[1] || null };
}

function seleccionarPlanesConPresupuesto(presupuestoUF, zona, edadTitular, edadesCargas) {
  const planesZona = PLANES.filter(p => p.zona === zona || p.zona === 'LIBRE_ELECCION');
  
  const planesConValor = planesZona.map(p => {
    const calc = calcularValorPlan(p.pb_uf, edadTitular, edadesCargas);
    return { ...p, valorCalculadoUF: calc.totalUF, valorCalculadoCLP: calc.totalCLP, gesUF: calc.gesUF, gesCLP: calc.gesCLP };
  });
  
  const maxPresupuesto = presupuestoUF * 1.10;
  const minPresupuesto = presupuestoUF * 0.90;
  let planesValidos = planesConValor.filter(p => p.valorCalculadoUF <= maxPresupuesto && p.valorCalculadoUF >= minPresupuesto);
  
  if (planesValidos.length === 0) {
    planesValidos = planesConValor.filter(p => p.valorCalculadoUF <= maxPresupuesto);
    planesValidos.sort((a, b) => b.valorCalculadoUF - a.valorCalculadoUF);
  } else {
    planesValidos.sort((a, b) => b.valorCalculadoUF - a.valorCalculadoUF);
  }
  
  return { plan1: planesValidos[0] || null, plan2: planesValidos[1] || null };
}

/*========================================================
  GENERAR HTML DE UN PLAN
=========================================================*/
function generarHTMLPlan(plan, numero, sieteUF, sieteCLP, montoAdicional = 0) {
  if (!plan) return '';
  
  const uf = window.__UF_VALOR || 39700;
  const adicionalUF = Math.max(0, plan.valorCalculadoUF - sieteUF - (montoAdicional / uf));
  const adicionalCLP = Math.round(adicionalUF * uf);

  const esPrincipal = numero === 1;
  const badgeClass = esPrincipal ? 'principal' : 'secundario';
  const cardClass = esPrincipal ? '' : 'secundario';
  const badgeText = esPrincipal ? '‚ú® PLAN RECOMENDADO 1' : 'üî∑ PLAN RECOMENDADO 2';
  
  let coberturasHTML = '';
  if (plan.hospitalizacion) {
    coberturasHTML = `
      <div class="coberturas-section">
        <div class="coberturas-title">üìä Cobertura Hospitalaria</div>
        <div class="coberturas-texto">${plan.hospitalizacion.replace(/\n/g, '<br>')}</div>
      </div>
    `;
  }
  
  // CONSULTA PREFERENTE O LIBRE ELECCI√ìN
  let consultaHTML = '';
  if (plan.consulta) {
    const consultaTipo = plan.consulta.tipo === 'preferente' ? 'Consulta Preferente Ambulatoria' : 'Consulta Libre Elecci√≥n';
    consultaHTML = `
      <div class="coberturas-section">
        <div class="coberturas-title">üè• ${consultaTipo}</div>
        <div class="coberturas-texto">${plan.consulta.valor}</div>
      </div>
    `;
  }
  
  let clinicasHTML = '';
  clinicasHTML = generarHTMLClinicas(plan, numero);
  
  return `
    <div class="plan-card ${cardClass}">
      <span class="plan-badge ${badgeClass}">${badgeText}</span>
      
      <div class="plan-nombre-container">
        <span class="plan-nombre-estrella">‚òÖ</span>
        <span class="plan-nombre">${plan.plan} <span style="font-size: 0.8rem; color: #aaa;">(${plan.codigo})</span></span>
        <span class="plan-nombre-estrella">‚òÖ</span>
      </div>
      
      <div class="plan-info">
        <div class="plan-info-item">
          <div class="plan-info-label">Valor del Plan</div>
          <div class="plan-info-value">$${formatearCLP(plan.valorCalculadoCLP)}</div>
          <div class="small">${plan.valorCalculadoUF.toFixed(2)} UF</div>
        </div>
        <div class="plan-info-item">
          <div class="plan-info-label">Adicional a pagar</div>
          <div class="plan-info-value ${adicionalCLP <= 0 ? 'verde' : 'amarillo'}">$${formatearCLP(Math.max(0, adicionalCLP))}</div>
        </div>
        <div class="plan-info-item">
          <div class="plan-info-label">GES incluido</div>
          <div class="plan-info-value verde">$${formatearCLP(plan.gesCLP)}</div>
          <div class="small">${plan.gesUF.toFixed(2)} UF</div>
        </div>
        <div class="plan-info-item">
          <div class="plan-info-label">Tope anual</div>
          <div class="plan-info-value">${formatearCLP(plan.tope_anual_uf || 7000)} UF</div>
        </div>
      </div>
      
      ${coberturasHTML}
      ${consultaHTML}
      ${clinicasHTML}
    </div>
  `;
}

/*========================================================
  GENERAR HTML DE CL√çNICAS - REDES GX (G41, G42, G43, G44)
=========================================================*/
/*========================================================
  GENERAR HTML DE CL√çNICAS - 3 FORMATOS
=========================================================*/
function generarHTMLClinicas(plan, numeroPlan) {
  // PRIORIDAD 1: coberturas_redes (% por grupo) - Mostrar SOLO esto
  if (plan.coberturas_redes && Object.keys(plan.coberturas_redes).length > 0) {
    return generarHTMLGruposGX(plan, numeroPlan);
  }
  
  // PRIORIDAD 2: hospitalizacion con cl√≠nicas (SOLO si NO tiene coberturas_redes)
  if (plan.hospitalizacion) {
    return generarHTMLClinicasDesdeHospitalizacion(plan, numeroPlan);
  }
  
  return '';
}

/*========================================================
  M√âTODO 1: coberturas_redes (% por grupo GX)
=========================================================*/
function generarHTMLGruposGX(plan, numeroPlan) {
  const planId = `plan${numeroPlan}`;
  const grupos = ['G41', 'G42', 'G43', 'G44', 'G45', 'G46'];
  
  let gruposHTML = grupos
    .filter(g => plan.coberturas_redes[g] !== undefined)
    .map((g, i) => {
      const cobertura = plan.coberturas_redes[g];
      const grupoId = `${planId}-${g}`;
      const flecha = i === 0 ? '‚ñº' : '‚ñ∫';
      const colorCobertura = cobertura >= 90 ? '#4ade80' : cobertura >= 80 ? '#fbbf24' : cobertura >= 60 ? '#60a5fa' : '#ff8080';
      
      // Obtener cl√≠nicas reales del grupo
      let clinicasHTML = '';
      const grupoNombre = `Grupo ${g.substring(1)} - GX ${g === 'G41' ? 'Ampliada' : g === 'G42' ? 'Ampliada' : g === 'G43' ? 'Red' : g === 'G44' ? 'Red' : g === 'G45' ? 'Plus' : 'Premium'}`;
      const clinicasDelGrupo = GRUPOS_GX[grupoNombre] || [];
      
      if (clinicasDelGrupo.length > 0) {
        clinicasHTML = clinicasDelGrupo.map(c => 
          `<div style="padding: 8px 15px; border-bottom: 1px solid #1a3a5a; font-size: 0.9rem;">
            <span style="color: #4ade80;">‚úì</span> ${c.nombre} <span style="color: #888; font-size: 0.85rem;">(${c.ciudad})</span>
          </div>`
        ).join('');
      }
      
      return `
        <div style="margin-bottom: 12px;">
          <button type="button" class="grupo-boton-expandible" onclick="toggleClinicasGrupo('${grupoId}', this)" style="
            width: 100%;
            background: #1a3a5a;
            border: 1px solid #3a5a7a;
            color: #d4af37;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-align: left;
            transition: all 0.3s;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <span>${flecha} ${g} - ${clinicasDelGrupo.length} prestadores</span>
            <span style="color: ${colorCobertura}; font-weight: bold;">${cobertura}%</span>
          </button>
          <div id="${grupoId}" class="clinicas-grupo-content" style="
            display: ${i === 0 ? 'block' : 'none'};
            background: #0d1f2d;
            border: 1px solid #2a3a4a;
            border-top: none;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
          ">
            ${clinicasHTML || '<div style="padding: 15px; color: #888;">Sin cl√≠nicas registradas</div>'}
          </div>
        </div>
      `;
    })
    .join('');
  
  return gruposHTML ? `
    <div class="clinicas-section" style="margin-top: 20px; border-top: 1px solid #3a5a7a; padding-top: 20px;">
      <div style="color: #d4af37; font-weight: bold; margin-bottom: 15px; font-size: 1.1rem;">üè• Redes de Cl√≠nicas GX</div>
      <div style="display: flex; flex-direction: column; gap: 8px;">
        ${gruposHTML}
      </div>
    </div>
  ` : '';
}

/*========================================================
  M√âTODO 2: hospitalizacion con %GXX=NN%
=========================================================*/
function generarHTMLGruposDesdeHospitalizacion(plan, numeroPlan) {
  const planId = `plan${numeroPlan}`;
  const regex = /%G(\d+)=(\d+)%/g;
  const grupos = {};
  let match;
  
  while ((match = regex.exec(plan.hospitalizacion)) !== null) {
    const grupoNum = match[1];
    const cobertura = parseInt(match[2]);
    grupos[`G${grupoNum}`] = cobertura;
  }
  
  if (Object.keys(grupos).length === 0) {
    return '';
  }
  
  let gruposHTML = Object.entries(grupos)
    .map(([g, cobertura], i) => {
      const grupoId = `${planId}-${g}`;
      const flecha = i === 0 ? '‚ñº' : '‚ñ∫';
      const colorCobertura = cobertura >= 90 ? '#4ade80' : cobertura >= 80 ? '#fbbf24' : cobertura >= 60 ? '#60a5fa' : '#ff8080';
      
      return `
        <div style="margin-bottom: 12px;">
          <button type="button" class="grupo-boton-expandible" onclick="toggleClinicasGrupo('${grupoId}', this)" style="
            width: 100%;
            background: #1a3a5a;
            border: 1px solid #3a5a7a;
            color: #d4af37;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-align: left;
            transition: all 0.3s;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <span>${flecha} ${g}</span>
            <span style="color: ${colorCobertura}; font-weight: bold;">${cobertura}%</span>
          </button>
          <div id="${grupoId}" class="clinicas-grupo-content" style="
            display: ${i === 0 ? 'block' : 'none'};
            background: #0d1f2d;
            border: 1px solid #2a3a4a;
            border-top: none;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            padding: 15px;
            color: #999;
            font-size: 0.9rem;
          ">
            Red de cl√≠nicas con ${cobertura}% de cobertura
          </div>
        </div>
      `;
    })
    .join('');
  
  return `
    <div class="clinicas-section" style="margin-top: 20px; border-top: 1px solid #3a5a7a; padding-top: 20px;">
      <div style="color: #d4af37; font-weight: bold; margin-bottom: 15px; font-size: 1.1rem;">üè• Redes de Cl√≠nicas GX</div>
      <div style="display: flex; flex-direction: column; gap: 8px;">
        ${gruposHTML}
      </div>
    </div>
  `;
}

/*========================================================
  M√âTODO 3: texto_completo con "Red de Cl√≠nicas Gxx"
=========================================================*/
function generarHTMLDesdeTextoCompleto(plan, numeroPlan) {
  const texto = plan.texto_completo;
  const planId = `plan${numeroPlan}`;
  const regexRedes = /(\d+)%\s*cobertura\s*‚Äì\s*Red de Cl√≠nicas\s*(G\d+)\s*\(([^)]+)\)/gi;
  
  const redes = {};
  let match;
  
  while ((match = regexRedes.exec(texto)) !== null) {
    const cobertura = match[1];
    const grupo = match[2];
    const clinicasTexto = match[3];
    
    const clinicas = clinicasTexto.split(',').map(c => {
      const partes = c.trim().split(' ‚Äì ');
      return {
        nombre: partes[0].trim(),
        ciudad: partes[1] ? partes[1].trim() : ''
      };
    });
    
    redes[grupo] = {
      cobertura: parseInt(cobertura),
      clinicas: clinicas
    };
  }
  
  if (Object.keys(redes).length === 0) {
    return '';
  }
  
  const gruposOrdenados = ['G41', 'G42', 'G43', 'G44', 'G45', 'G46'].filter(g => redes[g]);
  
  let gruposHTML = gruposOrdenados.map((grupo, i) => {
    const flecha = i === 0 ? '‚ñº' : '‚ñ∫';
    const data = redes[grupo];
    const grupoId = `${planId}-${grupo}`;
    const colorCobertura = data.cobertura >= 90 ? '#4ade80' : data.cobertura >= 80 ? '#fbbf24' : data.cobertura >= 60 ? '#60a5fa' : '#ff8080';
    
    let clinicasListado = data.clinicas.map(c => 
      `<div style="padding: 8px 15px; border-bottom: 1px solid #1a3a5a; font-size: 0.9rem;">
        <span style="color: #4ade80;">‚úì</span> ${c.nombre} <span style="color: #888; font-size: 0.85rem;">${c.ciudad ? '(' + c.ciudad + ')' : ''}</span>
      </div>`
    ).join('');
    
    return `
      <div style="margin-bottom: 12px;">
        <button type="button" class="grupo-boton-expandible" onclick="toggleClinicasGrupo('${grupoId}', this)" style="
          width: 100%;
          background: #1a3a5a;
          border: 1px solid #3a5a7a;
          color: #d4af37;
          padding: 12px 15px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
          text-align: left;
          transition: all 0.3s;
          font-size: 0.95rem;
          display: flex;
          justify-content: space-between;
          align-items: center;
        ">
          <span>${flecha} ${grupo} - ${data.clinicas.length} prestadores</span>
          <span style="color: ${colorCobertura}; font-weight: bold;">${data.cobertura}%</span>
        </button>
        <div id="${grupoId}" class="clinicas-grupo-content" style="
          display: ${i === 0 ? 'block' : 'none'};
          background: #0d1f2d;
          border: 1px solid #2a3a4a;
          border-top: none;
          border-radius: 0 0 8px 8px;
          overflow: hidden;
        ">
          ${clinicasListado}
        </div>
      </div>
    `;
  }).join('');
  
  return `
    <div class="clinicas-section" style="margin-top: 20px; border-top: 1px solid #3a5a7a; padding-top: 20px;">
      <div style="color: #d4af37; font-weight: bold; margin-bottom: 15px; font-size: 1.1rem;">üè• Redes de Cl√≠nicas</div>
      <div style="display: flex; flex-direction: column; gap: 8px;">
        ${gruposHTML}
      </div>
    </div>
  `;
}

/*========================================================
  M√âTODO 4: hospitalizacion con cl√≠nicas (texto descriptivo)
=========================================================*/
function generarHTMLClinicasDesdeHospitalizacion(plan, numeroPlan) {
  const planId = `plan${numeroPlan}`;
  const lineas = plan.hospitalizacion.split('\n').filter(l => l.trim());
  
  let seccionesHTML = '';
  let porcentajeActual = null;
  let clinicasActuales = [];
  
  for (const linea of lineas) {
    const match = linea.match(/^(\d+)%\s*(.*)/);
    
    if (match) {
      if (porcentajeActual !== null && clinicasActuales.length > 0) {
        seccionesHTML += generarSeccionClinicas(planId, porcentajeActual, clinicasActuales);
      }
      
      porcentajeActual = match[1];
      const textClinicas = match[2].trim();
      clinicasActuales = textClinicas ? [textClinicas] : [];
    } else if (porcentajeActual !== null && linea.trim()) {
      clinicasActuales.push(linea.trim());
    }
  }
  
  if (porcentajeActual !== null && clinicasActuales.length > 0) {
    seccionesHTML += generarSeccionClinicas(planId, porcentajeActual, clinicasActuales);
  }
  
  return seccionesHTML ? `
    <div class="clinicas-section" style="margin-top: 20px; border-top: 1px solid #3a5a7a; padding-top: 20px;">
      <div style="color: #d4af37; font-weight: bold; margin-bottom: 15px; font-size: 1.1rem;">üè• Cobertura Hospitalaria</div>
      <div style="display: flex; flex-direction: column; gap: 8px;">
        ${seccionesHTML}
      </div>
    </div>
  ` : '';
}

function generarSeccionClinicas(planId, porcentaje, clinicasTexto) {
  const seccionId = `${planId}-cobertura-${porcentaje}`;
  const colorCobertura = porcentaje >= 90 ? '#4ade80' : porcentaje >= 80 ? '#fbbf24' : porcentaje >= 70 ? '#60a5fa' : '#ff8080';
  
  let clinicasListado = '';
  for (const texto of clinicasTexto) {
    const clinicas = texto.split(/[,]+/).map(c => c.trim()).filter(c => c);
    clinicasListado += clinicas.map(c => 
      `<div style="padding: 8px 15px; border-bottom: 1px solid #1a3a5a; font-size: 0.9rem;">
        <span style="color: #4ade80;">‚úì</span> ${c}
      </div>`
    ).join('');
  }
  
  return `
    <div style="margin-bottom: 12px;">
      <button type="button" class="grupo-boton-expandible" onclick="toggleClinicasGrupo('${seccionId}', this)" style="
        width: 100%;
        background: #1a3a5a;
        border: 1px solid #3a5a7a;
        color: #d4af37;
        padding: 12px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        text-align: left;
        transition: all 0.3s;
        font-size: 0.95rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <span>‚ñ∫ ${porcentaje}% Cobertura</span>
        <span style="color: ${colorCobertura}; font-weight: bold; font-size: 1rem;">${porcentaje}%</span>
      </button>
      <div id="${seccionId}" class="clinicas-grupo-content" style="
        display: none;
        background: #0d1f2d;
        border: 1px solid #2a3a4a;
        border-top: none;
        border-radius: 0 0 8px 8px;
        overflow: hidden;
      ">
        ${clinicasListado}
      </div>
    </div>
  `;
}

// Funci√≥n para toggle de grupos de cl√≠nicas
function toggleClinicasGrupo(grupoId, boton) {
  const contenido = document.getElementById(grupoId);
  if (!contenido) return;
  
  // Toggle display
  const isActive = contenido.style.display === 'block';
  contenido.style.display = isActive ? 'none' : 'block';
  
  // Cambiar flecha
  const textoActual = boton.textContent;
  const nuevaFlecha = isActive ? '‚ñ∫' : '‚ñº';
  const textSinFlecha = textoActual.substring(3);
  boton.textContent = nuevaFlecha + ' ' + textSinFlecha;
  
  // Cambiar clase active
  if (isActive) {
    boton.classList.remove('active');
  } else {
    boton.classList.add('active');
  }
}

/*========================================================
  CALLMEBOT
=========================================================*/
async function enviarCallMeBot(mensaje) {
  if (!CALLMEBOT_APIKEY || CALLMEBOT_APIKEY === "PENDIENTE") {
    console.warn('‚ö†Ô∏è CallMeBot no configurado para este asesor');
    return;
  }
  try {
    const url = `https://api.callmebot.com/whatsapp.php?phone=${CALLMEBOT_PHONE}&text=${encodeURIComponent(mensaje)}&apikey=${CALLMEBOT_APIKEY}`;
    await fetch(url, { mode: 'no-cors' });
    console.log('‚úÖ CallMeBot enviado');
  } catch (err) {
    console.error('Error CallMeBot:', err);
  }
}

  /*========================================================
  FORMULARIO PRINCIPAL
=========================================================*/
document.getElementById("mainForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const btn = document.getElementById("submitBtn");
  const statusMsg = document.getElementById("statusMsg");
  
  btn.disabled = true;
  btn.textContent = "Calculando...";
  statusMsg.textContent = "";
  contadorRecalculos = 0;

  const data = new FormData(this);

  formularioDatos = {
    nombre: data.get("nombre"),
    correo: data.get("correo"),
    telefono: data.get("telefono"),
    edad: data.get("edad"),
    rut: data.get("rut"),
    isapre: data.get("isapre"),
    renta: data.get("renta"),
    cargas: data.get("cargas"),
    region: data.get("region"),
    mensaje: data.get("mensaje")
  };
  
  // VALIDAR CAMPOS OBLIGATORIOS
  const camposObligatorios = ['nombre', 'correo', 'telefono', 'edad', 'rut', 'isapre', 'renta', 'region'];
  const faltanCampos = camposObligatorios.filter(campo => !formularioDatos[campo]);
  
  if (faltanCampos.length > 0) {
    statusMsg.textContent = "‚ùå Por favor completa todos los campos requeridos";
    statusMsg.className = "small error-msg";
    btn.disabled = false;
    btn.textContent = "Cotizar Ahora";
    return;
  }

  const uf = window.__UF_VALOR || 39700;
  const renta = Number(formularioDatos.renta);
  const edadTitular = Number(formularioDatos.edad);
  
  const cargasTexto = (formularioDatos.cargas || "").replace(/\n/g, ", ").trim();
  const edadesCargas = cargasTexto.split(/[\n,;]+/)
    .map(s => s.trim())
    .filter(Boolean)
    .map(Number)
    .filter(n => !isNaN(n) && n >= 0 && n <= 120);
  
  // CALCULAR 7% CON VALIDACI√ìN RTI
  const calcSiete = calcularSietePorCiento(renta, uf);
  const sieteCLP = calcSiete.sietePorCientoCLP;
  const sieteUF = calcSiete.sietePorCientoUF;
  const rtiAplicado = calcSiete.rtiAplicado;
  
  const zona = REGION_A_ZONA[formularioDatos.region] || 'SANTIAGO';
  
  const { plan1, plan2 } = seleccionarPlanes(sieteUF, zona, edadTitular, edadesCargas);
  
  ultimoResultado = { sieteCLP, sieteUF, edadesCargas, cargasTexto, zona, plan1, plan2, edadTitular };

  // ENVIAR A GOOGLE FORMS
  try {
    const plan1Nombre = plan1 ? plan1.plan : 'Sin plan disponible';
    const plan2Nombre = plan2 ? plan2.plan : 'Sin plan disponible';
    
    const params = new URLSearchParams();
    params.append(FORM_FIELDS.nombre, formularioDatos.nombre);
    params.append(FORM_FIELDS.rut, formularioDatos.rut);
    params.append(FORM_FIELDS.correo, formularioDatos.correo);
    params.append(FORM_FIELDS.telefono, formularioDatos.telefono);
    params.append(FORM_FIELDS.edad, formularioDatos.edad);
    params.append(FORM_FIELDS.isapre, formularioDatos.isapre);
    params.append(FORM_FIELDS.renta, formularioDatos.renta);
    params.append(FORM_FIELDS.region, formularioDatos.region);
    params.append(FORM_FIELDS.cargas, cargasTexto || 'Sin cargas');
    params.append(FORM_FIELDS.mensaje, formularioDatos.mensaje || "(sin mensaje)");
    params.append(FORM_FIELDS.plan1, plan1Nombre);
    params.append(FORM_FIELDS.plan2, plan2Nombre);
    params.append(FORM_FIELDS.asesorid, asesorKey);

    fetch(FORM_BASE_URL, { 
      method: "POST", 
      mode: "no-cors", 
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: params.toString()
    }).catch(() => {});

    statusMsg.textContent = "‚úÖ Datos enviados correctamente";
    statusMsg.className = "small success-msg";
  } catch (err) {
    statusMsg.textContent = "‚ö†Ô∏è Error al enviar";
    statusMsg.className = "small error-msg";
  }

  // CALLMEBOT
  const cargasInfo = edadesCargas.length > 0 ? `${edadesCargas.length} (${edadesCargas.join(', ')} a√±os)` : '0';
  const msgWA = `üîî NUEVA COTIZACI√ìN - ${ASESOR_NOMBRE}

üë§ ${formularioDatos.nombre}
üìß ${formularioDatos.correo}
üìû ${formularioDatos.telefono}
üìç ${formularioDatos.region} (${zona})
üí∞ Renta: $${formatearCLP(renta)}
üë• Cargas: ${cargasInfo}

üìä 7%: $${formatearCLP(sieteCLP)} (${sieteUF.toFixed(2)} UF)

üìã Planes sugeridos:
1) ${plan1 ? plan1.plan + ' ‚Üí ' + plan1.valorCalculadoUF.toFixed(2) + ' UF' : 'Sin plan'}
2) ${plan2 ? plan2.plan + ' ‚Üí ' + plan2.valorCalculadoUF.toFixed(2) + ' UF' : 'Sin plan'}`;
  
  enviarCallMeBot(msgWA);

  // MOSTRAR RESULTADO
  let htmlResultado = `
    <div class="resumen-cotizacion">
      <div class="resumen-titulo">üìä Tu Cotizaci√≥n - ${formularioDatos.nombre}</div>
      <div class="resumen-grid">
        <div class="resumen-item">
          <div class="resumen-label">Tu 7% obligatorio</div>
          <div class="resumen-value destacado">$${formatearCLP(sieteCLP)}</div>
          <div class="resumen-uf">${sieteUF.toFixed(2)} UF</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Cargas</div>
          <div class="resumen-value">${edadesCargas.length}</div>
          <div class="resumen-uf">${edadesCargas.length > 0 ? '(' + edadesCargas.join(', ') + ' a√±os)' : 'Sin cargas'}</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Zona</div>
          <div class="resumen-value" style="font-size:0.95rem;">${zona}</div>
          <div class="resumen-uf">${formularioDatos.region}</div>
        </div>
      </div>
    </div>
    
    <h2 class="gold" style="margin-top:30px;">üè• Planes Recomendados</h2>
    <p class="small">Basado en tu 7% ($${formatearCLP(sieteCLP)}), te sugerimos estos planes:</p>
  `;
  
  if (plan1) {
    htmlResultado += generarHTMLPlan(plan1, 1, sieteUF, sieteCLP, 0);
  } else {
    htmlResultado += `<p class="small" style="color:#fbbf24;">No se encontr√≥ un plan que cumpla con el criterio para tu 7%. Solicita asesor√≠a personalizada.</p>`;
  }
  
  if (plan2) {
    htmlResultado += generarHTMLPlan(plan2, 2, sieteUF, sieteCLP, 0);
  }

  htmlResultado += `
    <div class="disclaimer">
      <span class="disclaimer-icon">‚ö†Ô∏è</span>
      Los valores presentados son referenciales y est√°n sujetos a verificaci√≥n. Un Ejecutivo de Ventas validar√° esta informaci√≥n y te contactar√° para formalizar tu plan de salud.
    </div>
  `;

  htmlResultado += `
    <div class="mejorar-cobertura">
      <div class="mejorar-titulo">üí° ¬øTe gustar√≠a acceder a mejores coberturas?</div>
      <div class="mejorar-texto">
        Puedes complementar tu 7% legal con un aporte adicional mensual para obtener planes con mayores beneficios, mejor red de cl√≠nicas y mayor protecci√≥n para ti y tu familia.
      </div>
      
      <div class="adicional-actual">
        <div class="adicional-label">Tu presupuesto actual (7%)</div>
        <div class="adicional-valor">$${formatearCLP(sieteCLP)}</div>
      </div>
      
      <div class="mejorar-input-container">
        <div>
          <label class="small" style="display:block; margin-bottom:5px; color:#ccc;">Monto adicional mensual:</label>
          <input type="number" id="montoAdicional" class="mejorar-input" placeholder="Ej: 50000" min="0" step="1000">
        </div>
        <button type="button" id="btnRecalcular" class="btn-recalcular">üîÑ Recalcular Planes</button>
      </div>
      <p class="small" style="margin-top:15px; color:#888;">Ingresa un monto en pesos chilenos para ver planes con mejores coberturas.</p>
    </div>
  `;

  document.getElementById("resultadoDetalle").innerHTML = htmlResultado;
  document.getElementById("resultado-preliminar").style.display = "block";

  document.getElementById("btnRecalcular").addEventListener("click", recalcularConAdicional);

  btn.disabled = false;
  btn.textContent = "Cotizar Ahora";

  setTimeout(() => {
    document.getElementById("resultado-preliminar").scrollIntoView({ behavior: "smooth" });
  }, 300);
});

/*========================================================
  RECALCULAR CON MONTO ADICIONAL
=========================================================*/
function recalcularConAdicional() {
  try {
    const montoAdicionalInput = document.getElementById("montoAdicional");
    if (!montoAdicionalInput) return;
    
    const montoAdicional = parseInt(montoAdicionalInput.value) || 0;
    
    if (montoAdicional <= 0) {
      alert("Por favor ingresa un monto adicional mayor a 0");
      return;
    }

    if (!ultimoResultado) {
      alert("Primero realiza una cotizaci√≥n");
      return;
    }

    contadorRecalculos++;
    
    const uf = window.__UF_VALOR || 39700;
    const r = ultimoResultado;
  
    const nuevoPresupuestoCLP = r.sieteCLP + montoAdicional;
    const nuevoPresupuestoUF = nuevoPresupuestoCLP / uf;
    
    const nuevosPlanes = seleccionarPlanesConPresupuesto(nuevoPresupuestoUF, r.zona, r.edadTitular, r.edadesCargas);
    
    ultimoResultado.plan1 = nuevosPlanes.plan1;
    ultimoResultado.plan2 = nuevosPlanes.plan2;
    ultimoResultado.montoAdicional = montoAdicional;
    ultimoResultado.presupuestoTotalCLP = nuevoPresupuestoCLP;
    ultimoResultado.presupuestoTotalUF = nuevoPresupuestoUF;

    let htmlResultado = `
      <div class="resumen-cotizacion">
        <div class="resumen-titulo">üìä Tu Cotizaci√≥n Mejorada - ${formularioDatos.nombre}</div>
        <div class="resumen-grid">
          <div class="resumen-item">
            <div class="resumen-label">Tu 7% obligatorio</div>
            <div class="resumen-value">$${formatearCLP(r.sieteCLP)}</div>
            <div class="resumen-uf">${r.sieteUF.toFixed(2)} UF</div>
          </div>
          <div class="resumen-item">
            <div class="resumen-label">Aporte adicional</div>
            <div class="resumen-value" style="color:#4ade80;">+$${formatearCLP(montoAdicional)}</div>
            <div class="resumen-uf">+${(montoAdicional / uf).toFixed(2)} UF</div>
          </div>
          <div class="resumen-item">
            <div class="resumen-label">Presupuesto Total</div>
            <div class="resumen-value destacado">$${formatearCLP(nuevoPresupuestoCLP)}</div>
            <div class="resumen-uf">${nuevoPresupuestoUF.toFixed(2)} UF</div>
          </div>
          <div class="resumen-item">
            <div class="resumen-label">Zona</div>
            <div class="resumen-value" style="font-size:0.95rem;">${r.zona}</div>
            <div class="resumen-uf">${formularioDatos.region}</div>
          </div>
        </div>
      </div>
      
      <h2 class="gold" style="margin-top:30px;">üè• Nuevos Planes con Mayor Cobertura</h2>
      <p class="small">Con tu presupuesto mejorado de $${formatearCLP(nuevoPresupuestoCLP)}, ahora puedes acceder a estos planes:</p>
    `;
    
    if (nuevosPlanes.plan1) {
      htmlResultado += generarHTMLPlan(nuevosPlanes.plan1, 1, nuevoPresupuestoUF, nuevoPresupuestoCLP, montoAdicional);
    } else {
      htmlResultado += `<p class="small" style="color:#fbbf24;">No se encontr√≥ un plan adicional. Solicita asesor√≠a personalizada.</p>`;
    }
    
    if (nuevosPlanes.plan2) {
      htmlResultado += generarHTMLPlan(nuevosPlanes.plan2, 2, nuevoPresupuestoUF, nuevoPresupuestoCLP, montoAdicional);
    }

    htmlResultado += `
      <div class="disclaimer">
        <span class="disclaimer-icon">‚ö†Ô∏è</span>
        Los valores presentados son referenciales y est√°n sujetos a verificaci√≥n. Un Ejecutivo de Ventas validar√° esta informaci√≥n y te contactar√° para formalizar tu plan de salud.
      </div>
    `;

    if (contadorRecalculos < MAX_RECALCULOS) {
      const recalculosRestantes = MAX_RECALCULOS - contadorRecalculos;
      htmlResultado += `
        <div class="mejorar-cobertura">
          <div class="mejorar-titulo">üîÑ ¬øDeseas ajustar tu aporte adicional?</div>
          <p class="small" style="color:#fbbf24; margin-bottom:15px;">Te queda${recalculosRestantes > 1 ? 'n' : ''} ${recalculosRestantes} ajuste${recalculosRestantes > 1 ? 's' : ''} disponible${recalculosRestantes > 1 ? 's' : ''}</p>
          <div class="adicional-actual">
            <div class="adicional-label">Aporte adicional actual</div>
            <div class="adicional-valor">$${formatearCLP(montoAdicional)}</div>
          </div>
          
          <div class="mejorar-input-container">
            <div>
              <label class="small" style="display:block; margin-bottom:5px; color:#ccc;">Nuevo monto adicional:</label>
              <input type="number" id="montoAdicional" class="mejorar-input" placeholder="Ej: 50000" min="0" step="1000" value="${montoAdicional}">
            </div>
            <button type="button" id="btnRecalcular" class="btn-recalcular">üîÑ Recalcular Planes</button>
          </div>
        </div>
      `;
    } else {
      htmlResultado += `
        <div class="mejorar-cobertura" style="border-color: #d4af37;">
          <div class="mejorar-titulo" style="color:#d4af37;">‚úÖ Has revisado tus opciones de cobertura</div>
          <p class="mejorar-texto">
            Ya exploraste diferentes alternativas. Ahora puedes solicitar asesor√≠a personalizada para finalizar tu afiliaci√≥n, 
            o si conoces a alguien que necesite un plan de salud, ¬°puedes referirlo!
          </p>
          <div class="adicional-actual">
            <div class="adicional-label">Tu presupuesto final</div>
            <div class="adicional-valor">$${formatearCLP(nuevoPresupuestoCLP)}</div>
          </div>
        </div>
      `;
    }

    document.getElementById("resultadoDetalle").innerHTML = htmlResultado;
    
    const btnRecalcular = document.getElementById("btnRecalcular");
    if (btnRecalcular) {
      btnRecalcular.addEventListener("click", recalcularConAdicional);
    }

    document.getElementById("resultado-preliminar").scrollIntoView({ behavior: "smooth" });
    
  } catch (error) {
    console.error("Error en recalcularConAdicional:", error);
    alert("Ocurri√≥ un error al recalcular. Por favor intenta de nuevo.");
  }
}

/*========================================================
  BOT√ìN ASESOR√çA
=========================================================*/
document.getElementById("btnAsesoria").addEventListener("click", function() {
  if (!formularioDatos || !formularioDatos.nombre) {
    alert("Primero completa y env√≠a la cotizaci√≥n.");
    return;
  }

  const r = ultimoResultado;
  const plan1Nombre = r.plan1 ? r.plan1.plan : '-';
  const plan2Nombre = r.plan2 ? r.plan2.plan : '-';
  const plan1Valor = r.plan1 ? `${r.plan1.valorCalculadoUF.toFixed(2)} UF` : '-';
  const plan2Valor = r.plan2 ? `${r.plan2.valorCalculadoUF.toFixed(2)} UF` : '-';
  
  const cargasInfo = r.edadesCargas.length > 0 ? `${r.edadesCargas.length} (${r.edadesCargas.join(', ')} a√±os)` : '0';
  
  const tieneAdicional = r.montoAdicional && r.montoAdicional > 0;
  const textoAdicional = tieneAdicional 
    ? `‚Ä¢ Aporte adicional: $${formatearCLP(r.montoAdicional)}
- Presupuesto total: $${formatearCLP(r.presupuestoTotalCLP)} (${r.presupuestoTotalUF.toFixed(2)} UF)`
    : ''; 

  const mensaje = `üîî SOLICITUD DE ASESOR√çA

üë§ Datos del cliente:
- Nombre: ${formularioDatos.nombre}
- Correo: ${formularioDatos.correo}
- RUT: ${formularioDatos.rut}
- Tel√©fono: ${formularioDatos.telefono}
- Edad: ${formularioDatos.edad} a√±os
- Isapre actual: ${formularioDatos.isapre}
- Regi√≥n: ${formularioDatos.region} (${r.zona})
- Renta: $${formatearCLP(Number(formularioDatos.renta))}
- Cargas: ${cargasInfo}

üí∞ Cotizaci√≥n:
- Tu 7%: $${formatearCLP(r.sieteCLP)} (${r.sieteUF.toFixed(2)} UF)
${textoAdicional}

üìã Planes sugeridos:
1) ${plan1Nombre} ‚Üí ${plan1Valor}
2) ${plan2Nombre} ‚Üí ${plan2Valor}

‚ö° SOLICITA CONTACTO URGENTE`;

  enviarCallMeBot(mensaje);
  
  alert("‚úÖ Solicitud enviada. Un asesor te contactar√° a la brevedad.");

  document.getElementById("seccionBusquedaClinica").style.display = "block";

  document.getElementById("referidos").style.display = "block";
  setTimeout(() => {
    document.getElementById("referidos").scrollIntoView({ behavior: "smooth" });
  }, 400);
});

/*========================================================
  BOT√ìN BUSCAR POR CL√çNICA DESDE RESULTADOS
=========================================================*/
document.getElementById("btnBuscarClinicaDesdeResultados").addEventListener("click", function() {
  // Mostrar secci√≥n de b√∫squeda por cl√≠nica sin requerir cotizaci√≥n adicional
  document.getElementById("seccionBusquedaClinica").style.display = "block";
  document.getElementById("inputBuscadorClinica").focus();
  setTimeout(() => {
    document.getElementById("seccionBusquedaClinica").scrollIntoView({ behavior: "smooth" });
  }, 100);
});

/*========================================================
  BOT√ìN ENVIAR RESUMEN AL USUARIO
=========================================================*/
document.getElementById("btnEnviarUsuario").addEventListener("click", function() {
  if (!formularioDatos || !formularioDatos.nombre) {
    alert("Primero completa y env√≠a la cotizaci√≥n.");
    return;
  }

  const r = ultimoResultado;
  const plan1Nombre = r.plan1 ? r.plan1.plan : '-';
  const plan2Nombre = r.plan2 ? r.plan2.plan : '-';
  const plan1Valor = r.plan1 ? `${r.plan1.valorCalculadoUF.toFixed(2)} UF` : '-';
  const plan2Valor = r.plan2 ? `${r.plan2.valorCalculadoUF.toFixed(2)} UF` : '-';

  const mensaje = `Estimado/a ${formularioDatos.nombre} üëã

Gracias por tu inter√©s en *Colmena Golden Cross*

üìã *Resumen de tu cotizaci√≥n:*
- Plan 1: ${plan1Nombre} ‚Üí ${plan1Valor}
- Plan 2: ${plan2Nombre} ‚Üí ${plan2Valor}
- Tu 7%: $${formatearCLP(r.sieteCLP)} (${r.sieteUF.toFixed(2)} UF)

üìÑ *Documentos para iniciar tu afiliaci√≥n:*
1. √öltima liquidaci√≥n de sueldo
2. 12 √∫ltimas cotizaciones AFP
3. Foto RUT (ambos lados)

Puedes enviarlos por este medio.

*${ASESOR_NOMBRE}*
Ejecutivo de Ventas - Colmena Golden Cross
üìû ${ASESOR_TELEFONO}`;

  enviarCallMeBot(mensaje);
  
  alert("‚úÖ Resumen enviado a tu WhatsApp. Reenv√≠alo al cliente.");
});

/*========================================================
  FORMULARIO REFERIDOS
=========================================================*/
document.getElementById("formReferidos").addEventListener("submit", async function(e) {
  e.preventDefault();

  const nombreUsuario = document.getElementById("nombreUsuario").value;
  const nombreReferido = document.getElementById("nombreReferido").value;
  const telefonoReferido = document.getElementById("telefonoReferido").value;
  const correoReferido = document.getElementById("correoReferido").value;

  const f = new FormData();
  f.append(REFERIDOS_FIELDS.tu_nombre, nombreUsuario);
  f.append(REFERIDOS_FIELDS.nombre_referido, nombreReferido);
  f.append(REFERIDOS_FIELDS.telefono_referido, telefonoReferido);
  f.append(REFERIDOS_FIELDS.correo_referido, correoReferido);
  f.append(REFERIDOS_FIELDS.mensaje_adicional, "Referido enviado desde landing");
  f.append(REFERIDOS_FIELDS.asesorid_referidos, asesorKey);

  try {
    await fetch(GOOGLE_FORM_REFERIDOS_URL, { method: "POST", mode: "no-cors", body: f });
    document.getElementById("mensajeExitoReferido").style.display = "block";
    document.getElementById("mensajeErrorReferido").style.display = "none";

    const msgRef = `üéØ NUEVO REFERIDO - ${ASESOR_NOMBRE}

Referido por: ${nombreUsuario}
Nombre: ${nombreReferido}
Tel: ${telefonoReferido}
Correo: ${correoReferido}`;
    enviarCallMeBot(msgRef);

    // RESETEAR DATOS DESPU√âS DE ENVIAR Y ESPERAR 10 SEGUNDOS ANTES DE SUBIR
    setTimeout(() => {
      // Resetear formulario de referidos
      document.getElementById("formReferidos").reset();
      
      // Resetear datos de cotizaci√≥n
      document.getElementById("mainForm").reset();
      formularioDatos = {};
      ultimoResultado = null;
      contadorRecalculos = 0;
      
      // Ocultar secciones
      document.getElementById("resultado-preliminar").style.display = "none";
      document.getElementById("referidos").style.display = "none";
      document.getElementById("mensajeExitoReferido").style.display = "none";
      
      // Subir al inicio despu√©s de 10 segundos
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 10000);

  } catch (err) {
    document.getElementById("mensajeErrorReferido").style.display = "block";
    document.getElementById("mensajeExitoReferido").style.display = "none";
  }
});

/*========================================================
  M√ìDULO: B√öSQUEDA POR CL√çNICA FAVORITA
=========================================================*/

let datosBusquedaClinica = {
  clinicaSeleccionada: null,
  redEncontrada: null,
  planSeleccionado: null,
  cobertura: null
};

function buscarClinicaEnRedes(nombreClinica) {
  const nombreNormalizado = nombreClinica.toLowerCase().trim();
  
  for (const [grupoRed, clinicas] of Object.entries(REDES_CLINICAS)) {
    for (const clinica of clinicas) {
      if (clinica.nombre.toLowerCase().includes(nombreNormalizado)) {
        return { grupoRed, clinica };
      }
    }
  }
  
  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUSCAR 4 PLANES POR CL√çNICA - DIFERENCIADOS POR COBERTURA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAPEO DE C√ìDIGOS DE GRUPO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MAPEO_CODIGOS_GRUPO = {
  'G41': 'Grupo 41 - GX Preferente',
  'G42': 'Grupo 42 - GX Ampliada',
  'G43': 'Grupo 43 - GX Red',
  'G44': 'Grupo 44 - GX Red',
  'G45': 'Grupo 45 - GX Plus',
  'G46': 'Grupo 46 - GX Premium',
  'G55': 'GC1 (G55)',
  'G56': 'GC2 (G56)',
  'G57': 'GC3 (G57)',
  'G63': 'GS1 (G63)',
  'G64': 'GS2 (G64)',
  'G65': 'GS3 (G65)'
};

const MAPEO_GRUPO_A_CODIGO = {};
for (const [codigo, nombre] of Object.entries(MAPEO_CODIGOS_GRUPO)) {
  MAPEO_GRUPO_A_CODIGO[nombre] = codigo;
}

function obtenerPlanesConClinica(nombreClinica) {
  if (!PLANES || PLANES.length === 0) {
    console.warn('No hay planes cargados');
    return [];
  }
  
  const uf = window.__UF_VALOR || 39700;
  const sieteUF = ultimoResultado ? ultimoResultado.sieteUF : 0;
  
  // Buscar cl√≠nica en TODOS los grupos GX
  let grupoClinicaEncontrado = null;
  let clinicaEncontrada = null;
  
  for (const [grupoNombre, clinicas] of Object.entries(GRUPOS_GX)) {
    const clinica = clinicas.find(c => c.nombre.toUpperCase().includes(nombreClinica.toUpperCase()));
    if (clinica) {
      grupoClinicaEncontrado = grupoNombre;
      clinicaEncontrada = clinica;
      break;
    }
  }
  
  if (!clinicaEncontrada) {
    return [];
  }
  
  // Filtrar planes que incluyen este grupo
  const planesQueCubren = PLANES.filter(plan => {
    // Verificar si el plan tiene acceso a este grupo
    return plan.coberturas_redes && plan.coberturas_redes[grupoClinicaEncontrado];
  });
  
  if (planesQueCubren.length === 0) {
    return [];
  }
  
  // Calcular valor de cada plan y agregar cobertura del grupo
  const planesConValor = planesQueCubren.map(plan => {
    const calc = calcularValorPlan(plan.pb_uf, ultimoResultado.edadTitular, ultimoResultado.edadesCargas);
    return {
      ...plan,
      valorCalculadoUF: calc.totalUF,
      valorCalculadoCLP: calc.totalCLP,
      gesUF: calc.gesUF,
      gesCLP: calc.gesCLP,
      coberturaGrupo: plan.coberturas_redes[grupoClinicaEncontrado],
      grupoClinica: grupoClinicaEncontrado
    };
  });
  
  // Ordenar por distancia al 7% (m√°s cercanos primero)
  planesConValor.sort((a, b) => 
    Math.abs(a.valorCalculadoUF - sieteUF) - Math.abs(b.valorCalculadoUF - sieteUF)
  );
  
  // Obtener m√°ximo 4 planes y asegurar que tengan % de cobertura DIFERENTES
  const planesFinales = [];
  const coberturaUsadas = new Set();
  
  for (const plan of planesConValor) {
    if (planesFinales.length >= 4) break;
    
    const cobertura = plan.coberturaGrupo;
    if (!coberturaUsadas.has(cobertura)) {
      coberturaUsadas.add(cobertura);
      planesFinales.push(plan);
    }
  }
  
  // Si no tenemos 4 y hay m√°s planes, agregar aunque tengan cobertura igual (hasta 4 total)
  if (planesFinales.length < 4) {
    for (const plan of planesConValor) {
      if (planesFinales.length >= 4) break;
      if (!planesFinales.includes(plan)) {
        planesFinales.push(plan);
      }
    }
  }
  
  return {
    clinicaEncontrada,
    grupoClinica: grupoClinicaEncontrado,
    planesDisponibles: planesFinales.slice(0, 4)
  };
}

function generarResultadoBusquedaClinica(clinicaEncontrada, grupoRed, planesDisponibles) {
  const uf = window.__UF_VALOR || 39700;
  
  if (planesDisponibles.length === 0) {
    return `
      <div class="busqueda-clinica-resultado">
        <div style="background: #4a1a1a; border: 2px solid #ff8080; border-radius: 10px; padding: 20px; margin: 20px 0;">
          <div style="color: #ff8080; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">‚ùå Cl√≠nica no disponible en planes actuales</div>
          <p style="color: #ccc; margin-bottom: 15px;">
            La cl√≠nica <strong>"${clinicaEncontrada.nombre}"</strong> en <strong>${clinicaEncontrada.ciudad}</strong> 
            no est√° disponible en los planes que cotizaste (${ultimoResultado.plan1?.plan || ''} y ${ultimoResultado.plan2?.plan || ''}).
          </p>
          <p style="color: #888; font-size: 0.9rem;">
            üí° Sugerencia: Ajusta tu presupuesto hacia arriba para acceder a planes con mejores redes de cl√≠nicas.
          </p>
        </div>
      </div>
    `;
  }
  
  let html = `
    <div class="busqueda-clinica-resultado">
      <div style="background: linear-gradient(135deg, #0f2640, #1a3a5a); border: 2px solid #4ade80; border-radius: 10px; padding: 25px; margin: 20px 0;">
        <div style="color: #4ade80; font-size: 1.3rem; font-weight: bold; margin-bottom: 15px;">‚úÖ ¬°Cl√≠nica encontrada!</div>
        
        <div style="background: #112233; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #d4af37;">
          <div style="color: #d4af37; font-weight: bold; font-size: 1.1rem;">${clinicaEncontrada.nombre}</div>
          <div style="color: #888; font-size: 0.9rem; margin-top: 5px;">üìç ${clinicaEncontrada.ciudad}</div>
          <div style="color: #888; font-size: 0.9rem; margin-top: 5px;">üè¢ Red: <strong>${grupoRed}</strong></div>
        </div>
  `;
  
  planesDisponibles.forEach((plan, index) => {
    const esDeSegundo = plan.plan === ultimoResultado.plan2?.plan;
    const cobertura = plan.cobertura;
    const badgeColor = esDeSegundo ? '#60a5fa' : '#d4af37';
    const badgeText = esDeSegundo ? 'üî∑ PLAN 2' : '‚ú® PLAN 1';
    
    html += `
      <div style="background: #1a2a3a; border: 1px solid ${badgeColor}; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
          <div>
            <div style="color: ${badgeColor}; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px;">${badgeText}</div>
            <div style="color: #d4af37; font-size: 1.2rem; font-weight: bold;">${plan.plan}</div>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 15px;">
          <div style="background: #0d1f2d; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Cobertura en esta cl√≠nica</div>
            <div style="color: #4ade80; font-size: 1.3rem; font-weight: bold;">${cobertura}%</div>
          </div>
          
          <div style="background: #0d1f2d; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Valor del plan</div>
            <div style="color: #fff; font-size: 1.1rem; font-weight: bold;">$${formatearCLP(plan.valorCalculadoCLP)}</div>
            <div style="color: #aaa; font-size: 0.8rem;">${plan.valorCalculadoUF.toFixed(2)} UF</div>
          </div>
          
          <div style="background: #0d1f2d; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">Aporte GES</div>
            <div style="color: #4ade80; font-size: 1.1rem; font-weight: bold;">$${formatearCLP(plan.gesCLP)}</div>
            <div style="color: #aaa; font-size: 0.8rem;">${plan.gesUF.toFixed(2)} UF</div>
          </div>
        </div>
        
        <div style="background: #0d1f2d; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
          <div style="color: #d4af37; font-weight: bold; margin-bottom: 8px;">üè® Otras cl√≠nicas disponibles en la red ${grupoRed}:</div>
          <div style="max-height: 150px; overflow-y: auto;">
            ${generarListaClinicasRed(grupoRed)}
          </div>
        </div>
        
        <button type="button" class="btn-enviar-clinica" data-plan-nombre="${plan.plan}" data-clinica="${clinicaEncontrada.nombre}" data-cobertura="${cobertura}" style="width: 100%; background: linear-gradient(135deg, #4ade80, #22c55e); color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
          üì§ Enviar esta cotizaci√≥n por WhatsApp y Email
        </button>
      </div>
    `;
  });
  
  html += `
    </div>
  </div>`;
  
  return html;
}

function generarListaClinicasRed(grupoRed) {
  const clinicas = REDES_CLINICAS[grupoRed] || [];
  
  if (clinicas.length === 0) return '<p style="color: #888;">No hay cl√≠nicas registradas</p>';
  
  return `
    <ul style="list-style: none; padding: 0; margin: 0; color: #ccc; font-size: 0.9rem;">
      ${clinicas.slice(0, 8).map(c => `
        <li style="padding: 5px 0; border-bottom: 1px solid #2a3a4a;">
          ‚Ä¢ ${c.nombre} <span style="color: #888;">(${c.ciudad})</span>
        </li>
      `).join('')}
      ${clinicas.length > 8 ? `<li style="padding: 5px 0; color: #888;">+ ${clinicas.length - 8} cl√≠nicas m√°s...</li>` : ''}
    </ul>
  `;
}

async function enviarCotizacionConClinica(nombrePlan, nombreClinica, cobertura) {
  if (!formularioDatos || !formularioDatos.nombre) {
    alert("Por favor, completa primero la cotizaci√≥n principal.");
    return;
  }
  
  const r = ultimoResultado;
  
  const mensajeAsesor = `üîî COTIZACI√ìN CON CL√çNICA FAVORITA

üë§ Cliente: ${formularioDatos.nombre}
üìû Tel√©fono: ${formularioDatos.telefono}
üìß Correo: ${formularioDatos.correo}
üìç Regi√≥n: ${formularioDatos.region}

üè• CL√çNICA SELECCIONADA: ${nombreClinica}
üìã Plan: ${nombrePlan}
‚úÖ Cobertura: ${cobertura}%

üí∞ Detalles econ√≥micos:
- 7% obligatorio: $${formatearCLP(r.sieteCLP)} (${r.sieteUF.toFixed(2)} UF)
${r.montoAdicional ? `- Aporte adicional: $${formatearCLP(r.montoAdicional)}
- Presupuesto total: $${formatearCLP(r.presupuestoTotalCLP)} (${r.presupuestoTotalUF.toFixed(2)} UF)` : ''}
- Valor plan: $${formatearCLP(r.plan1?.valorCalculadoCLP || r.plan2?.valorCalculadoCLP)}
- GES incluido: $${formatearCLP(r.plan1?.gesCLP || r.plan2?.gesCLP)}

‚ö° REQUIERE CONTACTO URGENTE`;

  enviarCallMeBot(mensajeAsesor);
  
  try {
    const sheetParams = new URLSearchParams();
    sheetParams.append('entry.1455181501', formularioDatos.nombre);
    sheetParams.append('entry.1514828805', formularioDatos.rut);
    sheetParams.append('entry.1253669566', formularioDatos.correo);
    sheetParams.append('entry.1927631596', formularioDatos.telefono);
    sheetParams.append('entry.1515225692', formularioDatos.edad);
    sheetParams.append('entry.1312575017', formularioDatos.isapre);
    sheetParams.append('entry.1350273122', formularioDatos.renta);
    sheetParams.append('entry.1283417188', formularioDatos.region);
    sheetParams.append('entry.6457415', ultimoResultado.cargasTexto || 'Sin cargas');
    sheetParams.append('entry.860152674', `B√öSQUEDA POR CL√çNICA: ${nombreClinica} | Cobertura: ${cobertura}%`);
    sheetParams.append('entry.1176082335', nombrePlan);
    sheetParams.append('entry.1798986413', `B√∫squeda por cl√≠nica: ${nombreClinica}`);
    sheetParams.append('entry.1496988494', asesorKey);

    fetch(FORM_BASE_URL, { 
      method: "POST", 
      mode: "no-cors", 
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: sheetParams.toString()
    }).catch(() => {});

    alert(`‚úÖ Cotizaci√≥n enviada:\n\n‚Ä¢ WhatsApp: ${ASESOR_NOMBRE}\n‚Ä¢ Google Sheets: Registrado\n‚Ä¢ Email: Se enviar√° a ${ASESOR_CORREO}\n\nEl asesor te contactar√° a la brevedad.`);
    
  } catch (err) {
    console.error('Error enviando cotizaci√≥n:', err);
    alert('‚ö†Ô∏è Hubo un error al enviar. Intenta de nuevo.');
  }
}

function manejarBusquedaClinica() {
  const inputClinica = document.getElementById("inputBuscadorClinica");
  
  if (!inputClinica || !inputClinica.value.trim()) {
    alert("Por favor ingresa el nombre de una cl√≠nica.");
    return;
  }
  
  if (!ultimoResultado) {
    alert("Primero debes realizar una cotizaci√≥n de planes.");
    return;
  }
  
  const nombreClinica = inputClinica.value.trim();
  const resultado = obtenerPlanesConClinica(nombreClinica);
  
  if (!resultado || resultado.planesDisponibles.length === 0) {
    alert(`‚ùå No encontramos la cl√≠nica "${nombreClinica}" o no est√° disponible en nuestros planes.`);
    return;
  }
  
  const { clinicaEncontrada, grupoClinica, planesDisponibles } = resultado;
  
  const resultadoHTML = generarResultadoBusquedaClinicaNew(clinicaEncontrada, grupoClinica, planesDisponibles);
  
  const contenedorResultado = document.getElementById("resultadoBusquedaClinica");
  if (contenedorResultado) {
    contenedorResultado.innerHTML = resultadoHTML;
  }
  
  document.getElementById("seccionBusquedaClinica").scrollIntoView({ behavior: 'smooth' });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GENERAR RESULTADO DE B√öSQUEDA POR CL√çNICA - 4 PLANES DIFERENCIADOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function generarResultadoBusquedaClinicaNew(clinica, grupo, planes) {
  if (!planes || planes.length === 0) {
    return `
      <div style="background: #4a1a1a; border: 2px solid #ff8080; border-radius: 10px; padding: 20px; margin: 20px 0;">
        <div style="color: #ff8080; font-size: 1.2rem; font-weight: bold;">‚ùå No hay planes disponibles</div>
        <p style="color: #ccc; margin-top: 10px;">La cl√≠nica ${clinica.nombre} no est√° disponible en planes actualmente.</p>
      </div>
    `;
  }
  
  const uf = window.__UF_VALOR || 39700;
  const r = ultimoResultado;
  
  let planesHTML = planes.map((plan, i) => {
    const numero = i + 1;
    const badge = numero === 1 ? 'ü•á MEJOR OPCI√ìN' : numero === 2 ? 'ü•à ALTERNATIVA 2' : numero === 3 ? 'ü•â ALTERNATIVA 3' : '‚≠ê ALTERNATIVA 4';
    const adicional = Math.max(0, plan.valorCalculadoUF - r.sieteUF);
    const adicionalCLP = Math.round(adicional * uf);
    
    return `
      <div style="background: #112233; border: 2px solid #d4af37; border-radius: 15px; padding: 25px; margin: 20px 0;">
        <span style="display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; background: #d4af37; color: #0a1a2a; margin-bottom: 15px;">${badge}</span>
        
        <div style="font-size: 1.5rem; font-weight: bold; color: #d4af37; margin: 15px 0; text-align: center;">${plan.plan}</div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0;">
          <div style="background: #1a2a3a; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">Valor del Plan</div>
            <div style="font-size: 1.1rem; font-weight: bold; color: #fbbf24;">$${formatearCLP(plan.valorCalculadoCLP)}</div>
            <div style="font-size: 0.85rem; color: #aaa;">${plan.valorCalculadoUF.toFixed(2)} UF</div>
          </div>
          <div style="background: #1a2a3a; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">Cobertura en ${grupo}</div>
            <div style="font-size: 1.1rem; font-weight: bold; color: #4ade80;">${plan.coberturaGrupo}%</div>
          </div>
          <div style="background: #1a2a3a; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">Aporte Adicional</div>
            <div style="font-size: 1.1rem; font-weight: bold; color: ${adicionalCLP > 0 ? '#fbbf24' : '#4ade80'};">$${formatearCLP(adicionalCLP)}</div>
          </div>
        </div>
        
        <div style="background: #0d1f2d; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 3px solid #4ade80;">
          <div style="color: #4ade80; font-weight: bold; margin-bottom: 10px;">‚úì Cobertura: ${plan.coberturaGrupo}%</div>
          <div style="color: #b8c5d6; font-size: 0.9rem;">GES incluido: $${formatearCLP(plan.gesCLP)}</div>
        </div>
      </div>
    `;
  }).join('');
  
  return `
    <div style="background: linear-gradient(135deg, #0f2640, #1a3a5a); padding: 25px; border-radius: 15px; border: 1px solid #4ade80; margin: 20px 0;">
      <div style="color: #4ade80; font-size: 1.3rem; font-weight: bold; margin-bottom: 10px;">
        ‚úÖ Planes disponibles para ${clinica.nombre} (${clinica.ciudad})
      </div>
      <div style="color: #b8c5d6; font-size: 0.9rem; margin-bottom: 20px;">
        Mostramos los ${planes.length} mejores planes diferenciados por cobertura en esta cl√≠nica
      </div>
      ${planesHTML}
    </div>
  `;
}

function inicializarBusquedaClinica() {
  const btnBuscar = document.getElementById("btnBuscarClinica");
  if (btnBuscar) {
    btnBuscar.addEventListener('click', manejarBusquedaClinica);
  }
  
  // Bot√≥n del formulario principal
  const btnBuscarFormulario = document.getElementById("btnBuscarClinicaFormulario");
  if (btnBuscarFormulario) {
    btnBuscarFormulario.addEventListener('click', function(e) {
      e.preventDefault();
      // Validar que tenga datos b√°sicos
      const nombre = document.getElementById("nombre").value;
      const edad = document.getElementById("edad").value;
      const renta = document.getElementById("renta").value;
      const region = document.getElementById("region").value;
      
      if (!nombre || !edad || !renta || !region) {
        alert("Por favor completa: Nombre, Edad, Renta y Regi√≥n");
        return;
      }
      
      // Si no hay cotizaci√≥n, inicializar datos b√°sicos
      if (!ultimoResultado) {
        const uf = window.__UF_VALOR || 39700;
        const edadTitular = Number(edad);
        const cargasTexto = (document.getElementById("cargas").value || "").replace(/\n/g, ", ").trim();
        const edadesCargas = cargasTexto.split(/[\n,;]+/)
          .map(s => s.trim())
          .filter(Boolean)
          .map(Number)
          .filter(n => !isNaN(n) && n >= 0 && n <= 120);
        
        const calcSiete = calcularSietePorCiento(Number(renta), uf);
        const zona = REGION_A_ZONA[region] || 'SANTIAGO';
        
        ultimoResultado = {
          sieteCLP: calcSiete.sietePorCientoCLP,
          sieteUF: calcSiete.sietePorCientoUF,
          edadesCargas: edadesCargas,
          cargasTexto: cargasTexto,
          zona: zona,
          edadTitular: edadTitular,
          plan1: null,
          plan2: null
        };
        
        // Guardar TODOS los datos del formulario
        formularioDatos = {
          nombre: nombre,
          edad: edad,
          renta: renta,
          region: region,
          cargas: cargasTexto,
          correo: document.getElementById("correo").value,
          telefono: document.getElementById("telefono").value,
          rut: document.getElementById("rut").value,
          isapre: document.getElementById("isapre").value,
          mensaje: document.getElementById("mensaje").value
        };
      }
      
      // Mostrar secci√≥n de b√∫squeda
      document.getElementById("seccionBusquedaClinica").style.display = "block";
      document.getElementById("inputBuscadorClinica").focus();
      document.getElementById("seccionBusquedaClinica").scrollIntoView({ behavior: 'smooth' });
    });
  }
  
  const inputClinica = document.getElementById("inputBuscadorClinica");
  if (inputClinica) {
    inputClinica.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        manejarBusquedaClinica();
      }
    });
  }
}

window.addEventListener('DOMContentLoaded', inicializarBusquedaClinica);

/*========================================================
  INICIO
=========================================================*/
window.addEventListener("load", () => {
  cargarUF();
  cargarPlanes();
  cargarRedesClincias();
});
</script>

</body>
</html>
