<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planes de Salud Colmena - AsesorÃ­a Profesional</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #0a1a2a; color: white; margin: 0; padding: 0; }
    header { background: linear-gradient(90deg, #0a1a2a, #12375a); padding: 40px; text-align: center; }
    h1 { color: #d4af37; font-size: 2.5rem; margin: 0; }
    h2 { color: #d4af37; }
    section { padding: 40px 20px; max-width: 900px; margin: auto; }
    .gold { color: #d4af37; }
    .card { background: #112233; border: 1px solid #d4af37; padding: 25px; border-radius: 15px; margin-bottom: 25px; }
    button { background: #d4af37; color: #0a1a2a; padding: 15px 25px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; font-weight: bold; }
    button:hover { opacity: 0.85; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-secundario { background: #4ade80; color: #0a1a2a; }
    form input, form select, form textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; background: #1a2a3a; color: white; }
    form input::placeholder { color: #888; }
    .small { font-size: 0.9rem; color: #ccc; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 200px; }
    .btn-grupo { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
    .btn-grupo button { flex: 1; min-width: 140px; }
    .success-msg { color: #4ade80; margin-top: 12px; font-weight: bold; }
    .error-msg { color: #ff8080; margin-top: 12px; }
    .resumen-cotizacion { background: #0d1f2d; border: 1px solid #3a5a7a; border-radius: 10px; padding: 20px; margin-bottom: 25px; }
    .resumen-titulo { color: #d4af37; font-size: 1.3rem; margin-bottom: 15px; font-weight: bold; }
    .resumen-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
    .resumen-item { text-align: center; padding: 15px; background: #112233; border-radius: 8px; }
    .resumen-label { font-size: 0.85rem; color: #888; margin-bottom: 5px; }
    .resumen-value { font-size: 1.2rem; font-weight: bold; color: #fff; }
    .resumen-value.destacado { color: #4ade80; }
    .resumen-uf { font-size: 0.85rem; color: #aaa; }
    .plan-card { background: #112233; border: 2px solid #d4af37; border-radius: 15px; padding: 25px; margin: 25px 0; }
    .plan-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-bottom: 15px; background: #d4af37; color: #0a1a2a; }
    .plan-nombre { font-size: 1.8rem; font-weight: bold; color: #d4af37; text-align: center; margin: 15px 0; }
    .plan-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0; }
    .plan-info-item { background: #1a2a3a; padding: 15px; border-radius: 8px; text-align: center; }
    .plan-info-label { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
    .plan-info-value { font-size: 1.1rem; font-weight: bold; color: #fff; }
    .plan-info-value.verde { color: #4ade80; }
    .plan-info-value.amarillo { color: #fbbf24; }
    .cobertura-section { background: #0d1f2d; padding: 15px; border-radius: 10px; margin: 15px 0; }
    .cobertura-title { color: #d4af37; font-weight: bold; margin-bottom: 10px; }
    .cobertura-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #2a3a4a; }
    .cobertura-item:last-child { border-bottom: none; }
    .redes-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #3a5a7a; }
    .redes-title { color: #d4af37; font-size: 0.95rem; margin-bottom: 10px; font-weight: bold; }
    .red-grupo { margin-bottom: 12px; }
    .red-boton { background: #1a3a5a; border: 1px solid #3a5a7a; color: #ccc; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; width: 100%; text-align: left; transition: all 0.3s; }
    .red-boton:hover { border-color: #d4af37; color: #d4af37; background: #0d1f2d; }
    .red-boton.activo { background: #d4af37; color: #0a1a2a; border-color: #d4af37; font-weight: bold; }
    .clinicas-desplegadas { display: none; background: #0a1a2a; padding: 10px; border-radius: 5px; margin-top: 8px; border-left: 3px solid #4ade80; }
    .clinicas-desplegadas.activo { display: block; }
    .clinica-item { padding: 6px 0; padding-left: 15px; font-size: 0.85rem; color: #b8c5d6; }
    .disclaimer { background: #1a2a3a; border-left: 4px solid #fbbf24; padding: 15px 20px; margin: 20px 0; border-radius: 0 8px 8px 0; font-size: 0.85rem; color: #b8c5d6; }
    .disclaimer-icon { color: #fbbf24; margin-right: 8px; }
    .btn-asesoria { display: inline-block; background: linear-gradient(135deg, #d4af37, #f0c860); color: #0a1a2a; padding: 18px 40px; border-radius: 12px; font-size: 1.2rem; font-weight: bold; border: none; cursor: pointer; }
    .btn-asesoria:hover { opacity: 0.9; }
    .planes-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 25px; }
    .referidos-section { background: linear-gradient(135deg,#0f2640 0%,#1a3a5a 100%); padding: 60px 20px; margin: 40px 0; display: none; }
    .referidos-container { max-width: 800px; margin: 0 auto; background: #112233; padding: 40px; border-radius: 20px; border: 1px solid #d4af37; }
    .referidos-header { text-align: center; margin-bottom: 30px; }
    .referidos-header h2 { color: #d4af37; font-size: 28px; margin-bottom: 15px; }
    .referidos-header p { color: #b8c5d6; font-size: 16px; }
    .form-section { background: #1a2a3a; padding: 25px; border-radius: 15px; border-left: 4px solid #d4af37; margin-bottom: 20px; }
    .form-section h3 { color: #d4af37; font-size: 18px; margin-bottom: 15px; margin-top: 0; }
    .form-group-referidos { margin-bottom: 15px; }
    .form-group-referidos label { display: block; color: #b8c5d6; margin-bottom: 8px; font-size: 14px; }
    .form-group-referidos input { width: 100%; padding: 12px; border: 2px solid #2a3a4a; border-radius: 8px; background: #0a1a2a; color: white; }
    .btn-enviar-referido { background: linear-gradient(135deg, #d4af37, #f0c860); color: #0a1a2a; padding: 15px 40px; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; width: 100%; }
    .mensaje-exito-referido { padding: 15px; border-radius: 10px; margin-top: 20px; display: none; font-weight: 600; text-align: center; background: #1a4d2e; color: #4ade80; border: 1px solid #4ade80; }
    @media (max-width: 600px) {
      .plan-nombre { font-size: 1.4rem; }
      .planes-grid { grid-template-columns: 1fr; }
      .btn-grupo { flex-direction: column; }
      .btn-grupo button { min-width: 100%; }
    }
  </style>
</head>
<body>

<header>
  <h1>AsesorÃ­a en Planes de Salud Colmena</h1>
  <p class="gold">AtenciÃ³n premium para clientes exigentes</p>
  <p class="small">Completa el formulario para obtener una cotizaciÃ³n exacta en UF y CLP.</p>
</header>

<section id="formulario" class="card">
  <h2 class="gold">Formulario para CÃ¡lculo del Plan</h2>
  <form id="mainForm">
    <div class="row">
      <div class="col"><input type="text" name="nombre" id="nombre" placeholder="Nombre completo" required /></div>
      <div class="col"><input type="email" name="correo" id="correo" placeholder="Correo electrÃ³nico" required /></div>
    </div>
    <div class="row">
      <div class="col"><input type="tel" name="telefono" id="telefono" placeholder="TelÃ©fono" required /></div>
      <div class="col"><input type="number" name="edad" id="edad" placeholder="Edad titular" min="18" max="99" required /></div>
    </div>
    <input type="text" name="rut" id="rut" placeholder="RUT (ej: 12.345.678-9)" required />
    <select name="isapre" id="isapre" required>
      <option value="">Isapre actual</option>
      <option>FONASA</option><option>Colmena</option><option>Cruz Blanca</option>
      <option>Consalud</option><option>BanmÃ©dica</option><option>Vida Tres</option>
    </select>
    <input type="number" id="renta" name="renta" placeholder="Renta imponible mensual (CLP)" required />
    <label class="small">Edad de las cargas (separadas por coma, ej: 5, 12, 30)</label>
    <textarea name="cargas" id="cargas" placeholder="Ej: 5, 12, 30" rows="2"></textarea>
    <select name="region" id="region" required>
      <option value="">Selecciona tu RegiÃ³n</option>
      <option value="Metropolitana">RegiÃ³n Metropolitana</option>
      <option value="ValparaÃ­so">RegiÃ³n de ValparaÃ­so</option>
      <option value="BÃ­o-BÃ­o">RegiÃ³n del BÃ­o-BÃ­o</option>
      <option value="Los Lagos">RegiÃ³n de Los Lagos</option>
    </select>
    <textarea name="mensaje" id="mensaje" placeholder="Mensaje adicional (opcional)" rows="2"></textarea>
    <div class="btn-grupo">
      <button type="submit" id="submitBtn">Cotizar Ahora</button>
      <button type="button" id="btnBuscarClinica" class="btn-secundario">ğŸ¥ Buscar por ClÃ­nica</button>
    </div>
    <p id="statusMsg" class="small" style="margin-top:10px;"></p>
  </form>
</section>

<section class="card">
  <h2 class="gold">UF del dÃ­a</h2>
  <p class="small">UF: <span id="ufValor">cargandoâ€¦</span></p>
</section>

<section id="resultado-preliminar" class="card" style="display:none">
  <div id="resultadoDetalle"></div>
  <div style="text-align:center;margin-top:30px;">
    <button id="btnAsesoria" class="btn-asesoria">ğŸ“‹ Solicitar AsesorÃ­a Personalizada</button>
  </div>
</section>

<section class="referidos-section" id="referidos">
  <div class="referidos-container">
    <div class="referidos-header">
      <h2>Â¿Quieres que asesoremos a un amigo?</h2>
      <p>Ingresa los datos y nos comunicaremos con tu referido.</p>
    </div>
    <form id="formReferidos">
      <div class="form-section">
        <h3>ğŸ‘¤ Tus Datos</h3>
        <div class="form-group-referidos">
          <label for="nombreUsuario">Tu Nombre *</label>
          <input type="text" id="nombreUsuario" required>
        </div>
      </div>
      <div class="form-section">
        <h3>ğŸ¯ Datos del Referido</h3>
        <div class="form-group-referidos">
          <label>Nombre Completo *</label>
          <input type="text" id="nombreReferido" required>
        </div>
        <div class="form-group-referidos">
          <label>TelÃ©fono *</label>
          <input type="tel" id="telefonoReferido" required>
        </div>
        <div class="form-group-referidos">
          <label>Correo *</label>
          <input type="email" id="correoReferido" required>
        </div>
      </div>
      <button type="submit" class="btn-enviar-referido">ğŸ“¤ Enviar Referido</button>
      <div id="mensajeExitoReferido" class="mensaje-exito-referido">âœ… Â¡Referido Enviado!</div>
    </form>
  </div>
</section>

<footer style="text-align:center; padding:30px; color:#666; font-size:0.85rem;">
  Â© 2025 Colmena Golden Cross - AsesorÃ­a en Planes de Salud
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const RTI_UF = 87.8;

const ASESORES = {
  jose_mora: {
    nombre: "JosÃ© Mora",
    telefono: "+56975356696",
    whatsapp: "56975356696",
    callmebot_apikey: "7360481"
  }
};

const asesor = ASESORES.jose_mora;
const CALLMEBOT_APIKEY = asesor.callmebot_apikey;
const ASESOR_NOMBRE = asesor.nombre;

const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdWN77vgHicHHkyq8w0ogOzP5MHnlhBSLZAObDyVQo-ILw73g/formResponse';
const FORM_FIELDS = {
  nombre: 'entry.1455181501',
  rut: 'entry.1514828805',
  correo: 'entry.1253669566',
  telefono: 'entry.1927631596',
  edad: 'entry.1515225692',
  isapre: 'entry.1312575017',
  renta: 'entry.1350273122',
  region: 'entry.1283417188',
  cargas: 'entry.6457415',
  mensaje: 'entry.860152674',
  plan1: 'entry.1176082335',
  plan2: 'entry.1798986413',
  asesorid: 'entry.1496988494'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLANES CON COBERTURAS HOSPITALIZACION Y AMBULATORIA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PLANES = [
  // SANTIAGO
  { id: 1, plan: "Colmena Bronze", pb_uf: 0.92, cob_hosp: 80, cob_amb: 60, redes: { "GX Premium": ["ClÃ­nica Alemana", "ClÃ­nica Las Condes", "Hospital Dipreca"], "GX Red": ["Hospital ClÃ­nico", "Hospital del Salvador"] }, zona: "SANTIAGO" },
  { id: 2, plan: "Colmena Silver", pb_uf: 1.22, cob_hosp: 90, cob_amb: 75, redes: { "GX Premium": ["ClÃ­nica Alemana", "ClÃ­nica Las Condes", "ClÃ­nica Indisa"], "GX Red": ["Hospital ClÃ­nico", "ClÃ­nica DÃ¡vila"] }, zona: "SANTIAGO" },
  { id: 3, plan: "Colmena Gold", pb_uf: 1.52, cob_hosp: 95, cob_amb: 85, redes: { "GX Premium": ["ClÃ­nica Alemana", "ClÃ­nica Las Condes", "ClÃ­nica Indisa", "Hospital Dipreca"], "GX Red": ["Hospital del Salvador", "ClÃ­nica San Camilo"] }, zona: "SANTIAGO" },
  { id: 4, plan: "Colmena Platinum", pb_uf: 1.82, cob_hosp: 100, cob_amb: 95, redes: { "GX Premium": ["ClÃ­nica Alemana", "ClÃ­nica Las Condes", "ClÃ­nica Indisa", "Hospital Dipreca", "ClÃ­nica Santa MarÃ­a"], "GX Red": ["Hospital ClÃ­nico", "Hospital del Salvador", "ClÃ­nica DÃ¡vila"] }, zona: "SANTIAGO" },
  
  // VALPARAISO
  { id: 5, plan: "Colmena Bronze Centro", pb_uf: 0.92, cob_hosp: 80, cob_amb: 60, redes: { "GX Premium": ["Hospital ValparaÃ­so", "ClÃ­nica ConcepciÃ³n"], "GX Red": ["Hospital QuilpuÃ©", "ClÃ­nica ViÃ±a"] }, zona: "CENTRO" },
  { id: 6, plan: "Colmena Silver Centro", pb_uf: 1.22, cob_hosp: 90, cob_amb: 75, redes: { "GX Premium": ["Hospital Ovalle", "ClÃ­nica La Serena"], "GX Red": ["Hospital Coquimbo", "ClÃ­nica Ovalle Regional"] }, zona: "CENTRO" },
  { id: 7, plan: "Colmena Gold Centro", pb_uf: 1.52, cob_hosp: 95, cob_amb: 85, redes: { "GX Premium": ["Hospital ValparaÃ­so", "ClÃ­nica ConcepciÃ³n", "Hospital Ovalle"], "GX Red": ["Hospital QuilpuÃ©", "ClÃ­nica La Serena", "Hospital Coquimbo"] }, zona: "CENTRO" },
  
  // SUR
  { id: 8, plan: "Colmena Bronze Sur", pb_uf: 0.92, cob_hosp: 80, cob_amb: 60, redes: { "GX Premium": ["Hospital ConcepciÃ³n", "Hospital Los Ãngeles"], "GX Red": ["ClÃ­nica Temuco", "Hospital Valdivia"] }, zona: "SUR" },
  { id: 9, plan: "Colmena Silver Sur", pb_uf: 1.22, cob_hosp: 90, cob_amb: 75, redes: { "GX Premium": ["Hospital Puerto Montt", "ClÃ­nica Punta Arenas"], "GX Red": ["Hospital Castro", "ClÃ­nica de Los RÃ­os"] }, zona: "SUR" },
  { id: 10, plan: "Colmena Gold Sur", pb_uf: 1.52, cob_hosp: 95, cob_amb: 85, redes: { "GX Premium": ["Hospital ConcepciÃ³n", "Hospital Los Ãngeles", "Hospital Puerto Montt"], "GX Red": ["ClÃ­nica Temuco", "Hospital Valdivia", "Hospital Castro"] }, zona: "SUR" },
];

const REGION_A_ZONA = {
  'Metropolitana': 'SANTIAGO',
  'ValparaÃ­so': 'CENTRO',
  'BÃ­o-BÃ­o': 'SUR',
  'Los Lagos': 'SUR'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VARIABLES GLOBALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let formularioDatos = {};
let ultimoResultado = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES UTILIDAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function formatearCLP(n) {
  return (n || 0).toLocaleString("es-CL");
}

function obtenerFactor(edad) {
  if (edad < 2) return 0.0;
  if (edad < 20) return 0.6;
  if (edad < 25) return 0.9;
  if (edad < 35) return 1.0;
  if (edad < 45) return 1.3;
  if (edad < 55) return 1.4;
  if (edad < 65) return 2.0;
  return 2.4;
}

function obtenerFactorCarga(edad) {
  if (edad < 2) return 0.0;
  if (edad < 20) return 0.6;
  if (edad < 25) return 0.7;
  if (edad < 35) return 0.7;
  if (edad < 45) return 0.9;
  if (edad < 55) return 1.0;
  if (edad < 65) return 1.4;
  return 2.2;
}

// â­ CALCULAR 7% CON RTI
function calcularSietePorCiento(rentaMensual, ufValor) {
  const rentaEnUF = rentaMensual / ufValor;
  const rentaAUsar = Math.min(rentaEnUF, RTI_UF);
  const sietePorCientoUF = rentaAUsar * 0.07;
  const sietePorCientoCLP = Math.round(sietePorCientoUF * ufValor);
  const rtiAplicado = rentaEnUF > RTI_UF;
  
  return {
    sietePorCientoUF,
    sietePorCientoCLP,
    rtiAplicado
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARGAR UF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function cargarUF() {
  try {
    const r = await fetch("https://mindicador.cl/api/");
    const j = await r.json();
    const uf = j.uf.valor;
    window.__UF_VALOR = uf;
    document.getElementById("ufValor").innerText = "$" + uf.toLocaleString("es-CL", { minimumFractionDigits: 2 });
  } catch (err) {
    window.__UF_VALOR = 39700;
    document.getElementById("ufValor").innerText = "$39.700 (estimado)";
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULAR VALOR DE PLAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function calcularValorPlan(pbUF, edadTitular, edadesCargas) {
  const uf = window.__UF_VALOR || 39700;
  let sumaFactores = obtenerFactor(edadTitular);
  edadesCargas.forEach(e => sumaFactores += obtenerFactorCarga(e));
  const valorPlanUF = pbUF * sumaFactores;
  const valorPlanCLP = Math.round(valorPlanUF * uf);
  let personasGES = edadTitular >= 2 ? 1 : 0;
  edadesCargas.forEach(e => { if (e >= 2) personasGES++; });
  const gesUF = 0.77 * personasGES;
  const gesCLP = Math.round(gesUF * uf);
  return { valorPlanUF, valorPlanCLP, gesUF, gesCLP, totalUF: valorPlanUF + gesUF, totalCLP: valorPlanCLP + gesCLP };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SELECCIONAR PLANES CORRECTAMENTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function seleccionarPlanes(sieteUF, sieteCLP, zona, edadTitular, edadesCargas) {
  const uf = window.__UF_VALOR || 39700;
  const planesZona = PLANES.filter(p => p.zona === zona);
  
  if (planesZona.length === 0) {
    return { plan1: null, plan2: null, plan3: null };
  }
  
  // Calcular valor para cada plan
  const planesConValor = planesZona.map(p => {
    const calc = calcularValorPlan(p.pb_uf, edadTitular, edadesCargas);
    return { 
      ...p, 
      valorUF: parseFloat(calc.totalUF),
      valorCLP: calc.totalCLP, 
      gesUF: calc.gesUF, 
      gesCLP: calc.gesCLP 
    };
  });
  
  // RANGO VÃLIDO: 7% - 5% (7% es el mÃ­nimo legal, 5% menos es el mÃ¡ximo descuento permitido)
  const minimo5menos = sieteUF * 0.95; // 5% menos del 7%
  const maximo7plus = sieteUF * 2; // hasta 200% (para aporte adicional)
  
  // Filtrar planes en rango vÃ¡lido
  const planesValidos = planesConValor.filter(p => p.valorUF >= minimo5menos && p.valorUF <= maximo7plus);
  
  if (planesValidos.length === 0) {
    // Si no hay en rango, buscar los mÃ¡s cercanos
    planesConValor.sort((a, b) => Math.abs(a.valorUF - sieteUF) - Math.abs(b.valorUF - sieteUF));
    return { 
      plan1: planesConValor[0] || null, 
      plan2: planesConValor[1] || null, 
      plan3: planesConValor[2] || null 
    };
  }
  
  // Ordenar por distancia al 7% (cercanÃ­a)
  planesValidos.sort((a, b) => Math.abs(a.valorUF - sieteUF) - Math.abs(b.valorUF - sieteUF));
  
  return { 
    plan1: planesValidos[0] || null, 
    plan2: planesValidos[1] || null, 
    plan3: planesValidos[2] || null 
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GENERAR HTML DE PLAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function generarHTMLPlan(plan, numero) {
  let redesHTML = '<div class="redes-section"><div class="redes-title">ğŸ¥ Redes de ClÃ­nicas</div>';
  
  Object.keys(plan.redes).forEach(grupo => {
    const idGrupo = `grupo-${plan.id}-${grupo.replace(/\s+/g, '-')}`;
    redesHTML += `
      <div class="red-grupo">
        <button type="button" class="red-boton" onclick="toggleClinicas('${idGrupo}')">${grupo}</button>
        <div id="${idGrupo}" class="clinicas-desplegadas">
          ${plan.redes[grupo].map(c => `<div class="clinica-item">âœ“ ${c}</div>`).join('')}
        </div>
      </div>
    `;
  });
  
  redesHTML += '</div>';
  
  const aporte = Math.max(0, plan.valorUF - ultimoResultado.sieteUF);
  const aporteTexto = aporte > 0.01 ? `+${aporte.toFixed(2)} UF` : 'Sin aporte';
  
  return `
    <div class="plan-card">
      <span class="plan-badge">${numero === 1 ? 'ğŸ¥‡ MEJOR OPCIÃ“N' : numero === 2 ? 'ğŸ¥ˆ ALTERNATIVA 2' : 'ğŸ¥‰ ALTERNATIVA 3'}</span>
      <div class="plan-nombre">${plan.plan}</div>
      <div class="plan-info">
        <div class="plan-info-item">
          <div class="plan-info-label">Valor Mensual</div>
          <div class="plan-info-value amarillo">$${formatearCLP(plan.valorCLP)}</div>
          <div class="small">${plan.valorUF.toFixed(2)} UF</div>
        </div>
        <div class="plan-info-item">
          <div class="plan-info-label">Aporte Adicional</div>
          <div class="plan-info-value verde">${aporteTexto}</div>
        </div>
        <div class="plan-info-item">
          <div class="plan-info-label">GES Incluido</div>
          <div class="plan-info-value verde">$${formatearCLP(plan.gesCLP)}</div>
        </div>
      </div>
      
      <div class="cobertura-section">
        <div class="cobertura-title">ğŸ“Š Coberturas</div>
        <div class="cobertura-item">
          <span>HospitalizaciÃ³n:</span>
          <span style="font-weight: bold; color: #4ade80;">${plan.cob_hosp}%</span>
        </div>
        <div class="cobertura-item">
          <span>Ambulatoria:</span>
          <span style="font-weight: bold; color: #fbbf24;">${plan.cob_amb}%</span>
        </div>
      </div>
      
      ${redesHTML}
    </div>
  `;
}

function toggleClinicas(idGrupo) {
  const elemento = document.getElementById(idGrupo);
  if (elemento) {
    elemento.classList.toggle('activo');
    const boton = elemento.previousElementSibling;
    if (boton) {
      boton.classList.toggle('activo');
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENVIAR DATOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function enviarGoogleForms(datos) {
  const params = new URLSearchParams();
  Object.keys(datos).forEach(key => {
    if (FORM_FIELDS[key]) {
      params.append(FORM_FIELDS[key], datos[key] || '');
    }
  });
  fetch(FORM_BASE_URL, { 
    method: "POST", 
    mode: "no-cors", 
    headers: {'Content-Type': 'application/x-www-form-urlencoded'}, 
    body: params.toString() 
  }).catch(() => {});
}

async function enviarCallMeBot(mensaje) {
  if (!CALLMEBOT_APIKEY) return;
  try {
    const url = `https://api.callmebot.com/whatsapp.php?phone=${asesor.whatsapp}&text=${encodeURIComponent(mensaje)}&apikey=${CALLMEBOT_APIKEY}`;
    await fetch(url, { mode: 'no-cors' });
  } catch (err) {
    console.error('Error WhatsApp:', err);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENTO: COTIZAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById("mainForm").addEventListener("submit", function(e) {
  e.preventDefault();
  
  const btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.textContent = "Calculando...";
  
  const uf = window.__UF_VALOR || 39700;
  const renta = Number(document.getElementById("renta").value);
  const edadTitular = Number(document.getElementById("edad").value);
  const cargasTexto = document.getElementById("cargas").value;
  const edadesCargas = cargasTexto.split(/[\n,;]+/).map(s => s.trim()).filter(Boolean).map(Number).filter(n => !isNaN(n) && n >= 0 && n <= 120);
  
  formularioDatos = {
    nombre: document.getElementById("nombre").value,
    correo: document.getElementById("correo").value,
    telefono: document.getElementById("telefono").value,
    edad: edadTitular,
    rut: document.getElementById("rut").value,
    isapre: document.getElementById("isapre").value,
    renta: renta,
    cargas: cargasTexto,
    region: document.getElementById("region").value,
    mensaje: document.getElementById("mensaje").value
  };
  
  // CALCULAR 7%
  const calcSiete = calcularSietePorCiento(renta, uf);
  const sieteCLP = calcSiete.sietePorCientoCLP;
  const sieteUF = calcSiete.sietePorCientoUF;
  
  const zona = REGION_A_ZONA[formularioDatos.region] || 'SANTIAGO';
  const { plan1, plan2, plan3 } = seleccionarPlanes(sieteUF, sieteCLP, zona, edadTitular, edadesCargas);
  
  ultimoResultado = { sieteCLP, sieteUF, edadesCargas, zona, plan1, plan2, plan3, edadTitular, calcSiete };
  
  // Enviar datos
  enviarGoogleForms({
    nombre: formularioDatos.nombre,
    rut: formularioDatos.rut,
    correo: formularioDatos.correo,
    telefono: formularioDatos.telefono,
    edad: formularioDatos.edad,
    isapre: formularioDatos.isapre,
    renta: formularioDatos.renta,
    region: formularioDatos.region,
    cargas: cargasTexto || 'Sin cargas',
    mensaje: formularioDatos.mensaje || "(sin mensaje)",
    plan1: plan1 ? plan1.plan : 'Sin plan',
    plan2: plan2 ? plan2.plan : 'Sin plan',
    asesorid: 'jose_mora'
  });
  
  const cargasInfo = edadesCargas.length > 0 ? `${edadesCargas.length} (${edadesCargas.join(', ')} aÃ±os)` : '0';
  const msgWA = `ğŸ”” NUEVA COTIZACIÃ“N\n\nğŸ‘¤ ${formularioDatos.nombre}\nğŸ“ ${formularioDatos.telefono}\nğŸ’° Renta: $${formatearCLP(renta)}\nğŸ‘¥ Cargas: ${cargasInfo}\n\nğŸ“Š 7%: $${formatearCLP(sieteCLP)} (${sieteUF.toFixed(2)} UF)${calcSiete.rtiAplicado ? '\nâš ï¸ RTI aplicado' : ''}\n\nğŸ“‹ Planes:\n1ï¸âƒ£ ${plan1 ? plan1.plan + ' â†’ ' + plan1.valorUF.toFixed(2) + ' UF' : 'N/A'}\n2ï¸âƒ£ ${plan2 ? plan2.plan + ' â†’ ' + plan2.valorUF.toFixed(2) + ' UF' : 'N/A'}\n3ï¸âƒ£ ${plan3 ? plan3.plan + ' â†’ ' + plan3.valorUF.toFixed(2) + ' UF' : 'N/A'}`;
  enviarCallMeBot(msgWA);
  
  // Mostrar resultados
  let html = `
    <div class="resumen-cotizacion">
      <div class="resumen-titulo">ğŸ“Š Tu CotizaciÃ³n - ${formularioDatos.nombre}</div>
      <div class="resumen-grid">
        <div class="resumen-item">
          <div class="resumen-label">Tu 7% obligatorio</div>
          <div class="resumen-value destacado">$${formatearCLP(sieteCLP)}</div>
          <div class="resumen-uf">${sieteUF.toFixed(2)} UF${calcSiete.rtiAplicado ? '<br><span style="color:#fbbf24;">âš ï¸ RTI aplicado</span>' : ''}</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Rango vÃ¡lido</div>
          <div class="resumen-value">$${formatearCLP(Math.round(sieteCLP * 0.95))} - $${formatearCLP(sieteCLP)}</div>
          <div class="resumen-uf">(7% - 5% menos)</div>
        </div>
        <div class="resumen-item">
          <div class="resumen-label">Cargas</div>
          <div class="resumen-value">${edadesCargas.length}</div>
        </div>
      </div>
    </div>
    <h2 class="gold" style="margin-top:30px;">ğŸ¥ Planes Recomendados</h2>
    <p class="small">Basado en tu 7% ($${formatearCLP(sieteCLP)}), seleccionamos los 3 mejores:</p>
    <div class="planes-grid">
      ${plan1 ? generarHTMLPlan(plan1, 1) : '<p class="error-msg">No disponible para tu regiÃ³n</p>'}
      ${plan2 ? generarHTMLPlan(plan2, 2) : ''}
      ${plan3 ? generarHTMLPlan(plan3, 3) : ''}
    </div>
    <div class="disclaimer">
      <span class="disclaimer-icon">âš ï¸</span>
      Los valores presentados son referenciales. Los % de cobertura son lo mÃ¡ximo que la isapre cubre en hospitalizaciÃ³n y ambulatoria.
    </div>
  `;
  
  document.getElementById("resultadoDetalle").innerHTML = html;
  document.getElementById("resultado-preliminar").style.display = "block";
  document.getElementById("resultado-preliminar").scrollIntoView({ behavior: "smooth" });
  
  btn.disabled = false;
  btn.textContent = "Cotizar Ahora";
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENTO: SOLICITAR ASESORÃA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById("btnAsesoria").addEventListener("click", function() {
  if (!ultimoResultado) {
    alert("Primero realiza una cotizaciÃ³n");
    return;
  }
  document.getElementById("referidos").style.display = "block";
  document.getElementById("referidos").scrollIntoView({ behavior: "smooth" });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMULARIO REFERIDOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById("formReferidos").addEventListener("submit", function(e) {
  e.preventDefault();
  const nombreUsuario = document.getElementById("nombreUsuario").value;
  const nombreReferido = document.getElementById("nombreReferido").value;
  const telefonoReferido = document.getElementById("telefonoReferido").value;
  
  const msgRef = `ğŸ¯ NUEVO REFERIDO\n\nReferido por: ${nombreUsuario}\nNombre: ${nombreReferido}\nTel: ${telefonoReferido}`;
  enviarCallMeBot(msgRef);
  
  document.getElementById("mensajeExitoReferido").style.display = "block";
  
  setTimeout(() => {
    document.getElementById("mainForm").reset();
    formularioDatos = {};
    ultimoResultado = null;
    document.getElementById("resultado-preliminar").style.display = "none";
    document.getElementById("referidos").style.display = "none";
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, 2000);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INICIALIZAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window.addEventListener("load", cargarUF);
</script>

</body>
</html>
