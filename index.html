<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planes de Salud Colmena - Asesor√≠a Profesional</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #0a1a2a; color: white; margin: 0; padding: 0; }
    header { background: linear-gradient(90deg, #0a1a2a, #12375a); padding: 40px; text-align: center; }
    h1 { color: #d4af37; font-size: 2.5rem; margin: 0; }
    section { padding: 40px 20px; max-width: 900px; margin: auto; }
    .gold { color: #d4af37; }
    .card { background: #112233; border: 1px solid #d4af37; padding: 20px; border-radius: 15px; margin-bottom: 25px; }
    button { background: #d4af37; color: #0a1a2a; padding: 15px 25px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; }
    button:hover { opacity: 0.85; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    form input, form select, form textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; box-sizing: border-box; }
    .whatsapp { display: block; background: #25D366; text-align: center; padding: 15px; color: white; text-decoration: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 20px; max-width: 300px; margin-left: auto; margin-right: auto; }
    .small { font-size: 0.9rem; color: #ccc; }
    .row { display:flex; gap:16px; flex-wrap: wrap; }
    .col { flex:1; min-width: 200px; }
    .uf-note { font-size:0.9rem; color:#cfcfcf; }
    .error-msg { color: #ff8080; margin-top: 12px; }
    .success-msg { color: #d4af37; margin-top: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>Asesor√≠a en Planes de Salud Colmena</h1>
    <p class="gold">Atenci√≥n premium para clientes exigentes</p>
    <p class="small">Completa el formulario para obtener una cotizaci√≥n exacta en UF y CLP.</p>
  </header>

  <!-- FORMULARIO -->
  <section id="formulario" class="card">
    <h2 class="gold">Formulario para C√°lculo del Plan</h2>

    <form id="mainForm">

      <div class="row">
        <div class="col"><input type="text" name="nombre" placeholder="Nombre completo" required /></div>
        <div class="col"><input type="email" name="correo" placeholder="Correo electr√≥nico" required /></div>
      </div>

      <div class="row">
        <div class="col"><input type="tel" name="telefono" placeholder="Tel√©fono" required /></div>
        <div class="col"><input type="number" name="edad" placeholder="Edad titular" required /></div>
      </div>

      <input type="text" name="rut" placeholder="RUT" required />

      <select name="isapre" required>
        <option value="">Isapre actual</option>
        <option>FONASA</option>
        <option>Colmena</option>
        <option>Cruz Blanca</option>
        <option>Consalud</option>
        <option>Banm√©dica</option>
        <option>Vida Tres</option>
      </select>

      <input type="number" id="renta" name="renta" placeholder="Renta imponible mensual (CLP)" required />

      <label class="small">Edad de las cargas (una por l√≠nea)</label>
      <textarea name="cargas" id="cargas" placeholder="Ej: 5&#10;12&#10;30"></textarea>

      <select name="region" required>
        <option value="">Selecciona tu Regi√≥n</option>
        <option>Regi√≥n de Arica y Parinacota</option>
        <option>Regi√≥n de Tarapac√°</option>
        <option>Regi√≥n de Antofagasta</option>
        <option>Regi√≥n de Atacama</option>
        <option>Regi√≥n de Coquimbo</option>
        <option>Regi√≥n de Valpara√≠so</option>
        <option>Regi√≥n Metropolitana</option>
        <option>Regi√≥n de O'Higgins</option>
        <option>Regi√≥n del Maule</option>
        <option>Regi√≥n del √ëuble</option>
        <option>Regi√≥n del B√≠o-B√≠o</option>
        <option>Regi√≥n de La Araucan√≠a</option>
        <option>Regi√≥n de Los R√≠os</option>
        <option>Regi√≥n de Los Lagos</option>
        <option>Regi√≥n de Ays√©n</option>
        <option>Regi√≥n de Magallanes</option>
      </select>

      <textarea name="mensaje" placeholder="Mensaje adicional (opcional)"></textarea>

      <button type="submit" id="submitBtn">Cotizar Ahora</button>
    </form>
  </section>

  <!-- UF -->
  <section class="card">
    <h2 class="gold">UF del d√≠a</h2>
    <p class="uf-note">UF: <span id="ufValor">cargando‚Ä¶</span> ‚Äî Fecha: <span id="ufFecha">-</span></p>
  </section>

  <!-- RESULTADO -->
  <section id="resultado-preliminar" class="card" style="display:none">
    <h2 class="gold">Resultado preliminar</h2>
    <div id="resultadoDetalle" style="line-height:1.7"></div>
  </section>

  <a class="whatsapp" href="https://wa.me/56990701837" target="_blank">Contactar por WhatsApp</a>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz1B1A1-d4nGFfhPDIp37GLeveWOsY2rr5TAV5iDU6eAduzUxs6dSx7gbSpMqJoHhAIqQ/exec';

    /* ================================
          CARGAR UF DEL D√çA
       ================================ */
    async function cargarUF() {
      try {
        const res = await fetch('https://mindicador.cl/api');
        const data = await res.json();
        const uf = data.uf.valor;
        window.__UF_VALOR = uf;
        document.getElementById('ufValor').innerText = '$' + uf.toLocaleString('es-CL', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
        document.getElementById('ufFecha').innerText = new Date(data.uf.fecha).toLocaleDateString('es-CL', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      } catch (e) {
        const ufDefault = 38000;
        window.__UF_VALOR = ufDefault;
        document.getElementById('ufValor').innerText = '$' + ufDefault.toLocaleString('es-CL') + ' (estimado)';
        document.getElementById('ufFecha').innerText = 'No disponible';
      }
    }

    /* ================================
          FACTORES ETARIOS
       ================================ */
    function obtenerFactor(edad) {
      if (edad <= 18) return 0.6;
      if (edad <= 35) return 1.0;
      if (edad <= 45) return 1.5;
      if (edad <= 59) return 2.0;
      return 2.4;
    }

    function formatearCLP(n) {
      return n.toLocaleString("es-CL");
    }

    /* ================================
          CALCULO GENERAL
       ================================ */
    function calcularCotizacion(obj) {
      const personas = 1 + obj.edadesCargas.length;

      let sumaFactores = obtenerFactor(obj.edadTitular);
      obj.edadesCargas.forEach(e => sumaFactores += obtenerFactor(e));

      const costoFactorizado = obj.valorBasePlan * sumaFactores;

      const uf = window.__UF_VALOR || 38000;
      const valorGesCLP = 0.93 * uf;
      const totalGes = Math.round(valorGesCLP * personas);

      const valorFinal = Math.round(costoFactorizado + totalGes);
      const siete = Math.round(obj.renta * 0.07);
      const adicional = Math.max(0, valorFinal - siete);

      const valorFinalUF = uf ? valorFinal / uf : null;

      return { personas, costoFactorizado, totalGes, valorFinal, siete, adicional, valorFinalUF };
    }

    /* ================================
          ENVIO Y RESULTADO
       ================================ */
    async function handleSubmit(e) {
      e.preventDefault();

      const form = document.getElementById("mainForm");
      const submitBtn = document.getElementById("submitBtn");
      const formData = new FormData(form);

      submitBtn.disabled = true;
      submitBtn.textContent = "Enviando...";

      const edadesCargas = (formData.get("cargas") || "")
        .split(/\n/)
        .map(s => s.trim())
        .filter(s => s !== "")
        .map(s => parseInt(s));

      const resultado = calcularCotizacion({
        renta: Number(formData.get("renta")),
        edadTitular: Number(formData.get("edad")),
        edadesCargas,
        valorBasePlan: 35000,
        valorGesUF: 0.93
      });

      const div = document.getElementById("resultadoDetalle");
      div.innerHTML = `
        <p><strong>Personas en plan:</strong> ${resultado.personas}</p>
        <p><strong>Costo base ajustado:</strong> $${formatearCLP(resultado.costoFactorizado)}</p>
        <p><strong>GES total:</strong> $${formatearCLP(resultado.totalGes)}</p>
        <p><strong>Valor final:</strong> $${formatearCLP(resultado.valorFinal)}</p>
        <p><strong>Valor final UF:</strong> ${resultado.valorFinalUF?.toFixed(3) ?? 'N/D'} UF</p>
        <p><strong>7% renta:</strong> $${formatearCLP(resultado.siete)}</p>
        <p><strong>Adicional:</strong> $${formatearCLP(resultado.adicional)}</p>
      `;
      document.getElementById("resultado-preliminar").style.display = "block";

      /* Enviar al Google Script */
      formData.append("valorFinal", resultado.valorFinal);
      formData.append("adicional", resultado.adicional);
      formData.append("siete", resultado.siete);
      formData.append("personas", resultado.personas);
      formData.append("costoFactorizado", resultado.costoFactorizado);
      formData.append("totalGes", resultado.totalGes);
      formData.append("planRecomendado", "Plan Est√°ndar");

      try {
        console.log('üì§ Enviando datos a Google Sheets...');
        
        const response = await fetch(SCRIPT_URL, { 
          method: 'POST',
          body: formData,
          redirect: 'follow'
        });
        
        console.log('‚úÖ Respuesta recibida');
        
        div.innerHTML += `<p class="success-msg">‚úÖ Datos enviados correctamente. Recibir√°s un correo pronto.</p>`;
        
      } catch (err) {
        console.error('‚ùå Error:', err);
        div.innerHTML += `<p class="error-msg">‚ùå Error al enviar. Por favor intenta nuevamente.</p>`;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Cotizar Ahora";
      }
    }

    // Asignar el evento submit
    document.getElementById('mainForm').addEventListener('submit', handleSubmit);

    window.addEventListener("load", cargarUF);
  </script>
</body>
</html>
