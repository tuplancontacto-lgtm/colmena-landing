<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planes de Salud Colmena - Asesor√≠a Profesional</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #0a1a2a; color: white; margin: 0; padding: 0; }
    header { background: linear-gradient(90deg, #0a1a2a, #12375a); padding: 40px; text-align: center; }
    h1 { color: #d4af37; font-size: 2.5rem; margin: 0; }
    section { padding: 40px 20px; max-width: 900px; margin: auto; }
    .gold { color: #d4af37; }
    .card { background: #112233; border: 1px solid #d4af37; padding: 20px; border-radius: 15px; margin-bottom: 25px; }
    button { background: #d4af37; color: #0a1a2a; padding: 15px 25px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; }
    button:hover { opacity: 0.85; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    form input, form select, form textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; box-sizing: border-box; }
    .whatsapp { display: block; background: #25D366; text-align: center; padding: 15px; color: white; text-decoration: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 20px; max-width: 300px; margin-left: auto; margin-right: auto; }
    .small { font-size: 0.9rem; color: #ccc; }
    .row { display:flex; gap:16px; flex-wrap: wrap; }
    .col { flex:1; min-width: 200px; }
    .uf-note { font-size:0.9rem; color:#cfcfcf; }
    .btn-asesoria { display: inline-block; background: linear-gradient(135deg, #d4af37, #f0c860); color: #0a1a2a; padding: 18px 40px; text-decoration: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 15px rgba(212,175,55,0.4); transition: all .3s ease; border: none; cursor: pointer; }
    .btn-asesoria:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,175,55,0.6); }

    /* Referidos */
    .referidos-section { background: linear-gradient(135deg,#0f2640 0%,#1a3a5a 100%); padding:60px 20px; margin:40px 0; }
    .referidos-container { max-width:800px; margin:0 auto; background:#112233; padding:40px; border-radius:20px; border:1px solid #d4af37; box-shadow:0 10px 40px rgba(0,0,0,0.3); }
    .referidos-header { text-align:center; margin-bottom:30px; }
    .referidos-header h2 { color:#d4af37; font-size:32px; margin-bottom:15px; font-weight:700; }
    .referidos-header p { color:#b8c5d6; font-size:18px; }
    .referidos-form { display:grid; gap:20px; }

    .form-section { background:#1a2a3a; padding:25px; border-radius:15px; border-left:4px solid #d4af37; }
    .form-section h3 { color:#d4af37; font-size:20px; margin-bottom:20px; }

    .form-group-referidos label { display:block; color:#b8c5d6; margin-bottom:8px; font-size:14px; font-weight:600; }
    .form-group-referidos input { width:100%; padding:12px; border:2px solid #2a3a4a; border-radius:8px; background:#0a1a2a; color:white; }

    .btn-enviar-referido { background:linear-gradient(135deg,#d4af37,#f0c860); color:#0a1a2a; padding:15px 40px; border:none; border-radius:10px; font-size:18px; font-weight:700; cursor:pointer; box-shadow:0 5px 15px rgba(212,175,55,0.3); width:100%; margin-top:20px; }

    .mensaje-exito-referido, .mensaje-error-referido { padding:15px; border-radius:10px; margin-top:20px; display:none; font-weight:600; text-align:center; }
    .mensaje-exito-referido { background:#1a4d2e; color:#4ade80; border:1px solid #4ade80; }
    .mensaje-error-referido { background:#4a1a1a; color:#ff8080; border:1px solid #ff8080; }
  </style>
</head>
<body>

<header>
  <h1>Asesor√≠a en Planes de Salud Colmena</h1>
  <p class="gold">Atenci√≥n premium para clientes exigentes</p>
  <p class="small">Completa el formulario para obtener una cotizaci√≥n exacta en UF y CLP.</p>
</header>

<section id="formulario" class="card">
  <h2 class="gold">Formulario para C√°lculo del Plan</h2>

  <form id="mainForm">
    <div class="row">
      <div class="col"><input type="text" name="nombre" id="nombre" placeholder="Nombre completo" required /></div>
      <div class="col"><input type="email" name="correo" id="correo" placeholder="Correo electr√≥nico" required /></div>
    </div>

    <div class="row">
      <div class="col"><input type="tel" name="telefono" id="telefono" placeholder="Tel√©fono" required /></div>
      <div class="col"><input type="number" name="edad" id="edad" placeholder="Edad titular" required /></div>
    </div>

    <input type="text" name="rut" id="rut" placeholder="RUT" required />

    <select name="isapre" id="isapre" required>
      <option value="">Isapre actual</option>
      <option>FONASA</option>
      <option>Colmena</option>
      <option>Cruz Blanca</option>
      <option>Consalud</option>
      <option>Banm√©dica</option>
      <option>Vida Tres</option>
    </select>

    <input type="number" id="renta" name="renta" placeholder="Renta imponible mensual (CLP)" required />

    <label class="small">Edad de las cargas (una por l√≠nea)</label>
    <textarea name="cargas" id="cargas" placeholder="Ej: 5&#10;12&#10;30"></textarea>

    <select name="region" id="region" required>
      <option value="">Selecciona tu Regi√≥n</option>
      <option>Regi√≥n de Valpara√≠so</option>
      <option>Regi√≥n Metropolitana</option>
      <option>Regi√≥n de Los R√≠os</option>
      <option>Regi√≥n de Los Lagos</option>
      <option>Regi√≥n de La Araucan√≠a</option>
      <option>Regi√≥n del B√≠o-B√≠o</option>
    </select>

    <textarea name="mensaje" id="mensaje" placeholder="Mensaje adicional (opcional)"></textarea>

    <button type="submit" id="submitBtn">Cotizar Ahora</button>
  </form>
</section>

<section class="card">
  <h2 class="gold">UF del d√≠a</h2>
  <p class="uf-note">UF: <span id="ufValor">cargando‚Ä¶</span> ‚Äî Fecha: <span id="ufFecha">-</span></p>
</section>

<section id="resultado-preliminar" class="card" style="display:none">
  <h2 class="gold">Resultado preliminar</h2>
  <div id="resultadoDetalle" style="line-height:1.7"></div>

  <div style="text-align:center;margin-top:30px;">
    <button id="btnAsesoria" class="btn-asesoria">üìã Solicitar Asesor√≠a Personalizada</button>
    <p class="small">Tus datos se enviar√°n inmediatamente</p>
  </div>
</section>

<!-- REFERIDOS -->
<section class="referidos-section" id="referidos" style="display:none">
  <div class="referidos-container">

    <div class="referidos-header">
      <h2>¬øQuieres que asesoremos a un amigo?</h2>
      <p>Ingresa los datos y nos comunicaremos con tu referido.</p>
    </div>

    <form id="formReferidos" class="referidos-form">

      <div class="form-section">
        <h3>üë§ Tus Datos</h3>
        <div class="form-group-referidos">
          <label for="nombreUsuario">Tu Nombre *</label>
          <input type="text" id="nombreUsuario" required>
        </div>
      </div>

      <div class="form-section">
        <h3>üéØ Datos del Referido</h3>

        <div class="form-group-referidos">
          <label>Nombre Completo *</label>
          <input type="text" id="nombreReferido" required>
        </div>

        <div class="form-group-referidos">
          <label>Tel√©fono *</label>
          <input type="tel" id="telefonoReferido" required>
        </div>

        <div class="form-group-referidos">
          <label>Correo *</label>
          <input type="email" id="correoReferido" required>
        </div>
      </div>

      <button type="submit" class="btn-enviar-referido">üì§ Enviar Referido</button>

      <div id="mensajeExitoReferido" class="mensaje-exito-referido">
        ‚úÖ ¬°Referido Enviado!
      </div>

      <div id="mensajeErrorReferido" class="mensaje-error-referido">
        ‚ùå Error al enviar. Intenta nuevamente.
      </div>

    </form>
  </div>
</section>

<!-- RESUMEN FINAL -->
<section id="resumen-final" class="card" style="display:none">
  <h2 class="gold">‚úÖ Resumen de tus Solicitudes</h2>
  <div id="resumenContenido" style="line-height:1.8"></div>
</section>

<a class="whatsapp" href="https://wa.me/56990701837" target="_blank">Contactar por WhatsApp</a>

<script>
/*========================================================
  CONFIG FORMULARIO
=========================================================*/

const FORM_BASE_URL =
'https://docs.google.com/forms/d/e/1FAIpQLSdWN77vgHicHHkyq8w0ogOzP5MHnlhBSLZAObDyVQo-ILw73g/formResponse';



const FORM_FIELDS = {
  nombre: 'entry.1455181501',
  rut: 'entry.1514828805',
  correo: 'entry.1253669566',
  telefono: 'entry.1927631596',
  edad: 'entry.1515225692',
  isapre: 'entry.1312575017',
  renta: 'entry.1350273122',
  region: 'entry.1283417188',
  cargas: 'entry.6457415',
  mensaje: 'entry.860152674'
};


let formularioDatos = {};

/*========================================================
  CARGAR UF
=========================================================*/

async function cargarUF() {
  try {
    const r = await fetch("https://mindicador.cl/api/");
    const j = await r.json();

    const uf = j.uf.valor;
    window.__UF_VALOR = uf;

    document.getElementById("ufValor").innerText =
      "$" + uf.toLocaleString("es-CL", { minimumFractionDigits: 2 });

    document.getElementById("ufFecha").innerText =
      new Date(j.uf.fecha).toLocaleDateString("es-CL", {
        year: "numeric",
        month: "long",
        day: "numeric"
      });

  } catch (err) {
    document.getElementById("ufValor").innerText = "$38.000 (estimado)";
    document.getElementById("ufFecha").innerText = "No disponible";
    window.__UF_VALOR = 38000;
  }
}

// **FALTABA ESTA L√çNEA**
cargarUF();


/*========================================================
  C√ÅLCULOS
=========================================================*/

function obtenerFactor(e) {
  if (e <= 18) return 0.6;
  if (e <= 35) return 1.0;
  if (e <= 45) return 1.5;
  if (e <= 59) return 2.0;
  return 2.4;
}

function formatearCLP(n) {
  return n.toLocaleString("es-CL");
}

/*========================================================
  COTIZACI√ìN: GES = 0.77 UF ‚Äî CARGAS <2 A√ëOS NO PAGAN
=========================================================*/

function calcularCotizacion(obj) {

  const personasTotales = 1 + obj.edadesCargas.length;

  let sumaFactores = obtenerFactor(obj.edadTitular);
  obj.edadesCargas.forEach(e => sumaFactores += obtenerFactor(e));

  const costoFactorizado = obj.valorBasePlan * sumaFactores;
  const uf = window.__UF_VALOR || 38000;

  /* GES CORRECTO */
  const valorGesUF = 0.77;
  const valorGesCLP = valorGesUF * uf;

  let personasQuePaganGES = 1; // Titular siempre paga

  obj.edadesCargas.forEach(e => {
    if (e >= 2) personasQuePaganGES++;
  });

  const totalGes = Math.round(valorGesCLP * personasQuePaganGES);

  const valorFinal = Math.round(costoFactorizado + totalGes);
  const siete = Math.round(obj.renta * 0.07);
  const adicional = Math.max(0, valorFinal - siete);
  const valorFinalUF = valorFinal / uf;

  return {
    personas: personasTotales,
    personasQuePaganGES,
    costoFactorizado,
    totalGes,
    valorFinal,
    siete,
    adicional,
    valorFinalUF
  };
}

/*========================================================
  ENV√çO DEL FORMULARIO PRINCIPAL
=========================================================*/

/*========================================================
  ENV√çO DEL FORMULARIO PRINCIPAL (AHORA S√ç ENV√çA)
=========================================================*/

document.getElementById("mainForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const data = new FormData(this);

  // Guardamos datos para resumen
  formularioDatos = {
    nombre: data.get("nombre"),
    correo: data.get("correo"),
    telefono: data.get("telefono"),
    edad: data.get("edad"),
    rut: data.get("rut"),
    isapre: data.get("isapre"),
    renta: data.get("renta"),
    cargas: data.get("cargas"),
    region: data.get("region"),
    mensaje: data.get("mensaje")
  };

  /* ======================================
     üìå ENV√çO A GOOGLE FORMS AUTOM√ÅTICO
     (ANTES ESTABA SOLO EN btnAsesoria)
  ======================================= */

  const f = new FormData();
  for (let k in FORM_FIELDS) {
    f.append(FORM_FIELDS[k], formularioDatos[k] ?? "");
  }

  // Enviar al Google Form
  await fetch(FORM_BASE_URL, {
    method: "POST",
    mode: "no-cors",
    body: f
  });

  /* ======================================
     üìå C√°lculo preliminar (igual que antes)
  ======================================= */

  const edadesCargas = (formularioDatos.cargas || "")
    .split("\n")
    .map(s => s.trim())
    .filter(Boolean)
    .map(Number);

  const r = calcularCotizacion({
    renta: Number(formularioDatos.renta),
    edadTitular: Number(formularioDatos.edad),
    edadesCargas,
    valorBasePlan: 35000
  });

 const nCargas = edadesCargas.length;

const mensajeCliente = `
  <strong style="font-size:1.2rem;">Cotizaci√≥n Personalizada ‚Äì Colmena</strong><br><br>

  Hola ${formularioDatos.nombre}, revis√© tus datos y prepar√© una propuesta ideal seg√∫n tu renta, cargas y edad.<br><br>

  <strong>üîπ Resultado de tu cotizaci√≥n</strong><br>
  Valor final estimado: <strong>${r.valorFinalUF.toFixed(3)} UF</strong><br>
  Total estimado en pesos: <strong>$${formatearCLP(r.valorFinal)}</strong><br>
  7% de tu renta: <strong>$${formatearCLP(r.siete)}</strong><br>
  Adicional a pagar sobre el 7%: <strong>$${formatearCLP(r.adicional)}</strong><br>
  Cargas consideradas: <strong>${nCargas}</strong><br><br>

  <strong>¬øQu√© viene ahora?</strong><br>
  Se seleccionar√°n 2 planes Colmena especialmente para ti:<br>
  ‚Ä¢ Un plan lo m√°s cercano posible a tu 7%, con el adicional m√°s bajo.<br>
  ‚Ä¢ Un plan con algo m√°s de cobertura y mejor red de cl√≠nicas.<br><br>

  Luego revisaremos juntos cu√°l te conviene m√°s üíõ
`;

document.getElementById("resultadoDetalle").innerHTML = mensajeCliente;
document.getElementById("resultado-preliminar").style.display = "block";


  document.getElementById("resultado-preliminar").style.display = "block";

  // ü§ñ Hacer scroll bonito
  setTimeout(() => {
    document.getElementById("resultado-preliminar")
      .scrollIntoView({ behavior: "smooth" });
  }, 300);
});


  document.getElementById("resultadoDetalle").innerHTML = `
    <p><strong>Personas en plan:</strong> ${r.personas}</p>
    <p><strong>Costo base ajustado:</strong> $${formatearCLP(r.costoFactorizado)}</p>
    <p><strong>GES total (${r.personasQuePaganGES} personas):</strong> $${formatearCLP(r.totalGes)}</p>
    <p><strong>Valor final:</strong> $${formatearCLP(r.valorFinal)}</p>
    <p><strong>Valor final UF:</strong> ${r.valorFinalUF.toFixed(3)} UF</p>
    <p><strong>7% renta:</strong> $${formatearCLP(r.siete)}</p>
    <p><strong>Adicional:</strong> $${formatearCLP(r.adicional)}</p>
  `;

  document.getElementById("resultado-preliminar").style.display = "block";
});

/*========================================================
  ENV√çO A GOOGLE FORMS DESDE BOT√ìN DE ASESOR√çA
=========================================================*/

document.getElementById("btnAsesoria").addEventListener("click", async function() {
  this.disabled = true;
  this.textContent = "‚è≥ Enviando...";

  const f = new FormData();

  for (let k in FORM_FIELDS) {
    f.append(FORM_FIELDS[k], formularioDatos[k] ?? "");
}


  await fetch(FORM_BASE_URL, {
    method: "POST",
    mode: "no-cors",
    body: f
  });

  this.textContent = "‚úÖ Enviado";
  this.style.background = "#4ade80";

  document.getElementById("referidos").style.display = "block";

  setTimeout(() => {
    document.getElementById("referidos").scrollIntoView({ behavior: "smooth" });
  }, 400);
});

/*========================================================
  REFERIDOS
=========================================================*/

const GOOGLE_FORM_REFERIDOS_URL =
'https://docs.google.com/forms/d/e/1FAIpQLSeIppjYB0Vgc6RsJ3AM0HcAVhLaxAT6ZZ_MxdPhmuwRkwLT-A/formResponse';

document.getElementById("formReferidos").addEventListener("submit", async function(e) {
  e.preventDefault();

  const nombreUsuario = document.getElementById("nombreUsuario").value;
  const nombreReferido = document.getElementById("nombreReferido").value;
  const telefonoReferido = document.getElementById("telefonoReferido").value;
  const correoReferido = document.getElementById("correoReferido").value;

  const f = new FormData();
  f.append("entry.1664559901", nombreUsuario);
  f.append("entry.715463265", nombreReferido);
  f.append("entry.1382714918", telefonoReferido);
  f.append("entry.897178414", correoReferido);
  f.append("entry.178502788", "Referido enviado desde landing");

  await fetch(GOOGLE_FORM_REFERIDOS_URL, {
    method:"POST", mode:"no-cors", body:f
  });

  document.getElementById("mensajeExitoReferido").style.display="block";

  mostrarResumenFinal(nombreUsuario, nombreReferido, telefonoReferido, correoReferido);

});

/*========================================================
  RESUMEN FINAL
=========================================================*/

function mostrarResumenFinal(nombreUsuario, nombreReferido, telefonoReferido, correoReferido) {

  const html = `
    <div style="background:#1a2a3a;padding:25px;border-radius:15px;margin-bottom:20px;">
      <h3 style="color:#d4af37;margin-top:0;">üìã Solicitud de Asesor√≠a</h3>
      <p><strong>Nombre:</strong> ${formularioDatos.nombre}</p>
      <p><strong>Correo:</strong> ${formularioDatos.correo}</p>
      <p><strong>Tel√©fono:</strong> ${formularioDatos.telefono}</p>
      <p><strong>Edad:</strong> ${formularioDatos.edad} a√±os</p>
      <p><strong>RUT:</strong> ${formularioDatos.rut}</p>
      <p><strong>Isapre actual:</strong> ${formularioDatos.isapre}</p>
      <p><strong>Renta:</strong> $${Number(formularioDatos.renta).toLocaleString('es-CL')}</p>
      <p><strong>Regi√≥n:</strong> ${formularioDatos.region}</p>
      ${formularioDatos.cargas ? `<p><strong>Cargas:</strong> ${formularioDatos.cargas.replace(/\n/g,", ")}</p>` : ""}
      <p style="color:#4ade80;font-weight:bold;margin-top:15px;">‚úÖ Enviado exitosamente</p>
    </div>

    <div style="background:#1a2a3a;padding:25px;border-radius:15px;">
      <h3 style="color:#d4af37;margin-top:0;">üéØ Referido</h3>
      <p><strong>Referido por:</strong> ${nombreUsuario}</p>
      <p><strong>Nombre del referido:</strong> ${nombreReferido}</p>
      <p><strong>Tel√©fono:</strong> ${telefonoReferido}</p>
      <p><strong>Correo:</strong> ${correoReferido}</p>
      <p style="color:#4ade80;font-weight:bold;margin-top:15px;">‚úÖ Referido enviado</p>
    </div>

    <div style="text-align:center;margin-top:30px;padding:20px;background:#0f2640;border-radius:10px;">
      <p style="font-size:1.1rem;color:#d4af37;margin:0;">
        ¬°Gracias por tu confianza! Te contactaremos dentro de pocas horas.
      </p>
    </div>
  `;

  document.getElementById("resumenContenido").innerHTML = html;
  document.getElementById("resumen-final").style.display = "block";

  setTimeout(() => {
    document.getElementById("resumen-final").scrollIntoView({
      behavior:"smooth",
      block:"start"
    });
  }, 400);
}

window.addEventListener("load", cargarUF);
</script>

</body>
</html>
