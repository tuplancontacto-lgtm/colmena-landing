<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buscar ClÃ­nica en Planes Colmena</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: Arial, sans-serif; 
      background: linear-gradient(135deg, #0a1a2a, #0d2a3a);
      color: white; 
      margin: 0; 
      padding: 0;
    }
    
    header {
      background: linear-gradient(90deg, #0a1a2a, #12375a);
      padding: 40px 20px;
      text-align: center;
      border-bottom: 3px solid #d4af37;
    }
    
    h1 { 
      color: #d4af37; 
      font-size: 2.2rem; 
      margin: 0 0 10px 0;
    }
    
    .header-subtitle {
      color: #aaa;
      font-size: 1rem;
    }
    
    main {
      max-width: 1000px;
      margin: 40px auto;
      padding: 0 20px;
    }
    
    .busqueda-container {
      background: #112233;
      border: 2px solid #d4af37;
      border-radius: 15px;
      padding: 40px;
      margin-bottom: 40px;
    }
    
    .input-wrapper {
      position: relative;
      margin-bottom: 20px;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #d4af37;
      background: #1a3a5a;
      color: white;
      font-size: 1rem;
    }
    
    input[type="text"]::placeholder {
      color: #666;
    }
    
    input[type="text"]:focus {
      outline: none;
      background: #1a4a7a;
      border-color: #fbbf24;
    }
    
    /* Autocomplete dropdown */
    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #1a3a5a;
      border: 1px solid #d4af37;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
    }
    
    .autocomplete-list.visible {
      display: block;
    }
    
    .autocomplete-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #0d2a3a;
      transition: all 0.2s;
    }
    
    .autocomplete-item:hover {
      background: #2a5a8a;
      color: #fbbf24;
    }
    
    .autocomplete-item-nombre {
      font-weight: bold;
      color: #d4af37;
    }
    
    .autocomplete-item-ciudad {
      font-size: 0.85rem;
      color: #aaa;
      margin-top: 3px;
    }
    
    .info-section {
      background: #0d1f2d;
      border-left: 4px solid #60a5fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    
    .resultados {
      margin-top: 40px;
    }
    
    .resultado-titulo {
      color: #d4af37;
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .planes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    
    .plan-card {
      background: #1a2a3a;
      border: 2px solid #d4af37;
      border-radius: 12px;
      padding: 25px;
      transition: all 0.3s;
    }
    
    .plan-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(212,175,55,0.3);
      border-color: #fbbf24;
    }
    
    .plan-card.secundario {
      border-color: #60a5fa;
    }
    
    .plan-card.secundario:hover {
      border-color: #a5c5ff;
    }
    
    .plan-titulo {
      color: #d4af37;
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 15px;
      word-break: break-word;
    }
    
    .plan-info {
      font-size: 0.9rem;
      line-height: 1.8;
      color: #ccc;
    }
    
    .plan-info-label {
      color: #aaa;
      font-weight: bold;
    }
    
    .plan-info-value {
      color: #4ade80;
      font-weight: bold;
    }
    
    .plan-info-value.amarillo {
      color: #fbbf24;
    }
    
    .plan-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
      margin-bottom: 10px;
      background: #d4af37;
      color: #0a1a2a;
    }
    
    .plan-badge.secundario {
      background: #60a5fa;
    }
    
    .clinica-info {
      background: #0d1f2d;
      border-left: 4px solid #4ade80;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .clinica-nombre {
      color: #d4af37;
      font-size: 1.4rem;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .clinica-ciudad {
      color: #aaa;
      font-size: 1rem;
    }
    
    .error-msg {
      color: #ff8080;
      background: #2a1a1a;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #ff8080;
    }
    
    .loading {
      text-align: center;
      color: #60a5fa;
      font-size: 1.2rem;
      padding: 20px;
    }
    
    .botones-accion {
      text-align: center;
      margin-top: 40px;
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    button {
      padding: 15px 30px;
      background: #d4af37;
      color: #0a1a2a;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    button:hover {
      background: #fbbf24;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(212,175,55,0.4);
    }
    
    button.secundario {
      background: #60a5fa;
    }
    
    button.secundario:hover {
      background: #a5c5ff;
    }
    
    footer {
      text-align: center;
      padding: 30px;
      color: #666;
      margin-top: 50px;
      border-top: 1px solid #3a5a7a;
    }
    
    .volver-link {
      color: #60a5fa;
      text-decoration: none;
      font-weight: bold;
    }
    
    .volver-link:hover {
      color: #d4af37;
    }
    
    @media (max-width: 600px) {
      h1 {
        font-size: 1.5rem;
      }
      
      .busqueda-container {
        padding: 20px;
      }
      
      .planes-grid {
        grid-template-columns: 1fr;
      }
      
      .botones-accion {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ¥ Buscar ClÃ­nica en Planes Colmena</h1>
    <p class="header-subtitle">Descubre quÃ© planes cubren tu clÃ­nica favorita</p>
  </header>
  
  <main>
    <div class="busqueda-container">
      <div class="info-section">
        <strong>ğŸ’¡ CÃ³mo usar:</strong> Empieza a escribir el nombre de tu clÃ­nica (ej: "V" para ViÃ±a, "Santa" para Santa MarÃ­a). Se mostrarÃ¡n sugerencias mientras escribes.
      </div>
      
      <div class="input-wrapper">
        <input 
          type="text" 
          id="clinicaBusqueda" 
          placeholder="Escribe el nombre de una clÃ­nica..."
          autocomplete="off"
        />
        <div id="autocompleteList" class="autocomplete-list"></div>
      </div>
      
      <div id="statusMsg"></div>
    </div>
    
    <div id="resultados" class="resultados"></div>
  </main>
  
  <footer>
    <a href="index.html" class="volver-link">â† Volver a CotizaciÃ³n de Planes</a>
  </footer>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIGURACIÃ“N
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const URL_PLANES = 'planes_completos_DEFINITIVO.json';
    const URL_REDES = 'redes_clinicas_UNIFICADO.json';
    
    let PLANES = [];
    let REDES_CLINICAS = {};
    let UF_VALOR = 39700;
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CARGAR DATOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function cargarDatos() {
      try {
        // Cargar planes
        const respPlanes = await fetch(URL_PLANES);
        PLANES = await respPlanes.json();
        console.log(`âœ… Planes cargados: ${PLANES.length}`);
        
        // Cargar redes
        const respRedes = await fetch(URL_REDES);
        REDES_CLINICAS = await respRedes.json();
        console.log(`âœ… Redes cargadas: ${Object.keys(REDES_CLINICAS).length}`);
        
        // Cargar UF
        try {
          const respUF = await fetch('https://mindicador.cl/api/uf');
          const dataUF = await respUF.json();
          UF_VALOR = Math.round(dataUF.UF.valor * 100) / 100;
          console.log(`âœ… UF cargada: ${UF_VALOR}`);
        } catch {
          console.log('â„¹ï¸ UF no disponible, usando valor por defecto');
        }
      } catch (err) {
        console.error('âŒ Error al cargar datos:', err);
        document.getElementById('statusMsg').innerHTML = 'âŒ Error al cargar datos. Recarga la pÃ¡gina.';
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTOCOMPLETE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function obtenerTodasLasClinicas() {
      const clinicas = [];
      
      for (const [grupoId, grupoData] of Object.entries(REDES_CLINICAS)) {
        if (grupoData.clinicas) {
          grupoData.clinicas.forEach(clinica => {
            clinicas.push({
              nombre: clinica.nombre,
              ciudad: clinica.ciudad,
              grupo: grupoId,
              grupoNombre: grupoData.nombre
            });
          });
        }
      }
      
      return clinicas;
    }
    
    function mostrarAutocomplete() {
      const input = document.getElementById('clinicaBusqueda').value.trim();
      const listElement = document.getElementById('autocompleteList');
      
      if (input.length < 1) {
        listElement.classList.remove('visible');
        return;
      }
      
      const todasLasClinicas = obtenerTodasLasClinicas();
      const filtradas = todasLasClinicas.filter(c => 
        c.nombre.toUpperCase().includes(input.toUpperCase())
      ).slice(0, 8);
      
      if (filtradas.length === 0) {
        listElement.classList.remove('visible');
        return;
      }
      
      let html = '';
      filtradas.forEach(clinica => {
        html += `
          <div class="autocomplete-item" onclick="seleccionarClinica('${clinica.nombre}', '${clinica.grupo}')">
            <div class="autocomplete-item-nombre">${clinica.nombre}</div>
            <div class="autocomplete-item-ciudad">ğŸ“ ${clinica.ciudad} â€¢ ${clinica.grupoNombre}</div>
          </div>
        `;
      });
      
      listElement.innerHTML = html;
      listElement.classList.add('visible');
    }
    
    function seleccionarClinica(nombreClinica, grupoId) {
      document.getElementById('clinicaBusqueda').value = nombreClinica;
      document.getElementById('autocompleteList').classList.remove('visible');
      buscarPlanesPorClinica(nombreClinica, grupoId);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BUSCAR PLANES POR CLÃNICA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function buscarPlanesPorClinica(nombreClinica, grupoId) {
      const statusMsg = document.getElementById('statusMsg');
      const resultados = document.getElementById('resultados');
      
      statusMsg.innerHTML = '';
      resultados.innerHTML = '';
      
      if (!nombreClinica) {
        statusMsg.innerHTML = '<div class="error-msg">âŒ Por favor selecciona una clÃ­nica</div>';
        return;
      }
      
      if (PLANES.length === 0) {
        statusMsg.innerHTML = '<div class="error-msg">âŒ Los planes aÃºn se estÃ¡n cargando</div>';
        return;
      }
      
      statusMsg.innerHTML = '<div class="loading">â³ Buscando planes...</div>';
      
      setTimeout(() => {
        const grupoData = REDES_CLINICAS[grupoId];
        
        if (!grupoData) {
          statusMsg.innerHTML = '<div class="error-msg">âŒ ClÃ­nica no encontrada</div>';
          return;
        }
        
        // Buscar planes que cubren este grupo
        const planesFiltrados = PLANES.filter(plan => 
          plan.coberturas_redes && plan.coberturas_redes[grupoId]
        );
        
        if (planesFiltrados.length === 0) {
          statusMsg.innerHTML = '<div class="error-msg">âŒ No hay planes disponibles para esta clÃ­nica</div>';
          return;
        }
        
        // Ordenar por valor y seleccionar 4 planes con coberturas diferentes
        const planesConValor = planesFiltrados.map(plan => ({
          ...plan,
          cobertura: plan.coberturas_redes[grupoId]
        }));
        
        planesConValor.sort((a, b) => a.pb_uf - b.pb_uf);
        
        // Obtener 4 planes diferenciados por cobertura
        const planesSeleccionados = [];
        const coberturaUsadas = new Set();
        
        for (const plan of planesConValor) {
          if (planesSeleccionados.length >= 4) break;
          
          if (!coberturaUsadas.has(plan.cobertura)) {
            coberturaUsadas.add(plan.cobertura);
            planesSeleccionados.push(plan);
          }
        }
        
        // Si no hay 4 diferenciados, agregar mÃ¡s
        if (planesSeleccionados.length < 4) {
          for (const plan of planesConValor) {
            if (planesSeleccionados.length >= 4) break;
            if (!planesSeleccionados.includes(plan)) {
              planesSeleccionados.push(plan);
            }
          }
        }
        
        mostrarPlanesSeleccionados(nombreClinica, grupoId, grupoData, planesSeleccionados, statusMsg, resultados);
      }, 300);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MOSTRAR PLANES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function mostrarPlanesSeleccionados(nombreClinica, grupoId, grupoData, planes, statusMsg, resultados) {
      statusMsg.innerHTML = '';
      
      let html = `
        <div class="clinica-info">
          <div class="clinica-nombre">âœ… ${nombreClinica}</div>
          <div class="clinica-ciudad">Red: ${grupoData.nombre}</div>
        </div>
        
        <div class="resultado-titulo">ğŸ“‹ Planes Disponibles (${planes.length})</div>
        
        <div class="planes-grid">
      `;
      
      planes.forEach((plan, index) => {
        const badge = index === 0 ? 'principal' : 'secundario';
        const badgeText = index === 0 ? 'âœ¨ PLAN 1' : (index === 1 ? 'ğŸ”· PLAN 2' : (index === 2 ? 'ğŸŸ¢ PLAN 3' : 'ğŸ”µ PLAN 4'));
        
        const valorUF = plan.pb_uf ? plan.pb_uf.toFixed(2) : '0.00';
        const valorCLP = Math.round(plan.pb_uf * UF_VALOR);
        const cobertura = plan.cobertura || 'N/A';
        
        html += `
          <div class="plan-card ${badge === 'secundario' ? 'secundario' : ''}">
            <div class="plan-badge ${badge}">${badgeText}</div>
            
            <div class="plan-titulo">${plan.plan}</div>
            
            <div class="plan-info">
              <div style="margin-bottom: 12px;">
                <div class="plan-info-label">ğŸ’° Prima Base</div>
                <div class="plan-info-value">${valorUF} UF</div>
                <div style="color: #888; font-size: 0.85rem;">($${formatearNumero(valorCLP)} aprox.)</div>
              </div>
              
              <div style="margin-bottom: 12px;">
                <div class="plan-info-label">ğŸ¥ Cobertura en Red</div>
                <div class="plan-info-value">${cobertura}%</div>
              </div>
              
              <div style="margin-bottom: 12px;">
                <div class="plan-info-label">ğŸ¨ HospitalizaciÃ³n</div>
                <div class="plan-info-value">Incluida</div>
              </div>
              
              <div style="margin-bottom: 12px;">
                <div class="plan-info-label">ğŸ©º Consulta Ambulatoria</div>
                <div class="plan-info-value">${plan.consulta?.valor || 'Incluida'}</div>
              </div>
              
              <div style="margin-bottom: 12px;">
                <div class="plan-info-label">ğŸ“‹ Tope Anual</div>
                <div class="plan-info-value amarillo">${plan.tope_anual_uf || 7000} UF</div>
              </div>
              
              <div>
                <div class="plan-info-label">Zona</div>
                <div class="plan-info-value">${plan.zona || 'SANTIAGO'}</div>
              </div>
            </div>
          </div>
        `;
      });
      
      html += `
        </div>
        
        <div class="botones-accion">
          <button onclick="document.getElementById('clinicaBusqueda').value=''; document.getElementById('resultados').innerHTML='';">ğŸ”„ Nueva BÃºsqueda</button>
          <button class="secundario" onclick="window.location.href='index.html';">ğŸ“‹ Ir a Cotizar</button>
        </div>
      `;
      
      resultados.innerHTML = html;
    }
    
    function formatearNumero(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EVENTOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    window.addEventListener('DOMContentLoaded', cargarDatos);
    
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('clinicaBusqueda');
      
      input.addEventListener('input', mostrarAutocomplete);
      
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const autocompleteList = document.getElementById('autocompleteList');
          if (autocompleteList.classList.contains('visible')) {
            const primerItem = autocompleteList.querySelector('.autocomplete-item');
            if (primerItem) {
              primerItem.click();
            }
          }
        }
      });
      
      // Cerrar autocomplete cuando hace click afuera
      document.addEventListener('click', (e) => {
        if (e.target !== input) {
          document.getElementById('autocompleteList').classList.remove('visible');
        }
      });
    });
  </script>
</body>
</html>
