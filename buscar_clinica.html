<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buscar Cl√≠nica en Planes Colmena - Optimizado</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: Arial, sans-serif; 
      background: linear-gradient(135deg, #0a1a2a, #0d2a3a);
      color: white; 
      margin: 0; 
      padding: 0;
    }
    
    header {
      background: linear-gradient(90deg, #0a1a2a, #12375a);
      padding: 40px 20px;
      text-align: center;
      border-bottom: 3px solid #d4af37;
    }
    
    h1 { 
      color: #d4af37; 
      font-size: 2.2rem; 
      margin: 0 0 10px 0;
    }
    
    .header-subtitle {
      color: #aaa;
      font-size: 1rem;
    }
    
    .performance-badge {
      display: inline-block;
      background: #4ade80;
      color: #0a1a2a;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: bold;
      margin-top: 10px;
    }
    
    main {
      max-width: 1000px;
      margin: 40px auto;
      padding: 0 20px;
    }
    
    .busqueda-container {
      background: #112233;
      border: 2px solid #d4af37;
      border-radius: 15px;
      padding: 40px;
      margin-bottom: 40px;
    }
    
    .input-wrapper {
      position: relative;
      margin-bottom: 20px;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 15px 50px 15px 15px;
      border-radius: 8px;
      border: 1px solid #d4af37;
      background: #1a3a5a;
      color: white;
      font-size: 1rem;
    }
    
    input[type="text"]::placeholder { color: #666; }
    input[type="text"]:focus {
      outline: none;
      background: #1a4a7a;
      border-color: #fbbf24;
    }
    
    .search-icon {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #d4af37;
      font-size: 1.2rem;
    }
    
    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #0a1a2a;
      border: 2px solid #4ade80;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 350px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
      box-shadow: 0 10px 30px rgba(74, 222, 128, 0.3);
    }
    
    .autocomplete-list.visible { display: block; }
    
    .autocomplete-item {
      padding: 15px;
      cursor: pointer;
      border-bottom: 1px solid #1a3a5a;
      transition: all 0.2s;
      position: relative;
    }
    
    .autocomplete-item:hover {
      background: #1a3a5a;
      border-left: 4px solid #4ade80;
      padding-left: 11px;
    }
    
    .autocomplete-item-nombre {
      font-weight: bold;
      color: #d4af37;
      font-size: 1rem;
      margin-bottom: 5px;
    }
    
    .autocomplete-item-ciudad {
      font-size: 0.85rem;
      color: #aaa;
    }
    
    .autocomplete-match-score {
      position: absolute;
      right: 15px;
      top: 15px;
      background: #4ade80;
      color: #0a1a2a;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    .autocomplete-footer {
      padding: 10px;
      text-align: center;
      color: #666;
      font-size: 0.8rem;
      background: #0d1f2d;
      border-top: 1px solid #1a3a5a;
    }
    
    .info-section {
      background: #0d1f2d;
      border-left: 4px solid #60a5fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    
    .stats-section {
      display: flex;
      gap: 20px;
      justify-content: space-around;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .stat-item {
      background: #0d1f2d;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      flex: 1;
      min-width: 150px;
      border: 1px solid #2a4a6a;
    }
    
    .stat-value {
      color: #4ade80;
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .stat-label {
      color: #aaa;
      font-size: 0.85rem;
      margin-top: 5px;
    }
    
    .plan-card {
      background: #1a2a3a;
      border: 2px solid #d4af37;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      transition: all 0.3s;
    }
    
    .plan-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(212,175,55,0.3);
    }
    
    .plan-titulo {
      color: #d4af37;
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 15px;
    }
    
    .plan-info {
      font-size: 0.9rem;
      line-height: 1.8;
      color: #ccc;
    }
    
    .clinica-info {
      background: linear-gradient(135deg, #0d1f2d, #1a3a5a);
      border: 2px solid #4ade80;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .clinica-nombre {
      color: #d4af37;
      font-size: 1.6rem;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .error-msg {
      color: #ff8080;
      background: #2a1a1a;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #ff8080;
    }
    
    button {
      padding: 15px 30px;
      background: #d4af37;
      color: #0a1a2a;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin: 10px 5px;
    }
    
    button:hover {
      background: #fbbf24;
      transform: translateY(-2px);
    }
    
    footer {
      text-align: center;
      padding: 30px;
      color: #666;
      margin-top: 50px;
    }
    
    .volver-link {
      color: #60a5fa;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>üè• Buscar Cl√≠nica en Planes Colmena</h1>
    <p class="header-subtitle">Descubre qu√© planes cubren tu cl√≠nica favorita</p>
    <span class="performance-badge">‚ö° B√∫squeda Optimizada con IA</span>
  </header>
  
  <main>
    <div class="busqueda-container">
      <div class="info-section">
        <strong>üí° B√∫squeda Inteligente:</strong> Usa algoritmos avanzados (Fuzzy Search + √çndices Invertidos) para encontrar resultados incluso con errores. Ej: "alemna" ‚Üí "Alemana"
      </div>
      
      <div class="stats-section">
        <div class="stat-item">
          <div class="stat-value" id="totalClinicas">-</div>
          <div class="stat-label">Cl√≠nicas Indexadas</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalPlanes">-</div>
          <div class="stat-label">Planes Disponibles</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="tiempoBusqueda">0ms</div>
          <div class="stat-label">Tiempo B√∫squeda</div>
        </div>
      </div>
      
      <div class="input-wrapper">
        <input 
          type="text" 
          id="clinicaBusqueda" 
          placeholder="Ej: Alemana, Cat√≥lica, D√°vila, Las Condes..."
          autocomplete="off"
        />
        <span class="search-icon">üîç</span>
        <div id="autocompleteList" class="autocomplete-list"></div>
      </div>
      
      <div id="statusMsg"></div>
    </div>
    
    <div id="resultados"></div>
  </main>
  
  <footer>
    <a href="index.html" class="volver-link">‚Üê Volver a Cotizaci√≥n</a>
  </footer>

  <script>
    const URL_PLANES = 'planes_completos_DEFINITIVO.json';
    const URL_REDES = 'redes_clinicas_UNIFICADO.json';
    let PLANES = [], REDES_CLINICAS = {}, UF_VALOR = 39700;
    let INDICE_CLINICAS = null, CACHE_NORMALIZACION = new Map(), TODAS_LAS_CLINICAS = [];
    
    function normalizarTextoOptimizado(texto) {
      if (!texto) return '';
      if (CACHE_NORMALIZACION.has(texto)) return CACHE_NORMALIZACION.get(texto);
      const resultado = texto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
      CACHE_NORMALIZACION.set(texto, resultado);
      return resultado;
    }
    
    function calcularDistanciaLevenshtein(str1, str2) {
      const m = str1.length, n = str2.length;
      if (Math.abs(m - n) > 5) return Math.max(m, n);
      const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
      for (let i = 0; i <= m; i++) dp[i][0] = i;
      for (let j = 0; j <= n; j++) dp[0][j] = j;
      for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
          dp[i][j] = str1[i - 1] === str2[j - 1] ? dp[i - 1][j - 1] : 1 + Math.min(dp[i - 1][j], dp[i][j - 1], dp[i - 1][j - 1]);
        }
      }
      return dp[m][n];
    }
    
    function crearNGramas(texto, n = 3) {
      const ngramas = new Set();
      const textoNorm = normalizarTextoOptimizado(texto);
      textoNorm.split(/\s+/).forEach(palabra => { if (palabra.length >= 3) ngramas.add(palabra); });
      for (let i = 0; i <= textoNorm.length - n; i++) ngramas.add(textoNorm.slice(i, i + n));
      return ngramas;
    }
    
    function construirIndiceClinicas(listaClinicas) {
      const inicio = performance.now();
      const indice = new Map();
      listaClinicas.forEach((clinica, idx) => {
        crearNGramas(clinica.nombre).forEach(ngrama => {
          if (!indice.has(ngrama)) indice.set(ngrama, []);
          indice.get(ngrama).push(idx);
        });
      });
      console.log('‚úÖ √çndice: ' + (performance.now() - inicio).toFixed(2) + 'ms');
      return indice;
    }
    
    function buscarClinicaOptimizada(terminoBusqueda, umbralFuzzy = 0.5) {
      const terminoNorm = normalizarTextoOptimizado(terminoBusqueda);
      if (!terminoNorm || terminoNorm.length < 1) return [];
      const ngramasBusqueda = crearNGramas(terminoNorm);
      const candidatos = new Map();
      ngramasBusqueda.forEach(ngrama => {
        (INDICE_CLINICAS?.get(ngrama) || []).forEach(idx => {
          candidatos.set(idx, (candidatos.get(idx) || 0) + 1);
        });
      });
      return Array.from(candidatos.entries()).map(([idx, matchesIndice]) => {
        const clinica = TODAS_LAS_CLINICAS[idx];
        const clinicaNorm = normalizarTextoOptimizado(clinica.nombre);
        const distancia = calcularDistanciaLevenshtein(terminoNorm, clinicaNorm);
        const maxLen = Math.max(terminoNorm.length, clinicaNorm.length);
        const similaridadFuzzy = 1 - (distancia / maxLen);
        const scoreIndice = matchesIndice / ngramasBusqueda.size;
        return {...clinica, score: (scoreIndice * 0.4) + (similaridadFuzzy * 0.6), scoreFuzzy: similaridadFuzzy};
      }).filter(r => r.scoreFuzzy >= umbralFuzzy).sort((a, b) => b.score - a.score);
    }
    
    async function cargarDatos() {
      try {
        const [respPlanes, respRedes] = await Promise.all([fetch(URL_PLANES), fetch(URL_REDES)]);
        PLANES = await respPlanes.json();
        REDES_CLINICAS = await respRedes.json();
        document.getElementById('totalPlanes').textContent = PLANES.length;
        const clinicasArray = [];
        for (const [grupoId, grupoData] of Object.entries(REDES_CLINICAS)) {
          if (grupoData.clinicas) {
            grupoData.clinicas.forEach(c => clinicasArray.push({nombre: c.nombre, ciudad: c.ciudad, grupo: grupoId, grupoNombre: grupoData.nombre}));
          }
        }
        TODAS_LAS_CLINICAS = clinicasArray;
        INDICE_CLINICAS = construirIndiceClinicas(clinicasArray);
        document.getElementById('totalClinicas').textContent = clinicasArray.length;
        try {
          const respUF = await fetch('https://mindicador.cl/api/uf');
          UF_VALOR = Math.round((await respUF.json()).UF.valor * 100) / 100;
        } catch {}
      } catch (err) {
        document.getElementById('statusMsg').innerHTML = '<div class="error-msg">‚ùå Error al cargar datos</div>';
      }
    }
    
    let timeoutAutocomplete;
    function mostrarAutocomplete() {
      clearTimeout(timeoutAutocomplete);
      const input = document.getElementById('clinicaBusqueda').value.trim();
      const listElement = document.getElementById('autocompleteList');
      if (input.length < 1) { listElement.classList.remove('visible'); return; }
      timeoutAutocomplete = setTimeout(() => {
        const inicio = performance.now();
        const resultados = buscarClinicaOptimizada(input, 0.4);
        const fin = performance.now();
        document.getElementById('tiempoBusqueda').textContent = (fin - inicio).toFixed(1) + 'ms';
        if (resultados.length === 0) {
          listElement.innerHTML = '<div class="autocomplete-footer">‚ùå Sin resultados</div>';
          listElement.classList.add('visible');
          return;
        }
        let html = '';
        resultados.slice(0, 8).forEach(clinica => {
          const matchPercent = Math.round(clinica.score * 100);
          html += '<div class="autocomplete-item" onclick=\'seleccionarClinica(' + JSON.stringify(clinica.nombre) + ', "' + clinica.grupo + '")\'><div class="autocomplete-item-nombre">' + clinica.nombre + '</div><div class="autocomplete-item-ciudad">üìç ' + clinica.ciudad + ' ‚Ä¢ ' + clinica.grupoNombre + '</div><span class="autocomplete-match-score">' + matchPercent + '%</span></div>';
        });
        html += '<div class="autocomplete-footer">‚ö° ' + (fin - inicio).toFixed(1) + 'ms ‚Ä¢ ' + resultados.length + ' resultados</div>';
        listElement.innerHTML = html;
        listElement.classList.add('visible');
      }, 150);
    }
    
    function seleccionarClinica(nombreClinica, grupoId) {
      document.getElementById('clinicaBusqueda').value = nombreClinica;
      document.getElementById('autocompleteList').classList.remove('visible');
      buscarPlanes(nombreClinica, grupoId);
    }
    
    function buscarPlanes(nombreClinica, grupoId) {
      const statusMsg = document.getElementById('statusMsg');
      const resultados = document.getElementById('resultados');
      statusMsg.innerHTML = '';
      resultados.innerHTML = '';
      if (!nombreClinica || PLANES.length === 0) return;
      const grupoData = REDES_CLINICAS[grupoId];
      if (!grupoData) return;
      const planesFiltrados = PLANES.filter(plan => plan.coberturas_redes && plan.coberturas_redes[grupoId]);
      if (planesFiltrados.length === 0) {
        statusMsg.innerHTML = '<div class="error-msg">‚ùå No hay planes para esta cl√≠nica</div>';
        return;
      }
      const planesConValor = planesFiltrados.map(plan => ({...plan, cobertura: plan.coberturas_redes[grupoId]})).sort((a, b) => a.pb_uf - b.pb_uf).slice(0, 4);
      let html = '<div class="clinica-info"><div class="clinica-nombre">‚úÖ ' + nombreClinica + '</div><div style="color: #aaa;">Red: ' + grupoData.nombre + '</div></div>';
      planesConValor.forEach((plan, i) => {
        const valorUF = plan.pb_uf ? plan.pb_uf.toFixed(2) : '0.00';
        const valorCLP = Math.round(plan.pb_uf * UF_VALOR);
        html += '<div class="plan-card"><div class="plan-titulo">' + (i + 1) + '. ' + plan.plan + '</div><div class="plan-info">üí∞ Prima Base: <strong style="color: #4ade80;">' + valorUF + ' UF</strong> ($' + valorCLP.toLocaleString('es-CL') + ')<br>üè• Cobertura: <strong style="color: #4ade80;">' + (plan.cobertura || 'N/A') + '%</strong><br>üìã Tope Anual: <strong style="color: #fbbf24;">' + (plan.tope_anual_uf || 7000) + ' UF</strong></div></div>';
      });
      html += '<div style="text-align: center; margin-top: 30px;"><button onclick="document.getElementById(\'clinicaBusqueda\').value=\'\'; document.getElementById(\'resultados\').innerHTML=\'\';">üîÑ Nueva B√∫squeda</button><button onclick="window.location.href=\'index.html\';">üìã Ir a Cotizar</button></div>';
      resultados.innerHTML = html;
    }
    
    window.addEventListener('DOMContentLoaded', cargarDatos);
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('clinicaBusqueda');
      input.addEventListener('input', mostrarAutocomplete);
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const primer = document.querySelector('.autocomplete-item');
          if (primer) primer.click();
        }
      });
      document.addEventListener('click', (e) => {
        if (e.target !== input) document.getElementById('autocompleteList').classList.remove('visible');
      });
    });
  </script>
</body>
</html>
